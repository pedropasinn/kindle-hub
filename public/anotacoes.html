<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kindle Notes App</title>
    <!-- Phosphor Icons: Biblioteca de ícones leve e nítida, ideal para simular o design e-ink -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="timer.js" defer></script>

    <style>
        /* --- RESET & VARIÁVEIS --- */
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border-color: #000000;
            --font-main: Helvetica, Arial, sans-serif; /* Fontes sem serifa limpas para legibilidade em e-ink */
            --radius: 12px;
            --spacing: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden; /* Comportamento de App */
            display: flex;
            flex-direction: column;
        }

        /* --- UTILITÁRIOS --- */
        .hidden { display: none !important; }
        .flex { display: flex; align-items: center; }
        .icon-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
        }
        
        /* --- CABEÇALHO GERAL --- */
        header {
            padding: var(--spacing);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid transparent; 
        }
        header h1 { font-size: 30px; font-weight: bold; }

        /* --- TELA 1: LISTA (HOME) --- */
        #screen-list {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Container unificado para Busca e Filtros */
        .search-and-filter {
            display: flex;
            align-items: center;
            padding: 0 var(--spacing);
            margin-bottom: 16px;
        }
        .search-and-filter > *:not(:last-child) {
            margin-right: 8px;
        }

        .search-bar {
            flex: 1; /* Ocupa o espaço restante */
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 8px 16px; /* Ajuste leve para alinhar visualmente com os botões */
            display: flex;
            align-items: center;
            height: 42px; /* Altura fixa para garantir alinhamento */
        }
        .search-bar > *:not(:last-child) {
            margin-right: 8px;
        }
        .search-bar input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 18px;
            background: transparent;
            font-family: inherit;
        }

        .action-buttons {
            display: flex;
            align-items: center;
            flex-shrink: 0; /* Impede que os botões encolham */
        }

        .action-buttons > *:not(:last-child) {
            margin-right: 8px;
        }
        
        .dropdown-btn {
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 0 14px;
            background: white;
            font-size: 16px;
            display: flex;
            align-items: center;
            font-family: inherit;
            cursor: pointer;
            height: 42px; /* Mesma altura da busca */
            white-space: nowrap;
            position: relative; /* Para posicionar o dropdown */
        }
        .dropdown-btn > *:not(:last-child) {
            margin-right: 6px;
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 8px); /* Abaixo do botão */
            right: 0;
            background: white;
            border: 2px solid #000;
            border-radius: 12px;
            box-shadow: 4px 4px 0px #000;
            z-index: 10;
            padding: 8px;
            width: 200px;
        }

        .dropdown-menu button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 10px 12px;
            border: none;
            background: none;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
        }
        .dropdown-menu button:hover {
            background-color: #f0f0f0;
        }

        .refresh-btn {
            border: 2px solid black;
            border-radius: 50%;
            width: 42px; /* Mesma altura da busca */
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        /* Chips de navegação horizontal */
        .chips-scroller {
            display: flex;
            overflow-x: auto;
            padding: 0 var(--spacing) 16px var(--spacing);
            scrollbar-width: none; /* Firefox */
            border-bottom: 1px solid #ccc;
        }
        .chips-scroller::-webkit-scrollbar { display: none; } /* Chrome/Safari */
        .chips-scroller > *:not(:last-child) {
            margin-right: 10px;
        }
        
        .chip {
            border: 2px solid var(--border-color);
            border-radius: 20px;
            padding: 8px 18px;
            font-weight: bold;
            font-size: 15px;
            white-space: nowrap;
            background: white;
            cursor: pointer;
            font-family: inherit;
        }
        .chip.active {
            background: var(--text-color);
            color: var(--bg-color);
        }

        /* Lista de Notas */
        .notes-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 var(--spacing);
        }
        .note-item {
            padding: 20px 0;
            border-bottom: 1px solid #999;
            cursor: pointer;
        }
        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .note-title { font-weight: bold; font-size: 20px; }
        .note-tag {
            border: 2px solid #666;
            border-radius: 14px;
            padding: 4px 10px;
            font-size: 12px;
            font-weight: bold;
            color: #444;
        }
        .note-preview {
            font-size: 16px;
            line-height: 1.4;
            color: #333;
            display: -webkit-box;
            line-clamp: 2;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 8px;
            word-wrap: break-word;
        }
        .note-date {
            text-align: right;
            font-size: 14px;
            color: #666;
        }

        /* --- TELA 2: MODAL (POPUP) --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0, 0.5);
            backdrop-filter: grayscale(1);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
        }

        /* Estilo BASE compartilhado (Aparência de Cartão E-ink) */
        .modal-window, 
        #screen-editor {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 16px;
            width: 100%;
            max-width: 500px; /* Mantém a largura controlada em ambos */
            height: 85vh;     /* Altura unificada */
            display: flex;
            flex-direction: column;
            box-shadow: 6px 6px 0px #000; /* Sombra sólida idêntica */
            position: relative;
        }

        /* Para garantir que o editor centralize se estiver solto na tela */
        #screen-editor {
            margin: 0 auto; 
        }

        /* --- CABEÇALHOS UNIFICADOS --- */
        .modal-header,
        #screen-editor header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 2px solid #000;
            background: #f4f4f4; /* Ambos agora têm o fundo cinza */
            border-radius: 14px 14px 0 0; /* Arredondamento apenas no topo */
        }

        .modal-header h2 { font-size: 20px; font-weight: bold; margin: 0; }

        /* --- CORPO / ÁREA DE TEXTO UNIFICADA --- */
        .modal-body,
        .modal-body-edit,
        .editor-content {
            padding: 20px;
            overflow-y: auto;
            font-size: 18px;   /* Tamanho padronizado */
            line-height: 1.5;  /* Espaçamento padronizado */
            text-align: justify;
            flex: 1;           /* Ocupa todo o espaço restante */
            font-family: var(--font-main);
            color: #000;

            /* Reset de input/textarea */
            border: none;
            outline: none;
            resize: none;
            background: transparent;
            width: 100%;
        }

        /* Espaçamento entre parágrafos no modal de visualização */
        .modal-body p {
            margin-bottom: 12px;
        }
        .modal-body p:last-child {
            margin-bottom: 0;
        }

        /* --- INPUTS ESPECÍFICOS --- */

        /* Título editável no Modal */
        .modal-title-edit {
            font-size: 20px;
            font-weight: bold;
            border: none;
            outline: none;
            background: transparent;
            width: 100%;
            text-align: left; /* Ajustado para alinhar com o layout padrão */
            cursor: pointer;
        }

        /* Ajustes Mobile */
        @media (max-width: 400px) {
            /* Ajuste para telas muito estreitas na barra de busca */
            .dropdown-btn span { display: none; } /* Esconde o texto "Ordenar" se ficar muito apertado */
            .dropdown-btn { padding: 0 10px; }
        }

    </style>
</head>
<body>

    <!-- === TELA 1: LISTA === -->
    <div id="screen-list">
        <header>
            <div class="flex">
                <a href="dashboard.html" style="display:flex;align-items:center;margin-right:16px;">
                    <img src="/icones/casa.png" alt="Home" style="width:40px;height:40px;">
                </a>
                <a href="plano-inclinado.html" style="display:flex;align-items:center;">
                    <img src="/icones/cruz.png" alt="Plano inclinado" style="width:40px;height:40px;">
                </a>
            </div>
            <h1>Anotações</h1>
            <div style="width: 70px"></div> <!-- Espaçador visual -->
        </header>

        <!-- Busca e Ações na mesma linha -->
        <div class="search-and-filter">
            <div class="search-bar">
                <i class="ph ph-magnifying-glass" style="font-size: 20px;"></i>
                <input type="text" placeholder="Buscar">
            </div>

            <div class="action-buttons">
                <div style="position: relative;"> <!-- Wrapper para o botão e menu -->
                    <button class="dropdown-btn">
                        <span>Ordenar</span> <i class="ph ph-caret-down"></i>
                    </button>
                    <div id="sort-menu" class="dropdown-menu hidden">
                        <button data-sort="recent">Mais Recentes</button>
                        <button data-sort="oldest">Mais Antigas</button>
                        <button data-sort="alpha-az">Ordem Alfabética (A-Z)</button>
                        <button data-sort="alpha-za">Ordem Alfabética (Z-A)</button>
                    </div>
                </div>
                <button class="icon-btn refresh-btn">
                    <i class="ph ph-arrows-clockwise" style="font-size: 20px;"></i>
                </button>
                <button class="icon-btn refresh-btn" onclick="createNewNote()">
                    <i class="ph ph-plus" style="font-size: 20px;"></i>
                </button>
            </div>
        </div>

        <!-- Categorias (Chips) -->
        <div class="chips-scroller">
            <!-- Os chips serão gerados dinamicamente pelo JavaScript -->
        </div>

        <!-- Lista -->
        <div class="notes-list">
            <!-- As anotações serão carregadas dinamicamente do Notion -->
        </div>
    </div>

    <!-- === TELA 2: MODAL (Overlay) === -->
    <div id="modal-view" class="modal-overlay hidden" onclick="closeModal(event)">
        <div class="modal-window" onclick="event.stopPropagation()">
            <div class="modal-header">
                <!-- Botão esquerdo: Lápis (modo view) ou Voltar (modo edit) -->
                <button class="icon-btn" id="modal-left-btn" onclick="toggleEditMode()">
                    <i class="ph ph-pencil-simple" style="font-size: 28px;"></i>
                </button>

                <!-- Título: h2 (modo view) ou input (modo edit) -->
                <h2 id="modal-title-view">Pequeno tirano</h2>
                <input type="text" id="modal-title-edit" class="modal-title-edit hidden" value="Pequeno tirano" onclick="enableModalTitleEdit()">

                <!-- Seletor de tag (só aparece em modo edit) -->
                <select id="modal-tag-selector" class="hidden" style="border: 2px solid #000; border-radius: 8px; padding: 8px 12px; font-size: 16px; background: white; font-family: inherit; cursor: pointer; margin-right: 8px;">
                    <option value="">Sem tag</option>
                </select>

                <!-- Botão direito: Excluir (modo view) ou Salvar (modo edit) -->
                <button class="icon-btn" id="modal-right-btn" onclick="deleteAnnotation()">
                    <i class="ph ph-trash" style="font-size: 28px;"></i>
                </button>
            </div>
            <div class="modal-body" id="modal-body-view">
                <p>Pequeno Tirano... Criança vai tacando pedras pela rua, até que quebra uma janela... decide não contar, com medo. Mas, como bom era o pai, se tivesse contato o pai pagaria sem pestanejar iria levar o menino para casa explica-lo do mal que tinha cometido e de como estava feliz dele ter assumido a culpa, ficaria feliz por ver seu pai feliz. Mas, ele não contou... deixou tudo para trás, inclusive a janela, ela ficou ali, quebrada... nunca souberam quem foi, nunca foi encontrado o culpado. O menino agora é um infame quebrador de janelas um verdadeiro detona ralph.</p>
                <br>
                <p>Não há como deixar as janelas da nossa vida quebradas, estamos deixando os outros passando frio pela brisas geladas que entram em suas vidas conta dos nossos erros. O mal entra por estas janelas, tanto na nossa casa quanto na dos outros. Precisamos blindar nossas janelas? É mais fácil blindar a janela de todas as pessoas? Ou conter os infames atiradores de pedras?</p>
            </div>
            <textarea class="modal-body modal-body-edit hidden" id="modal-body-edit"></textarea>
        </div>
    </div>

    <!-- === TELA 3: EDITOR === -->
    <div id="screen-editor" class="hidden">
        <header>
            <button class="icon-btn" onclick="closeEditor()">
                <i class="ph ph-arrow-left" style="font-weight: bold; font-size: 32px;"></i>
            </button>
            <div class="flex" style="align-items: center; flex: 1;">
                <input type="text" id="editor-title-input" style="font-size: 22px; font-weight:bold; border: none; outline: none; background: transparent; flex: 1; min-width: 0; cursor: pointer;" value="Pequeno tirano" readonly onclick="enableTitleEdit()">
            </div>
            <select id="editor-tag-selector" style="border: 2px solid #000; border-radius: 8px; padding: 8px 12px; font-size: 16px; background: white; font-family: inherit; cursor: pointer; margin-right: 8px;">
                <option value="">Sem tag</option>
            </select>
            <button class="icon-btn" onclick="saveAndClose()">
                <i class="ph ph-floppy-disk" style="font-size: 32px;"></i>
            </button>
        </header>

        <textarea class="editor-content">Pequeno Tirano... Criança vai tacando pedras pela rua, até que quebra uma janela... decide não contar, com medo. Mas, como bom era o pai, se tivesse contato o pai pagaria sem pestanejar iria levar o menino para casa explica-lo do mal que tinha cometido e de como estava feliz dele ter assumido a culpa, ficaria feliz por ver seu pai feliz. Mas, ele não contou... deixou tudo para trás, inclusive a janela, ela ficou ali, quebrada... nunca souberam quem foi, nunca foi encontrado o culpado. O menino agora é um infame quebrador de janelas um verdadeiro detona ralph. Não há como deixar as janelas da nossa vida quebradas, estamos deixando os outros passando frio pela brisas geladas que entram em suas vidas conta dos nossos erros. O mal entra por estas janelas, tanto na nossa casa quanto na dos outros. Precisamos blindar nossas janelas? É mais fácil blindar a janela de todas as pessoas? Ou conter os infames atiradores de pedras? Ficamos tentados vendo pedras pelo caminho... mas com a vontade fortalecida e o pensamento no amor do pai por nós torna nada razoável jogar uma Pedra por ai. # O Pequeno Tirano Era uma vez um menino que</textarea>
    </div>

    <script>
        // ============= CONFIGURAÇÃO =============
        const CATEGORIES = [
            'Círculo', 'Direção', 'B10', 'Aula de doutrina', 'Dia de Turno',
            'Oração Mental', 'Confissão', 'Recolhimento', 'Curso Anual', 'Retiro'
        ];

        // ============= ELEMENTOS =============
        const screenList = document.getElementById('screen-list');
        const modalView = document.getElementById('modal-view');
        const screenEditor = document.getElementById('screen-editor');
        const notesList = document.querySelector('.notes-list');
        const searchInput = document.querySelector('.search-bar input');
        const refreshBtn = document.querySelector('.refresh-btn');
        const chips = document.querySelectorAll('.chip');
        const sortBtn = document.querySelector('.dropdown-btn');
        const sortMenu = document.getElementById('sort-menu');

        // ============= ESTADO GLOBAL =============
        let allAnnotations = [];
        let currentFilter = null;
        let currentQuery = '';
        let currentAnnotation = null;
        let currentSort = 'recent'; // 'recent', 'oldest', 'alpha-az', 'alpha-za'
        let isEditMode = false; // Controla se o modal está em modo de edição


        // ============= FUNÇÕES AUXILIARES =============
        function formatDate(dateString) {
            if (!dateString) return 'Data desconhecida';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

// ============= FUNÇÕES DE SEGURANÇA (SUBSTITUA AS ANTERIORES) =============

        // 1. Função de Preview simplificada - usa o campo preview da API
        function extractPreview(annotation) {
            try {
                // Se for nulo/indefinido
                if (!annotation) return 'Sem conteúdo';

                // O preview já vem processado do servidor
                const preview = annotation.preview || '';

                // Se ficou vazio
                if (!preview.trim()) return 'Sem conteúdo';

                return preview;

            } catch (err) {
                console.error("Erro ao gerar preview:", err);
                return 'Erro na visualização';
            }
        }

        // 2. Carregamento com logs visíveis
        async function loadAnnotations() {
            try {
                console.log("Iniciando carregamento...");
                notesList.innerHTML = '<div style="text-align:center;padding:30px;">Carregando...</div>';

                const response = await fetch('/api/anotacoes');
                
                if (!response.ok) {
                    throw new Error(`Erro API: ${response.status}`);
                }

                const data = await response.json();
                console.log("Dados recebidos da API:", data);

                // Garante que é um array, senão cria um vazio
                allAnnotations = Array.isArray(data) ? data : [];
                
                if (allAnnotations.length === 0) {
                    console.warn("Array de anotações está vazio!");
                }

                renderAnnotations();
            } catch (err) {
                console.error('Erro fatal no load:', err);
                notesList.innerHTML = `<div style="color:red; text-align:center;">Erro: ${err.message}</div>`;
            }
        }

        // 3. Renderização com proteção contra quebras
        function renderAnnotations() {
            try {
                // Verificação de segurança dos elementos DOM
                if (!notesList) {
                    console.error("Elemento .notes-list não encontrado no HTML");
                    return;
                }

                // Filtragem
                let filtered = [...allAnnotations];
                
                // Aplica filtro de Tag
                if (currentFilter) {
                    filtered = filtered.filter(a => {
                        return Array.isArray(a.tags) && a.tags.includes(currentFilter);
                    });
                }

                // Aplica busca
                if (currentQuery) {
                    filtered = filtered.filter(a => {
                        const t = (a.title || '').toLowerCase();
                        // Conversão segura para string na busca
                        const c = JSON.stringify(a).toLowerCase(); 
                        return t.includes(currentQuery) || c.includes(currentQuery);
                    });
                }

                sortAnnotations(filtered);

                // Renderização
                if (filtered.length === 0) {
                    notesList.innerHTML = `
                        <div style="text-align:center;padding:50px;color:#666;">
                            <h3>Nenhuma anotação</h3>
                        </div>
                    `;
                    return;
                }

                // Construção do HTML
                notesList.innerHTML = filtered.map(a => {
                    // Proteção individual por item (se uma nota falhar, as outras carregam)
                    try {
                        const title = a.title || 'Sem título';
                        const tags = Array.isArray(a.tags) ? a.tags : [];
                        const primaryTag = tags[0] || 'Geral';
                        const date = formatDate(a.createdTime);
                        const preview = extractPreview(a); // Passa a anotação completa

                        return `
                            <div class="note-item" onclick="openAnnotation('${a.id}')">
                                <div class="note-header">
                                    <span class="note-title">${title}</span>
                                    <span class="note-tag">${primaryTag}</span>
                                </div>
                                <div class="note-preview">${preview}</div>
                                <div class="note-date">${date}</div>
                            </div>
                        `;
                    } catch (itemErr) {
                        console.error("Erro ao renderizar item:", itemErr, a);
                        return `<div class="note-item" style="color:red">Erro ao exibir nota</div>`;
                    }
                }).join('');

            } catch (renderErr) {
                console.error("Erro fatal na renderização:", renderErr);
                notesList.innerHTML = `<div style="color:red">Erro fatal de JS: ${renderErr.message}</div>`;
            }
        }

        // ============= ORDENAÇÃO, BUSCA E FILTROS =============
         function sortAnnotations(array) {
            switch (currentSort) {
                case 'recent':
                    array.sort((a, b) => new Date(b.createdTime) - new Date(a.createdTime));
                    break;
                case 'oldest':
                    array.sort((a, b) => new Date(a.createdTime) - new Date(b.createdTime));
                    break;
                case 'alpha-az':
                    array.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
                    break;
                case 'alpha-za':
                    array.sort((a, b) => (b.title || '').localeCompare(a.title || ''));
                    break;
            }
        }
        function onSearchChange() {
            currentQuery = searchInput.value.trim().toLowerCase();
            renderAnnotations();
        }

        function filterByTag(tag, btnEl) {
            // Primeiro, remove 'active' de todos os chips
            const allChips = document.querySelectorAll('.chips-scroller .chip');
            allChips.forEach(chip => chip.classList.remove('active'));

            // Se um botão foi clicado, adiciona 'active' a ele
            if (btnEl) {
                btnEl.classList.add('active');
            }
            
            currentFilter = tag || null;
            renderAnnotations();
        }


        // ============= ABRIR ANOTAÇÃO =============
        async function openAnnotation(annotationId) {
            try {
                const response = await fetch(`/api/anotacoes/${annotationId}`);
                if (!response.ok) throw new Error('Erro ao carregar anotação');

                const annotation = await response.json();
                currentAnnotation = annotation;

                // Atualizar modal com os dados
                const modalTitle = modalView.querySelector('.modal-header h2');
                const modalBody = modalView.querySelector('.modal-body');

                modalTitle.textContent = annotation.title || 'Sem título';

                // Preservar formatação original convertendo \n em <br> e parágrafos vazios
                const formattedContent = (annotation.content || 'Sem conteúdo')
                    .split('\n')
                    .map(line => line.trim() === '' ? '<br>' : `<p>${line}</p>`)
                    .join('');
                modalBody.innerHTML = formattedContent;

                // Abrir modal
                modalView.classList.remove('hidden');
            } catch (err) {
                console.error('Erro ao abrir anotação:', err);
                alert('Erro ao carregar anotação');
            }
        }

        // ============= NAVEGAÇÃO =============
        function openModal() {
            // Sempre abre em modo de visualização
            isEditMode = false;
            setViewMode();
            modalView.classList.remove('hidden');
        }

        function closeModal(event) {
            if (event && event.target === modalView) {
                modalView.classList.add('hidden');
                isEditMode = false;
            }
        }

        function setViewMode() {
            // Elementos do modo visualização
            const titleView = document.getElementById('modal-title-view');
            const titleEdit = document.getElementById('modal-title-edit');
            const bodyView = document.getElementById('modal-body-view');
            const bodyEdit = document.getElementById('modal-body-edit');
            const tagSelector = document.getElementById('modal-tag-selector');
            const leftBtn = document.getElementById('modal-left-btn');
            const rightBtn = document.getElementById('modal-right-btn');

            // Mostrar elementos de visualização
            titleView.classList.remove('hidden');
            bodyView.classList.remove('hidden');

            // Esconder elementos de edição
            titleEdit.classList.add('hidden');
            bodyEdit.classList.add('hidden');
            tagSelector.classList.add('hidden');

            // Configurar botões
            leftBtn.innerHTML = '<i class="ph ph-pencil-simple" style="font-size: 28px;"></i>';
            leftBtn.onclick = toggleEditMode;

            rightBtn.innerHTML = '<i class="ph ph-trash" style="font-size: 28px;"></i>';
            rightBtn.onclick = deleteAnnotation;
        }

        function setEditMode() {
            // Elementos do modo edição
            const titleView = document.getElementById('modal-title-view');
            const titleEdit = document.getElementById('modal-title-edit');
            const bodyView = document.getElementById('modal-body-view');
            const bodyEdit = document.getElementById('modal-body-edit');
            const tagSelector = document.getElementById('modal-tag-selector');
            const leftBtn = document.getElementById('modal-left-btn');
            const rightBtn = document.getElementById('modal-right-btn');

            // Copiar conteúdo para os campos de edição
            titleEdit.value = currentAnnotation.title || 'Sem título';
            bodyEdit.value = currentAnnotation.content || '';

            // Configurar tag selector
            const currentTag = (currentAnnotation.tags && currentAnnotation.tags[0]) || '';
            tagSelector.value = currentTag;

            // Esconder elementos de visualização
            titleView.classList.add('hidden');
            bodyView.classList.add('hidden');

            // Mostrar elementos de edição
            titleEdit.classList.remove('hidden');
            titleEdit.readOnly = true;
            titleEdit.style.cursor = 'pointer';
            bodyEdit.classList.remove('hidden');
            tagSelector.classList.remove('hidden');

            // Configurar botões
            leftBtn.innerHTML = '<i class="ph ph-arrow-left" style="font-size: 28px;"></i>';
            leftBtn.onclick = toggleEditMode;

            rightBtn.innerHTML = '<i class="ph ph-floppy-disk" style="font-size: 28px;"></i>';
            rightBtn.onclick = saveModalEdit;
        }

        function toggleEditMode() {
            if (isEditMode) {
                // Volta para modo visualização sem salvar
                isEditMode = false;
                setViewMode();
            } else {
                // Entra em modo de edição
                isEditMode = true;
                setEditMode();
            }
        }

        function enableModalTitleEdit() {
            if (!isEditMode) return;
            const titleEdit = document.getElementById('modal-title-edit');
            titleEdit.readOnly = false;
            titleEdit.style.cursor = 'text';
            titleEdit.focus();
            titleEdit.select();
        }

        async function saveModalEdit() {
            if (!currentAnnotation) return;

            try {
                const titleEdit = document.getElementById('modal-title-edit');
                const bodyEdit = document.getElementById('modal-body-edit');
                const tagSelector = document.getElementById('modal-tag-selector');

                const title = titleEdit.value.trim() || 'Sem título';
                const content = bodyEdit.value;
                const selectedTag = tagSelector.value;
                const tags = selectedTag ? [selectedTag] : [];

                const response = await fetch(`/api/anotacoes/${currentAnnotation.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        tags: tags
                    })
                });

                if (!response.ok) {
                    throw new Error('Erro ao salvar anotação');
                }

                // Atualizar currentAnnotation com os novos dados
                currentAnnotation.title = title;
                currentAnnotation.content = content;
                currentAnnotation.tags = tags;

                // Atualizar visualização
                const titleView = document.getElementById('modal-title-view');
                const bodyView = document.getElementById('modal-body-view');
                titleView.textContent = title;

                // Preservar formatação original
                const formattedContent = content
                    .split('\n')
                    .map(line => line.trim() === '' ? '<br>' : `<p>${line}</p>`)
                    .join('');
                bodyView.innerHTML = formattedContent;

                // Voltar para modo visualização
                isEditMode = false;
                setViewMode();

                // Recarregar anotações
                await loadAnnotations();
            } catch (err) {
                console.error('Erro ao salvar:', err);
                alert('Erro ao salvar anotação: ' + err.message);
            }
        }

        function openEditor() {
            if (!currentAnnotation) return;

            // Preencher editor
            const editorTitleInput = document.getElementById('editor-title-input');
            const editorTextarea = screenEditor.querySelector('.editor-content');

            editorTitleInput.value = currentAnnotation.title || 'Sem título';
            editorTitleInput.readOnly = true; // Começa readonly
            editorTitleInput.style.cursor = 'pointer';
            editorTextarea.value = currentAnnotation.content || '';

            // Configurar tag selector
            const tagSelector = document.getElementById('editor-tag-selector');
            const currentTag = (currentAnnotation.tags && currentAnnotation.tags[0]) || '';
            tagSelector.value = currentTag;

            // Esconder timer widget
            const timerWidget = document.getElementById('timer-widget');
            if (timerWidget) {
                timerWidget.style.display = 'none';
            }

            // Navegar para o editor
            modalView.classList.add('hidden');
            screenList.classList.add('hidden');
            screenEditor.classList.remove('hidden');
        }

        function enableTitleEdit() {
            const editorTitleInput = document.getElementById('editor-title-input');
            editorTitleInput.readOnly = false;
            editorTitleInput.style.cursor = 'text';
            editorTitleInput.focus();
            editorTitleInput.select();
        }

        function closeEditor() {
            // Mostrar timer widget novamente
            const timerWidget = document.getElementById('timer-widget');
            if (timerWidget) {
                timerWidget.style.display = '';
            }

            // Simplesmente volta sem salvar
            screenEditor.classList.add('hidden');
            screenList.classList.remove('hidden');
            openModal();
        }

        async function saveAndClose() {
            if (!currentAnnotation) return;

            try {
                const editorTitleInput = document.getElementById('editor-title-input');
                const editorTextarea = screenEditor.querySelector('.editor-content');
                const tagSelector = document.getElementById('editor-tag-selector');
                const title = editorTitleInput.value.trim() || 'Sem título';
                const content = editorTextarea.value;
                const selectedTag = tagSelector.value;
                const tags = selectedTag ? [selectedTag] : [];

                const response = await fetch(`/api/anotacoes/${currentAnnotation.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        tags: tags
                    })
                });

                if (!response.ok) {
                    throw new Error('Erro ao salvar anotação');
                }

                // Atualizar currentAnnotation com os novos dados
                currentAnnotation.title = title;
                currentAnnotation.content = content;

                // Mostrar timer widget novamente
                const timerWidget = document.getElementById('timer-widget');
                if (timerWidget) {
                    timerWidget.style.display = '';
                }

                screenEditor.classList.add('hidden');
                screenList.classList.remove('hidden');

                // Recarregar anotações
                await loadAnnotations();
            } catch (err) {
                console.error('Erro ao salvar:', err);
                alert('Erro ao salvar anotação: ' + err.message);
            }
        }

        async function deleteAnnotation() {
            if (!currentAnnotation) return;

            try {
                const response = await fetch(`/api/anotacoes/${currentAnnotation.id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Erro ao excluir anotação');
                }

                // Fechar modal
                modalView.classList.add('hidden');

                // Recarregar anotações
                await loadAnnotations();
            } catch (err) {
                console.error('Erro ao excluir:', err);
                alert('Erro ao excluir anotação: ' + err.message);
            }
        }

        async function createNewNote() {
            try {
                // Herdar tag do filtro atual, se houver
                const inheritedTags = currentFilter ? [currentFilter] : [];

                const response = await fetch('/api/anotacoes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: 'Nova Anotação',
                        content: '',
                        tags: inheritedTags
                    })
                });

                if (!response.ok) {
                    throw new Error('Erro ao criar anotação');
                }

                const newAnnotation = await response.json();
                currentAnnotation = newAnnotation;

                // Atualizar elementos do modal com a nova nota
                const titleView = document.getElementById('modal-title-view');
                const bodyView = document.getElementById('modal-body-view');
                titleView.textContent = 'Nova Anotação';
                bodyView.innerHTML = '';

                // Abrir modal em modo de edição
                isEditMode = true;
                setEditMode();
                modalView.classList.remove('hidden');

                // Focar no título para facilitar edição
                const titleEdit = document.getElementById('modal-title-edit');
                titleEdit.readOnly = false;
                titleEdit.style.cursor = 'text';
                titleEdit.focus();
                titleEdit.select();
            } catch (err) {
                console.error('Erro ao criar nota:', err);
                alert('Erro ao criar anotação: ' + err.message);
            }
        }


        // ============= CONFIGURAR FILTROS E TAGS =============
        function setupChips() {
            const chipsContainer = document.querySelector('.chips-scroller');
            chipsContainer.innerHTML = '';

            // Criar chip "Todas"
            const allChip = document.createElement('button');
            allChip.className = 'chip active';
            allChip.textContent = 'Todas';
            allChip.onclick = () => filterByTag(null, allChip);
            chipsContainer.appendChild(allChip);

            // Criar chips para cada categoria
            CATEGORIES.forEach(category => {
                const chip = document.createElement('button');
                chip.className = 'chip';
                chip.textContent = category;
                chip.onclick = () => filterByTag(category, chip);
                chipsContainer.appendChild(chip);
            });
        }

        function setupTagSelector() {
            // Tag selector do editor antigo (pode ser removido depois)
            const editorTagSelector = document.getElementById('editor-tag-selector');
            if (editorTagSelector) {
                editorTagSelector.innerHTML = '<option value="">Sem tag</option>';
                CATEGORIES.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    editorTagSelector.appendChild(option);
                });
            }

            // Tag selector do modal
            const modalTagSelector = document.getElementById('modal-tag-selector');
            if (modalTagSelector) {
                modalTagSelector.innerHTML = '<option value="">Sem tag</option>';
                CATEGORIES.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    modalTagSelector.appendChild(option);
                });
            }
        }

        // ============= INICIALIZAÇÃO =============
        window.addEventListener('DOMContentLoaded', () => {
            // Configurar busca
            searchInput.addEventListener('input', onSearchChange);

            // Configurar botão de atualizar
            refreshBtn.addEventListener('click', loadAnnotations);

            // Configurar Ordenação
            sortBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Impede que o listener de 'window' feche o menu imediatamente
                sortMenu.classList.toggle('hidden');
            });

            sortMenu.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    currentSort = e.target.dataset.sort;
                    sortMenu.classList.add('hidden');
                    renderAnnotations();
                }
            });

            // Fechar dropdown ao clicar fora
            window.addEventListener('click', () => {
                if (!sortMenu.classList.contains('hidden')) {
                    sortMenu.classList.add('hidden');
                }
            });

            // Configurar chips e tags
            setupChips();
            setupTagSelector();

            // Carregar anotações
            loadAnnotations();

            console.log('✅ App inicializado');
        });
    </script>
</body>
</html>