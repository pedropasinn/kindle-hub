<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bíblia Ave Maria - Kindle Hub</title>
    <link rel="stylesheet" href="style.css">
    <script src="timer.js"></script>
    <!-- Carrega versão embutida da Bíblia (prioridade para Kindle offline) -->
    <script src="biblias/bibliaAveMaria.js"></script>
    <style>
        .bible-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .bible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #000;
        }

        .bible-header h1 {
            font-size: 24px;
            margin: 0;
        }

        .back-link {
            padding: 8px 16px;
            background: #fff;
            border: 2px solid #000;
            text-decoration: none;
            color: #000;
            font-weight: bold;
            border-radius: 4px;
        }

        .back-link:hover {
            background: #f0f0f0;
        }

        /* Testament Toggle */
        .testament-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .testament-toggle button {
            flex: 1;
            padding: 12px;
            background: #fff;
            border: 3px solid #000;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .testament-toggle button.active {
            background: #000;
            color: #fff;
        }

        .testament-toggle button:hover:not(.active) {
            background: #f0f0f0;
        }

        /* Selectors */
        .selectors {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .selector-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .selector-group label {
            font-weight: bold;
            font-size: 13px;
            color: #333;
        }

        .selector-group select {
            padding: 10px;
            font-size: 14px;
            border: 3px solid #000;
            border-radius: 6px;
            background: #fff;
            cursor: pointer;
        }

        .selector-group select:focus {
            outline: none;
            border-color: #333;
        }

        /* Chapter Navigation - Grid Layout */
        .chapter-nav {
            display: grid;
            grid-template-columns: 48px 1fr 48px;  /* botão | título | botão */
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            padding: 10px 12px;
            background: #f8f8f8;
            border: 2px solid #000;
            border-radius: 8px;
        }

        .chapter-nav h2 {
            grid-column: 2;                  /* Coluna do meio */
            margin: 0;
            font-size: 18px;
            text-align: center;
            min-height: 42px;                /* Mesma altura do botão */
            display: flex;
            align-items: center;             /* Centro vertical */
            justify-content: center;         /* Centro horizontal */
            line-height: 1.2;
        }

        .nav-btn {
            box-sizing: border-box;
            width: 48px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            background: #fff;
            border: 3px solid #000;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #btnPrev {
            grid-column: 1;                  /* Primeira coluna */
        }

        #btnNext {
            grid-column: 3;                  /* Terceira coluna */
        }

        .nav-btn:hover:not(:disabled) {
            background: #f0f0f0;
            transform: translateY(-2px);
        }

        .nav-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Para telas pequenas (Kindle) */
        @media (max-width: 650px) {
            .chapter-nav {
                grid-template-columns: 42px 1fr 42px;  /* Botões menores */
                padding: 8px 10px;
                gap: 8px;
            }

            .nav-btn {
                width: 42px;
                height: 38px;
                font-size: 14px;
            }

            .chapter-nav h2 {
                font-size: 16px;
                min-height: 38px;            /* Mesma altura dos botões no Kindle */
            }
        }

        /* Verse Container */
        .verse-container {
            background: #fff;
            padding: 20px;
            border: 2px solid #000;
            border-radius: 8px;
            line-height: 1.8;
            font-size: 18px;
        }

        .verse {
            margin-bottom: 15px;
            text-align: justify;
        }

        .verse-number {
            font-weight: bold;
            color: #000;
            margin-right: 8px;
            font-size: 14px;
            vertical-align: super;
            font-size: 12px;
        }

        .verse-text {
            color: #000;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 60px;
            font-size: 18px;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #d00;
            font-weight: bold;
            background: #fee;
            border: 2px solid #d00;
            border-radius: 8px;
            margin: 20px 0;
        }

        /* Botão Voltar ao Topo */
        #btnVoltarTopo {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: #000;
            color: #fff;
            border: 3px solid #000;
            border-radius: 50%;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease, background 0.2s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #btnVoltarTopo.visivel {
            opacity: 1;
            visibility: visible;
        }

        #btnVoltarTopo:hover {
            background: #333;
            transform: scale(1.1);
        }

        #btnVoltarTopo:active {
            transform: scale(0.95);
        }

        /* Responsive */
        @media (max-width: 600px) {
            .selectors {
                grid-template-columns: 1fr;
            }

            .chapter-nav {
                flex-direction: column;
                gap: 15px;
            }

            .nav-btn {
                width: 100%;
            }

            .chapter-nav h2 {
                order: -1;
            }

            #btnVoltarTopo {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="bible-container">
        <!-- Header -->
        <div class="bible-header">
            <a href="plano-inclinado.html" class="back-link">Voltar</a>
            <h1>Bíblia Ave Maria</h1>
            <div style="width: 100px;"></div> <!-- Spacer for centering -->
        </div>

        <!-- Testament Toggle -->
        <div class="testament-toggle">
            <button id="btnAntigoTestamento" class="active" onclick="switchTestament('antigoTestamento')">
                Antigo Testamento
            </button>
            <button id="btnNovoTestamento" onclick="switchTestament('novoTestamento')">
                Novo Testamento
            </button>
        </div>

        <!-- Selectors -->
        <div class="selectors">
            <div class="selector-group">
                <label for="bookSelect">Livro:</label>
                <select id="bookSelect" onchange="onBookChange()">
                    <option value="">Carregando...</option>
                </select>
            </div>
            <div class="selector-group">
                <label for="chapterSelect">Capítulo:</label>
                <select id="chapterSelect" onchange="onChapterChange()">
                    <option value="">-</option>
                </select>
            </div>
        </div>

        <!-- Chapter Navigation -->
        <div class="chapter-nav">
            <button id="btnPrev" class="nav-btn" onclick="goToPreviousChapter()"> ◄ </button>
            <h2 id="chapterTitle">-</h2>
            <button id="btnNext" class="nav-btn" onclick="goToNextChapter()"> ► </button>
        </div>

        <!-- Verse Container -->
        <div id="verseContainer" class="verse-container">
            <div class="loading">Carregando Bíblia...</div>
        </div>
    </div>

    <!-- Botão Voltar ao Topo -->
    <button id="btnVoltarTopo" title="Voltar ao topo">↑</button>

    <script>
        // ========== ESTADO GLOBAL ==========
        var bibliaData = null;
        var currentTestament = 'antigoTestamento';
        var currentBookIndex = 0;
        var currentChapter = 1;

        // ========== INICIALIZAÇÃO ==========

        /**
         * Carrega o JSON da Bíblia (híbrido: embutido prioritário + XHR robusto como fallback)
         * Otimizado para Kindle com WebKit antigo
         */
        function loadBibleData() {
            // PRIORIDADE 1: Tenta usar versão embutida (100% offline, sem XHR)
            if (window.BIBLIA_AVE_MARIA) {
                console.log('Usando versão embutida da Bíblia (modo offline)');
                bibliaData = window.BIBLIA_AVE_MARIA;
                populateBookDropdown();
                renderChapter();
                return;
            }

            // FALLBACK: XHR robusto com tratamento para Kindle
            console.log('Versão embutida não encontrada. Tentando XHR...');

            var xhr = new XMLHttpRequest();
            // Caminho relativo (sem barra inicial) para compatibilidade file://
            xhr.open('GET', 'biblias/bibliaAveMaria.json?v=1', true);

            // Força MIME type correto (importante para Kindles antigos)
            if (xhr.overrideMimeType) {
                xhr.overrideMimeType('application/json');
            }

            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    // Sucesso HTTP normal (200-299)
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            bibliaData = JSON.parse(xhr.responseText);
                            populateBookDropdown();
                            renderChapter();
                            console.log('Bíblia carregada via XHR (HTTP)');
                        } catch (e) {
                            console.error('JSON inválido:', e);
                            document.getElementById('verseContainer').innerHTML =
                                '<div class="error">Erro ao processar dados da Bíblia.</div>';
                        }
                        return;
                    }

                    // IMPORTANTE: Kindle em file:// retorna status 0 mesmo com conteúdo válido
                    if (xhr.status === 0 && xhr.responseText) {
                        try {
                            bibliaData = JSON.parse(xhr.responseText);
                            populateBookDropdown();
                            renderChapter();
                            console.log('Bíblia carregada via XHR (file://)');
                            return;
                        } catch (e2) {
                            console.error('JSON inválido (status 0):', e2);
                        }
                    }

                    // Erro real
                    console.error('Falha ao carregar JSON. Status:', xhr.status);
                    document.getElementById('verseContainer').innerHTML =
                        '<div class="error">Erro ao carregar a Bíblia. Por favor, recarregue a página.<br>Dica: Verifique se a pasta "biblias" está no mesmo local do arquivo HTML.</div>';
                }
            };

            xhr.onerror = function() {
                console.error('Erro de rede/XHR');
                document.getElementById('verseContainer').innerHTML =
                    '<div class="error">Erro de conexão ao carregar a Bíblia.<br>Certifique-se de que o arquivo bibliaAveMaria.js foi carregado.</div>';
            };

            try {
                xhr.send(null);
            } catch (sendErr) {
                console.error('Send falhou:', sendErr);
                document.getElementById('verseContainer').innerHTML =
                    '<div class="error">Não foi possível iniciar a leitura do arquivo.<br>Use a versão embutida (bibliaAveMaria.js).</div>';
            }
        }

        // ========== SELETORES ==========

        /**
         * Popula dropdown de livros baseado no testamento atual
         */
        function populateBookDropdown() {
            if (!bibliaData) return;

            var books = bibliaData[currentTestament];
            var select = document.getElementById('bookSelect');
            var i, option;

            select.innerHTML = '';
            for (i = 0; i < books.length; i++) {
                option = document.createElement('option');
                option.value = i;
                option.textContent = books[i].nome;
                select.appendChild(option);
            }

            select.value = currentBookIndex;
            populateChapterDropdown();
        }

        /**
         * Popula dropdown de capítulos baseado no livro atual
         */
        function populateChapterDropdown() {
            if (!bibliaData) return;

            var book = bibliaData[currentTestament][currentBookIndex];
            var select = document.getElementById('chapterSelect');
            var i, cap, option;

            select.innerHTML = '';
            for (i = 0; i < book.capitulos.length; i++) {
                cap = book.capitulos[i];
                option = document.createElement('option');
                option.value = cap.capitulo;
                option.textContent = cap.capitulo;
                select.appendChild(option);
            }

            select.value = currentChapter;
        }

        /**
         * Troca entre Antigo e Novo Testamento
         */
        function switchTestament(testament) {
            currentTestament = testament;
            currentBookIndex = 0;
            currentChapter = 1;

            // Atualiza botões
            document.getElementById('btnAntigoTestamento').classList.toggle('active', testament === 'antigoTestamento');
            document.getElementById('btnNovoTestamento').classList.toggle('active', testament === 'novoTestamento');

            // Atualiza interface
            populateBookDropdown();
            renderChapter();
        }

        /**
         * Quando usuário seleciona um livro diferente
         */
        function onBookChange() {
            var select = document.getElementById('bookSelect');
            currentBookIndex = parseInt(select.value);
            currentChapter = 1;

            populateChapterDropdown();
            renderChapter();
        }

        /**
         * Quando usuário seleciona um capítulo diferente
         */
        function onChapterChange() {
            var select = document.getElementById('chapterSelect');
            currentChapter = parseInt(select.value);
            renderChapter();
        }

        // ========== NAVEGAÇÃO ==========

        /**
         * Vai para capítulo anterior
         */
        function goToPreviousChapter() {
            if (!bibliaData) return;

            var book = bibliaData[currentTestament][currentBookIndex];
            var prevBook;

            if (currentChapter > 1) {
                currentChapter--;
            } else if (currentBookIndex > 0) {
                // Vai para o último capítulo do livro anterior
                currentBookIndex--;
                prevBook = bibliaData[currentTestament][currentBookIndex];
                currentChapter = prevBook.capitulos.length;
                populateBookDropdown();
            } else {
                // Já está no primeiro capítulo do primeiro livro
                return;
            }

            document.getElementById('chapterSelect').value = currentChapter;
            renderChapter();
        }

        /**
         * Vai para próximo capítulo
         */
        function goToNextChapter() {
            if (!bibliaData) return;

            var book = bibliaData[currentTestament][currentBookIndex];
            var maxChapters = book.capitulos.length;

            if (currentChapter < maxChapters) {
                currentChapter++;
            } else if (currentBookIndex < bibliaData[currentTestament].length - 1) {
                // Vai para o primeiro capítulo do próximo livro
                currentBookIndex++;
                currentChapter = 1;
                populateBookDropdown();
            } else {
                // Já está no último capítulo do último livro
                return;
            }

            document.getElementById('chapterSelect').value = currentChapter;
            renderChapter();
        }

        /**
         * Atualiza estado dos botões de navegação
         */
        function updateNavigationButtons() {
            if (!bibliaData) return;

            var book = bibliaData[currentTestament][currentBookIndex];
            var maxChapters = book.capitulos.length;
            var isFirstBook = currentBookIndex === 0;
            var isLastBook = currentBookIndex === bibliaData[currentTestament].length - 1;
            var btnPrev, btnNext;

            // Botão Anterior
            btnPrev = document.getElementById('btnPrev');
            btnPrev.disabled = (currentChapter === 1 && isFirstBook);

            // Botão Próximo
            btnNext = document.getElementById('btnNext');
            btnNext.disabled = (currentChapter === maxChapters && isLastBook);
        }

        // ========== RENDERIZAÇÃO ==========

        /**
         * Renderiza o capítulo atual
         */
        function renderChapter() {
            if (!bibliaData) return;

            var book = bibliaData[currentTestament][currentBookIndex];
            var chapter = null;
            var i, verse;
            var container, html;

            // Buscar capítulo manualmente (compatível com ES5)
            for (i = 0; i < book.capitulos.length; i++) {
                if (book.capitulos[i].capitulo === currentChapter) {
                    chapter = book.capitulos[i];
                    break;
                }
            }

            if (!chapter) {
                console.error('Capítulo não encontrado:', currentChapter);
                return;
            }

            // Atualiza título (sem template literals)
            document.getElementById('chapterTitle').textContent =
                book.nome + ' ' + currentChapter;

            // Renderiza versículos
            container = document.getElementById('verseContainer');
            html = '';

            for (i = 0; i < chapter.versiculos.length; i++) {
                verse = chapter.versiculos[i];
                html += '<div class="verse">';
                html += '<span class="verse-number">' + verse.versiculo + '</span>';
                html += '<span class="verse-text">' + verse.texto + '</span>';
                html += '</div>';
            }

            container.innerHTML = html;

            // Atualiza botões de navegação
            updateNavigationButtons();

            // Scroll para o topo (compatível com navegadores antigos)
            window.scrollTo(0, 0);
        }

        // ========== BOTÃO VOLTAR AO TOPO ==========

        /**
         * Controla visibilidade do botão baseado no scroll
         */
        function handleScrollButton() {
            var btnVoltarTopo = document.getElementById('btnVoltarTopo');
            var scrollPosition = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;

            if (scrollPosition > 300) {
                if (btnVoltarTopo.className.indexOf('visivel') === -1) {
                    btnVoltarTopo.className += ' visivel';
                }
            } else {
                btnVoltarTopo.className = btnVoltarTopo.className.replace(' visivel', '').replace('visivel', '');
            }
        }

        /**
         * Scroll suave para o topo (compatível com Kindle)
         */
        function scrollToTop() {
            var currentPosition = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;

            if (currentPosition > 0) {
                window.scrollTo(0, 0);
            }
        }

        // ========== INICIALIZAÇÃO ==========

        /**
         * Inicializa eventos da página
         */
        function initPage() {
            var btnVoltarTopo = document.getElementById('btnVoltarTopo');

            // Event listener para scroll
            if (window.addEventListener) {
                window.addEventListener('scroll', handleScrollButton);
            } else if (window.attachEvent) {
                window.attachEvent('onscroll', handleScrollButton);
            }

            // Event listener para botão voltar ao topo
            if (btnVoltarTopo) {
                if (btnVoltarTopo.addEventListener) {
                    btnVoltarTopo.addEventListener('click', scrollToTop);
                } else if (btnVoltarTopo.attachEvent) {
                    btnVoltarTopo.attachEvent('onclick', scrollToTop);
                }
            }

            // Carrega dados da Bíblia
            loadBibleData();
        }

        // Carrega Bíblia quando página carrega
        if (document.addEventListener) {
            document.addEventListener('DOMContentLoaded', initPage);
        } else if (document.attachEvent) {
            document.attachEvent('onreadystatechange', function() {
                if (document.readyState === 'complete') {
                    initPage();
                }
            });
        } else {
            window.onload = initPage;
        }
    </script>
</body>
</html>
