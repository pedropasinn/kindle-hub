<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-3">
  <title>Calend√°rio ‚Äì Vers√£o Kindle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{font-family:Arial, sans-serif;background:#fff;color:#000;overflow:hidden}

    /* vari√°veis din√¢micas */
    :root{ 
      --relogio-percent: 70; 
      --eventos-percent: 30;
    }

    .viewport{
      position:relative;
      width:100vw; height:100vh;
      display:flex; flex-direction:row;
      transform-origin:left top;
    }
    .viewport.rotated{
      transform:rotate(90deg) translateY(-100%);
      width:100vh; height:100vw;
    }

    /* Propor√ß√£o din√¢mica via vari√°veis CSS */
    .secao-relogio{
      position:relative;
      flex:0 0 calc(var(--relogio-percent) * 1%);
      min-width:0;
      display:flex;
      flex-direction:column;
      border-right:2px solid #000;
      background:#f8f8f8;
    }
    .secao-eventos{
      flex:0 0 calc(var(--eventos-percent) * 1%); 
      min-width:0; 
      display:flex; 
      flex-direction:column;
      background:#fff;
    }

    /* Painel de Controles - ancorado na se√ß√£o do rel√≥gio */
    .painel-controles{
      position:absolute;
      top:10px;
      left:10px;
      background:rgba(255,255,255,0.98);
      border:2px solid #000;
      border-radius:8px;
      padding:12px;
      box-shadow:0 4px 16px rgba(0,0,0,0.3);
      z-index:1000;
      max-width:340px;
      transition:all 0.3s ease;
    }
    .painel-controles.minimizado{
      max-width:80px;
    }
    .painel-controles.minimizado .conteudo-controles{
      display:none;
    }
    .btn-toggle{
      background:#333;
      color:#fff;
      border:none;
      padding:8px 14px;
      cursor:pointer;
      border-radius:5px;
      font-size:14px;
      font-weight:bold;
      width:100%;
      margin-bottom:10px;
    }
    .painel-controles.minimizado .btn-toggle{
      margin-bottom:0;
    }
    .conteudo-controles{
      display:block;
    }
    .grupo-controle{
      margin-bottom:12px;
    }
    .label-controle{
      display:block;
      font-size:11px;
      font-weight:bold;
      margin-bottom:4px;
      color:#333;
    }
    .slider-controle{
      width:100%;
      height:24px;
      cursor:pointer;
    }
    .valor-controle{
      display:inline-block;
      font-weight:bold;
      color:#000;
      font-size:12px;
      margin-left:6px;
    }
    .botoes-dia{
      display:flex;
      gap:4px;
    }
    .btn-dia{
      flex:1;
      padding:6px 4px;
      background:#f0f0f0;
      border:2px solid #999;
      border-radius:4px;
      cursor:pointer;
      font-size:11px;
      font-weight:bold;
      text-align:center;
    }
    .btn-dia.ativo{
      background:#333;
      color:#fff;
      border-color:#000;
    }
    .btn-girar{
      width:100%;
      padding:6px;
      background:#fff;
      border:2px solid #333;
      border-radius:4px;
      cursor:pointer;
      font-size:11px;
      font-weight:bold;
    }
    .checkbox-container{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 0;
    }
    .checkbox-container input[type="checkbox"]{
      width:18px;
      height:18px;
      cursor:pointer;
    }
    .checkbox-container label{
      cursor:pointer;
      font-size:12px;
      font-weight:bold;
      flex:1;
    }

    /* Quando eventos est√° oculto - toda a se√ß√£o desaparece */
    .secao-eventos.oculto{
      display:none !important;
    }

    /* Quando eventos est√° oculto, rel√≥gio ocupa 100% */
    .secao-relogio.expandido{
      flex:1 1 100% !important;
      border-right:none !important;
    }

    /* Rel√≥gio central */
    .relogio-wrap{
      flex:1; 
      display:flex; 
      flex-direction:column; 
      justify-content:center; 
      align-items:center;
      padding:20px;
    }
    .relogio{
      font-family:"Courier New", monospace;
      font-weight:bold;
      /* tamanho fixo em pixels - igual ao index.html */
      font-size:120px;
      line-height:1;
      margin-bottom:12px;
      text-align:center;
      color:#000;
    }
    .data{
      font-size:24px;
      margin-bottom:6px;
      text-align:center;
      color:#333;
    }
    .semana{
      font-size:20px;
      color:#666;
      text-align:center;
    }

    /* Eventos com rolagem */
    .topo-eventos{
      display:flex; 
      align-items:center; 
      justify-content:center; 
      padding:8px; 
      border-bottom:2px solid #000;
      background:#fff;
    }
    .titulo{
      font-size:24px;
      font-weight:bold;
      text-align:center;
    }
    .lista{
      flex:1; 
      overflow-y:auto; 
      overflow-x:hidden;
      padding:8px; 
      display:flex; 
      flex-direction:column; 
      gap:6px;
    }
    .evento{
      border-left:4px solid #999;
      padding:12px;
      background:#f5f5f5;
      font-size:18px;
      border-radius:4px;
    }
    .evento .t{
      font-weight:bold;
      margin-bottom:4px;
      font-size:20px;
    }
    .evento .h{
      color:#555;
      font-size:16px;
    }
    .evento.atual{
      background:#fff9e6; 
      border-left-color:#000; 
      font-weight:bold;
      box-shadow:0 0 8px rgba(200,160,0,0.3);
    }
    .evento.passado{
      opacity:0.5; 
      background:#e8e8e8;
    }
    .sem{
      color:#777;
      text-align:center;
      padding:20px;
      font-size:18px;
    }

    /* Esconde scrollbar mas mant√©m funcionalidade */
    .lista::-webkit-scrollbar{
      width:8px;
    }
    .lista::-webkit-scrollbar-track{
      background:#f0f0f0;
    }
    .lista::-webkit-scrollbar-thumb{
      background:#ccc;
      border-radius:4px;
    }

    /* Contador de Pr√≥ximo Evento */
    .contador-evento{
      margin:20px;
      background:#fff;
      border:3px solid #000;
      border-radius:8px;
      padding:16px;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
    }
    .contador-titulo{
      font-size:18px;
      font-weight:bold;
      margin-bottom:8px;
      color:#000;
      text-align:center;
    }
    .contador-tempo{
      font-size:32px;
      font-weight:bold;
      color:#000;
      text-align:center;
      font-family:"Courier New", monospace;
      margin-bottom:4px;
    }
    .contador-label{
      font-size:14px;
      color:#666;
      text-align:center;
    }
    .contador-evento.atual{
      background:#fff9e6;
      border-color:#ffd700;
    }
    .contador-evento.proximo{
      background:#f0f8ff;
      border-color:#4682b4;
    }
  </style>
</head>
<body>
  <div id="vp" class="viewport rotated">
    <!-- LADO ESQUERDO: REL√ìGIO -->
    <section class="secao-relogio">
      <!-- Painel de Menu Principal (Hub + Config) -->
      <div id="painelMenu" class="painel-controles minimizado" style="max-width: 400px;">
        <button class="btn-toggle" onclick="toggleMenu()">‚ãÆ</button>
        <div class="conteudo-controles">
          <!-- Hub: Atalhos -->
          <details open>
            <summary style="cursor: pointer; font-weight: bold; padding: 8px; background: #f0f0f0; border-radius: 4px; margin-bottom: 10px;">Hub</summary>
            <div style="padding: 10px; display: flex; flex-direction: column; gap: 8px;">
              <a href="agenda.html" style="padding: 10px; background: #fff; border: 2px solid #000; text-decoration: none; color: #000; font-weight: bold; text-align: center; border-radius: 4px;">Agenda</a>
              <a href="plano-inclinado.html" style="padding: 10px; background: #fff; border: 2px solid #000; text-decoration: none; color: #000; font-weight: bold; text-align: center; border-radius: 4px;">Plano de Vida</a>
            </div>
          </details>

          <!-- Configura√ß√µes -->
          <details>
            <summary style="cursor: pointer; font-weight: bold; padding: 8px; background: #f0f0f0; border-radius: 4px; margin-bottom: 10px;">Config.</summary>
            <div style="padding: 10px;">
          <div class="grupo-controle">
            <label class="label-controle">
              Tamanho do Rel√≥gio
              <span class="valor-controle" id="valorTamanho">120px</span>
            </label>
            <input
              type="range"
              class="slider-controle"
              id="sliderTamanho"
              min="60"
              max="200"
              value="120"
              step="10"
              oninput="ajustarTamanho(this.value)">
          </div>

          <div class="grupo-controle">
            <label class="label-controle">
              Propor√ß√£o Rel√≥gio/Eventos
              <span class="valor-controle" id="valorProporcao">70/30</span>
            </label>
            <input
              type="range"
              class="slider-controle"
              id="sliderProporcao"
              min="40"
              max="85"
              value="70"
              step="5"
              oninput="ajustarProporcao(this.value)">
          </div>

          <div class="grupo-controle">
            <label class="label-controle">Selecionar Dia</label>
            <div class="botoes-dia">
              <button class="btn-dia" id="btnOntem" onclick="irParaDia(-1)">Ontem</button>
              <button class="btn-dia ativo" id="btnHoje" onclick="irParaDia(0)">Hoje</button>
              <button class="btn-dia" id="btnAmanha" onclick="irParaDia(1)">Amanh√£</button>
            </div>
          </div>

          <div class="grupo-controle">
            <button class="btn-girar" id="btnRot" onclick="girarTela()">üîÑ Girar 90¬∞</button>
          </div>

          <div class="grupo-controle">
            <div class="checkbox-container">
              <input type="checkbox" id="checkMostrarEventos" checked onchange="toggleEventos()">
              <label for="checkMostrarEventos">Mostrar Eventos</label>
            </div>
          </div>
            </div>
          </details>
        </div>
      </div>

      <div class="relogio-wrap">
        <div id="relogio" class="relogio">00:00</div>
        <div id="data" class="data">‚Äì</div>
        <div id="semana" class="semana">‚Äì</div>
      </div>

      <!-- Contador de Pr√≥ximo Evento -->
      <div id="contadorEvento" class="contador-evento">
        <div class="contador-titulo" id="contadorTitulo">‚Äî</div>
        <div class="contador-tempo" id="contadorTempo">‚Äî</div>
        <div class="contador-label" id="contadorLabel">‚Äî</div>
      </div>
    </section>

    <!-- LADO DIREITO: EVENTOS -->
    <section class="secao-eventos">
      <div class="topo-eventos"><div id="titulo" class="titulo">Eventos</div></div>
      <div id="lista" class="lista"><div class="sem">Carregando‚Ä¶</div></div>
    </section>
  </div>

  <script>
  // ====== CONFIG ======
  var TIME_OFFSET_MINUTES = -180; // -3h (ajuste conforme seu fuso)
  
  // Eventos do Google Calendar
  var eventosData = {};
  var allGoogleEvents = [];

  // Carregar eventos do Google Calendar
  async function carregarEventos() {
    try {
      const response = await fetch(window.location.origin + '/api/calendar/events?days=14');
      if (response.ok) {
        allGoogleEvents = await response.json();
        // Converter formato Google para formato dashboard
        eventosData = {};
        allGoogleEvents.forEach(event => {
          const start = new Date(event.start.dateTime || event.start.date);
          start.setHours(start.getHours() - 3); // Ajustar timezone
          const end = event.end.dateTime ? new Date(event.end.dateTime) : start;
          end.setHours(end.getHours() - 3); // Ajustar timezone

          const dataKey = ymd(start);
          if (!eventosData[dataKey]) {
            eventosData[dataKey] = [];
          }

          eventosData[dataKey].push({
            titulo: event.summary || 'Sem t√≠tulo',
            inicio: ('0' + start.getHours()).slice(-2) + ':' + ('0' + start.getMinutes()).slice(-2),
            fim: ('0' + end.getHours()).slice(-2) + ':' + ('0' + end.getMinutes()).slice(-2)
          });
        });
        atualizar();
      }
    } catch (error) {
      console.error('Erro ao carregar eventos:', error);
    }
  }

  // ====== FUN√á√ïES AUXILIARES ======
  function agoraCorrigido(){ 
    var d = new Date(); 
    return new Date(d.getTime() + TIME_OFFSET_MINUTES * 60000); 
  }
  
  function ymd(d){
    var a = d.getFullYear();
    var m = ('0' + (d.getMonth() + 1)).slice(-2);
    var dia = ('0' + d.getDate()).slice(-2);
    return a + '-' + m + '-' + dia;
  }
  
  function minutos(hhmm){
    var p = hhmm.split(':');
    var h = parseInt(p[0], 10) || 0;
    var m = parseInt(p[1], 10) || 0;
    return h * 60 + m;
  }
  
  var meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
  var dias = ['Domingo','Segunda-feira','Ter√ßa-feira','Quarta-feira','Quinta-feira','Sexta-feira','S√°bado'];
  
  var dataSel = agoraCorrigido();
  var offsetDia = 0; // -1=ontem, 0=hoje, 1=amanh√£

  // ====== CONTROLES ======
  function toggleMenu(){
    var painel = document.getElementById('painelMenu');

    if(painel.className.indexOf('minimizado') >= 0){
      // Expandir
      painel.className = 'painel-controles';
      localStorage.setItem('menuAberto', 'true');
    } else {
      // Minimizar
      painel.className = 'painel-controles minimizado';
      localStorage.setItem('menuAberto', 'false');
    }
  }

  function ajustarTamanho(valor){
    var tamanho = parseInt(valor);
    document.getElementById('relogio').style.fontSize = tamanho + 'px';
    document.getElementById('valorTamanho').textContent = tamanho + 'px';

    // Salvar prefer√™ncia
    localStorage.setItem('tamanhoRelogio', valor);
  }

  function ajustarProporcao(valor){
    var relogioPercent = parseInt(valor);
    var eventosPercent = 100 - relogioPercent;

    document.documentElement.style.setProperty('--relogio-percent', relogioPercent);
    document.documentElement.style.setProperty('--eventos-percent', eventosPercent);

    document.getElementById('valorProporcao').textContent = relogioPercent + '/' + eventosPercent;

    // Salvar prefer√™ncia
    localStorage.setItem('proporcao', valor);
  }

  function irParaDia(offset){
    offsetDia = offset;
    var agora = agoraCorrigido();
    dataSel = new Date(agora.getTime() + (offset * 86400000));
    
    // Atualizar bot√µes ativos
    document.getElementById('btnOntem').className = 'btn-dia' + (offset === -1 ? ' ativo' : '');
    document.getElementById('btnHoje').className = 'btn-dia' + (offset === 0 ? ' ativo' : '');
    document.getElementById('btnAmanha').className = 'btn-dia' + (offset === 1 ? ' ativo' : '');
    
    atualizar();
  }

  function girarTela(){
    var vp = document.getElementById('vp');

    if(vp.className.indexOf('rotated') >= 0){
      vp.className = 'viewport';
    } else {
      vp.className = 'viewport rotated';
    }

    // Salvar prefer√™ncia
    localStorage.setItem('rotacao', vp.className);
  }

  function toggleEventos(){
    var checkbox = document.getElementById('checkMostrarEventos');
    var secaoEventos = document.querySelector('.secao-eventos');
    var secaoRelogio = document.querySelector('.secao-relogio');

    if(checkbox.checked){
      // Mostrar eventos - rel√≥gio menor (130px)
      secaoEventos.classList.remove('oculto');
      secaoRelogio.classList.remove('expandido');
      ajustarTamanho(130);
      document.getElementById('sliderTamanho').value = 130;
    } else {
      // Ocultar eventos - rel√≥gio maior (200px)
      secaoEventos.classList.add('oculto');
      secaoRelogio.classList.add('expandido');
      ajustarTamanho(200);
      document.getElementById('sliderTamanho').value = 200;
    }

    // Salvar prefer√™ncia
    localStorage.setItem('mostrarEventos', checkbox.checked);
  }

  // ====== DESENHAR INTERFACE ======
  function desenharHorario(){
    var n = agoraCorrigido();
    var h = ('0' + n.getHours()).slice(-2);
    var m = ('0' + n.getMinutes()).slice(-2);
    
    document.getElementById('relogio').innerHTML = h + ':' + m;
    document.getElementById('data').innerHTML = n.getDate() + ' de ' + meses[n.getMonth()];
    document.getElementById('semana').innerHTML = dias[n.getDay()];
  }

  function estadoEvento(evt, baseDate){
    var n = agoraCorrigido();
    var isHoje = ymd(n) === ymd(baseDate);
    
    if(!isHoje){
      return baseDate < n ? 'passado' : 'futuro';
    }
    
    var t = n.getHours() * 60 + n.getMinutes();
    var i = minutos(evt.inicio);
    var f = minutos(evt.fim);
    
    if(t < i) return 'futuro';
    if(t >= i && t < f) return 'atual';
    return 'passado';
  }

  function desenharEventos(){
    var key = ymd(dataSel);
    var evts = eventosData[key] || [];
    
    var n = agoraCorrigido();
    var hj = ymd(n);
    var ont = new Date(n.getTime() - 86400000);
    var am = new Date(n.getTime() + 86400000);
    
    var titulo = 'Eventos de ';
    if(key === hj){
      titulo += 'Hoje';
    } else if(key === ymd(ont)){
      titulo += 'Ontem';
    } else if(key === ymd(am)){
      titulo += 'Amanh√£';
    } else {
      titulo += dataSel.getDate() + ' de ' + meses[dataSel.getMonth()];
    }
    
    document.getElementById('titulo').innerHTML = titulo;
    
    var lista = document.getElementById('lista');
    if(!evts.length){
      lista.innerHTML = '<div class="sem">Nenhum evento para este dia</div>';
      return;
    }
    
    var html = '';
    for(var i = 0; i < evts.length; i++){
      var e = evts[i];
      var st = estadoEvento(e, dataSel);
      html += '<div class="evento ' + st + '">';
      html += '<div class="t">' + e.titulo + '</div>';
      html += '<div class="h">' + e.inicio + ' ‚Äì ' + e.fim + '</div>';
      html += '</div>';
    }
    lista.innerHTML = html;
  }

  function atualizarContador(){
    var key = ymd(dataSel);
    var evts = eventosData[key] || [];
    var n = agoraCorrigido();
    var hj = ymd(n);

    // Filtrar eventos que n√£o t√™m estrela
    var eventosValidos = [];
    for(var i = 0; i < evts.length; i++){
      if(evts[i].titulo.indexOf('‚≠ê') === -1){
        eventosValidos.push(evts[i]);
      }
    }

    // S√≥ mostrar contador para hoje
    var contador = document.getElementById('contadorEvento');
    if(key !== hj || eventosValidos.length === 0){
      contador.style.display = 'none';
      return;
    }

    contador.style.display = 'block';
    var agora = n.getHours() * 60 + n.getMinutes();
    var eventoAtual = null;
    var proximoEvento = null;

    // Procurar evento atual ou pr√≥ximo (ignorando eventos com estrela)
    for(var i = 0; i < eventosValidos.length; i++){
      var e = eventosValidos[i];
      var inicio = minutos(e.inicio);
      var fim = minutos(e.fim);

      if(agora >= inicio && agora < fim){
        eventoAtual = e;
        break;
      }

      if(agora < inicio && !proximoEvento){
        proximoEvento = e;
      }
    }

    var titulo = document.getElementById('contadorTitulo');
    var tempo = document.getElementById('contadorTempo');
    var label = document.getElementById('contadorLabel');

    if(eventoAtual){
      // Evento acontecendo agora
      contador.className = 'contador-evento atual';
      titulo.textContent = eventoAtual.titulo;

      var fimMin = minutos(eventoAtual.fim);
      var diff = fimMin - agora;

      if(diff <= 0){
        tempo.textContent = 'Terminando...';
        label.textContent = '';
      } else {
        var horas = Math.floor(diff / 60);
        var mins = diff % 60;

        if(horas > 0){
          tempo.textContent = horas + 'h ' + mins + 'min';
        } else {
          tempo.textContent = mins + ' min';
        }
        label.textContent = 'para terminar';
      }
    } else if(proximoEvento){
      // Pr√≥ximo evento
      contador.className = 'contador-evento proximo';
      titulo.textContent = proximoEvento.titulo;

      var inicioMin = minutos(proximoEvento.inicio);
      var diff = inicioMin - agora;

      if(diff <= 0){
        tempo.textContent = 'Come√ßando...';
        label.textContent = '';
      } else {
        var horas = Math.floor(diff / 60);
        var mins = diff % 60;

        if(horas > 0){
          tempo.textContent = horas + 'h ' + mins + 'min';
        } else {
          tempo.textContent = mins + ' min';
        }
        label.textContent = 'para come√ßar';
      }
    } else {
      // Todos os eventos j√° passaram
      contador.style.display = 'none';
    }
  }

  function atualizar(){
    desenharHorario();
    desenharEventos();
    atualizarContador();
  }

  // ====== CARREGAR PREFER√äNCIAS ======
  function carregarPreferencias(){
    // Carregar rota√ß√£o salva da viewport
    var rotSalva = localStorage.getItem('rotacao');
    if(rotSalva){
      document.getElementById('vp').className = rotSalva;
    }

    // Carregar estado do menu
    var menuAberto = localStorage.getItem('menuAberto');
    if(menuAberto === 'true'){
      document.getElementById('painelMenu').className = 'painel-controles';
    }

    // Carregar propor√ß√£o salva
    var propSalva = localStorage.getItem('proporcao');
    if(propSalva){
      document.getElementById('sliderProporcao').value = propSalva;
      ajustarProporcao(propSalva);
    }

    // Carregar estado de mostrar eventos
    var mostrarEventos = localStorage.getItem('mostrarEventos');
    if(mostrarEventos === 'false'){
      document.getElementById('checkMostrarEventos').checked = false;
      document.querySelector('.secao-eventos').classList.add('oculto');
      document.querySelector('.secao-relogio').classList.add('expandido');
      // Ajustar rel√≥gio para 200px quando eventos ocultos
      ajustarTamanho(200);
      document.getElementById('sliderTamanho').value = 200;
    } else {
      // Ajustar rel√≥gio para 130px quando eventos vis√≠veis
      ajustarTamanho(130);
      document.getElementById('sliderTamanho').value = 130;
    }

    // Carregar tamanho do rel√≥gio salvo (se existir, sobrescreve o padr√£o acima)
    var tamanhoSalvo = localStorage.getItem('tamanhoRelogio');
    if(tamanhoSalvo){
      document.getElementById('sliderTamanho').value = tamanhoSalvo;
      ajustarTamanho(tamanhoSalvo);
    }
  }

  // ====== INICIALIZA√á√ÉO ======
  carregarPreferencias();
  carregarEventos(); // Carregar eventos do Google Calendar
  atualizar();

  // Atualizar a cada minuto
  setInterval(atualizar, 60000);

  // Atualizar contador a cada 30 segundos para contagem mais precisa
  setInterval(atualizarContador, 30000);

  // Recarregar eventos a cada 5 minutos
  setInterval(carregarEventos, 300000);
  </script>
</body>
</html>