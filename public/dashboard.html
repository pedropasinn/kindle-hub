<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Calendário – Versão Kindle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{font-family:Arial, sans-serif;background:#fff;color:#000;overflow:hidden}

    /* variáveis dinâmicas */
    :root{ 
      --relogio-percent: 70; 
      --eventos-percent: 30;
    }

    .viewport{
      position:relative;
      width:100vw; height:100vh;
      display:flex; flex-direction:row;
      transform-origin:left top;
    }
    .viewport.rotated{
      transform:rotate(90deg) translateY(-100%);
      width:100vh; height:100vw;
    }

    /* Proporção dinâmica via variáveis CSS */
    .secao-relogio{
      position:relative;
      flex:0 0 calc(var(--relogio-percent) * 1%);
      min-width:0;
      display:flex;
      flex-direction:column;
      border-right:2px solid #000;
      background:#f8f8f8;
    }
    .secao-eventos{
      flex:0 0 calc(var(--eventos-percent) * 1%); 
      min-width:0; 
      display:flex; 
      flex-direction:column;
      background:#fff;
    }

    /* Painel de Controles - ancorado na seção do relógio */
    .painel-controles{
      position:absolute;
      top:10px;
      left:10px;
      background:rgba(255,255,255,0.98);
      border:2px solid #000;
      border-radius:8px;
      padding:12px;
      z-index:1000;
      max-width:340px;
      transition:all 0.3s ease;
    }
    .painel-controles.minimizado{
      max-width:80px;
    }
    .painel-controles.minimizado .conteudo-controles{
      display:none;
    }
    .btn-toggle{
      background:#333;
      color:#fff;
      border:none;
      padding:8px 14px;
      cursor:pointer;
      border-radius:5px;
      font-size:14px;
      font-weight:bold;
      width:100%;
      margin-bottom:10px;
    }
    .painel-controles.minimizado .btn-toggle{
      margin-bottom:0;
    }
    .conteudo-controles{
      display:block;
    }
    .grupo-controle{
      margin-bottom:12px;
    }
    .label-controle{
      display:block;
      font-size:11px;
      font-weight:bold;
      margin-bottom:4px;
      color:#333;
    }
    .slider-controle{
      width:100%;
      height:24px;
      cursor:pointer;
    }
    .valor-controle{
      display:inline-block;
      font-weight:bold;
      color:#000;
      font-size:12px;
      margin-left:6px;
    }
    .botoes-dia{
      display:flex;
      gap:4px;
    }
    .btn-dia{
      flex:1;
      padding:6px 4px;
      background:#f0f0f0;
      border:2px solid #999;
      border-radius:4px;
      cursor:pointer;
      font-size:11px;
      font-weight:bold;
      text-align:center;
    }
    .btn-dia.ativo{
      background:#333;
      color:#fff;
      border-color:#000;
    }
    .btn-girar{
      width:100%;
      padding:6px;
      background:#fff;
      border:2px solid #333;
      border-radius:4px;
      cursor:pointer;
      font-size:11px;
      font-weight:bold;
    }
    .checkbox-container{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 0;
    }
    .checkbox-container input[type="checkbox"]{
      width:18px;
      height:18px;
      cursor:pointer;
    }
    .checkbox-container label{
      cursor:pointer;
      font-size:12px;
      font-weight:bold;
      flex:1;
    }

    /* Quando eventos está oculto - toda a seção desaparece */
    .secao-eventos.oculto{
      display:none !important;
    }

    /* Quando eventos está oculto, relógio ocupa 100% */
    .secao-relogio.expandido{
      flex:1 1 100% !important;
      border-right:none !important;
    }

    /* Relógio central */
    .relogio-wrap{
      flex:1; 
      display:flex; 
      flex-direction:column; 
      justify-content:center; 
      align-items:center;
      padding:20px;
    }
    .data-semana-linha{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:30px;
      margin-bottom:12px;
    }
    .relogio{
      font-family:"Courier New", monospace;
      font-weight:bold;
      /* tamanho fixo em pixels - igual ao index.html */
      font-size:120px;
      line-height:1;
      margin-bottom:12px;
      text-align:center;
      color:#000;
    }
    .data{
      font-size:24px;
      text-align:center;
      color:#333;
    }
    .semana{
      font-size:24px;
      color:#666;
      text-align:center;
    }

    /* Eventos com rolagem */
    .topo-eventos{
      display:flex; 
      align-items:center; 
      justify-content:center; 
      padding:8px; 
      border-bottom:2px solid #000;
      background:#fff;
    }
    .titulo{
      font-size:24px;
      font-weight:bold;
      text-align:center;
    }
    .lista{
      flex:1; 
      overflow-y:auto; 
      overflow-x:hidden;
      padding:8px; 
      display:flex; 
      flex-direction:column; 
      gap:6px;
    }
    .evento{
      border-left:4px solid #999;
      padding:12px;
      background:#f5f5f5;
      font-size:18px;
      border-radius:4px;
    }
    .evento .t{
      font-weight:bold;
      margin-bottom:4px;
      font-size:20px;
    }
    .evento .h{
      color:#555;
      font-size:16px;
    }
    .evento.atual{
      background:#fff9e6; 
      border-left-color:#000; 
      font-weight:bold;
    }
    .evento.passado{
      opacity:0.5; 
      background:#e8e8e8;
    }
    .sem{
      color:#777;
      text-align:center;
      padding:20px;
      font-size:18px;
    }

    /* Esconde scrollbar mas mantém funcionalidade */
    .lista::-webkit-scrollbar{
      width:8px;
    }
    .lista::-webkit-scrollbar-track{
      background:#f0f0f0;
    }
    .lista::-webkit-scrollbar-thumb{
      background:#ccc;
      border-radius:4px;
    }

    /* Contador de Próximo Evento */
    .contador-evento{
      margin:20px;
      background:#fff;
      border:3px solid #000;
      border-radius:8px;
      padding:16px;
      position:relative;
    }
    .contador-titulo{
      font-size:18px;
      font-weight:bold;
      margin-bottom:8px;
      color:#000;
      text-align:center;
    }
    .contador-tempo{
      font-size:32px;
      font-weight:bold;
      color:#000;
      text-align:center;
      font-family:"Courier New", monospace;
      margin-bottom:4px;
    }
    .contador-label{
      font-size:14px;
      color:#666;
      text-align:center;
    }
    .contador-evento.atual{
      background:#fff9e6;
      border-color:#ffd700;
    }
    .contador-evento.proximo{
      background:#f0f8ff;
      border-color:#4682b4;
    }
    .contador-evento.oculto{
      display:none !important;
    }
    .btn-fechar-contador{
      position:absolute;
      top:8px;
      right:8px;
      background:transparent;
      border:none;
      font-size:24px;
      font-weight:bold;
      cursor:pointer;
      color:#666;
      width:30px;
      height:30px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:4px;
      transition:all 0.2s;
      z-index:10;
      line-height:1;
      padding:0;
    }
    .btn-fechar-contador:hover{
      background:#f0f0f0;
      color:#000;
    }
    .btn-fechar-contador:active{
      background:#e0e0e0;
    }

    /* Aba inferior para reabrir contador */
    .aba-contador{
      position:fixed;
      bottom:-50px;
      left:50%;
      transform:translateX(-50%);
      background:#000;
      color:#fff;
      padding:8px 24px;
      border-radius:8px 8px 0 0;
      cursor:pointer;
      z-index:999;
      font-weight:bold;
      font-size:14px;
      transition:all 0.3s ease;
    }
    .aba-contador.visivel{
      bottom:0;
    }
    .aba-contador:hover{
      background:#333;
      padding-top:12px;
    }

    /* Aba superior (Agenda) ancorada na divisão direita */
    .aba-agenda{
      position:fixed;
      top:8px;
      /* Quando eventos estão visíveis, ancoro na % do relógio */
      left:calc(var(--relogio-percent) * 1vw);
      /* Trago a aba um pouco para a ESQUERDA da divisória */
      transform:translateX(calc(-100% - 8px));
      background:#000;
      color:#fff;
      padding:8px 14px;
      border-radius:8px;
      cursor:pointer;
      z-index:1100;
      font-weight:bold;
      font-size:14px;
      user-select:none;
      transition:left .25s ease, transform .2s ease, background .2s ease, opacity .2s ease;
    }
    .aba-agenda:hover{
      background:#333;
      transform:translateX(calc(-100% - 8px)) translateY(-1px);
    }
    .aba-agenda.aberta{
      opacity:.95;
    }

    /* Quando os eventos estão ocultos, a "divisória" é a borda direita do viewport */
    body.eventos-ocultos .aba-agenda{
      left:100vw;
      transform:translateX(calc(-100% - 8px));
    }

    /* Topo de eventos grudado e alinhado à esquerda */
    .topo-eventos{
      position:sticky;
      top:0;
      z-index:2;
      justify-content:flex-start;
      padding-left:12px;
    }
    .titulo{
      text-align:left;
    }

    /* Esconder checkbox antiga de Mostrar Eventos */
    #checkMostrarEventos,
    label[for="checkMostrarEventos"]{
      display:none !important;
    }

    /* ===== TIMER STYLES ===== */
    .timer-mode-toggle {
      display: flex;
      gap: 16px;
      margin-bottom:1px;
    }
    .btn-mode {
      flex: 1;
      padding: 6px;
      background: #fff;
      border: 2px solid #000;
      cursor: pointer;
      font-weight: bold;
      font-size: 13px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    .btn-mode.active {
      background: #000;
      color: #fff;
    }
    .btn-mode:hover {
      background: #f0f0f0;
    }
    .btn-mode.active:hover {
      background: #333;
    }

    /* Classe genérica para esconder elementos */
    .hidden {
      display: none !important;
    }

    /* Containers de Display (Relógio ou Timer) */
    .display-container {
      display: block;
    }
    .display-container.hidden {
      display: none;
    }

    /* Container do Timer Circular - ÁREA PRINCIPAL */
    .timer-container-main {
      position: relative;
      width: 300px;
      height: 300px;
      margin: 15px auto;
    }

    /* SVG Circle com barras */
    .timer-circle {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg); /* Inicia no topo */
    }
    .timer-bar {
      transition: opacity 0.3s ease; /* Animação suave */
    }
    .timer-bar.hidden {
      opacity: 0;
    }

    /* Display Central - ÁREA PRINCIPAL */
    .timer-display-main {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 48px;
      font-weight: bold;
      color: #000;
      pointer-events: none;
      font-family: 'Courier New', monospace;
    }

    /* Botões de Preset - ÁREA PRINCIPAL */
    .preset-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 10px auto;
      max-width: 400px;
      transition: opacity 0.3s ease;
    }
    .preset-buttons.hidden {
      display: none;
    }
    .btn-preset {
      padding: 10px;
      background: #e8e8e8;
      border: 3px solid #000;
      cursor: pointer;
      font-weight: bold;
      font-size: 20px;
      border-radius: 6px;
      transition: all 0.2s ease;
    }
    .btn-preset:hover {
      background: #f0f0f0;
      transform: translateY(-2px);
    }
    .btn-preset:active {
      background: #e0e0e0;
      transform: translateY(0);
      box-shadow: none;
    }

    /* Input Manual - ÁREA PRINCIPAL */
    .manual-input {
      display: flex;
      gap: 12px;
      margin: 20px auto;
      max-width: 400px;
      transition: opacity 0.3s ease;
    }
    .manual-input.hidden {
      display: none;
    }
    .manual-input input {
      flex: 1;
      padding: 12px;
      border: 3px solid #000;
      font-size: 14px;
      border-radius: 6px;
      font-family: Arial, sans-serif;
    }
    .manual-input input:focus {
      outline: none;
      border-color: #333;
    }
    .btn-start-custom {
      padding: 12px 24px;
      background: #000;
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      border-radius: 6px;
      transition: all 0.2s ease;
    }
    .btn-start-custom:hover {
      background: #333;
      transform: translateY(-2px);
    }
    .btn-start-custom:active {
      background: #555;
      transform: translateY(0);
      box-shadow: none;
    }

    /* Controles Play/Pause/Stop - ÁREA PRINCIPAL */
    .timer-controls {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin: 10px auto;
      transition: opacity 0.3s ease;
    }
    .timer-controls.hidden {
      display: none;
    }
    .btn-control {
      width: 60px;
      height: 60px;
      background: #fff;
      border: 3px solid #000;
      cursor: pointer;
      font-size: 24px;
      font-weight: bold;
      border-radius: 50%;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-control:hover {
      background: #f0f0f0;
      transform: scale(1.1);
    }
    .btn-control:active {
      background: #e0e0e0;
      transform: scale(0.95);
      box-shadow: none;
    }

    /* Widget no canto superior direito (outras páginas) - definido aqui também para consistência */
    .timer-widget {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.98);
      border: 2px solid #000;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: bold;
      z-index: 9999;
      display: none;
      align-items: center;
      gap: 8px;
    }

    /* Modal de Notificação */
    .timer-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 99999;
    }
    .timer-modal-content {
      background: #fff;
      border: 4px solid #000;
      padding: 40px;
      text-align: center;
      max-width: 400px;
      border-radius: 8px;
      animation: modalFadeIn 0.3s ease;
    }
    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    .timer-modal-title {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 20px;
      color: #000;
    }
    .timer-modal-btn {
      padding: 14px 40px;
      background: #000;
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      border-radius: 6px;
      margin-top: 10px;
      transition: all 0.2s ease;
    }
    .timer-modal-btn:hover {
      background: #333;
      transform: scale(1.05);
    }
    .timer-modal-btn:active {
      background: #555;
      transform: scale(0.98);
    }
  </style>
  <script src="timer.js"></script>
</head>
<body>
  <div id="vp" class="viewport rotated">
    <!-- LADO ESQUERDO: RELÓGIO -->
    <section class="secao-relogio">
      <!-- Painel de Menu Principal (Hub + Config) -->
      <div id="painelMenu" class="painel-controles minimizado" style="max-width: 400px;">
        <button class="btn-toggle" onclick="toggleMenu()">⋮</button>
        <div class="conteudo-controles">
          <!-- Hub: Atalhos -->
          <details open>
            <summary style="cursor: pointer; font-weight: bold; padding: 8px; background: #f0f0f0; border-radius: 4px; margin-bottom: 10px;">Hub</summary>
            <div style="padding: 10px; display: flex; flex-direction: column; gap: 8px;">
              <a href="agenda.html" style="padding: 10px; background: #fff; border: 2px solid #000; text-decoration: none; color: #000; font-weight: bold; text-align: center; border-radius: 4px;">Agenda</a>
              <a href="plano-inclinado.html" style="padding: 10px; background: #fff; border: 2px solid #000; text-decoration: none; color: #000; font-weight: bold; text-align: center; border-radius: 4px;">Plano de Vida</a>
            </div>
          </details>

          <!-- Configurações -->
          <details>
            <summary style="cursor: pointer; font-weight: bold; padding: 8px; background: #f0f0f0; border-radius: 4px; margin-bottom: 10px;">Config.</summary>
            <div style="padding: 10px;">
          <div class="grupo-controle">
            <label class="label-controle">
              Tamanho do Relógio
              <span class="valor-controle" id="valorTamanho">120px</span>
            </label>
            <input
              type="range"
              class="slider-controle"
              id="sliderTamanho"
              min="60"
              max="200"
              value="120"
              step="10"
              oninput="ajustarTamanho(this.value)">
          </div>

          <div class="grupo-controle">
            <label class="label-controle">
              Proporção Relógio/Eventos
              <span class="valor-controle" id="valorProporcao">70/30</span>
            </label>
            <input
              type="range"
              class="slider-controle"
              id="sliderProporcao"
              min="40"
              max="85"
              value="70"
              step="5"
              oninput="ajustarProporcao(this.value)">
          </div>

          <div class="grupo-controle">
            <label class="label-controle">Selecionar Dia</label>
            <div class="botoes-dia">
              <button class="btn-dia" id="btnOntem" onclick="irParaDia(-1)">Ontem</button>
              <button class="btn-dia ativo" id="btnHoje" onclick="irParaDia(0)">Hoje</button>
              <button class="btn-dia" id="btnAmanha" onclick="irParaDia(1)">Amanhã</button>
            </div>
          </div>

          <div class="grupo-controle">
            <button class="btn-girar" id="btnRot" onclick="girarTela()">Girar 90°</button>
          </div>

          <div class="grupo-controle">
            <div class="checkbox-container">
              <input type="checkbox" id="checkMostrarEventos" checked onchange="toggleEventos()">
              <label for="checkMostrarEventos">Mostrar Eventos</label>
            </div>
          </div>

          <!-- Timer/Relógio Toggle -->
          <div class="grupo-controle">
            <label class="label-controle">Exibir</label>
            <div class="timer-mode-toggle">
              <button id="btnModeClock" class="btn-mode active" onclick="setDisplayMode('clock')">Relógio</button>
              <button id="btnModeTimer" class="btn-mode" onclick="setDisplayMode('timer')">Timer</button>
            </div>
          </div>
            </div>
          </details>
        </div>
      </div>

      <div class="relogio-wrap">
        <div class="data-semana-linha" id="dataSemanaLinha">
          <div id="data" class="data">–</div>
          <div id="semana" class="semana">–</div>
        </div>

        <!-- RELÓGIO PRINCIPAL -->
        <div id="relogioContainer" class="display-container">
          <div id="relogio" class="relogio">00:00</div>
        </div>

        <!-- TIMER PRINCIPAL (escondido por padrão) -->
        <div id="timerMainContainer" class="display-container hidden">
          <!-- Timer Circular (60 barras radiais) -->
          <div class="timer-container-main">
            <svg class="timer-circle" viewBox="0 0 200 200">
              <!-- Barras geradas via JS -->
            </svg>
            <!-- Display Central HH:MM -->
            <div class="timer-display-main" id="timerDisplay">00:00</div>
          </div>

          <!-- Preset Buttons (aparecem quando timer parado) -->
          <div id="presetButtons" class="preset-buttons">
            <button class="btn-preset" onclick="startPreset('5min')">5 min</button>
            <button class="btn-preset" onclick="startPreset('10min')">10 min</button>
            <button class="btn-preset" onclick="startPreset('30min')">30 min</button>
            <button class="btn-preset" onclick="startPreset('2h')">2 horas</button>
          </div>

          <!-- Input Manual -->
          <div id="manualInput" class="manual-input">
            <input type="number" id="customMinutes" placeholder="Minutos" min="1" max="999">
            <button id="btnStartCustom" class="btn-start-custom" onclick="startCustomTimer()">Iniciar</button>
          </div>

          <!-- Controles (aparecem quando timer ativo) -->
          <div id="timerControls" class="timer-controls hidden">
            <button id="btnPlayPause" class="btn-control" onclick="togglePlayPause()">▶</button>
            <button id="btnStop" class="btn-control" onclick="stopTimerUI()">■</button>
          </div>
        </div>

        <!-- Widget de Previsão do Tempo -->
        <div id="weatherWidget" style="margin: 10px auto 5px; transform: scale(1.2); transform-origin: top center;">
          <div id="ww_024836fa03d7b" v='1.3' loc='id' a='{"t":"horizontal","lang":"pt","sl_lpl":1,"ids":["wl1583"],"font":"Arial","sl_ics":"one","sl_sot":"celsius","cl_bkg":"#FFFFFF00","cl_font":"rgba(31,27,27,1)","cl_cloud":"rgba(81,77,77,1)","cl_persp":"rgba(0,0,0,1)","cl_sun":"rgba(30,29,26,1)","cl_moon":"rgba(40,38,34,1)","cl_thund":"rgba(34,31,29,1)","el_nme":3,"el_cwt":3,"el_phw":3}'>Mais previsões: <a href="https://tempolongo.com/rio_de_janeiro_tempo_25_dias/" id="ww_024836fa03d7b_u" target="_blank">Rio de Janeiro 30 day forecast</a></div><script async src="https://app3.weatherwidget.org/js/?id=ww_024836fa03d7b"></script>
        </div>
      </div>

      <!-- Contador de Próximo Evento -->
      <div id="contadorEvento" class="contador-evento">
        <button id="btnFecharContador" class="btn-fechar-contador" title="Fechar" onclick="fecharContador()">×</button>
        <div class="contador-titulo" id="contadorTitulo">—</div>
        <div class="contador-tempo" id="contadorTempo">—</div>
        <div class="contador-label" id="contadorLabel">—</div>
      </div>
    </section>

    <!-- Aba inferior para reabrir o contador -->
    <div id="abaContador" class="aba-contador" onclick="abrirContador()">Eventos</div>

    <!-- Aba superior para toggle da agenda -->
    <div id="abaAgenda" class="aba-agenda" onclick="toggleAgenda()">Agenda</div>

    <!-- LADO DIREITO: EVENTOS -->
    <section class="secao-eventos">
      <div class="topo-eventos"><div id="titulo" class="titulo">Eventos</div></div>
      <div id="lista" class="lista"><div class="sem">Carregando…</div></div>
    </section>
  </div>

  <script>
  // ====== CONFIG ======
  var TIME_OFFSET_MINUTES = -180; // -3h (ajuste conforme seu fuso)
  
  // Eventos do Google Calendar
  var eventosData = {};
  var allGoogleEvents = [];

  // Carregar eventos do Google Calendar
  async function carregarEventos() {
    try {
      const response = await fetch(window.location.origin + '/api/calendar/events?days=14');
      if (response.ok) {
        allGoogleEvents = await response.json();
        // Converter formato Google para formato dashboard
        eventosData = {};
        allGoogleEvents.forEach(event => {
          const start = new Date(event.start.dateTime || event.start.date);
          start.setHours(start.getHours() - 3); // Ajustar timezone
          const end = event.end.dateTime ? new Date(event.end.dateTime) : start;
          end.setHours(end.getHours() - 3); // Ajustar timezone

          const dataKey = ymd(start);
          if (!eventosData[dataKey]) {
            eventosData[dataKey] = [];
          }

          eventosData[dataKey].push({
            titulo: event.summary || 'Sem título',
            inicio: ('0' + start.getHours()).slice(-2) + ':' + ('0' + start.getMinutes()).slice(-2),
            fim: ('0' + end.getHours()).slice(-2) + ':' + ('0' + end.getMinutes()).slice(-2)
          });
        });
        atualizar();
      }
    } catch (error) {
      console.error('Erro ao carregar eventos:', error);
    }
  }

  // ====== FUNÇÕES AUXILIARES ======
  function agoraCorrigido(){ 
    var d = new Date(); 
    return new Date(d.getTime() + TIME_OFFSET_MINUTES * 60000); 
  }
  
  function ymd(d){
    var a = d.getFullYear();
    var m = ('0' + (d.getMonth() + 1)).slice(-2);
    var dia = ('0' + d.getDate()).slice(-2);
    return a + '-' + m + '-' + dia;
  }
  
  function minutos(hhmm){
    var p = hhmm.split(':');
    var h = parseInt(p[0], 10) || 0;
    var m = parseInt(p[1], 10) || 0;
    return h * 60 + m;
  }
  
  var meses = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
  var dias = ['Domingo','Segunda-feira','Terça-feira','Quarta-feira','Quinta-feira','Sexta-feira','Sábado'];
  
  var dataSel = agoraCorrigido();
  var offsetDia = 0; // -1=ontem, 0=hoje, 1=amanhã

  // ====== CONTROLES ======
  function toggleMenu(){
    var painel = document.getElementById('painelMenu');

    if(painel.className.indexOf('minimizado') >= 0){
      // Expandir
      painel.className = 'painel-controles';
      localStorage.setItem('menuAberto', 'true');
    } else {
      // Minimizar
      painel.className = 'painel-controles minimizado';
      localStorage.setItem('menuAberto', 'false');
    }
  }

  function ajustarTamanho(valor){
    var tamanho = parseInt(valor);
    document.getElementById('relogio').style.fontSize = tamanho + 'px';
    document.getElementById('valorTamanho').textContent = tamanho + 'px';

    // Salvar preferência
    localStorage.setItem('tamanhoRelogio', valor);
  }

  function ajustarProporcao(valor){
    var relogioPercent = parseInt(valor);
    var eventosPercent = 100 - relogioPercent;

    document.documentElement.style.setProperty('--relogio-percent', relogioPercent);
    document.documentElement.style.setProperty('--eventos-percent', eventosPercent);

    document.getElementById('valorProporcao').textContent = relogioPercent + '/' + eventosPercent;

    // Salvar preferência
    localStorage.setItem('proporcao', valor);
  }

  function irParaDia(offset){
    offsetDia = offset;
    var agora = agoraCorrigido();
    dataSel = new Date(agora.getTime() + (offset * 86400000));
    
    // Atualizar botões ativos
    document.getElementById('btnOntem').className = 'btn-dia' + (offset === -1 ? ' ativo' : '');
    document.getElementById('btnHoje').className = 'btn-dia' + (offset === 0 ? ' ativo' : '');
    document.getElementById('btnAmanha').className = 'btn-dia' + (offset === 1 ? ' ativo' : '');
    
    atualizar();
  }

  function girarTela(){
    var vp = document.getElementById('vp');

    if(vp.className.indexOf('rotated') >= 0){
      vp.className = 'viewport';
    } else {
      vp.className = 'viewport rotated';
    }

    // Salvar preferência
    localStorage.setItem('rotacao', vp.className);
  }

  function setMostrarEventos(flag){
    var secaoEventos = document.querySelector('.secao-eventos');
    var secaoRelogio = document.querySelector('.secao-relogio');
    var abaAgenda = document.getElementById('abaAgenda');

    if(flag){
      secaoEventos.classList.remove('oculto');
      secaoRelogio.classList.remove('expandido');
      document.body.classList.remove('eventos-ocultos');
      document.body.classList.add('eventos-visiveis');

      ajustarTamanho(130);
      var s = document.getElementById('sliderTamanho');
      if(s) s.value = 130;
      if(abaAgenda) abaAgenda.classList.add('aberta');
    } else {
      secaoEventos.classList.add('oculto');
      secaoRelogio.classList.add('expandido');
      document.body.classList.remove('eventos-visiveis');
      document.body.classList.add('eventos-ocultos');

      ajustarTamanho(200);
      var s2 = document.getElementById('sliderTamanho');
      if(s2) s2.value = 200;
      if(abaAgenda) abaAgenda.classList.remove('aberta');
    }
    localStorage.setItem('mostrarEventos', flag ? 'true' : 'false');
  }

  function toggleEventos(){
    var checkbox = document.getElementById('checkMostrarEventos');
    setMostrarEventos(!!checkbox.checked);
  }

  function toggleAgenda(){
    var atual = localStorage.getItem('mostrarEventos') !== 'false';
    setMostrarEventos(!atual);
  }

  // ====== CONTROLES DO CONTADOR DE EVENTOS ======
  function fecharContador(){
    console.log('fecharContador chamado');
    var contador = document.getElementById('contadorEvento');
    var aba = document.getElementById('abaContador');

    if(contador && aba){
      contador.classList.add('oculto');
      aba.classList.add('visivel');
      console.log('Contador fechado com sucesso');
      console.log('Classes do contador:', contador.className);
      console.log('Classes da aba:', aba.className);
    } else {
      console.error('Elementos não encontrados', {contador: !!contador, aba: !!aba});
    }

    // Salvar preferência
    localStorage.setItem('contadorVisivel', 'false');
  }

  function abrirContador(){
    console.log('abrirContador chamado');
    var contador = document.getElementById('contadorEvento');
    var aba = document.getElementById('abaContador');

    if(contador && aba){
      contador.classList.remove('oculto');
      aba.classList.remove('visivel');
      console.log('Contador aberto com sucesso');
      console.log('Classes do contador:', contador.className);
      console.log('Classes da aba:', aba.className);
    } else {
      console.error('Elementos não encontrados', {contador: !!contador, aba: !!aba});
    }

    // Salvar preferência
    localStorage.setItem('contadorVisivel', 'true');
  }

  // ====== DESENHAR INTERFACE ======
  function desenharHorario(){
    var n = agoraCorrigido();
    var h = ('0' + n.getHours()).slice(-2);
    var m = ('0' + n.getMinutes()).slice(-2);
    
    document.getElementById('relogio').innerHTML = h + ':' + m;
    document.getElementById('data').innerHTML = n.getDate() + ' de ' + meses[n.getMonth()];
    document.getElementById('semana').innerHTML = dias[n.getDay()];
  }

  function estadoEvento(evt, baseDate){
    var n = agoraCorrigido();
    var isHoje = ymd(n) === ymd(baseDate);
    
    if(!isHoje){
      return baseDate < n ? 'passado' : 'futuro';
    }
    
    var t = n.getHours() * 60 + n.getMinutes();
    var i = minutos(evt.inicio);
    var f = minutos(evt.fim);
    
    if(t < i) return 'futuro';
    if(t >= i && t < f) return 'atual';
    return 'passado';
  }

  function desenharEventos(){
    var key = ymd(dataSel);
    var evts = eventosData[key] || [];
    
    var n = agoraCorrigido();
    var hj = ymd(n);
    var ont = new Date(n.getTime() - 86400000);
    var am = new Date(n.getTime() + 86400000);
    
    var titulo = 'Eventos de ';
    if(key === hj){
      titulo += 'Hoje';
    } else if(key === ymd(ont)){
      titulo += 'Ontem';
    } else if(key === ymd(am)){
      titulo += 'Amanhã';
    } else {
      titulo += dataSel.getDate() + ' de ' + meses[dataSel.getMonth()];
    }
    
    document.getElementById('titulo').innerHTML = titulo;
    
    var lista = document.getElementById('lista');
    if(!evts.length){
      lista.innerHTML = '<div class="sem">Nenhum evento para este dia</div>';
      return;
    }
    
    var html = '';
    for(var i = 0; i < evts.length; i++){
      var e = evts[i];
      var st = estadoEvento(e, dataSel);
      html += '<div class="evento ' + st + '">';
      html += '<div class="t">' + e.titulo + '</div>';
      html += '<div class="h">' + e.inicio + ' – ' + e.fim + '</div>';
      html += '</div>';
    }
    lista.innerHTML = html;
  }

  // Variável global para rastrear estado anterior do contador
  var estadoContadorAnterior = null;

  // Funções helper para gerenciar o contador
  function usuarioFechouContador(){
    return localStorage.getItem('contadorVisivel') === 'false';
  }

  function setEstadoContador(estado){ // 'atual' | 'proximo' | null
    var contador = document.getElementById('contadorEvento');
    contador.classList.remove('atual','proximo');
    if (estado) contador.classList.add(estado);
    // Importante: não tocar na classe 'oculto' aqui.
  }

  function atualizarContador(){
    var key = ymd(dataSel);
    var evts = eventosData[key] || [];
    var n = agoraCorrigido();
    var hj = ymd(n);

    // Filtrar eventos que não têm estrela
    var eventosValidos = [];
    for(var i = 0; i < evts.length; i++){
      if(evts[i].titulo.indexOf('⭐') === -1){
        eventosValidos.push(evts[i]);
      }
    }

    var contador = document.getElementById('contadorEvento');
    var aba = document.getElementById('abaContador');

    // Respeitar escolha do usuário
    var contadorDeveEstarVisivel = !usuarioFechouContador();
    if (key !== hj || eventosValidos.length === 0){
      // Se não for hoje ou não houver eventos, esconder tudo
      contador.classList.add('oculto');
      aba.classList.remove('visivel');
      estadoContadorAnterior = 'vazio';
      return;
    }

    if (contadorDeveEstarVisivel){
      contador.classList.remove('oculto');
      aba.classList.remove('visivel');
    } else {
      // Mantém oculto e mostra a aba
      contador.classList.add('oculto');
      aba.classList.add('visivel');
    }
    var agora = n.getHours() * 60 + n.getMinutes();
    var eventoAtual = null;
    var proximoEvento = null;

    // Procurar evento atual ou próximo (ignorando eventos com estrela)
    for(var i = 0; i < eventosValidos.length; i++){
      var e = eventosValidos[i];
      var inicio = minutos(e.inicio);
      var fim = minutos(e.fim);

      if(agora >= inicio && agora < fim){
        eventoAtual = e;
        break;
      }

      if(agora < inicio && !proximoEvento){
        proximoEvento = e;
      }
    }

    var titulo = document.getElementById('contadorTitulo');
    var tempo = document.getElementById('contadorTempo');
    var label = document.getElementById('contadorLabel');
    var estadoAtual = null;
    var deveAbrir = false;

    if(eventoAtual){
      // Evento acontecendo agora
      setEstadoContador('atual');
      titulo.textContent = eventoAtual.titulo;

      var fimMin = minutos(eventoAtual.fim);
      var diff = fimMin - agora;

      estadoAtual = 'atual:' + eventoAtual.titulo;

      if(diff <= 0){
        tempo.textContent = 'Terminando...';
        label.textContent = '';
      } else {
        var horas = Math.floor(diff / 60);
        var mins = diff % 60;

        if(horas > 0){
          tempo.textContent = horas + 'h ' + mins + 'min';
        } else {
          tempo.textContent = mins + ' min';
        }
        label.textContent = 'para terminar';
      }

      // Abrir se evento começou agora
      if(estadoContadorAnterior && estadoContadorAnterior !== estadoAtual){
        deveAbrir = true;
      }
    } else if(proximoEvento){
      // Próximo evento
      setEstadoContador('proximo');
      titulo.textContent = proximoEvento.titulo;

      var inicioMin = minutos(proximoEvento.inicio);
      var diff = inicioMin - agora;

      estadoAtual = 'proximo:' + proximoEvento.titulo;

      if(diff <= 0){
        tempo.textContent = 'Começando...';
        label.textContent = '';
        deveAbrir = true; // Abrir quando evento está começando
      } else {
        var horas = Math.floor(diff / 60);
        var mins = diff % 60;

        if(horas > 0){
          tempo.textContent = horas + 'h ' + mins + 'min';
        } else {
          tempo.textContent = mins + ' min';
        }
        label.textContent = 'para começar';

        // Abrir quando faltam 5 minutos ou menos
        if(diff <= 5 && estadoContadorAnterior && !estadoContadorAnterior.includes('proximo:' + proximoEvento.titulo)){
          deveAbrir = true;
        }
      }

      // Detectar mudança de evento próximo
      if(estadoContadorAnterior && !estadoContadorAnterior.includes('proximo:' + proximoEvento.titulo)){
        deveAbrir = true;
      }
    } else {
      // Todos os eventos já passaram
      contador.classList.add('oculto');
      document.getElementById('abaContador').classList.remove('visivel');
      estadoAtual = 'vazio';
    }

    // Atualizar estado anterior
    estadoContadorAnterior = estadoAtual;

    // Abrir contador automaticamente se houver mudança importante
    if(deveAbrir && !usuarioFechouContador()){
      abrirContador();
    }
  }

  function atualizar(){
    desenharHorario();
    desenharEventos();
    atualizarContador();
  }

  // ====== CARREGAR PREFERÊNCIAS ======
  function carregarPreferencias(){
    // Carregar rotação salva da viewport
    var rotSalva = localStorage.getItem('rotacao');
    if(rotSalva){
      document.getElementById('vp').className = rotSalva;
    }

    // Carregar estado do menu
    var menuAberto = localStorage.getItem('menuAberto');
    if(menuAberto === 'true'){
      document.getElementById('painelMenu').className = 'painel-controles';
    }

    // Carregar proporção salva
    var propSalva = localStorage.getItem('proporcao');
    if(propSalva){
      document.getElementById('sliderProporcao').value = propSalva;
      ajustarProporcao(propSalva);
    }

    // Carregar estado de mostrar eventos
    var mostrarEventos = localStorage.getItem('mostrarEventos');
    if(mostrarEventos === 'false'){
      document.getElementById('checkMostrarEventos').checked = false;
      setMostrarEventos(false);
    } else {
      setMostrarEventos(true);
    }

    // Carregar tamanho do relógio salvo (se existir, sobrescreve o padrão acima)
    var tamanhoSalvo = localStorage.getItem('tamanhoRelogio');
    if(tamanhoSalvo){
      document.getElementById('sliderTamanho').value = tamanhoSalvo;
      ajustarTamanho(tamanhoSalvo);
    }

    // Carregar estado do contador de eventos
    var contadorVisivel = localStorage.getItem('contadorVisivel');
    if(contadorVisivel === 'false'){
      document.getElementById('contadorEvento').classList.add('oculto');
      document.getElementById('abaContador').classList.add('visivel');
    }
  }

  // ====== TIMER FUNCTIONS ======

  let timerBars = [];
  let timerAnimationFrame = null;
  let timerUpdateInterval = null;

  /**
   * Gera as 60 barras radiais no SVG
   */
  function generateTimerBars() {
    const svg = document.querySelector('.timer-circle');
    if (!svg) return;

    const numBars = 60;
    const centerX = 100;
    const centerY = 100;
    const radius = 90;
    const barLength = 12;

    // Limpar barras existentes
    svg.innerHTML = '';
    timerBars = [];

    for (let i = 0; i < numBars; i++) {
      const angle = (i / numBars) * 2 * Math.PI;
      const x1 = centerX + radius * Math.cos(angle);
      const y1 = centerY + radius * Math.sin(angle);
      const x2 = centerX + (radius - barLength) * Math.cos(angle);
      const y2 = centerY + (radius - barLength) * Math.sin(angle);

      const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      line.setAttribute('x1', x1);
      line.setAttribute('y1', y1);
      line.setAttribute('x2', x2);
      line.setAttribute('y2', y2);
      line.setAttribute('stroke', '#000');
      line.setAttribute('stroke-width', '2.5');
      line.setAttribute('stroke-linecap', 'round');
      line.setAttribute('class', 'timer-bar');
      line.setAttribute('data-index', i);

      svg.appendChild(line);
      timerBars.push(line);
    }
  }

  /**
   * Atualiza visualização das barras baseado no progresso
   */
  function updateTimerBarsDisplay() {
    if (!window.KindleTimer) return;

    const state = window.KindleTimer.getState();

    if (!state.isActive) {
      // Timer parado - mostra todas as barras
      timerBars.forEach(bar => bar.classList.remove('hidden'));
      return;
    }

    const remaining = window.KindleTimer.getRemainingTime();
    const progress = 1 - (remaining / state.duration); // 0 a 1

    // Calcula quantas barras devem estar escondidas
    const barsToHide = Math.floor(progress * timerBars.length);

    // Atualiza visibilidade das barras (sentido horário)
    timerBars.forEach((bar, index) => {
      if (index < barsToHide) {
        bar.classList.add('hidden');
      } else {
        bar.classList.remove('hidden');
      }
    });
  }

  /**
   * Atualiza display central do timer
   */
  function updateTimerDisplay() {
    if (!window.KindleTimer) return;

    const display = document.getElementById('timerDisplay');
    if (!display) return;

    const state = window.KindleTimer.getState();

    // Sempre mostra o tempo do timer (não mais alterna com relógio)
    if (!state.isActive) {
      display.textContent = '00:00';
    } else {
      const remaining = window.KindleTimer.getRemainingTime();
      display.textContent = window.KindleTimer.formatTime(remaining);
    }
  }

  /**
   * Atualiza UI (barras + display + controles)
   */
  function updateTimerUI() {
    if (!window.KindleTimer) return;

    const state = window.KindleTimer.getState();

    // Atualiza display e barras
    updateTimerDisplay();
    updateTimerBarsDisplay();

    // Controla visibilidade dos elementos
    const presetButtons = document.getElementById('presetButtons');
    const manualInput = document.getElementById('manualInput');
    const timerControls = document.getElementById('timerControls');

    if (state.isActive) {
      // Timer ativo - esconde presets e input, mostra controles
      presetButtons.classList.add('hidden');
      manualInput.classList.add('hidden');
      timerControls.classList.remove('hidden');

      // Atualiza botão play/pause
      const btnPlayPause = document.getElementById('btnPlayPause');
      if (state.isPaused) {
        btnPlayPause.textContent = '▶';
        btnPlayPause.title = 'Continuar';
      } else {
        btnPlayPause.textContent = '❚❚';
        btnPlayPause.title = 'Pausar';
      }
    } else {
      // Timer parado - mostra presets e input, esconde controles
      presetButtons.classList.remove('hidden');
      manualInput.classList.remove('hidden');
      timerControls.classList.add('hidden');
    }
  }

  /**
   * Inicia timer com preset
   */
  function startPreset(presetName) {
    if (!window.KindleTimer) return;

    const duration = window.KindleTimer.PRESETS[presetName];
    if (!duration) return;

    window.KindleTimer.start(duration, presetName);
    startTimerMonitoring();
    updateTimerUI();
  }

  /**
   * Inicia timer customizado
   */
  function startCustomTimer() {
    if (!window.KindleTimer) return;

    const input = document.getElementById('customMinutes');
    const minutes = parseInt(input.value);

    if (!minutes || minutes < 1) {
      alert('Digite um valor válido em minutos');
      return;
    }

    const duration = minutes * 60 * 1000; // Converte para ms
    window.KindleTimer.start(duration, 'custom');
    startTimerMonitoring();
    updateTimerUI();

    // Limpa input
    input.value = '';
  }

  /**
   * Toggle play/pause
   */
  function togglePlayPause() {
    if (!window.KindleTimer) return;

    const state = window.KindleTimer.getState();

    if (state.isPaused) {
      window.KindleTimer.resume();
    } else {
      window.KindleTimer.pause();
    }

    updateTimerUI();
  }

  /**
   * Para timer
   */
  function stopTimerUI() {
    if (!window.KindleTimer) return;

    window.KindleTimer.stop();
    stopTimerMonitoring();
    updateTimerUI();
  }

  /**
   * Alterna entre exibir relógio ou timer na área principal
   */
  function setDisplayMode(mode) {
    console.log('setDisplayMode chamado com modo:', mode);

    const relogioContainer = document.getElementById('relogioContainer');
    const timerContainer = document.getElementById('timerMainContainer');
    const dataSemanaLinha = document.getElementById('dataSemanaLinha');
    const weatherWidget = document.getElementById('weatherWidget');
    const btnTimer = document.getElementById('btnModeTimer');
    const btnClock = document.getElementById('btnModeClock');

    console.log('Elementos encontrados:', {
      relogioContainer: !!relogioContainer,
      timerContainer: !!timerContainer,
      dataSemanaLinha: !!dataSemanaLinha,
      weatherWidget: !!weatherWidget
    });

    if (mode === 'timer') {
      // Mostra timer, esconde relógio, data e clima
      relogioContainer.classList.add('hidden');
      timerContainer.classList.remove('hidden');
      if (dataSemanaLinha) {
        dataSemanaLinha.classList.add('hidden');
        console.log('Data/Semana escondida');
      }
      if (weatherWidget) {
        weatherWidget.classList.add('hidden');
        console.log('Weather widget escondido');
      }
      btnTimer.classList.add('active');
      btnClock.classList.remove('active');

      // Salva preferência
      localStorage.setItem('displayMode', 'timer');

      // Atualiza UI do timer
      updateTimerUI();
    } else {
      // Mostra relógio, data e clima, esconde timer
      relogioContainer.classList.remove('hidden');
      timerContainer.classList.add('hidden');
      if (dataSemanaLinha) {
        dataSemanaLinha.classList.remove('hidden');
        console.log('Data/Semana mostrada');
      }
      if (weatherWidget) {
        weatherWidget.classList.remove('hidden');
        console.log('Weather widget mostrado');
      }
      btnClock.classList.add('active');
      btnTimer.classList.remove('active');

      // Salva preferência
      localStorage.setItem('displayMode', 'clock');
    }
  }

  /**
   * Inicia monitoramento contínuo do timer
   */
  function startTimerMonitoring() {
    if (timerUpdateInterval) return; // Já está rodando

    timerUpdateInterval = setInterval(() => {
      updateTimerUI();
    }, 1000); // Atualiza a cada segundo
  }

  /**
   * Para monitoramento
   */
  function stopTimerMonitoring() {
    if (timerUpdateInterval) {
      clearInterval(timerUpdateInterval);
      timerUpdateInterval = null;
    }
  }

  /**
   * Inicializa timer UI
   */
  function initTimerUI() {
    // Gera barras SVG
    generateTimerBars();

    // Carrega preferência de exibição (relógio ou timer)
    const displayMode = localStorage.getItem('displayMode') || 'clock';
    setDisplayMode(displayMode);

    // Se timer estava ativo, continua monitorando
    if (window.KindleTimer) {
      const state = window.KindleTimer.getState();
      if (state.isActive) {
        startTimerMonitoring();
        // Se timer está ativo, muda automaticamente para modo timer
        setDisplayMode('timer');
      }
    }

    // Atualiza UI inicial
    updateTimerUI();

    // Listener para Enter no input customizado
    const customInput = document.getElementById('customMinutes');
    if (customInput) {
      customInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          startCustomTimer();
        }
      });
    }
  }

  // ====== INICIALIZAÇÃO ======
  carregarPreferencias();
  carregarEventos(); // Carregar eventos do Google Calendar
  atualizar();

  // Inicializa timer UI quando KindleTimer estiver disponível
  if (window.KindleTimer) {
    initTimerUI();
  } else {
    // Aguarda timer.js carregar
    setTimeout(() => {
      if (window.KindleTimer) {
        initTimerUI();
      }
    }, 100);
  }

  // Atualizar a cada minuto
  setInterval(atualizar, 60000);

  // Atualizar contador a cada 30 segundos para contagem mais precisa
  setInterval(atualizarContador, 30000);

  // Recarregar eventos a cada 5 minutos
  setInterval(carregarEventos, 300000);
  </script>
</body>
</html>