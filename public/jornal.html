<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Bullet Journal - Pedro 2026</title>
    <style>
        :root {
            --background: #ffffff;
            --foreground: #09090b;
            --card: #ffffff;
            --primary: #18181b;
            --secondary: #f4f4f5;
            --muted-foreground: #71717a;
            --border: #e4e4e7;
            --radius: 0.75rem;
            --font-sans: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-size-base: 18px;
            --font-size-sm: 16px;
            --font-size-xs: 14px;
            --font-size-lg: 20px;
            --font-size-xl: 24px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; background-color: var(--background); color: var(--foreground); font-family: var(--font-sans); font-size: var(--font-size-base); line-height: 1.5; }
        .app-shell { display: flex; flex-direction: column; height: 100vh; }
        .app-header { border-bottom: 1px solid var(--border); padding: 12px 1.25rem; background: rgba(255,255,255,0.95); backdrop-filter: blur(8px); z-index: 50; flex-shrink: 0; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .header-date { font-size: var(--font-size-xl); font-weight: 700; text-transform:capitalize; cursor: pointer; padding: 4px 8px; border-radius: 0.5rem; }
        .header-date:active { background: var(--secondary); }
        .btn-icon { background: transparent; border: 1px solid var(--border); border-radius: 0.5rem; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .btn-icon:active { background: var(--secondary); transform: scale(0.96); }
        .nav-tabs { display: -webkit-box; display: flex; -webkit-flex-wrap: wrap; flex-wrap: wrap; -webkit-box-pack: center; justify-content: center; }
        .nav-tab { font-size: var(--font-size-sm); text-transform: uppercase; padding: 8px 14px; border: 1px solid var(--border); background: var(--secondary); cursor: pointer; border-radius: 0.5rem; font-weight: 500; margin-right: 6px; margin-bottom: 6px; }
        .nav-tab:active { transform: scale(0.96); }
        .nav-tab.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .main {flex: 1; overflow-y: auto; padding: 0.7rem; padding-bottom: 1rem; max-width: 700px; margin: 0 auto; width: 100%; }
        .card { background: var(--card); border-radius: var(--radius); padding: 0.75rem 0.5rem 0.5rem 0.5rem; }
        .card-title { font-size: var(--font-size-lg); font-weight: 700; border-bottom: 1px solid var(--secondary); padding-bottom: 10px; margin-bottom: 14px; display: flex; justify-content: space-between; align-items: center; }
        .btn { font-size: var(--font-size-sm); padding: 8px 16px; border: 1px solid var(--border); background: var(--secondary); cursor: pointer; border-radius: 0.5rem; font-weight: 500; }
        .btn:active { transform: scale(0.96); background: var(--border); }
        .btn-primary { background: var(--primary); color: #fff; border-color: var(--primary); }
        .special-day { background: var(--secondary); border: 1px solid var(--border); border-radius: 0.5rem; padding: 10px 14px; font-size: var(--font-size-sm); }
        .schedule-item { display: flex; padding: 8px 0; border-bottom: 1px dotted var(--border); }
        .schedule-time { width: 70px; font-size: var(--font-size-sm); color: var(--muted-foreground); flex-shrink: 0; }
        .schedule-event { flex: 1; }
        .schedule-event.special { font-weight: 600; }
        .habit-row { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px dotted var(--border); }
        .habit-name { flex: 1; }
        .habit-check { width: 36px; height: 36px; border: 2px solid var(--primary); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .habit-check.checked { background: var(--primary); color: #fff; }
        .tracker-table { width: 100%; border-collapse: collapse; font-size: var(--font-size-sm); table-layout: fixed; }
        .tracker-table th, .tracker-table td { border: 1px solid var(--border); padding: 8px; text-align: center; }
        .tracker-table th { background: var(--secondary); font-size: var(--font-size-xs); text-transform: uppercase; }
        .tracker-table .label { text-align: left; font-weight: 500; width: 25%; }
        .tracker-cell { cursor: pointer; min-width: 36px; height: 36px; }
        .tracker-cell.checked { background: var(--primary); color: #fff; }
        .tracker-cell.na { background: var(--secondary); color: var(--muted-foreground); }
        .month-calendar { display: table; width: 100%; border-collapse: collapse; }
        .month-row { display: table-row; }
        .month-cell { display: table-cell; border: 1px solid var(--border); width: 14.28%; height: 50px; text-align: center; vertical-align: top; padding: 4px; cursor: pointer; }
        .month-cell.header { background: var(--secondary); font-size: var(--font-size-xs); font-weight: 600; height: auto; padding: 8px 4px; }
        .month-cell.today { border: 3px solid var(--primary); font-weight: 700; background: var(--secondary); }
        .month-cell.selected { background: var(--primary); color: #fff; }
        .month-cell.special { background: #f5f5f5; }
        .month-cell.empty { background: #fafafa; }
        .month-cell.has-events { font-weight: 700; text-decoration: underline; }
        .entry { padding: 10px 0; border-bottom: 1px dotted var(--border); display: flex; align-items: flex-start; gap: 10px; }
        .entry-symbol { width: 24px; cursor: pointer; font-size: var(--font-size-lg); flex-shrink: 0; }
        .entry-text { flex: 1; }
        .entry-text.done { text-decoration: line-through; color: var(--muted-foreground); }
        .add-entry { margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--border); display: flex; gap: 8px; flex-wrap: wrap; }
        .add-entry input { flex: 1; min-width: 150px; padding: 10px 14px; border: 1px solid var(--border); border-radius: 0.5rem; font-size: var(--font-size-base); }
        .add-entry select { padding: 10px 14px; border: 1px solid var(--border); border-radius: 0.5rem; font-size: var(--font-size-base); }
        .index-item { padding: 14px 0; border-bottom: 1px dotted var(--border); cursor: pointer; }
        .index-item:active { background: var(--secondary); }
        .summary-box { text-align: center; padding: 16px; }
        .summary-percent { font-size: 2.5rem; font-weight: 700; }
        .summary-bar { height: 10px; background: var(--secondary); margin-top: 10px; border-radius: 5px; overflow: hidden; }
        .summary-fill { height: 100%; background: var(--primary); border-radius: 5px; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; }
        .modal-overlay.active { display: flex; align-items: center; justify-content: center; }
        .modal { background: #fff; border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; width: 90%; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        .modal-title { font-weight: 700; font-size: var(--font-size-lg); margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; font-size: var(--font-size-xs); text-transform: uppercase; color: var(--muted-foreground); margin-bottom: 6px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: 0.5rem; font-size: var(--font-size-base); font-family: inherit; }
        .modal-actions { margin-top: 16px; display: flex; gap: 10px; justify-content: flex-end; }
        .study-check { width: 28px; height: 28px; border: 2px solid var(--border); border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .study-check.checked { background: var(--primary); color: #fff; border-color: var(--primary); }
        .future-month { margin-bottom: 16px; }
        .future-month-header { font-weight: 600; padding: 10px 14px; background: var(--primary); color: #fff; border-radius: 0.5rem 0.5rem 0 0; text-transform: capitalize; }
        .future-month-content { padding: 10px 14px; border: 1px solid var(--border); border-top: none; border-radius: 0 0 0.5rem 0.5rem; min-height: 50px; }
        .note-item { padding: 14px; border: 1px solid var(--border); border-radius: 0.5rem; margin-bottom: 12px; }
        .note-date { font-size: var(--font-size-xs); color: var(--muted-foreground); margin-bottom: 6px; }
        .note-type { display: inline-block; font-size: var(--font-size-xs); padding: 2px 8px; background: var(--secondary); border-radius: 4px; margin-right: 8px; }
        /* Leituras */
        .nav-tab.leituras { background: var(--secondary); border-color: var(--border); }
        .nav-tab.leituras.active { background: var(--primary); color: #fff; }
        .reading-card { border-left: 4px solid var(--primary); }
        .reading-card.noturna { background: var(--secondary); }
        .reading-progress { display: -webkit-box; display: flex; -webkit-box-align: center; align-items: center; margin: 10px 0; }
        .reading-progress-bar { -webkit-box-flex: 1; flex: 1; height: 12px; background: var(--secondary); border-radius: 6px; overflow: hidden; margin-right: 10px; }
        .reading-progress-fill { height: 100%; border-radius: 6px; background: var(--primary); }
        .reading-percent { font-weight: 700; min-width: 50px; text-align: right; }
        .reading-meta { font-size: var(--font-size-xs); color: var(--muted-foreground); }
        .reading-input { width: 80px; padding: 6px 10px; border: 1px solid var(--border); border-radius: 0.5rem; text-align: center; }
        .stats-grid { display: -webkit-box; display: flex; -webkit-flex-wrap: wrap; flex-wrap: wrap; }
        .stat-box { text-align: center; padding: 16px; background: var(--secondary); border-radius: var(--radius); width: 48%; margin-right: 2%; margin-bottom: 12px; }
        .stat-value { font-size: 1.8rem; font-weight: 700; }
        .stat-label { font-size: var(--font-size-xs); color: var(--muted-foreground); text-transform: uppercase; }
        .book-type { font-size: var(--font-size-xs); padding: 2px 8px; border-radius: 4px; font-weight: 600; background: #ccc; color: #333; }
        .book-type.espiritual { background: #4a5568; color: #fff; }
        .book-type.cultural { background: #718096; color: #fff; }
        /* Reading Grid Layout */
        .reading-grid { display: flex; gap: 16px; }
        .reading-col-left { flex: 1.2; }
        .reading-col-right { flex: 0.8; }
        .reading-col-title { font-size: var(--font-size-lg); font-weight: 700; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid var(--primary); }
        .reading-book-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px; margin-bottom: 12px; }
        .reading-book-card .book-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .reading-book-card .book-title { font-weight: 700; font-size: var(--font-size-base); }
        .reading-book-card .book-author { font-size: var(--font-size-sm); color: var(--muted-foreground); }
        .reading-book-card .book-pages { font-size: var(--font-size-xs); color: var(--muted-foreground); }
        .reading-book-card .book-meta { font-size: var(--font-size-xs); color: var(--muted-foreground); margin-top: 4px; }
        .reading-book-card .week-goal { background: var(--secondary); padding: 8px 10px; border-radius: 6px; margin-top: 10px; font-size: var(--font-size-sm); }
        .reading-book-card .week-goal-complete { background: #dcfce7; border: 1px solid #22c55e; }
        .library-section { margin-bottom: 16px; }
        .library-section-title { font-size: var(--font-size-xs); text-transform: uppercase; color: var(--muted-foreground); font-weight: 600; margin-bottom: 8px; letter-spacing: 0.5px; }
        .library-item { padding: 10px 12px; background: var(--card); border: 1px solid var(--border); border-radius: 6px; margin-bottom: 6px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .library-item:active { background: var(--secondary); }
        .library-item .item-title { font-size: var(--font-size-sm); font-weight: 500; }
        .library-item .item-status { font-size: var(--font-size-xs); color: var(--muted-foreground); }
        @media (max-width: 600px) { .reading-grid { flex-direction: column; } }
        /* Week View */
        .week-grid { display: flex; flex-direction: column; }
        .week-row { display: flex; margin-bottom: 12px; }
        .week-day { flex: 1; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; min-height: 150px; }
        .week-day.weekend { flex: 1; min-height: 80px; }
        .week-day-header { font-weight: 700; font-size: var(--font-size-sm); text-transform: uppercase; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
        .week-day-header .day-number { background: var(--primary); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: var(--font-size-xs); }
        .week-day.today .week-day-header { border-bottom-color: #16a34a; }
        .week-day.today .week-day-header .day-number { background: #16a34a; }
        .week-entry { font-size: var(--font-size-xs); padding: 4px 0; border-bottom: 1px dotted var(--border); display: flex; gap: 6px; align-items: flex-start; }
        .week-entry:last-child { border-bottom: none; }
        .week-entry-symbol { flex-shrink: 0; }
        .week-entry-text { flex: 1; word-break: break-word; }
        .week-entry-text.done { text-decoration: line-through; color: var(--muted-foreground); }
        .week-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .week-nav-title { font-weight: 700; font-size: var(--font-size-lg); }
        .weekend-container { display: flex; flex-direction: column; flex: 1; gap: 8px; }
        /* Day View Buttons */
        .day-buttons-grid { display: flex; flex-direction: column; margin-top: 10px; }
        .day-btn { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; margin-bottom: 10px; background: var(--card); border: 2px solid var(--border); border-radius: var(--radius); cursor: pointer; font-size: var(--font-size-lg); font-weight: 600; transition: all 0.1s ease; }
        .day-btn:active { transform: scale(0.98); background: var(--secondary); }
        .day-btn-icon { font-size: 1.5rem; margin-right: 12px; }
        .day-btn-label { flex: 1; text-align: left; }
        .day-btn-arrow { color: var(--muted-foreground); }
        .day-btn-badge { background: var(--primary); color: #fff; padding: 2px 10px; border-radius: 12px; font-size: var(--font-size-sm); margin-right: 8px; }
        /* Full Modal for Day Sections */
        .modal-full { background: #fff; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 101; overflow-y: auto; padding: 1rem; }
        .modal-full-header { display: flex; align-items: center; justify-content: space-between; padding: 7px 0; border-bottom: 2px solid var(--primary); margin-bottom: 16px; position: sticky; top: 0; background: #fff; z-index: 10; }
        .modal-full-title { font-size: var(--font-size-xl); font-weight: 700; }
        .modal-full-close { background: var(--secondary); border: 1px solid var(--border); border-radius: 0.5rem; padding: 10px 20px; font-size: var(--font-size-base); cursor: pointer; font-weight: 600; }
        .modal-full-close:active { background: var(--border); }
    </style>
</head>
<body>
<div class="app-shell">
    <header class="app-header">
        <div class="header-top">
            <div>
                <div class="header-date" id="header-date"></div>
            </div>
            <div style="display:flex;gap:8px;">
                <button class="btn-icon" onclick="forceSync()" title="Sincronizar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>
                </button>
                <button class="btn-icon" onclick="window.location.href='dashboard.html'">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                </button>
            </div>
        </div>
        <div class="nav-tabs" id="nav-tabs">
            <span class="nav-tab active" data-view="dia">Dia</span>
            <span class="nav-tab" data-view="semana">Semana</span>
            <span class="nav-tab" data-view="mes">Mês</span>
            <span class="nav-tab" data-view="plano">Plano</span>
            <span class="nav-tab leituras" data-view="leituras">Leituras</span>
            <span class="nav-tab" data-view="notas">Notas</span>
        </div>
    </header>
    <div class="main" id="main-content"></div>
</div>
<div class="modal-overlay" id="modal-overlay"><div class="modal" id="modal-content"></div></div>
<script>
var BuJo = {
    state: {
        currentView: 'dia',
        selectedDate: new Date(),
        entries: [],
        spiritualHabits: {},
        studyGoals: {},
        mortifications: {},
        projects: [],
        futureLog: [],
        notes: [],
        calendarEvents: [],
        readingProgress: { noturna: { currentPage: 0 }, currentWeek: 1, books: {} }
    },
    symbols: { task: '•', taskDone: '✕', taskMigrated: '→', event: '○', note: '–' },
    dailySpiritualHabits: [
        { id: 'serviam', name: 'Sérviam' },
        { id: 'preces', name: 'Preces' },
        { id: 'oracao-manha', name: 'Oração manhã' },
        { id: 'santa-missa', name: 'Santa Missa' },
        { id: 'leitura-espiritual', name: 'Leit. Espiritual' },
        { id: 'leitura-nt', name: 'Leitura NT' },
        { id: 'angelus', name: 'Angelus' },
        { id: 'visita-santissimo', name: 'Visita Santíssimo' },
        { id: 'lembrai-vos', name: 'Lembrai-vos' },
        { id: 'terco', name: 'Terço' },
        { id: 'oracao-tarde', name: 'Oração tarde' },
        { id: 'contemplacao', name: 'Contemplação' },
        { id: 'exame', name: 'Exame' },
        { id: '2-horas', name: '2 horas' },
        { id: '3-ave-marias', name: '3 Ave Marias' }
    ],
    weeklySpecialHabits: {
        2: [{ id: 'turno', name: 'Dia de Turno' }, { id: 'salmo-2', name: 'Salmo 2' }],
        3: [{ id: 'guarda', name: 'Dia de Guarda' }, { id: 'disciplina', name: 'Disciplina' }],
        4: [{ id: 'adoro-te', name: 'Adoro Te Devote' }],
        6: [{ id: 'oracao-nossa-senhora', name: 'Oração N. Senhora' }, { id: 'mortificacao-extra', name: 'Mortif. Extra' }]
    },
    studyGoalsList: [
        { id: 'latim', name: 'Latim', dailyGoal: 1, description: 'Gradus Primus - 1 lição', weekDays: [1, 2, 3, 4, 5] },
        { id: 'japones', name: 'Japonês', dailyGoal: 1, description: '1 sessão de estudo', weekDays: [0, 2, 3, 4] },
        { id: 'estatistica', name: 'Estatística', dailyGoal: 2, description: '2 blocos de estudo' },
        { id: 'tenis-mesa', name: 'Tênis Mesa', dailyGoal: 1, description: '1 treino', weekDays: [1, 5, 6] }
    ],
    readingPlan: {
        noturna: { titulo: 'Vida de Cristo', autor: 'Fulton Sheen', paginas: 1015 },
        cronograma: [
            { semana: 1, espiritual: { titulo: 'Cristianismo puro e simples', autor: 'C.S. Lewis', pInicio: 1, pFim: 58 }, secular: { titulo: 'Viagem a Alfa Centauri', autor: 'Michael D. O\'Brien', pInicio: 1, pFim: 122 }, bloco: 'Fundamentos da Fé' },
            { semana: 2, espiritual: { titulo: 'Cristianismo puro e simples', autor: 'C.S. Lewis', pInicio: 59, pFim: 116 }, secular: { titulo: 'Viagem a Alfa Centauri', autor: 'Michael D. O\'Brien', pInicio: 123, pFim: 244 }, bloco: 'Fundamentos da Fé' },
            { semana: 3, espiritual: { titulo: 'Cristianismo puro e simples', autor: 'C.S. Lewis', pInicio: 117, pFim: 174 }, secular: { titulo: 'Viagem a Alfa Centauri', autor: 'Michael D. O\'Brien', pInicio: 245, pFim: 366 }, bloco: 'Fundamentos da Fé' },
            { semana: 4, espiritual: { titulo: 'Cristianismo puro e simples', autor: 'C.S. Lewis', pInicio: 175, pFim: 232 }, secular: { titulo: 'Viagem a Alfa Centauri', autor: 'Michael D. O\'Brien', pInicio: 367, pFim: 488 }, bloco: 'Fundamentos da Fé' },
            { semana: 5, espiritual: { titulo: 'Cristianismo puro e simples', autor: 'C.S. Lewis', pInicio: 233, pFim: 288 }, secular: { titulo: 'Viagem a Alfa Centauri', autor: 'Michael D. O\'Brien', pInicio: 489, pFim: 608 }, bloco: 'Fundamentos da Fé' },
            { semana: 6, espiritual: { titulo: 'Cartas de um diabo a seu aprendiz', autor: 'C.S. Lewis', pInicio: 1, pFim: 42 }, secular: { titulo: 'Memórias póstumas de Brás Cubas', autor: 'Machado de Assis', pInicio: 1, pFim: 66 }, bloco: 'Fundamentos da Fé' },
            { semana: 7, espiritual: { titulo: 'Cartas de um diabo a seu aprendiz', autor: 'C.S. Lewis', pInicio: 43, pFim: 84 }, secular: { titulo: 'Memórias póstumas de Brás Cubas', autor: 'Machado de Assis', pInicio: 67, pFim: 132 }, bloco: 'Fundamentos da Fé' },
            { semana: 8, espiritual: { titulo: 'Cartas de um diabo a seu aprendiz', autor: 'C.S. Lewis', pInicio: 85, pFim: 126 }, secular: { titulo: 'Memórias póstumas de Brás Cubas', autor: 'Machado de Assis', pInicio: 133, pFim: 198 }, bloco: 'Fundamentos da Fé' },
            { semana: 9, espiritual: { titulo: 'Cartas de um diabo a seu aprendiz', autor: 'C.S. Lewis', pInicio: 127, pFim: 168 }, secular: { titulo: 'Memórias póstumas de Brás Cubas', autor: 'Machado de Assis', pInicio: 199, pFim: 264 }, bloco: 'Fundamentos da Fé' },
            { semana: 10, espiritual: { titulo: 'Cartas de um diabo a seu aprendiz', autor: 'C.S. Lewis', pInicio: 169, pFim: 208 }, secular: { titulo: 'Memórias póstumas de Brás Cubas', autor: 'Machado de Assis', pInicio: 265, pFim: 332 }, bloco: 'Fundamentos da Fé' },
            { semana: 11, espiritual: { titulo: 'A abolição do homem', autor: 'C.S. Lewis', pInicio: 1, pFim: 26 }, secular: { titulo: 'Fundamentos de antropologia', autor: 'Ricardo Yepes Stork', pInicio: 1, pFim: 76 }, bloco: 'Pessoa e Antropologia' },
            { semana: 12, espiritual: { titulo: 'A abolição do homem', autor: 'C.S. Lewis', pInicio: 27, pFim: 52 }, secular: { titulo: 'Fundamentos de antropologia', autor: 'Ricardo Yepes Stork', pInicio: 77, pFim: 152 }, bloco: 'Pessoa e Antropologia' },
            { semana: 13, espiritual: { titulo: 'A abolição do homem', autor: 'C.S. Lewis', pInicio: 53, pFim: 78 }, secular: { titulo: 'Fundamentos de antropologia', autor: 'Ricardo Yepes Stork', pInicio: 153, pFim: 228 }, bloco: 'Pessoa e Antropologia' },
            { semana: 14, espiritual: { titulo: 'A abolição do homem', autor: 'C.S. Lewis', pInicio: 79, pFim: 104 }, secular: { titulo: 'Fundamentos de antropologia', autor: 'Ricardo Yepes Stork', pInicio: 229, pFim: 304 }, bloco: 'Pessoa e Antropologia' },
            { semana: 15, espiritual: { titulo: 'A abolição do homem', autor: 'C.S. Lewis', pInicio: 105, pFim: 128 }, secular: { titulo: 'Fundamentos de antropologia', autor: 'Ricardo Yepes Stork', pInicio: 305, pFim: 380 }, bloco: 'Pessoa e Antropologia' },
            { semana: 16, espiritual: { titulo: 'Confissões de um Converso', autor: 'Robert H. Benson', pInicio: 1, pFim: 45 }, secular: { titulo: 'Personalismo', autor: 'Emmanuel Mounier', pInicio: 1, pFim: 46 }, bloco: 'Pessoa e Antropologia' },
            { semana: 17, espiritual: { titulo: 'Confissões de um Converso', autor: 'Robert H. Benson', pInicio: 46, pFim: 90 }, secular: { titulo: 'Personalismo', autor: 'Emmanuel Mounier', pInicio: 47, pFim: 92 }, bloco: 'Pessoa e Antropologia' },
            { semana: 18, espiritual: { titulo: 'Confissões de um Converso', autor: 'Robert H. Benson', pInicio: 91, pFim: 136 }, secular: { titulo: 'Personalismo', autor: 'Emmanuel Mounier', pInicio: 93, pFim: 139 }, bloco: 'Pessoa e Antropologia' },
            { semana: 19, espiritual: { titulo: 'Gabriel Marcel e Edith Stein', autor: 'Urbano Zilles', pInicio: 1, pFim: 32 }, secular: { titulo: 'A antropologia personalista de Mounier', autor: 'A.J. Severino', pInicio: 1, pFim: 53 }, bloco: 'Pessoa e Antropologia' },
            { semana: 20, espiritual: { titulo: 'Gabriel Marcel e Edith Stein', autor: 'Urbano Zilles', pInicio: 33, pFim: 64 }, secular: { titulo: 'A antropologia personalista de Mounier', autor: 'A.J. Severino', pInicio: 54, pFim: 106 }, bloco: 'Pessoa e Antropologia' },
            { semana: 21, espiritual: { titulo: 'Gabriel Marcel e Edith Stein', autor: 'Urbano Zilles', pInicio: 65, pFim: 94 }, secular: { titulo: 'A antropologia personalista de Mounier', autor: 'A.J. Severino', pInicio: 107, pFim: 158 }, bloco: 'Pessoa e Antropologia' },
            { semana: 22, espiritual: { titulo: 'As Moradas do Castelo Interior', autor: 'Sta. Teresa d Ávila', pInicio: 1, pFim: 64 }, secular: { titulo: 'Mapa do mundo pessoal', autor: 'Julián Marías', pInicio: 1, pFim: 37 }, bloco: 'Vida Interior I' },
            { semana: 23, espiritual: { titulo: 'As Moradas do Castelo Interior', autor: 'Sta. Teresa d Ávila', pInicio: 65, pFim: 128 }, secular: { titulo: 'Mapa do mundo pessoal', autor: 'Julián Marías', pInicio: 38, pFim: 74 }, bloco: 'Vida Interior I' },
            { semana: 24, espiritual: { titulo: 'As Moradas do Castelo Interior', autor: 'Sta. Teresa d Ávila', pInicio: 129, pFim: 192 }, secular: { titulo: 'Mapa do mundo pessoal', autor: 'Julián Marías', pInicio: 75, pFim: 111 }, bloco: 'Vida Interior I' },
            { semana: 25, espiritual: { titulo: 'As Moradas do Castelo Interior', autor: 'Sta. Teresa d Ávila', pInicio: 193, pFim: 254 }, secular: { titulo: 'Mapa do mundo pessoal', autor: 'Julián Marías', pInicio: 112, pFim: 148 }, bloco: 'Vida Interior I' },
            { semana: 26, espiritual: { titulo: 'São Bernardo de Claraval', autor: 'Daniel-Rops', pInicio: 1, pFim: 32 }, secular: { titulo: 'A educação sentimental', autor: 'Julián Marías', pInicio: 1, pFim: 60 }, bloco: 'Vida Interior I' },
            { semana: 27, espiritual: { titulo: 'São Bernardo de Claraval', autor: 'Daniel-Rops', pInicio: 33, pFim: 64 }, secular: { titulo: 'A educação sentimental', autor: 'Julián Marías', pInicio: 61, pFim: 120 }, bloco: 'Vida Interior I' },
            { semana: 28, espiritual: { titulo: 'São Bernardo de Claraval', autor: 'Daniel-Rops', pInicio: 65, pFim: 96 }, secular: { titulo: 'A educação sentimental', autor: 'Julián Marías', pInicio: 121, pFim: 180 }, bloco: 'Vida Interior I' },
            { semana: 29, espiritual: { titulo: 'São Bernardo de Claraval', autor: 'Daniel-Rops', pInicio: 97, pFim: 128 }, secular: { titulo: 'A educação sentimental', autor: 'Julián Marías', pInicio: 181, pFim: 240 }, bloco: 'Vida Interior I' },
            { semana: 30, espiritual: { titulo: 'Introdução ao Cristianismo', autor: 'Joseph Ratzinger', pInicio: 1, pFim: 54 }, secular: { titulo: 'O mito do Papa de Hitler', autor: 'David G. Dalin', pInicio: 1, pFim: 45 }, bloco: 'Cristo e a História' },
            { semana: 31, espiritual: { titulo: 'Introdução ao Cristianismo', autor: 'Joseph Ratzinger', pInicio: 55, pFim: 108 }, secular: { titulo: 'O mito do Papa de Hitler', autor: 'David G. Dalin', pInicio: 46, pFim: 90 }, bloco: 'Cristo e a História' },
            { semana: 32, espiritual: { titulo: 'Introdução ao Cristianismo', autor: 'Joseph Ratzinger', pInicio: 109, pFim: 162 }, secular: { titulo: 'O mito do Papa de Hitler', autor: 'David G. Dalin', pInicio: 91, pFim: 135 }, bloco: 'Cristo e a História' },
            { semana: 33, espiritual: { titulo: 'Introdução ao Cristianismo', autor: 'Joseph Ratzinger', pInicio: 163, pFim: 216 }, secular: { titulo: 'O mito do Papa de Hitler', autor: 'David G. Dalin', pInicio: 136, pFim: 180 }, bloco: 'Cristo e a História' },
            { semana: 34, espiritual: { titulo: 'Introdução ao Cristianismo', autor: 'Joseph Ratzinger', pInicio: 217, pFim: 272 }, secular: { titulo: 'O mito do Papa de Hitler', autor: 'David G. Dalin', pInicio: 181, pFim: 224 }, bloco: 'Cristo e a História' },
            { semana: 35, espiritual: { titulo: 'Relatório sobre a fé', autor: 'Messori/Ratzinger', pInicio: 1, pFim: 54 }, secular: { titulo: 'Comunismo', autor: 'Jordán B. Genta', pInicio: 1, pFim: 40 }, bloco: 'Cristo e a História' },
            { semana: 36, espiritual: { titulo: 'Relatório sobre a fé', autor: 'Messori/Ratzinger', pInicio: 55, pFim: 108 }, secular: { titulo: 'Comunismo', autor: 'Jordán B. Genta', pInicio: 41, pFim: 80 }, bloco: 'Cristo e a História' },
            { semana: 37, espiritual: { titulo: 'Relatório sobre a fé', autor: 'Messori/Ratzinger', pInicio: 109, pFim: 162 }, secular: { titulo: 'Comunismo', autor: 'Jordán B. Genta', pInicio: 81, pFim: 120 }, bloco: 'Cristo e a História' },
            { semana: 38, espiritual: { titulo: 'Relatório sobre a fé', autor: 'Messori/Ratzinger', pInicio: 163, pFim: 216 }, secular: { titulo: 'Comunismo', autor: 'Jordán B. Genta', pInicio: 121, pFim: 160 }, bloco: 'Cristo e a História' },
            { semana: 39, espiritual: { titulo: 'Relatório sobre a fé', autor: 'Messori/Ratzinger', pInicio: 217, pFim: 272 }, secular: { titulo: 'Comunismo', autor: 'Jordán B. Genta', pInicio: 161, pFim: 200 }, bloco: 'Cristo e a História' },
            { semana: 40, espiritual: { titulo: 'A vida vale a pena ser vivida', autor: 'Fulton Sheen', pInicio: 1, pFim: 46 }, secular: { titulo: 'Dostoievski: Sementes da revolta', autor: 'Joseph Frank', pInicio: 1, pFim: 55 }, bloco: 'Literatura Russa I' },
            { semana: 41, espiritual: { titulo: 'A vida vale a pena ser vivida', autor: 'Fulton Sheen', pInicio: 47, pFim: 92 }, secular: { titulo: 'Dostoievski: Sementes da revolta', autor: 'Joseph Frank', pInicio: 56, pFim: 110 }, bloco: 'Literatura Russa I' },
            { semana: 42, espiritual: { titulo: 'A vida vale a pena ser vivida', autor: 'Fulton Sheen', pInicio: 93, pFim: 138 }, secular: { titulo: 'Dostoievski: Sementes da revolta', autor: 'Joseph Frank', pInicio: 111, pFim: 165 }, bloco: 'Literatura Russa I' },
            { semana: 43, espiritual: { titulo: 'A vida vale a pena ser vivida', autor: 'Fulton Sheen', pInicio: 139, pFim: 184 }, secular: { titulo: 'Dostoievski: Sementes da revolta', autor: 'Joseph Frank', pInicio: 166, pFim: 220 }, bloco: 'Literatura Russa I' },
            { semana: 44, espiritual: { titulo: 'A vida vale a pena ser vivida', autor: 'Fulton Sheen', pInicio: 185, pFim: 230 }, secular: { titulo: 'Dostoievski: Sementes da revolta', autor: 'Joseph Frank', pInicio: 221, pFim: 275 }, bloco: 'Literatura Russa I' },
            { semana: 45, espiritual: { titulo: 'A vida vale a pena ser vivida', autor: 'Fulton Sheen', pInicio: 231, pFim: 276 }, secular: { titulo: 'Dostoievski: Sementes da revolta', autor: 'Joseph Frank', pInicio: 276, pFim: 330 }, bloco: 'Literatura Russa I' },
            { semana: 46, espiritual: { titulo: 'A vida vale a pena ser vivida', autor: 'Fulton Sheen', pInicio: 277, pFim: 322 }, secular: { titulo: 'Dostoievski: Sementes da revolta', autor: 'Joseph Frank', pInicio: 331, pFim: 385 }, bloco: 'Literatura Russa I' },
            { semana: 47, espiritual: { titulo: 'A vida vale a pena ser vivida', autor: 'Fulton Sheen', pInicio: 323, pFim: 368 }, secular: { titulo: 'Dostoievski: Sementes da revolta', autor: 'Joseph Frank', pInicio: 386, pFim: 440 }, bloco: 'Literatura Russa I' },
            { semana: 48, espiritual: { titulo: 'A vida vale a pena ser vivida', autor: 'Fulton Sheen', pInicio: 369, pFim: 416 }, secular: { titulo: 'Dostoievski: Sementes da revolta', autor: 'Joseph Frank', pInicio: 441, pFim: 496 }, bloco: 'Literatura Russa I' },
            { semana: 49, espiritual: { titulo: 'Cartas de Amor de uma Santa', autor: 'Gianna B. Molla', pInicio: 1, pFim: 36 }, secular: { titulo: 'A última ao cadafalso', autor: 'Gertrud von le Fort', pInicio: 1, pFim: 48 }, bloco: 'Amor e Vocação' },
            { semana: 50, espiritual: { titulo: 'Cartas de Amor de uma Santa', autor: 'Gianna B. Molla', pInicio: 37, pFim: 72 }, secular: { titulo: 'A última ao cadafalso', autor: 'Gertrud von le Fort', pInicio: 49, pFim: 96 }, bloco: 'Amor e Vocação' },
            { semana: 51, espiritual: { titulo: 'Cartas de Amor de uma Santa', autor: 'Gianna B. Molla', pInicio: 73, pFim: 108 }, secular: { titulo: 'A última ao cadafalso', autor: 'Gertrud von le Fort', pInicio: 97, pFim: 144 }, bloco: 'Amor e Vocação' },
            { semana: 52, espiritual: { titulo: 'Cartas de Amor de uma Santa', autor: 'Gianna B. Molla', pInicio: 109, pFim: 144 }, secular: { titulo: 'A última ao cadafalso', autor: 'Gertrud von le Fort', pInicio: 145, pFim: 192 }, bloco: 'Amor e Vocação' },
            { semana: 53, espiritual: { titulo: 'Amor e responsabilidade', autor: 'Karol Wojtyla', pInicio: 1, pFim: 50 }, secular: { titulo: 'Otelo', autor: 'William Shakespeare', pInicio: 1, pFim: 47 }, bloco: 'Amor e Vocação' },
            { semana: 54, espiritual: { titulo: 'Amor e responsabilidade', autor: 'Karol Wojtyla', pInicio: 51, pFim: 100 }, secular: { titulo: 'Otelo', autor: 'William Shakespeare', pInicio: 48, pFim: 94 }, bloco: 'Amor e Vocação' },
            { semana: 55, espiritual: { titulo: 'Amor e responsabilidade', autor: 'Karol Wojtyla', pInicio: 101, pFim: 150 }, secular: { titulo: 'Otelo', autor: 'William Shakespeare', pInicio: 95, pFim: 141 }, bloco: 'Amor e Vocação' },
            { semana: 56, espiritual: { titulo: 'Amor e responsabilidade', autor: 'Karol Wojtyla', pInicio: 151, pFim: 200 }, secular: { titulo: 'Otelo', autor: 'William Shakespeare', pInicio: 142, pFim: 188 }, bloco: 'Amor e Vocação' },
            { semana: 57, espiritual: { titulo: 'Amor e responsabilidade', autor: 'Karol Wojtyla', pInicio: 201, pFim: 250 }, secular: { titulo: 'Otelo', autor: 'William Shakespeare', pInicio: 189, pFim: 235 }, bloco: 'Amor e Vocação' },
            { semana: 58, espiritual: { titulo: 'Amor e responsabilidade', autor: 'Karol Wojtyla', pInicio: 251, pFim: 300 }, secular: { titulo: 'Otelo', autor: 'William Shakespeare', pInicio: 236, pFim: 282 }, bloco: 'Amor e Vocação' },
            { semana: 59, espiritual: { titulo: 'Amor e responsabilidade', autor: 'Karol Wojtyla', pInicio: 301, pFim: 354 }, secular: { titulo: 'Otelo', autor: 'William Shakespeare', pInicio: 283, pFim: 328 }, bloco: 'Amor e Vocação' },
            { semana: 60, espiritual: { titulo: 'Caminhar com Jesus', autor: 'Álvaro del Portillo', pInicio: 1, pFim: 42 }, secular: { titulo: 'Dostoievski: Anos de provação', autor: 'Joseph Frank', pInicio: 1, pFim: 53 }, bloco: 'Literatura Russa II' },
            { semana: 61, espiritual: { titulo: 'Caminhar com Jesus', autor: 'Álvaro del Portillo', pInicio: 43, pFim: 84 }, secular: { titulo: 'Dostoievski: Anos de provação', autor: 'Joseph Frank', pInicio: 54, pFim: 106 }, bloco: 'Literatura Russa II' },
            { semana: 62, espiritual: { titulo: 'Caminhar com Jesus', autor: 'Álvaro del Portillo', pInicio: 85, pFim: 126 }, secular: { titulo: 'Dostoievski: Anos de provação', autor: 'Joseph Frank', pInicio: 107, pFim: 159 }, bloco: 'Literatura Russa II' },
            { semana: 63, espiritual: { titulo: 'Caminhar com Jesus', autor: 'Álvaro del Portillo', pInicio: 127, pFim: 168 }, secular: { titulo: 'Dostoievski: Anos de provação', autor: 'Joseph Frank', pInicio: 160, pFim: 212 }, bloco: 'Literatura Russa II' },
            { semana: 64, espiritual: { titulo: 'Caminhar com Jesus', autor: 'Álvaro del Portillo', pInicio: 169, pFim: 210 }, secular: { titulo: 'Dostoievski: Anos de provação', autor: 'Joseph Frank', pInicio: 213, pFim: 265 }, bloco: 'Literatura Russa II' },
            { semana: 65, espiritual: { titulo: 'Caminhar com Jesus', autor: 'Álvaro del Portillo', pInicio: 211, pFim: 252 }, secular: { titulo: 'Dostoievski: Anos de provação', autor: 'Joseph Frank', pInicio: 266, pFim: 318 }, bloco: 'Literatura Russa II' },
            { semana: 66, espiritual: { titulo: 'Caminhar com Jesus', autor: 'Álvaro del Portillo', pInicio: 253, pFim: 294 }, secular: { titulo: 'Dostoievski: Anos de provação', autor: 'Joseph Frank', pInicio: 319, pFim: 371 }, bloco: 'Literatura Russa II' },
            { semana: 67, espiritual: { titulo: 'Caminhar com Jesus', autor: 'Álvaro del Portillo', pInicio: 295, pFim: 336 }, secular: { titulo: 'Dostoievski: Anos de provação', autor: 'Joseph Frank', pInicio: 372, pFim: 424 }, bloco: 'Literatura Russa II' },
            { semana: 68, espiritual: { titulo: 'As cerejeiras em flor', autor: 'José Miguel Cejas', pInicio: 1, pFim: 41 }, secular: { titulo: 'Dostoievski: Efeitos da libertação', autor: 'Joseph Frank', pInicio: 1, pFim: 59 }, bloco: 'Literatura Russa II' },
            { semana: 69, espiritual: { titulo: 'As cerejeiras em flor', autor: 'José Miguel Cejas', pInicio: 42, pFim: 82 }, secular: { titulo: 'Dostoievski: Efeitos da libertação', autor: 'Joseph Frank', pInicio: 60, pFim: 118 }, bloco: 'Literatura Russa II' },
            { semana: 70, espiritual: { titulo: 'As cerejeiras em flor', autor: 'José Miguel Cejas', pInicio: 83, pFim: 123 }, secular: { titulo: 'Dostoievski: Efeitos da libertação', autor: 'Joseph Frank', pInicio: 119, pFim: 177 }, bloco: 'Literatura Russa II' },
            { semana: 71, espiritual: { titulo: 'As cerejeiras em flor', autor: 'José Miguel Cejas', pInicio: 124, pFim: 164 }, secular: { titulo: 'Dostoievski: Efeitos da libertação', autor: 'Joseph Frank', pInicio: 178, pFim: 236 }, bloco: 'Literatura Russa II' },
            { semana: 72, espiritual: { titulo: 'As cerejeiras em flor', autor: 'José Miguel Cejas', pInicio: 165, pFim: 205 }, secular: { titulo: 'Dostoievski: Efeitos da libertação', autor: 'Joseph Frank', pInicio: 237, pFim: 295 }, bloco: 'Literatura Russa II' },
            { semana: 73, espiritual: { titulo: 'As cerejeiras em flor', autor: 'José Miguel Cejas', pInicio: 206, pFim: 246 }, secular: { titulo: 'Dostoievski: Efeitos da libertação', autor: 'Joseph Frank', pInicio: 296, pFim: 354 }, bloco: 'Literatura Russa II' },
            { semana: 74, espiritual: { titulo: 'As cerejeiras em flor', autor: 'José Miguel Cejas', pInicio: 247, pFim: 287 }, secular: { titulo: 'Dostoievski: Efeitos da libertação', autor: 'Joseph Frank', pInicio: 355, pFim: 413 }, bloco: 'Literatura Russa II' },
            { semana: 75, espiritual: { titulo: 'As cerejeiras em flor', autor: 'José Miguel Cejas', pInicio: 288, pFim: 328 }, secular: { titulo: 'Dostoievski: Efeitos da libertação', autor: 'Joseph Frank', pInicio: 414, pFim: 472 }, bloco: 'Literatura Russa II' },
            { semana: 76, espiritual: { titulo: 'As cerejeiras em flor', autor: 'José Miguel Cejas', pInicio: 329, pFim: 368 }, secular: { titulo: 'Dostoievski: Efeitos da libertação', autor: 'Joseph Frank', pInicio: 473, pFim: 528 }, bloco: 'Literatura Russa II' },
            { semana: 77, espiritual: { titulo: 'A economia das parábolas', autor: 'Robert A. Sirico', pInicio: 1, pFim: 31 }, secular: { titulo: 'A Grande Depressão Americana', autor: 'Murray N. Rothbard', pInicio: 1, pFim: 63 }, bloco: 'Economia e Sociedade' },
            { semana: 78, espiritual: { titulo: 'A economia das parábolas', autor: 'Robert A. Sirico', pInicio: 32, pFim: 62 }, secular: { titulo: 'A Grande Depressão Americana', autor: 'Murray N. Rothbard', pInicio: 64, pFim: 126 }, bloco: 'Economia e Sociedade' },
            { semana: 79, espiritual: { titulo: 'A economia das parábolas', autor: 'Robert A. Sirico', pInicio: 63, pFim: 93 }, secular: { titulo: 'A Grande Depressão Americana', autor: 'Murray N. Rothbard', pInicio: 127, pFim: 189 }, bloco: 'Economia e Sociedade' },
            { semana: 80, espiritual: { titulo: 'A economia das parábolas', autor: 'Robert A. Sirico', pInicio: 94, pFim: 124 }, secular: { titulo: 'A Grande Depressão Americana', autor: 'Murray N. Rothbard', pInicio: 190, pFim: 252 }, bloco: 'Economia e Sociedade' },
            { semana: 81, espiritual: { titulo: 'A economia das parábolas', autor: 'Robert A. Sirico', pInicio: 125, pFim: 155 }, secular: { titulo: 'A Grande Depressão Americana', autor: 'Murray N. Rothbard', pInicio: 253, pFim: 315 }, bloco: 'Economia e Sociedade' },
            { semana: 82, espiritual: { titulo: 'A economia das parábolas', autor: 'Robert A. Sirico', pInicio: 156, pFim: 184 }, secular: { titulo: 'A Grande Depressão Americana', autor: 'Murray N. Rothbard', pInicio: 316, pFim: 378 }, bloco: 'Economia e Sociedade' },
            { semana: 83, espiritual: { titulo: 'Cristianismo e economia', autor: 'Élio E. Gasda', pInicio: 1, pFim: 45 }, secular: { titulo: 'Manual do Perfeito Idiota', autor: 'Mendoza et al.', pInicio: 1, pFim: 52 }, bloco: 'Economia e Sociedade' },
            { semana: 84, espiritual: { titulo: 'Cristianismo e economia', autor: 'Élio E. Gasda', pInicio: 46, pFim: 90 }, secular: { titulo: 'Manual do Perfeito Idiota', autor: 'Mendoza et al.', pInicio: 53, pFim: 104 }, bloco: 'Economia e Sociedade' },
            { semana: 85, espiritual: { titulo: 'Cristianismo e economia', autor: 'Élio E. Gasda', pInicio: 91, pFim: 135 }, secular: { titulo: 'Manual do Perfeito Idiota', autor: 'Mendoza et al.', pInicio: 105, pFim: 156 }, bloco: 'Economia e Sociedade' },
            { semana: 86, espiritual: { titulo: 'Cristianismo e economia', autor: 'Élio E. Gasda', pInicio: 136, pFim: 180 }, secular: { titulo: 'Manual do Perfeito Idiota', autor: 'Mendoza et al.', pInicio: 157, pFim: 208 }, bloco: 'Economia e Sociedade' },
            { semana: 87, espiritual: { titulo: 'Cristianismo e economia', autor: 'Élio E. Gasda', pInicio: 181, pFim: 225 }, secular: { titulo: 'Manual do Perfeito Idiota', autor: 'Mendoza et al.', pInicio: 209, pFim: 260 }, bloco: 'Economia e Sociedade' },
            { semana: 88, espiritual: { titulo: 'Cristianismo e economia', autor: 'Élio E. Gasda', pInicio: 226, pFim: 270 }, secular: { titulo: 'Manual do Perfeito Idiota', autor: 'Mendoza et al.', pInicio: 261, pFim: 312 }, bloco: 'Economia e Sociedade' },
            { semana: 89, espiritual: { titulo: 'Cristianismo e economia', autor: 'Élio E. Gasda', pInicio: 271, pFim: 312 }, secular: { titulo: 'Manual do Perfeito Idiota', autor: 'Mendoza et al.', pInicio: 313, pFim: 364 }, bloco: 'Economia e Sociedade' },
            { semana: 90, espiritual: { titulo: 'O que há de errado com o mundo', autor: 'G.K. Chesterton', pInicio: 1, pFim: 55 }, secular: { titulo: 'As ideias têm consequências', autor: 'Richard M. Weaver', pInicio: 1, pFim: 52 }, bloco: 'Pensamento e Cultura' },
            { semana: 91, espiritual: { titulo: 'O que há de errado com o mundo', autor: 'G.K. Chesterton', pInicio: 56, pFim: 110 }, secular: { titulo: 'As ideias têm consequências', autor: 'Richard M. Weaver', pInicio: 53, pFim: 104 }, bloco: 'Pensamento e Cultura' },
            { semana: 92, espiritual: { titulo: 'O que há de errado com o mundo', autor: 'G.K. Chesterton', pInicio: 111, pFim: 165 }, secular: { titulo: 'As ideias têm consequências', autor: 'Richard M. Weaver', pInicio: 105, pFim: 156 }, bloco: 'Pensamento e Cultura' },
            { semana: 93, espiritual: { titulo: 'O que há de errado com o mundo', autor: 'G.K. Chesterton', pInicio: 166, pFim: 218 }, secular: { titulo: 'As ideias têm consequências', autor: 'Richard M. Weaver', pInicio: 157, pFim: 208 }, bloco: 'Pensamento e Cultura' },
            { semana: 94, espiritual: { titulo: 'O Catecismo', autor: 'Fulton J. Sheen', pInicio: 1, pFim: 58 }, secular: { titulo: 'Dostoievski: Anos milagrosos', autor: 'Joseph Frank', pInicio: 1, pFim: 60 }, bloco: 'Literatura Russa III' },
            { semana: 95, espiritual: { titulo: 'O Catecismo', autor: 'Fulton J. Sheen', pInicio: 59, pFim: 116 }, secular: { titulo: 'Dostoievski: Anos milagrosos', autor: 'Joseph Frank', pInicio: 61, pFim: 120 }, bloco: 'Literatura Russa III' },
            { semana: 96, espiritual: { titulo: 'O Catecismo', autor: 'Fulton J. Sheen', pInicio: 117, pFim: 174 }, secular: { titulo: 'Dostoievski: Anos milagrosos', autor: 'Joseph Frank', pInicio: 121, pFim: 180 }, bloco: 'Literatura Russa III' },
            { semana: 97, espiritual: { titulo: 'O Catecismo', autor: 'Fulton J. Sheen', pInicio: 175, pFim: 232 }, secular: { titulo: 'Dostoievski: Anos milagrosos', autor: 'Joseph Frank', pInicio: 181, pFim: 240 }, bloco: 'Literatura Russa III' },
            { semana: 98, espiritual: { titulo: 'O Catecismo', autor: 'Fulton J. Sheen', pInicio: 233, pFim: 290 }, secular: { titulo: 'Dostoievski: Anos milagrosos', autor: 'Joseph Frank', pInicio: 241, pFim: 300 }, bloco: 'Literatura Russa III' },
            { semana: 99, espiritual: { titulo: 'O Catecismo', autor: 'Fulton J. Sheen', pInicio: 291, pFim: 348 }, secular: { titulo: 'Dostoievski: Anos milagrosos', autor: 'Joseph Frank', pInicio: 301, pFim: 360 }, bloco: 'Literatura Russa III' },
            { semana: 100, espiritual: { titulo: 'O Catecismo', autor: 'Fulton J. Sheen', pInicio: 349, pFim: 406 }, secular: { titulo: 'Dostoievski: Anos milagrosos', autor: 'Joseph Frank', pInicio: 361, pFim: 420 }, bloco: 'Literatura Russa III' },
            { semana: 101, espiritual: { titulo: 'O Catecismo', autor: 'Fulton J. Sheen', pInicio: 407, pFim: 464 }, secular: { titulo: 'Dostoievski: Anos milagrosos', autor: 'Joseph Frank', pInicio: 421, pFim: 480 }, bloco: 'Literatura Russa III' },
            { semana: 102, espiritual: { titulo: 'O Catecismo', autor: 'Fulton J. Sheen', pInicio: 465, pFim: 522 }, secular: { titulo: 'Dostoievski: Anos milagrosos', autor: 'Joseph Frank', pInicio: 481, pFim: 540 }, bloco: 'Literatura Russa III' },
            { semana: 103, espiritual: { titulo: 'O Catecismo', autor: 'Fulton J. Sheen', pInicio: 523, pFim: 580 }, secular: { titulo: 'Dostoievski: Anos milagrosos', autor: 'Joseph Frank', pInicio: 541, pFim: 600 }, bloco: 'Literatura Russa III' },
            { semana: 104, espiritual: { titulo: 'O Catecismo', autor: 'Fulton J. Sheen', pInicio: 581, pFim: 639 }, secular: { titulo: 'Dostoievski: Anos milagrosos', autor: 'Joseph Frank', pInicio: 601, pFim: 662 }, bloco: 'Literatura Russa III' }
        ]
    },
    dayNames: ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'],
    dayNamesShort: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb']
};

function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
function formatDateKey(date) {
    var d = new Date(date);
    return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}
function getMonthKey(date) { var d = new Date(date); return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0'); }
function getWeekDays(date) {
    var d = new Date(date);
    var start = new Date(d);
    start.setDate(d.getDate() - d.getDay());
    var days = [];
    for (var i = 0; i < 7; i++) {
        var day = new Date(start);
        day.setDate(start.getDate() + i);
        days.push(day);
    }
    return days;
}
function isToday(date) {
    var today = new Date();
    return date.getDate() === today.getDate() && date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear();
}
function isThirdSunday(date) { return date.getDay() === 0 && date.getDate() >= 15 && date.getDate() <= 21; }
function formatDateDisplay(date) { return date.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' }); }
function formatDateShort(date) { return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }); }

// ============= SISTEMA DE LOG DE EVENTOS =============
function getDeviceId() {
    var deviceId = localStorage.getItem('bujo-device-id');
    if (!deviceId) {
        deviceId = 'device-' + generateId();
        localStorage.setItem('bujo-device-id', deviceId);
    }
    return deviceId;
}

function recordEvent(type, payload, dateKey) {
    var event = {
        eventId: generateId(),
        app: 'jornal',
        deviceId: getDeviceId(),
        ts: new Date().toISOString(),
        type: type,
        dateKey: dateKey || null,
        payload: payload || {}
    };

    var queue = [];
    try {
        var saved = localStorage.getItem('bujo-event-queue');
        if (saved) queue = JSON.parse(saved);
    } catch(e) {}

    queue.push(event);
    localStorage.setItem('bujo-event-queue', JSON.stringify(queue));

    // Tentar flush se fila grande ou após 10 segundos
    if (queue.length >= 10) {
        flushEventQueue();
    } else {
        clearTimeout(window.eventFlushTimeout);
        window.eventFlushTimeout = setTimeout(flushEventQueue, 10000);
    }
}

async function flushEventQueue() {
    var queue = [];
    try {
        var saved = localStorage.getItem('bujo-event-queue');
        if (saved) queue = JSON.parse(saved);
    } catch(e) {}

    if (queue.length === 0) return;

    try {
        var response = await fetch('/api/log/batch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ events: queue })
        });

        if (response.ok) {
            var result = await response.json();
            console.log('Eventos enviados:', result.accepted, 'de', result.total);
            // Limpar apenas os eventos enviados com sucesso
            localStorage.setItem('bujo-event-queue', '[]');
        }
    } catch(e) {
        console.warn('Falha ao enviar eventos:', e.message);
    }
}

// Flush quando voltar online
if (typeof window !== 'undefined') {
    window.addEventListener('online', flushEventQueue);
}

// Debounce para evitar múltiplas chamadas de sync
var syncTimeout = null;
var lastSyncTime = 0;
var isSyncing = false;

function saveState() {
    try {
        localStorage.setItem('bujo-kindle-v2', JSON.stringify(BuJo.state));
    } catch(e){}

    // Sincronizar com nuvem (debounced - espera 2 segundos após última alteração)
    clearTimeout(syncTimeout);
    syncTimeout = setTimeout(syncToCloud, 2000);
}

async function syncToCloud() {
    if (isSyncing) return;
    isSyncing = true;

    try {
        var stateToSync = {
            entries: BuJo.state.entries,
            spiritualHabits: BuJo.state.spiritualHabits,
            studyGoals: BuJo.state.studyGoals,
            mortifications: BuJo.state.mortifications,
            projects: BuJo.state.projects,
            futureLog: BuJo.state.futureLog,
            notes: BuJo.state.notes,
            readingProgress: BuJo.state.readingProgress
        };

        var response = await fetch('/api/sync/jornal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(stateToSync)
        });

        if (response.ok) {
            var result = await response.json();
            var syncTime = result.timestamp ? new Date(result.timestamp).getTime() : Date.now();
            localStorage.setItem('bujo-kindle-v2-time', syncTime.toString());
            lastSyncTime = syncTime;
            console.log('✅ Jornal sincronizado com sucesso');
            showSyncStatus('Sincronizado!', 'success');
        }
    } catch(e) {
        console.warn('Falha ao sincronizar com nuvem:', e.message);
        showSyncStatus('Erro ao sincronizar', 'error');
    } finally {
        isSyncing = false;
    }
}

async function loadFromCloud() {
    try {
        var response = await fetch('/api/sync/jornal');
        if (response.ok) {
            var data = await response.json();
            if (data.state) {
                return data;
            }
        }
    } catch(e) {
        console.warn('Falha ao carregar da nuvem:', e.message);
    }
    return null;
}

function loadState() {
    try {
        var saved = localStorage.getItem('bujo-kindle-v2');
        if (saved) {
            var p = JSON.parse(saved);
            BuJo.state.entries = p.entries || [];
            BuJo.state.spiritualHabits = p.spiritualHabits || {};
            BuJo.state.studyGoals = p.studyGoals || {};
            BuJo.state.mortifications = p.mortifications || {};
            BuJo.state.projects = p.projects || [];
            BuJo.state.futureLog = p.futureLog || [];
            BuJo.state.notes = p.notes || [];
            BuJo.state.readingProgress = p.readingProgress || { noturna: { currentPage: 0 }, currentWeek: 1, books: {} };
            if (p.selectedDate) BuJo.state.selectedDate = new Date(p.selectedDate);
        }
    } catch(e){}
}

// ============= FUNÇÕES DE MERGE INTELIGENTE =============

// Merge de arrays por ID (entries, projects, futureLog, notes)
function mergeArraysById(local, cloud) {
    var map = new Map();
    // Adicionar itens locais primeiro
    (local || []).forEach(function(item) {
        if (item.id) map.set(item.id, item);
    });
    // Sobrescrever/adicionar itens da nuvem (mais recentes têm prioridade)
    (cloud || []).forEach(function(item) {
        if (item.id) {
            var existing = map.get(item.id);
            if (!existing) {
                map.set(item.id, item);
            } else {
                // Se ambos existem, manter o mais recente (baseado em updatedAt ou criação)
                var localTime = existing.updatedAt || existing.createdAt || 0;
                var cloudTime = item.updatedAt || item.createdAt || 0;
                if (cloudTime >= localTime) {
                    map.set(item.id, item);
                }
            }
        }
    });
    return Array.from(map.values());
}

// Merge de objetos por chave (spiritualHabits, studyGoals, mortifications - chave é a data)
function mergeObjectsByKey(local, cloud) {
    var result = {};
    // Copiar todas as chaves locais
    Object.keys(local || {}).forEach(function(key) {
        result[key] = local[key];
    });
    // Sobrescrever/adicionar chaves da nuvem
    Object.keys(cloud || {}).forEach(function(key) {
        if (!result[key]) {
            result[key] = cloud[key];
        } else {
            // Merge profundo para objetos aninhados (ex: spiritualHabits['2026-01-30'] = { serviam: true, ... })
            if (typeof cloud[key] === 'object' && typeof result[key] === 'object') {
                result[key] = Object.assign({}, result[key], cloud[key]);
            } else {
                result[key] = cloud[key];
            }
        }
    });
    return result;
}

// Merge de readingProgress
function mergeReadingProgress(local, cloud) {
    var result = {
        noturna: { currentPage: 0 },
        currentWeek: 1,
        books: {}
    };

    // Usar o maior valor de página/semana entre local e nuvem
    var localNoturna = (local && local.noturna && local.noturna.currentPage) || 0;
    var cloudNoturna = (cloud && cloud.noturna && cloud.noturna.currentPage) || 0;
    result.noturna.currentPage = Math.max(localNoturna, cloudNoturna);

    var localWeek = (local && local.currentWeek) || 1;
    var cloudWeek = (cloud && cloud.currentWeek) || 1;
    result.currentWeek = Math.max(localWeek, cloudWeek);

    // Merge de books - usar maior valor para cada livro
    var localBooks = (local && local.books) || {};
    var cloudBooks = (cloud && cloud.books) || {};
    var allBookKeys = new Set(Object.keys(localBooks).concat(Object.keys(cloudBooks)));
    allBookKeys.forEach(function(key) {
        result.books[key] = Math.max(localBooks[key] || 0, cloudBooks[key] || 0);
    });

    return result;
}

function showSyncStatus(message, type) {
    var existing = document.getElementById('sync-status-toast');
    if (existing) existing.remove();

    var toast = document.createElement('div');
    toast.id = 'sync-status-toast';
    toast.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:10px 20px;border-radius:8px;font-size:14px;z-index:9999;transition:opacity 0.3s;';
    toast.style.background = type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6';
    toast.style.color = '#fff';
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(function() {
        toast.style.opacity = '0';
        setTimeout(function() { toast.remove(); }, 300);
    }, 2000);
}

async function syncFromCloud() {
    showSyncStatus('Sincronizando...', 'info');

    var cloudData = await loadFromCloud();

    if (cloudData && cloudData.state) {
        var cloud = cloudData.state;

        // MERGE INTELIGENTE - combinar dados locais e da nuvem
        BuJo.state.entries = mergeArraysById(BuJo.state.entries, cloud.entries);
        BuJo.state.projects = mergeArraysById(BuJo.state.projects, cloud.projects);
        BuJo.state.futureLog = mergeArraysById(BuJo.state.futureLog, cloud.futureLog);
        BuJo.state.notes = mergeArraysById(BuJo.state.notes, cloud.notes);

        BuJo.state.spiritualHabits = mergeObjectsByKey(BuJo.state.spiritualHabits, cloud.spiritualHabits);
        BuJo.state.studyGoals = mergeObjectsByKey(BuJo.state.studyGoals, cloud.studyGoals);
        BuJo.state.mortifications = mergeObjectsByKey(BuJo.state.mortifications, cloud.mortifications);

        BuJo.state.readingProgress = mergeReadingProgress(BuJo.state.readingProgress, cloud.readingProgress);

        // Salvar localmente o resultado do merge
        localStorage.setItem('bujo-kindle-v2', JSON.stringify(BuJo.state));

        console.log('✅ Dados merged com sucesso');
        render();

        // Enviar o resultado do merge de volta para a nuvem (para outros dispositivos)
        await syncToCloud();
    } else {
        // Nuvem vazia - enviar dados locais para a nuvem
        console.log('Nuvem vazia, enviando dados locais...');
        await syncToCloud();
    }
}

// Função para forçar sincronização manual
async function forceSync() {
    showSyncStatus('Forçando sincronização...', 'info');
    await syncFromCloud();
}

async function loadCalendarEvents() {
    try {
        var API_URL = window.location.origin;
        var response = await fetch(API_URL + '/api/calendar/events?days=60');
        if (response.ok) BuJo.state.calendarEvents = await response.json();
        else BuJo.state.calendarEvents = [];
    } catch(e) { BuJo.state.calendarEvents = []; }
    render();
}

function getEventsForDate(dateStr) {
    var events = [];
    for (var i = 0; i < BuJo.state.calendarEvents.length; i++) {
        var ev = BuJo.state.calendarEvents[i];
        if (ev.start.date && ev.start.date === dateStr) {
            events.push({ ...ev, allDay: true });
        } else if (ev.start.dateTime) {
            var rd = new Date(ev.start.dateTime);
            rd.setHours(rd.getHours() - 3);
            if (formatDateKey(rd) === dateStr) {
                events.push({ ...ev, allDay: false, startTime: rd.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) });
            }
        }
    }
    events.sort(function(a,b) { return a.allDay && !b.allDay ? -1 : !a.allDay && b.allDay ? 1 : (a.startTime||'').localeCompare(b.startTime||''); });
    return events;
}

function init() { loadState(); updateHeaderDate(); bindNavEvents(); loadCalendarEvents(); syncFromCloud(); }
function updateHeaderDate() {
    var headerDate = document.getElementById('header-date');
    headerDate.textContent = new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    headerDate.onclick = function() { goToToday(); };
}
function bindNavEvents() {
    document.getElementById('nav-tabs').onclick = function(e) {
        if (e.target.className.indexOf('nav-tab') !== -1) setView(e.target.getAttribute('data-view'));
    };
    document.getElementById('modal-overlay').onclick = function(e) { if (e.target.id === 'modal-overlay') closeModal(); };
}
function setView(view) {
    BuJo.state.currentView = view;
    document.querySelectorAll('.nav-tab').forEach(function(t) {
        var isLeituras = t.getAttribute('data-view') === 'leituras';
        var isActive = t.getAttribute('data-view') === view;
        t.className = 'nav-tab' + (isLeituras ? ' leituras' : '') + (isActive ? ' active' : '');
    });
    render();
}

function render() {
    var main = document.getElementById('main-content');
    var view = BuJo.state.currentView;
    if (view === 'dia') main.innerHTML = renderDayView();
    else if (view === 'semana') main.innerHTML = renderWeekView();
    else if (view === 'mes') main.innerHTML = renderMonthView();
    else if (view === 'plano') main.innerHTML = renderPlanoVida();
    else if (view === 'leituras') main.innerHTML = renderLeituras();
    else if (view === 'notas') main.innerHTML = renderNotas();
    bindViewEvents();
}

function bindViewEvents() {
    var prevDate = document.getElementById('prev-date');
    var nextDate = document.getElementById('next-date');
    var prevWeek = document.getElementById('prev-week');
    var nextWeek = document.getElementById('next-week');
    var prevMonth = document.getElementById('prev-month');
    var nextMonth = document.getElementById('next-month');
    var todayBtn = document.getElementById('today-btn');
    if (prevDate) prevDate.onclick = function() { navigateDate(-1); };
    if (nextDate) nextDate.onclick = function() { navigateDate(1); };
    if (prevWeek) prevWeek.onclick = function() { navigateWeek(-1); };
    if (nextWeek) nextWeek.onclick = function() { navigateWeek(1); };
    if (prevMonth) prevMonth.onclick = function() { navigateMonth(-1); };
    if (nextMonth) nextMonth.onclick = function() { navigateMonth(1); };
    if (todayBtn) todayBtn.onclick = function() { goToToday(); };
    
    document.querySelectorAll('.spiritual-check').forEach(function(el) {
        el.onclick = function() { toggleSpiritualHabit(el.getAttribute('data-habit'), el.getAttribute('data-date')); };
    });
    document.querySelectorAll('.study-check').forEach(function(el) {
        el.onclick = function() { toggleStudyGoal(el.getAttribute('data-habit'), el.getAttribute('data-date'), parseInt(el.getAttribute('data-index'))); };
    });
    document.querySelectorAll('.mort-check').forEach(function(el) {
        el.onclick = function() { toggleMortification(el.getAttribute('data-date'), parseInt(el.getAttribute('data-index'))); };
    });
    
    var addEntryBtn = document.getElementById('add-entry-btn');
    var addEntryInput = document.getElementById('add-entry-input');
    if (addEntryBtn) addEntryBtn.onclick = addEntry;
    if (addEntryInput) addEntryInput.onkeypress = function(e) { if (e.key === 'Enter') addEntry(); };
    
    document.querySelectorAll('.entry-symbol[data-id]').forEach(function(el) {
        el.onclick = function() { cycleEntrySymbol(el.getAttribute('data-id')); };
    });
    document.querySelectorAll('.entry-edit').forEach(function(el) {
        el.onclick = function() { showEditEntryModal(el.getAttribute('data-id')); };
    });
    document.querySelectorAll('.event-clickable').forEach(function(el) {
        el.onclick = function() { showEventDetails(el.getAttribute('data-event-date'), parseInt(el.getAttribute('data-event-idx'))); };
    });
    
    var addMortBtn = document.getElementById('add-mort-btn');
    var addProjectBtn = document.getElementById('add-project-btn');
    var addFutureBtn = document.getElementById('add-future-btn');
    var addNoteBtn = document.getElementById('add-note-btn');
    var saveNotesBtn = document.getElementById('save-notes-btn');
    if (addMortBtn) addMortBtn.onclick = showAddMortModal;
    if (addProjectBtn) addProjectBtn.onclick = showAddProjectModal;
    if (addFutureBtn) addFutureBtn.onclick = showAddFutureModal;
    if (addNoteBtn) addNoteBtn.onclick = showAddNoteModal;
    if (saveNotesBtn) saveNotesBtn.onclick = saveAllNotes;
    
    document.querySelectorAll('.month-cell[data-date]').forEach(function(el) {
        el.onclick = function() { selectMonthDay(el.getAttribute('data-date')); };
        el.ondblclick = function() { BuJo.state.selectedDate = new Date(el.getAttribute('data-date') + 'T12:00:00'); setView('dia'); };
    });
    document.querySelectorAll('.index-item[data-view]').forEach(function(el) {
        el.onclick = function() { setView(el.getAttribute('data-view')); };
    });
}

function renderDayView() {
    var date = BuJo.state.selectedDate;
    var dateStr = formatDateKey(date);
    var dow = date.getDay();
    var specialHabits = BuJo.weeklySpecialHabits[dow] || [];
    var thirdSunday = isThirdSunday(date);
    var dayEntries = BuJo.state.entries.filter(function(e) { return e.date === dateStr; });
    var calendarEvents = getEventsForDate(dateStr);
    var todayBadge = isToday(date) ? ' <span style="background:var(--primary);color:#fff;padding:4px 10px;font-size:0.8rem;border-radius:4px;margin-left:8px;">HOJE</span>' : '';

    // Contadores para badges
    var entriesCount = dayEntries.length;
    var eventsCount = calendarEvents.length;
    var dayHabits = BuJo.state.spiritualHabits[dateStr] || {};
    var habitsChecked = 0;
    var habitsTotal = BuJo.dailySpiritualHabits.length;
    BuJo.dailySpiritualHabits.forEach(function(h) { if (dayHabits[h.id]) habitsChecked++; });
    var morts = BuJo.state.mortifications[dateStr] || [];
    var mortsCount = morts.length;

    // Verifica se o dia possui conteúdo especial
    var hasSpecial = specialHabits.length > 0 || thirdSunday;
    var titleStyle = hasSpecial ? '' : ' style="border-bottom:none;margin-bottom:0;padding-bottom:0;"';

    // Encontrar evento atual ou próximo
    var currentOrNextEvent = getCurrentOrNextEvent(calendarEvents);

    // Encontrar registro estrela
    var starEntry = dayEntries.find(function(e) { return e.starred; });

    // Obter resumo de leituras
    var readingSummary = getReadingSummary();

    var html = '<div class="card">';
    html += '<div class="card-title"' + titleStyle + '><span class="btn" id="prev-date" style="line-height:1;"><img src="/icones/seta.png" style="transform:rotate(180deg);width:20px;height:20px;"></span>';
    html += '<span style="flex:1;text-align:center;text-transform:capitalize;">' + formatDateDisplay(date) + todayBadge + '</span>';
    html += '<span class="btn" id="next-date" style="line-height:1;"><img src="/icones/seta.png" style="width:20px;height:20px;"></span></div>';

    if (hasSpecial) {
        html += '<div class="special-day"><strong>★ Especial:</strong> ';
        var sp = specialHabits.map(function(h) { return h.name; });
        if (thirdSunday) sp.push('Sýmbolum Athanasiánum');
        html += sp.join(' • ') + '</div>';
    }
    html += '</div>';

    // Botões
    html += '<div class="day-buttons-grid">';

    // EVENTOS
    html += '<div class="day-btn" onclick="openDaySection(\'eventos\')">';
    html += '<div style="flex:1;"><div class="day-btn-label">Eventos</div>';
    if (currentOrNextEvent) {
        html += '<div style="font-size:var(--font-size-xs);color:var(--muted-foreground);margin-top:2px;">' + currentOrNextEvent + '</div>';
    }
    html += '</div>';
    if (eventsCount > 0) html += '<span class="day-btn-badge">' + eventsCount + '</span>';
    html += '</div>';

    // REGISTROS
    html += '<div class="day-btn" onclick="openDaySection(\'registros\')">';
    html += '<div style="flex:1;"><div class="day-btn-label">Registros</div>';
    if (starEntry) {
        html += '<div style="font-size:var(--font-size-xs);color:var(--muted-foreground);margin-top:2px;">★ ' + starEntry.text.substring(0, 30) + (starEntry.text.length > 30 ? '...' : '') + '</div>';
    }
    html += '</div>';
    if (entriesCount > 0) html += '<span class="day-btn-badge">' + entriesCount + '</span>';
    html += '</div>';

    // PLANO DE VIDA
    html += '<div class="day-btn" onclick="openDaySection(\'plano\')">';
    html += '<span class="day-btn-label">Plano de Vida</span>';
    html += '<span class="day-btn-badge">' + habitsChecked + '/' + habitsTotal + '</span>';
    html += '</div>';

    // MORTIFICAÇÕES
    html += '<div class="day-btn" onclick="openDaySection(\'mortificacoes\')">';
    html += '<span class="day-btn-label">Mortificações</span>';
    if (mortsCount > 0) html += '<span class="day-btn-badge">' + mortsCount + '</span>';
    html += '</div>';

    // LEITURAS DO DIA
    html += '<div class="day-btn" onclick="openDaySection(\'leituras\')">';
    html += '<div style="flex:1;"><div class="day-btn-label">Leituras do Dia</div>';
    if (readingSummary) {
        html += '<div style="font-size:var(--font-size-xs);color:var(--muted-foreground);margin-top:2px;">' + readingSummary + '</div>';
    }
    html += '</div>';
    html += '</div>';

    // EXAME DE CONSCIÊNCIA
    html += '<div class="day-btn" onclick="openDaySection(\'exame\')" style="background:var(--secondary);border-color:var(--primary);">';
    html += '<span class="day-btn-label">Exame de Consciência</span>';
    html += '</div>';

    html += '</div>';
    return html;
}

function getCurrentOrNextEvent(events) {
    if (!events || events.length === 0) return null;
    var now = new Date();
    var currentHour = now.getHours();
    var currentMin = now.getMinutes();
    var currentTime = currentHour * 60 + currentMin;

    for (var i = 0; i < events.length; i++) {
        var ev = events[i];
        if (ev.allDay) return ev.summary;
        if (ev.startTime) {
            var parts = ev.startTime.split(':');
            var evTime = parseInt(parts[0]) * 60 + parseInt(parts[1]);
            if (evTime >= currentTime - 60) { // evento atual ou próximo (dentro de 1h)
                return (evTime <= currentTime ? 'Agora: ' : '') + ev.summary;
            }
        }
    }
    return events[0].summary; // retorna o primeiro se nenhum for atual
}

function getReadingSummary() {
    var cw = BuJo.state.readingProgress.currentWeek || 1;
    var wd = BuJo.readingPlan.cronograma.find(function(w) { return w.semana === cw; });
    if (!wd) return null;

    var ek = 'sem' + cw + '_esp', sk = 'sem' + cw + '_sec';
    var ep = BuJo.state.readingProgress.books[ek] || 0, sp = BuJo.state.readingProgress.books[sk] || 0;
    var et = wd.espiritual.pFim - wd.espiritual.pInicio + 1, st = wd.secular.pFim - wd.secular.pInicio + 1;
    var ePct = Math.round((ep / et) * 100), sPct = Math.round((sp / st) * 100);

    return 'Esp: ' + ePct + '% · Cul: ' + sPct + '%';
}

function renderDaySpiritualHabits(dateStr, dow, thirdSunday) {
    var dayHabits = BuJo.state.spiritualHabits[dateStr] || {};
    var specialHabits = BuJo.weeklySpecialHabits[dow] || [];
    var html = '<div style="display:-webkit-box;display:flex;-webkit-flex-wrap:wrap;flex-wrap:wrap;">';
    BuJo.dailySpiritualHabits.forEach(function(h) {
        var checked = dayHabits[h.id] || false;
        html += '<div class="habit-row" style="width:50%;-webkit-box-sizing:border-box;box-sizing:border-box;padding-right:8px;"><span class="habit-name">' + h.name + '</span>';
        html += '<span class="habit-check spiritual-check' + (checked ? ' checked' : '') + '" data-habit="' + h.id + '" data-date="' + dateStr + '">' + (checked ? '✓' : '') + '</span></div>';
    });
    html += '</div>';
    if (specialHabits.length > 0) {
        html += '<div style="margin-top:14px;padding-top:12px;border-top:2px solid var(--primary);"><strong>★ Especiais do dia</strong></div>';
        specialHabits.forEach(function(h) {
            var checked = dayHabits[h.id] || false;
            html += '<div class="habit-row" style="background:var(--secondary);margin:4px -10px;padding:10px;"><span class="habit-name" style="font-weight:600;">' + h.name + '</span>';
            html += '<span class="habit-check spiritual-check' + (checked ? ' checked' : '') + '" data-habit="' + h.id + '" data-date="' + dateStr + '">' + (checked ? '✓' : '') + '</span></div>';
        });
    }
    if (thirdSunday) {
        var checked = dayHabits['symbolum-athanasianum'] || false;
        html += '<div class="habit-row" style="background:var(--secondary);margin:4px -10px;padding:10px;"><span class="habit-name" style="font-weight:600;">Sýmbolum Athanasiánum</span>';
        html += '<span class="habit-check spiritual-check' + (checked ? ' checked' : '') + '" data-habit="symbolum-athanasianum" data-date="' + dateStr + '">' + (checked ? '✓' : '') + '</span></div>';
    }
    return html;
}

function renderMortifications(dateStr) {
    var morts = BuJo.state.mortifications[dateStr] || [];
    if (morts.length === 0) return '<p style="color:var(--muted-foreground);font-style:italic;">Nenhuma mortificação.</p>';
    return morts.map(function(m, i) {
        return '<div class="habit-row"><span class="habit-name"' + (m.done ? ' style="text-decoration:line-through;color:var(--muted-foreground);"' : '') + '>' + m.text + '</span>' +
            '<span class="habit-check mort-check' + (m.done ? ' checked' : '') + '" data-date="' + dateStr + '" data-index="' + i + '">' + (m.done ? '✓' : '') + '</span></div>';
    }).join('');
}

function renderEntry(entry) {
    var symbol = entry.type === 'note' ? BuJo.symbols.note : entry.type === 'event' ? BuJo.symbols.event : entry.status === 'done' ? BuJo.symbols.taskDone : entry.status === 'migrated' ? BuJo.symbols.taskMigrated : BuJo.symbols.task;
    return '<div class="entry"><span class="entry-symbol" data-id="' + entry.id + '">' + symbol + '</span>' +
        '<span class="entry-text' + (entry.status === 'done' ? ' done' : '') + '">' + entry.text + '</span>' +
        '<span class="btn entry-edit" data-id="' + entry.id + '" style="padding:4px 10px;">✎</span></div>';
}

function renderWeekView() {
    var date = BuJo.state.selectedDate;
    var dayOfWeek = date.getDay();
    // Ajusta para começar na segunda (0=dom, 1=seg, etc)
    var mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
    var monday = new Date(date);
    monday.setDate(date.getDate() + mondayOffset);

    var weekDays = [];
    for (var i = 0; i < 7; i++) {
        var d = new Date(monday);
        d.setDate(monday.getDate() + i);
        weekDays.push(d);
    }

    var weekStart = monday.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' });
    var sunday = weekDays[6];
    var weekEnd = sunday.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' });

    var html = '<div class="week-nav">';
    html += '<span class="btn" id="prev-week" style="line-height:1;"><img src="/icones/seta.png" style="transform:rotate(180deg);width:20px;height:20px;"></span>';
    html += '<span class="week-nav-title">' + weekStart + ' - ' + weekEnd + '</span>';
    html += '<span class="btn" id="next-week" style="line-height:1;"><img src="/icones/seta.png" style="width:20px;height:20px;"></span>';
    html += '</div>';

    html += '<div class="week-grid">';

    // Linha 1: Seg | Ter | Qua
    html += '<div class="week-row">';
    for (var i = 0; i < 3; i++) {
        html += renderWeekDayCard(weekDays[i]);
    }
    html += '</div>';

    // Linha 2: Qui | Sex | (Sab & Dom)
    html += '<div class="week-row">';
    for (var i = 3; i < 5; i++) {
        html += renderWeekDayCard(weekDays[i]);
    }
    // Sab & Dom dividindo espaço de um
    html += '<div class="weekend-container">';
    html += renderWeekDayCard(weekDays[5], true); // Sábado
    html += renderWeekDayCard(weekDays[6], true); // Domingo
    html += '</div>';
    html += '</div>';

    html += '</div>';
    return html;
}

function renderWeekDayCard(date, isWeekend) {
    var dateStr = formatDateKey(date);
    var dayName = date.toLocaleDateString('pt-BR', { weekday: 'short' }).replace('.', '');
    var dayNum = date.getDate();
    var isTodayDate = isToday(date);

    var entries = BuJo.state.entries.filter(function(e) { return e.date === dateStr; });

    var cardClass = 'week-day' + (isWeekend ? ' weekend' : '') + (isTodayDate ? ' today' : '');
    var html = '<div class="' + cardClass + '">';
    html += '<div class="week-day-header"><span>' + dayName + '</span><span class="day-number">' + dayNum + '</span></div>';

    if (entries.length === 0) {
        html += '<div style="color:var(--muted-foreground);font-size:var(--font-size-xs);font-style:italic;">Sem registros</div>';
    } else {
        entries.forEach(function(entry) {
            var symbol = entry.type === 'note' ? BuJo.symbols.note : entry.type === 'event' ? BuJo.symbols.event : entry.status === 'done' ? BuJo.symbols.taskDone : entry.status === 'migrated' ? BuJo.symbols.taskMigrated : BuJo.symbols.task;
            html += '<div class="week-entry">';
            html += '<span class="week-entry-symbol">' + symbol + '</span>';
            html += '<span class="week-entry-text' + (entry.status === 'done' ? ' done' : '') + '">' + entry.text + '</span>';
            html += '</div>';
        });
    }

    html += '</div>';
    return html;
}

function renderMonthView() {
    var date = BuJo.state.selectedDate;
    var year = date.getFullYear(), month = date.getMonth();
    var firstDay = new Date(year, month, 1);
    var lastDay = new Date(year, month + 1, 0);
    var startPadding = firstDay.getDay();
    var monthName = date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

    var html = '<div class="card"><div class="card-title"><span class="btn" id="prev-month" style="line-height:1;"><img src="/icones/seta.png" style="transform:rotate(180deg);width:20px;height:20px;"></span>';
    html += '<span style="flex:1;text-align:center;text-transform:capitalize;">' + monthName + '</span>';
    html += '<span class="btn" id="next-month" style="line-height:1;"><img src="/icones/seta.png" style="width:20px;height:20px;"></span></div>';
    html += '<div class="month-calendar"><div class="month-row">';
    BuJo.dayNamesShort.forEach(function(d) { html += '<div class="month-cell header">' + d + '</div>'; });
    html += '</div>';

    var dayCount = 0, totalCells = startPadding + lastDay.getDate(), rows = Math.ceil(totalCells / 7);
    for (var r = 0; r < rows; r++) {
        html += '<div class="month-row">';
        for (var c = 0; c < 7; c++) {
            var cellIndex = r * 7 + c;
            if (cellIndex < startPadding || dayCount >= lastDay.getDate()) {
                html += '<div class="month-cell empty"></div>';
            } else {
                dayCount++;
                var dayDate = new Date(year, month, dayCount);
                var dateStr = formatDateKey(dayDate);
                var dow = dayDate.getDay();
                var isTodayCell = isToday(dayDate);
                var isSelected = dateStr === formatDateKey(date);
                var special = dow === 2 || dow === 3 || dow === 4 || dow === 6 || isThirdSunday(dayDate);
                var hasEvents = getEventsForDate(dateStr).length > 0;

                var cellClass = 'month-cell';
                if (isTodayCell) cellClass += ' today';
                if (isSelected) cellClass += ' selected';
                if (special && !isTodayCell && !isSelected) cellClass += ' special';
                if (hasEvents) cellClass += ' has-events';
                html += '<div class="' + cellClass + '" data-date="' + dateStr + '"><strong>' + dayCount + '</strong></div>';
            }
        }
        html += '</div>';
    }
    html += '</div></div>';

    html += '<div class="card" id="day-events-panel">' + renderDayEventsPanel(formatDateKey(date)) + '</div>';
    return html;
}

function renderDayEventsPanel(dateStr) {
    var date = new Date(dateStr + 'T12:00:00');
    var dow = date.getDay();
    var calendarEvents = getEventsForDate(dateStr);
    var specialHabits = BuJo.weeklySpecialHabits[dow] || [];
    var thirdSunday = isThirdSunday(date);

    var html = '<div class="card-title" style="text-transform:capitalize;">' + formatDateDisplay(date) + '</div>';
    if (specialHabits.length > 0 || thirdSunday) {
        html += '<div class="special-day"><strong>★ </strong>';
        var sp = specialHabits.map(function(h) { return h.name; });
        if (thirdSunday) sp.push('Sýmbolum Athanasiánum');
        html += sp.join(' • ') + '</div>';
    }
    if (calendarEvents.length === 0) html += '<p style="color:var(--muted-foreground);font-style:italic;">Nenhum evento agendado.</p>';
    else calendarEvents.forEach(function(ev) {
        html += '<div class="schedule-item"><span class="schedule-time">' + (ev.allDay ? 'Dia' : ev.startTime) + '</span>';
        html += '<span class="schedule-event">' + (ev.summary || 'Sem título') + '</span></div>';
    });
    html += '<div style="margin-top:14px;text-align:center;"><span class="btn btn-primary" onclick="goToDay(\'' + dateStr + '\')">Ir para este dia <img src="/icones/seta.png" style="width:16px;height:16px;vertical-align:middle;"></span></div>';
    return html;
}

function renderPlanoVida() {
    var weekDays = getWeekDays(BuJo.state.selectedDate);
    var html = '<div class="card"><div class="card-title"><span class="btn" id="prev-week" style="line-height:1;"><img src="/icones/seta.png" style="transform:rotate(180deg);width:20px;height:20px;"></span>';
    html += '<span style="flex:1;text-align:center;">Plano de Vida</span><span class="btn" id="next-week" style="line-height:1;"><img src="/icones/seta.png" style="width:20px;height:20px;"></span></div>';
    html += '<div style="overflow-x:auto;"><table class="tracker-table"><tr><th class="label">Hábito</th>';
    weekDays.forEach(function(d) {
        var style = isToday(d) ? ' style="background:var(--primary);color:#fff;"' : '';
        html += '<th' + style + '>' + BuJo.dayNamesShort[d.getDay()] + '<br>' + d.getDate() + '</th>';
    });
    html += '</tr>';

    BuJo.dailySpiritualHabits.forEach(function(h) {
        html += '<tr><td class="label">' + h.name + '</td>';
        weekDays.forEach(function(d) {
            var dateStr = formatDateKey(d);
            var dayHabits = BuJo.state.spiritualHabits[dateStr] || {};
            var checked = dayHabits[h.id] || false;
            html += '<td class="tracker-cell spiritual-check' + (checked ? ' checked' : '') + '" data-habit="' + h.id + '" data-date="' + dateStr + '">' + (checked ? '✓' : '') + '</td>';
        });
        html += '</tr>';
    });

    var specialRows = [
        { id: 'turno', name: 'Dia Turno', dow: 2 }, { id: 'salmo-2', name: 'Salmo 2', dow: 2 },
        { id: 'guarda', name: 'Dia Guarda', dow: 3 }, { id: 'disciplina', name: 'Disciplina', dow: 3 },
        { id: 'adoro-te', name: 'Adoro Te Devote', dow: 4 },
        { id: 'oracao-nossa-senhora', name: 'Oração N.Sra', dow: 6 }, { id: 'mortificacao-extra', name: 'Mortif. Extra', dow: 6 }
    ];
    html += '<tr><td colspan="8" style="background:var(--secondary);font-weight:600;padding:10px;">★ Especiais</td></tr>';
    specialRows.forEach(function(row) {
        html += '<tr><td class="label">' + row.name + '</td>';
        weekDays.forEach(function(d) {
            var dateStr = formatDateKey(d);
            if (d.getDay() !== row.dow) html += '<td class="tracker-cell na">–</td>';
            else {
                var dayHabits = BuJo.state.spiritualHabits[dateStr] || {};
                var checked = dayHabits[row.id] || false;
                html += '<td class="tracker-cell spiritual-check' + (checked ? ' checked' : '') + '" data-habit="' + row.id + '" data-date="' + dateStr + '">' + (checked ? '✓' : '') + '</td>';
            }
        });
        html += '</tr>';
    });

    html += '<tr><td class="label">Symb. Athan.</td>';
    weekDays.forEach(function(d) {
        var dateStr = formatDateKey(d);
        if (!isThirdSunday(d)) html += '<td class="tracker-cell na">–</td>';
        else {
            var dayHabits = BuJo.state.spiritualHabits[dateStr] || {};
            var checked = dayHabits['symbolum-athanasianum'] || false;
            html += '<td class="tracker-cell spiritual-check' + (checked ? ' checked' : '') + '" data-habit="symbolum-athanasianum" data-date="' + dateStr + '">' + (checked ? '✓' : '') + '</td>';
        }
    });
    html += '</tr></table></div></div>';

    html += '<div class="card"><div class="card-title">Resumo da Semana</div>' + renderSpiritualSummary(weekDays) + '</div>';
    return html;
}

function renderSpiritualSummary(weekDays) {
    var dayStats = [];
    weekDays.forEach(function(d) {
        var dateStr = formatDateKey(d);
        var dayHabits = BuJo.state.spiritualHabits[dateStr] || {};
        var checked = 0, possible = BuJo.dailySpiritualHabits.length;
        BuJo.dailySpiritualHabits.forEach(function(h) { if (dayHabits[h.id]) checked++; });
        if (d.getDay() === 2) { possible += 2; if (dayHabits['turno']) checked++; if (dayHabits['salmo-2']) checked++; }
        if (d.getDay() === 3) { possible += 2; if (dayHabits['guarda']) checked++; if (dayHabits['disciplina']) checked++; }
        if (d.getDay() === 4) { possible++; if (dayHabits['adoro-te']) checked++; }
        if (d.getDay() === 6) { possible += 2; if (dayHabits['oracao-nossa-senhora']) checked++; if (dayHabits['mortificacao-extra']) checked++; }
        if (isThirdSunday(d)) { possible++; if (dayHabits['symbolum-athanasianum']) checked++; }
        var pct = possible > 0 ? Math.round((checked / possible) * 100) : 0;
        dayStats.push({ day: BuJo.dayNamesShort[d.getDay()], pct: pct, isToday: isToday(d) });
    });
    var html = '<div style="display:-webkit-box;display:flex;-webkit-box-align:flex-end;align-items:flex-end;height:150px;border-bottom:2px solid var(--primary);padding-bottom:8px;">';
    dayStats.forEach(function(s) {
        var barHeight = Math.max(s.pct * 1.2, 4);
        var barStyle = 'width:12%;height:' + barHeight + 'px;background:' + (s.isToday ? 'var(--primary)' : 'var(--border)') + ';margin-right:2%;';
        html += '<div style="' + barStyle + '"></div>';
    });
    html += '</div>';
    html += '<div style="display:-webkit-box;display:flex;margin-top:4px;">';
    dayStats.forEach(function(s) {
        html += '<div style="width:12%;margin-right:2%;text-align:center;font-size:var(--font-size-xs);">' + s.day + '</div>';
    });
    html += '</div>';
    html += '<div style="display:-webkit-box;display:flex;margin-top:2px;">';
    dayStats.forEach(function(s) {
        html += '<div style="width:12%;margin-right:2%;text-align:center;font-size:var(--font-size-xs);font-weight:600;">' + s.pct + '%</div>';
    });
    html += '</div>';
    return html;
}

function renderNotas() {
    var html = '<div class="card"><div class="card-title">Notas Salvas <span class="btn" id="add-note-btn">+ Nova</span></div>';
    html += '<div style="margin-bottom:16px;"><span class="btn" id="save-notes-btn">Importar notas do Registro</span></div>';

    if (BuJo.state.notes.length === 0) html += '<p style="color:var(--muted-foreground);font-style:italic;text-align:center;padding:20px;">Nenhuma nota salva.</p>';
    else {
        var sorted = BuJo.state.notes.slice().sort(function(a,b) { return new Date(b.createdAt) - new Date(a.createdAt); });
        sorted.forEach(function(note) {
            var d = new Date(note.createdAt);
            html += '<div class="note-item"><div class="note-date">';
            if (note.type) html += '<span class="note-type">' + note.type + '</span>';
            html += formatDateShort(d) + ' às ' + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) + '</div>';
            html += '<div class="note-content">' + note.text + '</div>';
            html += '<div style="margin-top:8px;"><span class="btn" onclick="deleteNote(\'' + note.id + '\')" style="padding:4px 10px;">Excluir</span></div></div>';
        });
    }
    html += '</div>';
    return html;
}

function navigateDate(delta) { BuJo.state.selectedDate = new Date(BuJo.state.selectedDate.getTime() + delta * 86400000); render(); }
function navigateWeek(delta) { BuJo.state.selectedDate = new Date(BuJo.state.selectedDate.getTime() + delta * 7 * 86400000); render(); }
function navigateMonth(delta) { var d = BuJo.state.selectedDate; BuJo.state.selectedDate = new Date(d.getFullYear(), d.getMonth() + delta, 1); render(); }
function selectMonthDay(dateStr) { BuJo.state.selectedDate = new Date(dateStr + 'T12:00:00'); render(); }
function goToDay(dateStr) { BuJo.state.selectedDate = new Date(dateStr + 'T12:00:00'); setView('dia'); }
function goToToday() { BuJo.state.selectedDate = new Date(); render(); }

function toggleSpiritualHabit(habitId, dateStr) {
    if (!BuJo.state.spiritualHabits[dateStr]) BuJo.state.spiritualHabits[dateStr] = {};
    var newValue = !BuJo.state.spiritualHabits[dateStr][habitId];
    BuJo.state.spiritualHabits[dateStr][habitId] = newValue;
    recordEvent('spiritual_toggled', { habitId: habitId, value: newValue }, dateStr);
    saveState(); render();
}
function toggleStudyGoal(habitId, dateStr, index) {
    if (!BuJo.state.studyGoals[dateStr]) BuJo.state.studyGoals[dateStr] = {};
    if (!BuJo.state.studyGoals[dateStr][habitId]) BuJo.state.studyGoals[dateStr][habitId] = [];
    var newValue = !BuJo.state.studyGoals[dateStr][habitId][index];
    BuJo.state.studyGoals[dateStr][habitId][index] = newValue;
    recordEvent('study_toggled', { habitId: habitId, index: index, value: newValue }, dateStr);
    saveState(); render();
}
function toggleMortification(dateStr, index) {
    var morts = BuJo.state.mortifications[dateStr];
    if (morts && morts[index]) {
        morts[index].done = !morts[index].done;
        recordEvent('mortification_toggled', { index: index, text: morts[index].text, done: morts[index].done }, dateStr);
        saveState(); render();
    }
}

function addEntry() {
    var input = document.getElementById('add-entry-input');
    var type = document.getElementById('add-entry-type').value;
    var text = input.value.trim();
    if (!text) return;
    var dateStr = formatDateKey(BuJo.state.selectedDate);
    var newEntry = { id: generateId(), date: dateStr, type: type, text: text, status: 'pending', createdAt: new Date().toISOString() };
    BuJo.state.entries.push(newEntry);
    recordEvent('entry_added', { id: newEntry.id, entryType: type, text: text, status: 'pending' }, dateStr);
    saveState(); input.value = ''; render();
}
function cycleEntrySymbol(id) {
    var entry = BuJo.state.entries.find(function(e) { return e.id === id; });
    if (entry && entry.type === 'task') {
        var oldStatus = entry.status;
        entry.status = entry.status === 'pending' ? 'done' : entry.status === 'done' ? 'migrated' : 'pending';
        recordEvent('entry_status_changed', { id: id, from: oldStatus, to: entry.status }, entry.date);
        saveState(); render();
    }
}
function deleteEntry(id) {
    var entry = BuJo.state.entries.find(function(e) { return e.id === id; });
    if (entry) recordEvent('entry_deleted', { id: id, entryType: entry.type, text: entry.text }, entry.date);
    BuJo.state.entries = BuJo.state.entries.filter(function(e) { return e.id !== id; });
    saveState();
    closeModal();
    if (daySectionOverlay) {
        refreshDaySection('registros');
    } else {
        render();
    }
}

function showEditEntryModal(id) {
    var entry = BuJo.state.entries.find(function(e) { return e.id === id; });
    if (!entry) return;
    var typeOptions = '<option value="task"' + (entry.type === 'task' ? ' selected' : '') + '>' + BuJo.symbols.task + ' Tarefa</option>' +
        '<option value="event"' + (entry.type === 'event' ? ' selected' : '') + '>' + BuJo.symbols.event + ' Evento</option>' +
        '<option value="note"' + (entry.type === 'note' ? ' selected' : '') + '>' + BuJo.symbols.note + ' Nota</option>';
    showModal('<div class="modal-title">Editar Registro</div>' +
        '<div class="form-group"><label>Tipo</label><select id="edit-entry-type">' + typeOptions + '</select></div>' +
        '<div class="form-group"><label>Texto</label><textarea id="edit-entry-text" rows="3">' + entry.text + '</textarea></div>' +
        '<div class="form-group"><label>Data</label><input type="date" id="edit-entry-date" value="' + entry.date + '"></div>' +
        '<div class="modal-actions" style="justify-content:space-between;">' +
        '<span class="btn" style="background:#dc2626;color:#fff;border-color:#dc2626;" onclick="deleteEntry(\'' + id + '\')">Excluir</span>' +
        '<div style="display:flex;gap:10px;"><span class="btn" onclick="closeModal()">Cancelar</span><span class="btn btn-primary" onclick="editEntry(\'' + id + '\')">Salvar</span></div></div>');
}

function editEntry(id) {
    var entry = BuJo.state.entries.find(function(e) { return e.id === id; });
    if (!entry) return;
    var newText = document.getElementById('edit-entry-text').value.trim();
    var newType = document.getElementById('edit-entry-type').value;
    var newDate = document.getElementById('edit-entry-date').value;
    if (!newText) return;
    var oldText = entry.text;
    var oldType = entry.type;
    var oldDate = entry.date;
    entry.text = newText;
    entry.type = newType;
    entry.date = newDate;
    if (newType !== 'task') entry.status = 'pending';
    recordEvent('entry_edited', { id: id, oldText: oldText, newText: newText, oldType: oldType, newType: newType, oldDate: oldDate, newDate: newDate }, entry.date);
    saveState();
    closeModal();
    if (daySectionOverlay) {
        refreshDaySection('registros');
    } else {
        render();
    }
}

function showEventDetails(dateStr, eventIdx) {
    var events = getEventsForDate(dateStr);
    if (!events || eventIdx >= events.length) return;
    var ev = events[eventIdx];

    var html = '<div class="modal-title">' + (ev.summary || 'Sem título') + '</div>';

    // Horários
    if (ev.allDay) {
        html += '<div style="margin-bottom:12px;"><strong>Dia inteiro</strong></div>';
    } else {
        var startTime = '';
        var endTime = '';
        if (ev.start.dateTime) {
            var startDate = new Date(ev.start.dateTime);
            startDate.setHours(startDate.getHours() - 3);
            startTime = startDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }
        if (ev.end && ev.end.dateTime) {
            var endDate = new Date(ev.end.dateTime);
            endDate.setHours(endDate.getHours() - 3);
            endTime = endDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }
        html += '<div style="margin-bottom:12px;">';
        html += '<div style="font-size:0.9rem;color:var(--muted-foreground);margin-bottom:4px;">Horário</div>';
        html += '<div style="font-size:1.1rem;font-weight:600;">' + startTime;
        if (endTime) html += ' – ' + endTime;
        html += '</div></div>';
    }

    // Localização
    if (ev.location) {
        html += '<div style="margin-bottom:12px;">';
        html += '<div style="font-size:0.9rem;color:var(--muted-foreground);margin-bottom:4px;">Local</div>';
        html += '<div>' + ev.location + '</div></div>';
    }

    // Descrição
    if (ev.description) {
        html += '<div style="margin-bottom:12px;">';
        html += '<div style="font-size:0.9rem;color:var(--muted-foreground);margin-bottom:4px;">Descrição</div>';
        html += '<div style="white-space:pre-wrap;font-size:0.95rem;background:var(--secondary);padding:10px;border-radius:6px;">' + ev.description + '</div></div>';
    }

    html += '<div class="modal-actions"><span class="btn btn-primary" onclick="closeModal()">Fechar</span></div>';
    showModal(html);
}

function deleteNote(id) {
    var note = BuJo.state.notes.find(function(n) { return n.id === id; });
    if (note) recordEvent('note_deleted', { id: id, text: note.text }, note.date);
    BuJo.state.notes = BuJo.state.notes.filter(function(n) { return n.id !== id; });
    saveState(); render();
}
function deleteFutureEntry(id) {
    var entry = BuJo.state.futureLog.find(function(f) { return f.id === id; });
    if (entry) recordEvent('future_deleted', { id: id, text: entry.text, month: entry.month });
    BuJo.state.futureLog = BuJo.state.futureLog.filter(function(f) { return f.id !== id; });
    saveState(); render();
}

function saveAllNotes() {
    var imported = 0;
    BuJo.state.entries.forEach(function(entry) {
        if (entry.type === 'note' && !BuJo.state.notes.some(function(n) { return n.originalId === entry.id; })) {
            BuJo.state.notes.push({ id: generateId(), originalId: entry.id, text: entry.text, type: 'Registro', date: entry.date, createdAt: entry.createdAt });
            imported++;
        }
    });
    saveState();
    alert(imported > 0 ? imported + ' nota(s) importada(s)!' : 'Nenhuma nota nova.');
    render();
}

function showModal(content) { document.getElementById('modal-content').innerHTML = content; document.getElementById('modal-overlay').className = 'modal-overlay active'; }
function closeModal() { document.getElementById('modal-overlay').className = 'modal-overlay'; }

// ============= MODAIS DE SEÇÃO DO DIA =============
var daySectionOverlay = null;

function openDaySection(section) {
    var date = BuJo.state.selectedDate;
    var dateStr = formatDateKey(date);
    var dow = date.getDay();
    var thirdSunday = isThirdSunday(date);

    var html = '<div class="modal-full" id="day-section-modal">';
    html += '<div class="modal-full-header">';

    var title = '';
    if (section === 'eventos') title = 'Eventos';
    else if (section === 'registros') title = 'Registros';
    else if (section === 'plano') title = 'Plano de Vida';
    else if (section === 'mortificacoes') title = 'Mortificações';
    else if (section === 'leituras') title = 'Leituras do Dia';
    else if (section === 'exame') title = 'Exame de Consciência';

    html += '<span class="modal-full-title">' + title + '</span>';
    html += '<button class="modal-full-close" onclick="closeDaySection()">Voltar</button>';
    html += '</div>';

    if (section === 'eventos') html += renderDaySectionEventos(dateStr);
    else if (section === 'registros') html += renderDaySectionRegistros(dateStr);
    else if (section === 'plano') html += renderDaySectionPlano(dateStr, dow, thirdSunday);
    else if (section === 'mortificacoes') html += renderDaySectionMortificacoes(dateStr);
    else if (section === 'leituras') html += renderDaySectionLeituras();
    else if (section === 'exame') html += renderDaySectionExame();

    html += '</div>';

    daySectionOverlay = document.createElement('div');
    daySectionOverlay.innerHTML = html;
    document.body.appendChild(daySectionOverlay);
    bindDaySectionEvents(section, dateStr);
}

function closeDaySection() {
    if (daySectionOverlay) {
        daySectionOverlay.remove();
        daySectionOverlay = null;
    }
}

function bindDaySectionEvents(section, dateStr) {
    if (section === 'registros') {
        var addBtn = document.getElementById('section-add-entry-btn');
        var addInput = document.getElementById('section-add-entry-input');
        if (addBtn) addBtn.onclick = addEntryFromSection;
        if (addInput) addInput.onkeypress = function(e) { if (e.key === 'Enter') addEntryFromSection(); };

        document.querySelectorAll('.section-entry-symbol[data-id]').forEach(function(el) {
            el.onclick = function() { cycleEntrySymbol(el.getAttribute('data-id')); refreshDaySection('registros'); };
        });

        // Clique no texto para editar
        document.querySelectorAll('.section-entry-text[data-id]').forEach(function(el) {
            el.onclick = function() {
                showEditEntryModal(el.getAttribute('data-id'));
            };
        });

        // Botão para duplicar migrado para próximo dia
        document.querySelectorAll('.section-migrate-next[data-id]').forEach(function(el) {
            el.onclick = function() { duplicateToNextDay(el.getAttribute('data-id')); };
        });

        // Clique na estrela para marcar/desmarcar
        document.querySelectorAll('.section-entry-star[data-id]').forEach(function(el) {
            el.onclick = function() { toggleEntryStar(el.getAttribute('data-id')); };
        });
    }

    if (section === 'eventos') {
        document.querySelectorAll('.section-event-clickable').forEach(function(el) {
            el.onclick = function() {
                showEventDetails(el.getAttribute('data-event-date'), parseInt(el.getAttribute('data-event-idx')));
            };
        });
    }

    if (section === 'plano' || section === 'mortificacoes') {
        document.querySelectorAll('.section-spiritual-check').forEach(function(el) {
            el.onclick = function() {
                toggleSpiritualHabit(el.getAttribute('data-habit'), el.getAttribute('data-date'));
                refreshDaySection('plano');
            };
        });
        document.querySelectorAll('.section-mort-check').forEach(function(el) {
            el.onclick = function() {
                toggleMortification(el.getAttribute('data-date'), parseInt(el.getAttribute('data-index')));
                refreshDaySection('mortificacoes');
            };
        });
        var addMortBtn = document.getElementById('section-add-mort-btn');
        if (addMortBtn) addMortBtn.onclick = function() { showAddMortModalFromSection(dateStr); };
    }
}

function refreshDaySection(section) {
    closeDaySection();
    openDaySection(section);
}

function addEntryFromSection() {
    var dateStr = formatDateKey(BuJo.state.selectedDate);
    var type = document.getElementById('section-add-entry-type').value;
    var text = document.getElementById('section-add-entry-input').value.trim();
    if (!text) return;
    var newEntry = { id: generateId(), date: dateStr, type: type, text: text, status: type === 'task' ? 'pending' : null, createdAt: new Date().toISOString() };
    BuJo.state.entries.push(newEntry);
    recordEvent('entry_added', { id: newEntry.id, type: type, text: text }, dateStr);
    saveState();
    refreshDaySection('registros');
}

function showAddMortModalFromSection(dateStr) {
    showAddMortModal();
}

function duplicateToNextDay(id) {
    var entry = BuJo.state.entries.find(function(e) { return e.id === id; });
    if (!entry) return;
    var currentDate = new Date(entry.date + 'T12:00:00');
    currentDate.setDate(currentDate.getDate() + 1);
    var nextDateStr = formatDateKey(currentDate);
    var newEntry = {
        id: generateId(),
        date: nextDateStr,
        type: entry.type,
        text: entry.text,
        status: 'pending',
        createdAt: new Date().toISOString()
    };
    BuJo.state.entries.push(newEntry);
    recordEvent('entry_duplicated', { originalId: id, newId: newEntry.id, text: entry.text, fromDate: entry.date, toDate: nextDateStr }, nextDateStr);
    saveState();
    refreshDaySection('registros');
}

function toggleEntryStar(id) {
    var entry = BuJo.state.entries.find(function(e) { return e.id === id; });
    if (!entry) return;
    // Remove estrela de outros registros do mesmo dia
    var dateStr = entry.date;
    BuJo.state.entries.forEach(function(e) {
        if (e.date === dateStr && e.id !== id) e.starred = false;
    });
    // Alterna a estrela deste registro
    entry.starred = !entry.starred;
    recordEvent('entry_starred', { id: id, starred: entry.starred }, dateStr);
    saveState();
    refreshDaySection('registros');
}

function renderDaySectionEventos(dateStr) {
    var calendarEvents = getEventsForDate(dateStr);
    var html = '<div class="card">';
    if (calendarEvents.length === 0) {
        html += '<p style="color:var(--muted-foreground);font-style:italic;text-align:center;padding:20px;">Nenhum evento agendado para este dia.</p>';
    } else {
        calendarEvents.forEach(function(ev, idx) {
            html += '<div class="schedule-item section-event-clickable" data-event-idx="' + idx + '" data-event-date="' + dateStr + '" style="padding:12px 0;cursor:pointer;">';
            html += '<span class="schedule-time" style="font-weight:600;">' + (ev.allDay ? 'Dia todo' : ev.startTime) + '</span>';
            html += '<span class="schedule-event" style="font-size:var(--font-size-lg);">' + (ev.summary || 'Sem título') + '</span>';
            html += '</div>';
        });
    }
    html += '</div>';
    return html;
}

function renderDaySectionRegistros(dateStr) {
    var dayEntries = BuJo.state.entries.filter(function(e) { return e.date === dateStr; });
    var html = '<div class="card">';
    html += '<div style="font-size:0.9rem;color:var(--muted-foreground);padding:8px 0;border-bottom:1px dotted var(--border);margin-bottom:10px;">';
    html += BuJo.symbols.task + ' tarefa &nbsp;&nbsp;' + BuJo.symbols.taskDone + ' feito &nbsp;&nbsp;' + BuJo.symbols.taskMigrated + ' migrado &nbsp;&nbsp;' + BuJo.symbols.event + ' evento &nbsp;&nbsp;' + BuJo.symbols.note + ' nota &nbsp;&nbsp;★ estrela</div>';

    if (dayEntries.length === 0) {
        html += '<p style="color:var(--muted-foreground);font-style:italic;">Nenhuma entrada...</p>';
    } else {
        dayEntries.forEach(function(e) {
            var symbol = e.type === 'note' ? BuJo.symbols.note : e.type === 'event' ? BuJo.symbols.event : e.status === 'done' ? BuJo.symbols.taskDone : e.status === 'migrated' ? BuJo.symbols.taskMigrated : BuJo.symbols.task;
            var starStyle = e.starred ? 'color:#f59e0b;' : 'color:var(--muted-foreground);opacity:0.4;';
            html += '<div class="entry" style="padding:12px 0;">';
            html += '<span class="section-entry-star" data-id="' + e.id + '" style="cursor:pointer;font-size:1rem;margin-right:6px;' + starStyle + '">★</span>';
            html += '<span class="entry-symbol section-entry-symbol" data-id="' + e.id + '" style="font-size:1.2rem;">' + symbol + '</span>';
            html += '<span class="entry-text section-entry-text' + (e.status === 'done' ? ' done' : '') + '" data-id="' + e.id + '" style="font-size:var(--font-size-lg);cursor:pointer;">' + e.text + '</span>';
            if (e.status === 'migrated') {
                html += '<span class="btn section-migrate-next" data-id="' + e.id + '" style="padding:6px 10px;font-size:0.8rem;margin-left:8px;">→+1</span>';
            }
            html += '</div>';
        });
    }

    html += '<div class="add-entry" style="margin-top:20px;padding-top:20px;">';
    html += '<select id="section-add-entry-type" style="padding:12px;font-size:var(--font-size-base);"><option value="task">' + BuJo.symbols.task + ' Tarefa</option><option value="event">' + BuJo.symbols.event + ' Evento</option><option value="note">' + BuJo.symbols.note + ' Nota</option></select>';
    html += '<input type="text" id="section-add-entry-input" placeholder="Digite..." style="padding:12px;font-size:var(--font-size-base);">';
    html += '<span class="btn btn-primary" id="section-add-entry-btn" style="padding:12px 20px;">+</span></div>';
    html += '</div>';
    return html;
}

function renderDaySectionPlano(dateStr, dow, thirdSunday) {
    var dayHabits = BuJo.state.spiritualHabits[dateStr] || {};
    var specialHabits = BuJo.weeklySpecialHabits[dow] || [];

    var html = '<div class="card">';
    html += '<div style="display:-webkit-box;display:flex;-webkit-flex-wrap:wrap;flex-wrap:wrap;">';
    BuJo.dailySpiritualHabits.forEach(function(h) {
        var checked = dayHabits[h.id] || false;
        html += '<div class="habit-row" style="width:50%;-webkit-box-sizing:border-box;box-sizing:border-box;padding-right:8px;"><span class="habit-name">' + h.name + '</span>';
        html += '<span class="habit-check section-spiritual-check' + (checked ? ' checked' : '') + '" data-habit="' + h.id + '" data-date="' + dateStr + '">' + (checked ? '✓' : '') + '</span></div>';
    });
    html += '</div>';

    if (specialHabits.length > 0) {
        html += '<div style="margin-top:14px;padding-top:12px;border-top:2px solid var(--primary);"><strong>★ Especiais do dia</strong></div>';
        specialHabits.forEach(function(h) {
            var checked = dayHabits[h.id] || false;
            html += '<div class="habit-row" style="background:var(--secondary);margin:4px -10px;padding:10px;"><span class="habit-name" style="font-weight:600;">' + h.name + '</span>';
            html += '<span class="habit-check section-spiritual-check' + (checked ? ' checked' : '') + '" data-habit="' + h.id + '" data-date="' + dateStr + '">' + (checked ? '✓' : '') + '</span></div>';
        });
    }

    if (thirdSunday) {
        var checked = dayHabits['symbolum-athanasianum'] || false;
        html += '<div class="habit-row" style="background:var(--secondary);margin:4px -10px;padding:10px;"><span class="habit-name" style="font-weight:600;">Sýmbolum Athanasiánum</span>';
        html += '<span class="habit-check section-spiritual-check' + (checked ? ' checked' : '') + '" data-habit="symbolum-athanasianum" data-date="' + dateStr + '">' + (checked ? '✓' : '') + '</span></div>';
    }
    html += '</div>';
    return html;
}

function renderDaySectionMortificacoes(dateStr) {
    var morts = BuJo.state.mortifications[dateStr] || [];
    var html = '<div class="card">';

    if (morts.length === 0) {
        html += '<p style="color:var(--muted-foreground);font-style:italic;text-align:center;padding:20px;">Nenhuma mortificação definida.</p>';
    } else {
        morts.forEach(function(m, i) {
            html += '<div class="habit-row" style="padding:14px 0;font-size:var(--font-size-lg);"><span class="habit-name"' + (m.done ? ' style="text-decoration:line-through;color:var(--muted-foreground);"' : '') + '>' + m.text + '</span>';
            html += '<span class="habit-check section-mort-check' + (m.done ? ' checked' : '') + '" data-date="' + dateStr + '" data-index="' + i + '" style="width:44px;height:44px;">' + (m.done ? '✓' : '') + '</span></div>';
        });
    }

    html += '<div style="margin-top:20px;text-align:center;"><span class="btn btn-primary" id="section-add-mort-btn" style="padding:14px 24px;font-size:var(--font-size-base);">+ Adicionar Mortificação</span></div>';
    html += '</div>';
    return html;
}

function renderDaySectionLeituras() {
    var cw = BuJo.state.readingProgress.currentWeek || 1;
    var wd = BuJo.readingPlan.cronograma.find(function(w) { return w.semana === cw; });
    var noturna = BuJo.readingPlan.noturna;
    var np = BuJo.state.readingProgress.noturna.currentPage || 0;
    var nPct = Math.round((np / noturna.paginas) * 100);

    var html = '<div class="card">';
    html += '<div style="margin-bottom:20px;">';
    html += '<div style="font-weight:700;font-size:var(--font-size-lg);margin-bottom:8px;">Leitura Noturna</div>';
    html += '<div style="font-size:var(--font-size-base);margin-bottom:8px;">' + noturna.titulo + ' - ' + noturna.autor + '</div>';
    html += '<div class="reading-progress"><div class="reading-progress-bar" style="height:16px;"><div class="reading-progress-fill" style="width:' + nPct + '%;"></div></div><span class="reading-percent" style="font-size:var(--font-size-lg);">' + nPct + '%</span></div>';
    html += '<div style="font-size:var(--font-size-sm);color:var(--muted-foreground);">Página ' + np + ' de ' + noturna.paginas + '</div>';
    html += '</div>';

    if (wd) {
        var ek = 'sem' + cw + '_esp', sk = 'sem' + cw + '_sec';
        var ep = BuJo.state.readingProgress.books[ek] || 0, sp = BuJo.state.readingProgress.books[sk] || 0;
        var et = wd.espiritual.pFim - wd.espiritual.pInicio + 1, st = wd.secular.pFim - wd.secular.pInicio + 1;
        var ePct = Math.round((ep / et) * 100), sPct = Math.round((sp / st) * 100);

        html += '<div style="margin-bottom:20px;padding:16px;background:var(--secondary);border-radius:var(--radius);">';
        html += '<div style="font-weight:700;font-size:var(--font-size-lg);margin-bottom:12px;">Semana ' + cw + ' - ' + wd.bloco + '</div>';

        html += '<div style="margin-bottom:16px;">';
        html += '<div><span class="book-type" style="background:#4a5568;color:#fff;">Espiritual</span></div>';
        html += '<div style="font-weight:600;margin:8px 0;">' + wd.espiritual.titulo + '</div>';
        html += '<div style="font-size:var(--font-size-sm);color:var(--muted-foreground);margin-bottom:8px;">' + wd.espiritual.autor + ' (p. ' + wd.espiritual.pInicio + '-' + wd.espiritual.pFim + ')</div>';
        html += '<div class="reading-progress"><div class="reading-progress-bar"><div class="reading-progress-fill" style="width:' + ePct + '%;"></div></div><span class="reading-percent">' + ePct + '%</span></div>';
        html += '</div>';

        html += '<div>';
        html += '<div><span class="book-type" style="background:#718096;color:#fff;">Secular</span></div>';
        html += '<div style="font-weight:600;margin:8px 0;">' + wd.secular.titulo + '</div>';
        html += '<div style="font-size:var(--font-size-sm);color:var(--muted-foreground);margin-bottom:8px;">' + wd.secular.autor + ' (p. ' + wd.secular.pInicio + '-' + wd.secular.pFim + ')</div>';
        html += '<div class="reading-progress"><div class="reading-progress-bar"><div class="reading-progress-fill" style="width:' + sPct + '%;"></div></div><span class="reading-percent">' + sPct + '%</span></div>';
        html += '</div>';
        html += '</div>';
    }

    html += '<div style="margin-top:20px;text-align:center;"><span class="btn btn-primary" onclick="closeDaySection();setView(\'leituras\');" style="padding:14px 24px;">Ir para Leituras Completas</span></div>';
    html += '</div>';
    return html;
}

function renderDaySectionExame() {
    var html = '<div style="padding:0 4px;line-height:1.8;">';

    html += '<div style="font-size:var(--font-size-xl);font-weight:700;margin-bottom:20px;padding-bottom:10px;border-bottom:3px solid var(--primary);">';
    html += 'Jesus, afasta de mim o que me afasta de ti!';
    html += '</div>';

    html += '<div style="margin-bottom:24px;">';
    html += '<p style="font-size:var(--font-size-base);margin-bottom:16px;"><strong>"Muitos vivem como anjos no meio do mundo. - Tu… por que não? (C122)"</strong></p>';
    html += '<p style="font-size:var(--font-size-sm);color:var(--muted-foreground);padding-left:12px;border-left:3px solid var(--border);">Usei o telefone enquanto estava deitado? Tirei ele do modo sono sem necessidade? Fiquei usando ele até tarde?</p>';
    html += '</div>';

    html += '<div style="margin-bottom:24px;">';
    html += '<p style="font-size:var(--font-size-base);margin-bottom:16px;"><strong>"Põe um motivo sobrenatural na tua atividade profissional de cada dia, e terás santificado o trabalho. (C359)"</strong></p>';
    html += '<p style="font-size:var(--font-size-sm);color:var(--muted-foreground);padding-left:12px;border-left:3px solid var(--border);">Lembrei de pedir graças antes de estudar? Deixei me distrair durante o estudo? Agradeci o tempo de estudo?</p>';
    html += '</div>';

    html += '<div style="margin-bottom:24px;">';
    html += '<p style="font-size:var(--font-size-base);margin-bottom:16px;"><strong>"Estar ocioso é coisa que não se compreende num homem com alma de apóstolo. (C358)"</strong></p>';
    html += '<p style="font-size:var(--font-size-sm);color:var(--muted-foreground);padding-left:12px;border-left:3px solid var(--border);">Lembrei das jaculatórias habituais? Vivi bem o tempo da tarde? Levei a sério o meu apostolado planejado?</p>';
    html += '</div>';

    html += '<div style="margin-top:30px;padding-top:20px;border-top:2px solid var(--primary);">';
    html += '<div style="font-size:var(--font-size-xl);font-weight:700;margin-bottom:16px;">Ato de Contrição</div>';
    html += '<p style="font-size:var(--font-size-base);font-style:italic;background:var(--secondary);padding:16px;border-radius:var(--radius);">';
    html += 'Senhor, me arrependo de todo o coração de vos ter ofendido. Dai-me a graça de não mais pecar.';
    html += '</p>';
    html += '</div>';

    html += '<div style="text-align:center;margin-top:30px;">';
    html += '<img src="/Imagens/download.png" alt="Imagem devocional" style="max-width:100%;height:auto;border-radius:var(--radius);">';
    html += '</div>';

    html += '</div>';
    return html;
}

function showAddMortModal() {
    var dateStr = formatDateKey(BuJo.state.selectedDate);
    showModal('<div class="modal-title">Adicionar Mortificação</div>' +
        '<div class="form-group"><label>Descrição</label><input type="text" id="mort-text" placeholder="Ex: Jejum até o almoço"></div>' +
        '<div class="modal-actions"><span class="btn" onclick="closeModal()">Cancelar</span><span class="btn btn-primary" onclick="addMortification(\'' + dateStr + '\')">Adicionar</span></div>');
}
function addMortification(dateStr) {
    var text = document.getElementById('mort-text').value.trim();
    if (!text) return;
    if (!BuJo.state.mortifications[dateStr]) BuJo.state.mortifications[dateStr] = [];
    BuJo.state.mortifications[dateStr].push({ text: text, done: false });
    recordEvent('mortification_added', { text: text }, dateStr);
    saveState();
    closeModal();
    if (daySectionOverlay) {
        refreshDaySection('mortificacoes');
    } else {
        render();
    }
}

function showAddProjectModal() {
    showModal('<div class="modal-title">Novo Projeto</div>' +
        '<div class="form-group"><label>Nome</label><input type="text" id="project-name"></div>' +
        '<div class="form-group"><label>Próxima Ação</label><input type="text" id="project-next"></div>' +
        '<div class="modal-actions"><span class="btn" onclick="closeModal()">Cancelar</span><span class="btn btn-primary" onclick="addProject()">Criar</span></div>');
}
function addProject() {
    var name = document.getElementById('project-name').value.trim();
    if (!name) return;
    var newProject = { id: generateId(), name: name, nextAction: document.getElementById('project-next').value, status: 'Em andamento', createdAt: new Date().toISOString() };
    BuJo.state.projects.push(newProject);
    recordEvent('project_added', { id: newProject.id, name: name });
    saveState(); closeModal(); render();
}

function showAddFutureModal() {
    var now = new Date(), options = '';
    for (var i = 0; i < 12; i++) {
        var d = new Date(now.getFullYear(), now.getMonth() + i, 1);
        options += '<option value="' + getMonthKey(d) + '">' + d.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }) + '</option>';
    }
    showModal('<div class="modal-title">Adicionar ao Future Log</div>' +
        '<div class="form-group"><label>Mês</label><select id="future-month">' + options + '</select></div>' +
        '<div class="form-group"><label>Dia (opcional)</label><input type="number" id="future-day" min="1" max="31" placeholder="Ex: 15"></div>' +
        '<div class="form-group"><label>Descrição</label><input type="text" id="future-text" placeholder="Ex: Aniversário"></div>' +
        '<div class="modal-actions"><span class="btn" onclick="closeModal()">Cancelar</span><span class="btn btn-primary" onclick="addFutureEntry()">Adicionar</span></div>');
}
function addFutureEntry() {
    var text = document.getElementById('future-text').value.trim();
    if (!text) return;
    var month = document.getElementById('future-month').value;
    var day = document.getElementById('future-day').value || null;
    var newEntry = { id: generateId(), month: month, day: day, text: text, createdAt: new Date().toISOString() };
    BuJo.state.futureLog.push(newEntry);
    recordEvent('future_added', { id: newEntry.id, month: month, day: day, text: text });
    saveState(); closeModal(); render();
}

function showAddNoteModal() {
    showModal('<div class="modal-title">Nova Nota</div>' +
        '<div class="form-group"><label>Tipo (opcional)</label><input type="text" id="note-type" placeholder="Ex: Reflexão, Ideia"></div>' +
        '<div class="form-group"><label>Conteúdo</label><textarea id="note-text" rows="4" placeholder="Escreva sua nota..."></textarea></div>' +
        '<div class="modal-actions"><span class="btn" onclick="closeModal()">Cancelar</span><span class="btn btn-primary" onclick="addNote()">Salvar</span></div>');
}
function addNote() {
    var text = document.getElementById('note-text').value.trim();
    if (!text) return;
    var noteType = document.getElementById('note-type').value.trim() || 'Nota';
    var newNote = { id: generateId(), text: text, type: noteType, createdAt: new Date().toISOString() };
    BuJo.state.notes.push(newNote);
    recordEvent('note_added', { id: newNote.id, text: text, type: noteType });
    saveState(); closeModal(); render();
}

function renderDayReading() {
    var cw = BuJo.state.readingProgress.currentWeek || 1;
    var wd = BuJo.readingPlan.cronograma.find(function(w) { return w.semana === cw; });
    var noturna = BuJo.readingPlan.noturna;
    var np = BuJo.state.readingProgress.noturna.currentPage || 0;
    var nPct = Math.round((np / noturna.paginas) * 100);

    var html = '<div style="margin-bottom:12px;">';
    html += '<div style="font-weight:600;">Noturna: ' + noturna.titulo + '</div>';
    html += '<div class="reading-progress"><div class="reading-progress-bar"><div class="reading-progress-fill" style="width:' + nPct + '%;"></div></div><span class="reading-percent">' + nPct + '%</span></div></div>';

    if (wd) {
        var ek = 'sem' + cw + '_esp', sk = 'sem' + cw + '_sec';
        var ep = BuJo.state.readingProgress.books[ek] || 0, sp = BuJo.state.readingProgress.books[sk] || 0;
        var et = wd.espiritual.pFim - wd.espiritual.pInicio + 1, st = wd.secular.pFim - wd.secular.pInicio + 1;
        var ePct = Math.round((ep / et) * 100), sPct = Math.round((sp / st) * 100);

        html += '<div style="margin-bottom:8px;"><span class="book-type">Espiritual</span> ' + wd.espiritual.titulo + ' <strong>' + ePct + '%</strong></div>';
        html += '<div style="margin-bottom:12px;"><span class="book-type">Secular</span> ' + wd.secular.titulo + ' <strong>' + sPct + '%</strong></div>';
    }
    html += '<div style="text-align:center;"><span class="btn" onclick="setView(\'leituras\')">Ir para Leituras</span></div>';
    return html;
}

function renderLeituras() {
    var cw = BuJo.state.readingProgress.currentWeek || 1;
    var wd = BuJo.readingPlan.cronograma.find(function(w) { return w.semana === cw; });
    var noturna = BuJo.readingPlan.noturna;
    var library = BuJo.state.readingProgress.library || {};

    var html = '<div class="reading-grid">';

    // ===== COLUNA ESQUERDA: LENDO =====
    html += '<div class="reading-col-left">';
    html += '<div class="reading-col-title">Lendo</div>';

    // Leitura Noturna
    html += renderReadingCard({
        id: 'noturna',
        category: 'espiritual',
        title: noturna.titulo,
        author: noturna.autor,
        totalPages: noturna.paginas,
        currentPage: BuJo.state.readingProgress.noturna.currentPage || 0,
        weekGoal: null,
        isNoturna: true
    });

    // Livro Espiritual da Semana
    if (wd) {
        var ek = 'sem' + cw + '_esp';
        var ep = BuJo.state.readingProgress.books[ek] || 0;
        var epPage = ep > 0 ? wd.espiritual.pInicio + ep - 1 : 0;
        var et = wd.espiritual.pFim - wd.espiritual.pInicio + 1;

        html += renderReadingCard({
            id: ek,
            category: 'espiritual',
            title: wd.espiritual.titulo,
            author: wd.espiritual.autor,
            totalPages: wd.espiritual.pFim,
            currentPage: epPage,
            weekGoal: { start: wd.espiritual.pInicio, end: wd.espiritual.pFim, read: ep, total: et },
            bloco: wd.bloco,
            week: cw
        });

        // Livro Cultural/Secular da Semana
        var sk = 'sem' + cw + '_sec';
        var sp = BuJo.state.readingProgress.books[sk] || 0;
        var spPage = sp > 0 ? wd.secular.pInicio + sp - 1 : 0;
        var st = wd.secular.pFim - wd.secular.pInicio + 1;

        html += renderReadingCard({
            id: sk,
            category: 'cultural',
            title: wd.secular.titulo,
            author: wd.secular.autor,
            totalPages: wd.secular.pFim,
            currentPage: spPage,
            weekGoal: { start: wd.secular.pInicio, end: wd.secular.pFim, read: sp, total: st },
            bloco: wd.bloco,
            week: cw
        });
    }

    html += '</div>';

    // ===== COLUNA DIREITA: BIBLIOTECA =====
    html += '<div class="reading-col-right">';
    html += '<div class="reading-col-title">Biblioteca</div>';

    // Obter todos os livros únicos do cronograma
    var allBooks = getAllBooksFromPlan();

    // Categorizar livros
    var proximas = allBooks.filter(function(b) { return (library[b.id] || 'nao_iniciado') === 'proximas'; });
    var concluidos = allBooks.filter(function(b) { return library[b.id] === 'concluido'; });
    var naoIniciados = allBooks.filter(function(b) { return !library[b.id] || library[b.id] === 'nao_iniciado'; });

    // Próximas Leituras
    html += '<div class="library-section">';
    html += '<div class="library-section-title">Próximas Leituras</div>';
    if (proximas.length === 0) {
        html += '<div style="color:var(--muted-foreground);font-size:var(--font-size-sm);font-style:italic;">Nenhum livro</div>';
    } else {
        proximas.forEach(function(b) {
            html += '<div class="library-item" onclick="showBookStatusModal(\'' + b.id + '\')">';
            html += '<span class="item-title">' + b.title + '</span>';
            html += '<span class="item-status">' + b.type + '</span>';
            html += '</div>';
        });
    }
    html += '</div>';

    // Concluídos
    html += '<div class="library-section">';
    html += '<div class="library-section-title">Concluído</div>';
    if (concluidos.length === 0) {
        html += '<div style="color:var(--muted-foreground);font-size:var(--font-size-sm);font-style:italic;">Nenhum livro</div>';
    } else {
        concluidos.forEach(function(b) {
            html += '<div class="library-item" onclick="showBookStatusModal(\'' + b.id + '\')">';
            html += '<span class="item-title">' + b.title + '</span>';
            html += '<span class="item-status">✓</span>';
            html += '</div>';
        });
    }
    html += '</div>';

    // Não Iniciados
    html += '<div class="library-section">';
    html += '<div class="library-section-title">Não Iniciado</div>';
    if (naoIniciados.length === 0) {
        html += '<div style="color:var(--muted-foreground);font-size:var(--font-size-sm);font-style:italic;">Nenhum livro</div>';
    } else {
        naoIniciados.slice(0, 10).forEach(function(b) {
            html += '<div class="library-item" onclick="showBookStatusModal(\'' + b.id + '\')">';
            html += '<span class="item-title">' + b.title + '</span>';
            html += '<span class="item-status">' + b.type + '</span>';
            html += '</div>';
        });
        if (naoIniciados.length > 10) {
            html += '<div style="color:var(--muted-foreground);font-size:var(--font-size-xs);text-align:center;padding:8px;">+' + (naoIniciados.length - 10) + ' livros</div>';
        }
    }
    html += '</div>';

    html += '</div>'; // fim col-right
    html += '</div>'; // fim reading-grid

    return html;
}

function renderReadingCard(book) {
    var pct = book.totalPages > 0 ? Math.round((book.currentPage / book.totalPages) * 100) : 0;
    var categoryClass = book.category === 'espiritual' ? 'espiritual' : 'cultural';
    var categoryLabel = book.category === 'espiritual' ? 'Espiritual' : 'Cultural';

    var html = '<div class="reading-book-card">';

    // Header: Categoria e Total de Páginas
    html += '<div class="book-header">';
    html += '<span class="book-type ' + categoryClass + '">' + categoryLabel + '</span>';
    html += '<span class="book-pages">' + book.totalPages + ' págs</span>';
    html += '</div>';

    // Título e Autor
    html += '<div class="book-title">' + book.title + '</div>';
    html += '<div class="book-author">' + book.author + '</div>';

    // Barra de progresso
    html += '<div class="reading-progress"><div class="reading-progress-bar"><div class="reading-progress-fill" style="width:' + pct + '%;"></div></div><span class="reading-percent">' + pct + '%</span></div>';

    // Registro de páginas
    if (book.isNoturna) {
        html += '<div style="display:flex;align-items:center;margin-top:8px;">Página: <input type="number" class="reading-input" value="' + book.currentPage + '" min="0" max="' + book.totalPages + '" onchange="updateNoturna(this.value)" style="margin-left:8px;margin-right:8px;"> / ' + book.totalPages + '</div>';
    } else if (book.weekGoal) {
        var goalPct = Math.round((book.weekGoal.read / book.weekGoal.total) * 100);
        var isComplete = goalPct >= 100;
        var currentPageValue = book.currentPage > 0 ? book.currentPage : '';

        html += '<div style="display:flex;align-items:center;margin-top:8px;">Página: <input type="number" class="reading-input" value="' + currentPageValue + '" min="' + book.weekGoal.start + '" max="' + book.weekGoal.end + '" placeholder="' + book.weekGoal.start + '" onchange="updateBookPage(\'' + book.id + '\',' + book.weekGoal.start + ',' + book.weekGoal.end + ',this.value)" style="margin-left:8px;margin-right:8px;width:70px;"> / ' + book.weekGoal.end + '</div>';

        // Meta da Semana
        html += '<div class="week-goal' + (isComplete ? ' week-goal-complete' : '') + '">';
        html += '<strong>Meta Semana ' + book.week + ':</strong> p.' + book.weekGoal.start + '–' + book.weekGoal.end + ' (' + goalPct + '%)';
        if (isComplete) {
            html += '<div style="margin-top:6px;"><span class="btn btn-primary" onclick="advanceToNextWeek()" style="padding:6px 12px;font-size:0.85rem;">Avançar Semana →</span></div>';
        }
        html += '</div>';
    }

    html += '</div>';
    return html;
}

function getAllBooksFromPlan() {
    var books = [];
    var seen = {};

    BuJo.readingPlan.cronograma.forEach(function(w) {
        var espKey = w.espiritual.titulo;
        if (!seen[espKey]) {
            seen[espKey] = true;
            books.push({
                id: 'book_esp_' + espKey.replace(/\s+/g, '_').toLowerCase(),
                title: w.espiritual.titulo,
                author: w.espiritual.autor,
                type: 'Esp'
            });
        }

        var secKey = w.secular.titulo;
        if (!seen[secKey]) {
            seen[secKey] = true;
            books.push({
                id: 'book_sec_' + secKey.replace(/\s+/g, '_').toLowerCase(),
                title: w.secular.titulo,
                author: w.secular.autor,
                type: 'Cul'
            });
        }
    });

    return books;
}

function showBookStatusModal(bookId) {
    var library = BuJo.state.readingProgress.library || {};
    var currentStatus = library[bookId] || 'nao_iniciado';

    var statusOptions = [
        { value: 'lendo', label: 'Lendo' },
        { value: 'proximas', label: 'Próximas Leituras' },
        { value: 'concluido', label: 'Concluído' },
        { value: 'nao_iniciado', label: 'Não Iniciado' }
    ];

    var optionsHtml = statusOptions.map(function(opt) {
        var selected = opt.value === currentStatus ? ' style="background:var(--primary);color:#fff;"' : '';
        return '<div class="library-item" onclick="changeBookStatus(\'' + bookId + '\',\'' + opt.value + '\')"' + selected + '><span class="item-title">' + opt.label + '</span>' + (opt.value === currentStatus ? '<span>✓</span>' : '') + '</div>';
    }).join('');

    showModal('<div class="modal-title">Alterar Estado</div>' + optionsHtml + '<div class="modal-actions"><span class="btn" onclick="closeModal()">Fechar</span></div>');
}

function changeBookStatus(bookId, status) {
    if (!BuJo.state.readingProgress.library) BuJo.state.readingProgress.library = {};
    BuJo.state.readingProgress.library[bookId] = status;
    saveState();
    closeModal();
    render();
}

function advanceToNextWeek() {
    var nw = BuJo.state.readingProgress.currentWeek + 1;
    if (nw <= 104) {
        BuJo.state.readingProgress.currentWeek = nw;
        saveState();
        render();
    }
}

function getBookNameFromKey(bookKey) {
    var match = bookKey.match(/sem(\d+)_(esp|sec)/);
    if (!match) return bookKey;
    var week = parseInt(match[1]);
    var type = match[2] === 'esp' ? 'Espiritual' : 'Secular';
    var wd = BuJo.readingPlan.cronograma.find(function(w) { return w.semana === week; });
    if (!wd) return bookKey;
    var book = type === 'Espiritual' ? wd.espiritual : wd.secular;
    return book.titulo;
}

function updateNoturna(v) {
    var page = parseInt(v) || 0;
    var dateStr = formatDateKey(new Date());
    if (!BuJo.state.readingProgress.noturna.history) BuJo.state.readingProgress.noturna.history = {};
    BuJo.state.readingProgress.noturna.history[dateStr] = page;
    BuJo.state.readingProgress.noturna.currentPage = page;
    saveState(); render();
}
function updateBook(k, v) { BuJo.state.readingProgress.books[k] = parseInt(v) || 0; saveState(); render(); }
function updateBookPage(bookKey, pInicio, pFim, pageValue) {
    var page = parseInt(pageValue);
    if (isNaN(page) || page < pInicio) {
        BuJo.state.readingProgress.books[bookKey] = 0;
    } else if (page > pFim) {
        BuJo.state.readingProgress.books[bookKey] = pFim - pInicio + 1;
    } else {
        BuJo.state.readingProgress.books[bookKey] = page - pInicio + 1;
    }
    var dateStr = formatDateKey(new Date());
    if (!BuJo.state.readingProgress.history) BuJo.state.readingProgress.history = {};
    if (!BuJo.state.readingProgress.history[dateStr]) BuJo.state.readingProgress.history[dateStr] = {};
    BuJo.state.readingProgress.history[dateStr][bookKey] = page;
    saveState(); render();
}
function navWeek(d) { var nw = BuJo.state.readingProgress.currentWeek + d; if (nw >= 1 && nw <= 104) { BuJo.state.readingProgress.currentWeek = nw; saveState(); render(); } }

if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
else init();
</script>
</body>
</html>