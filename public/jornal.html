<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Bullet Journal - Pedro 2026</title>
    <style>
        :root {
            --background: #ffffff;
            --foreground: #09090b;
            --card: #ffffff;
            --primary: #18181b;
            --secondary: #f4f4f5;
            --muted-foreground: #71717a;
            --border: #e4e4e7;
            --radius: 0.75rem;
            --font-sans: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-size-base: 18px;
            --font-size-sm: 16px;
            --font-size-xs: 14px;
            --font-size-lg: 20px;
            --font-size-xl: 24px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; background-color: var(--background); color: var(--foreground); font-family: var(--font-sans); font-size: var(--font-size-base); line-height: 1.5; }
        .app-shell { display: flex; flex-direction: column; height: 100vh; }
        .app-header { border-bottom: 1px solid var(--border); padding: 12px 1.25rem; background: rgba(255,255,255,0.95); backdrop-filter: blur(8px); z-index: 50; flex-shrink: 0; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .header-date { font-size: var(--font-size-xl); font-weight: 700; text-transform:capitalize; cursor: pointer; padding: 4px 8px; border-radius: 0.5rem; }
        .header-date:active { background: var(--secondary); }
        .btn-icon { background: transparent; border: 1px solid var(--border); border-radius: 0.5rem; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .btn-icon:active { background: var(--secondary); transform: scale(0.96); }
        .nav-tabs { display: -webkit-box; display: flex; -webkit-flex-wrap: wrap; flex-wrap: wrap; -webkit-box-pack: center; justify-content: center; }
        .nav-tab { font-size: var(--font-size-sm); text-transform: uppercase; padding: 8px 14px; border: 1px solid var(--border); background: var(--secondary); cursor: pointer; border-radius: 0.5rem; font-weight: 500; margin-right: 6px; margin-bottom: 6px; }
        .nav-tab:active { transform: scale(0.96); }
        .nav-tab.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .main {flex: 1; overflow-y: auto; padding: 0.7rem; padding-bottom: 1rem; max-width: 700px; margin: 0 auto; width: 100%; }
        .card { background: var(--card); border-radius: var(--radius); padding: 0.75rem 0.5rem 0.5rem 0.5rem; }
        .card-title { font-size: var(--font-size-lg); font-weight: 700; border-bottom: 1px solid var(--secondary); padding-bottom: 10px; margin-bottom: 14px; display: flex; justify-content: space-between; align-items: center; }
        .btn { font-size: var(--font-size-sm); padding: 8px 16px; border: 1px solid var(--border); background: var(--secondary); cursor: pointer; border-radius: 0.5rem; font-weight: 500; }
        .btn:active { transform: scale(0.96); background: var(--border); }
        .btn-primary { background: var(--primary); color: #fff; border-color: var(--primary); }
        .special-day { background: var(--secondary); border: 1px solid var(--border); border-radius: 0.5rem; padding: 10px 14px; font-size: var(--font-size-sm); }
        .schedule-item { display: flex; padding: 8px 0; border-bottom: 1px dotted var(--border); }
        .schedule-time { width: 70px; font-size: var(--font-size-sm); color: var(--muted-foreground); flex-shrink: 0; }
        .schedule-event { flex: 1; }
        .schedule-event.special { font-weight: 600; }
        .habit-row { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px dotted var(--border); }
        .habit-name { flex: 1; }
        .habit-check { width: 36px; height: 36px; border: 2px solid var(--primary); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .habit-check.checked { background: var(--primary); color: #fff; }
        .tracker-table { width: 100%; border-collapse: collapse; font-size: var(--font-size-sm); table-layout: fixed; }
        .tracker-table th, .tracker-table td { border: 1px solid var(--border); padding: 8px; text-align: center; }
        .tracker-table th { background: var(--secondary); font-size: var(--font-size-xs); text-transform: uppercase; }
        .tracker-table .label { text-align: left; font-weight: 500; width: 25%; }
        .tracker-cell { cursor: pointer; min-width: 36px; height: 36px; }
        .tracker-cell.checked { background: var(--primary); color: #fff; }
        .tracker-cell.na { background: var(--secondary); color: var(--muted-foreground); }
        .month-calendar { display: table; width: 100%; border-collapse: collapse; }
        .month-row { display: table-row; }
        .month-cell { display: table-cell; border: 1px solid var(--border); width: 14.28%; height: 50px; text-align: center; vertical-align: top; padding: 4px; cursor: pointer; }
        .month-cell.header { background: var(--secondary); font-size: var(--font-size-xs); font-weight: 600; height: auto; padding: 8px 4px; }
        .month-cell.today { border: 3px solid var(--primary); font-weight: 700; background: var(--secondary); }
        .month-cell.selected { background: var(--primary); color: #fff; }
        .month-cell.special { background: #f5f5f5; }
        .month-cell.empty { background: #fafafa; }
        .month-cell.has-events { font-weight: 700; text-decoration: underline; }
        .entry { padding: 10px 0; border-bottom: 1px dotted var(--border); display: flex; align-items: flex-start; gap: 10px; }
        .entry-symbol { width: 24px; cursor: pointer; font-size: var(--font-size-lg); flex-shrink: 0; }
        .entry-text { flex: 1; }
        .entry-text.done { text-decoration: line-through; color: var(--muted-foreground); }
        .add-entry { margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--border); display: flex; gap: 8px; flex-wrap: wrap; }
        .add-entry input { flex: 1; min-width: 150px; padding: 10px 14px; border: 1px solid var(--border); border-radius: 0.5rem; font-size: var(--font-size-base); }
        .add-entry select { padding: 10px 14px; border: 1px solid var(--border); border-radius: 0.5rem; font-size: var(--font-size-base); }
        .index-item { padding: 14px 0; border-bottom: 1px dotted var(--border); cursor: pointer; }
        .index-item:active { background: var(--secondary); }
        .summary-box { text-align: center; padding: 16px; }
        .summary-percent { font-size: 2.5rem; font-weight: 700; }
        .summary-bar { height: 10px; background: var(--secondary); margin-top: 10px; border-radius: 5px; overflow: hidden; }
        .summary-fill { height: 100%; background: var(--primary); border-radius: 5px; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; }
        .modal-overlay.active { display: flex; align-items: center; justify-content: center; }
        .modal { background: #fff; border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; width: 90%; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        .modal-title { font-weight: 700; font-size: var(--font-size-lg); margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; font-size: var(--font-size-xs); text-transform: uppercase; color: var(--muted-foreground); margin-bottom: 6px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: 0.5rem; font-size: var(--font-size-base); font-family: inherit; }
        .modal-actions { margin-top: 16px; display: flex; gap: 10px; justify-content: flex-end; }
        .study-check { width: 28px; height: 28px; border: 2px solid var(--border); border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .study-check.checked { background: var(--primary); color: #fff; border-color: var(--primary); }
        .future-month { margin-bottom: 16px; }
        .future-month-header { font-weight: 600; padding: 10px 14px; background: var(--primary); color: #fff; border-radius: 0.5rem 0.5rem 0 0; text-transform: capitalize; }
        .future-month-content { padding: 10px 14px; border: 1px solid var(--border); border-top: none; border-radius: 0 0 0.5rem 0.5rem; min-height: 50px; }
        .note-item { padding: 14px; border: 1px solid var(--border); border-radius: 0.5rem; margin-bottom: 12px; }
        .note-date { font-size: var(--font-size-xs); color: var(--muted-foreground); margin-bottom: 6px; }
        .note-type { display: inline-block; font-size: var(--font-size-xs); padding: 2px 8px; background: var(--secondary); border-radius: 4px; margin-right: 8px; }
        /* Week View */
        .week-grid { display: flex; flex-direction: column; }
        .week-row { display: flex; margin-bottom: 12px; }
        .week-day { flex: 1; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; min-height: 150px; }
        .week-day.weekend { flex: 1; min-height: 80px; }
        .week-day-header { font-weight: 700; font-size: var(--font-size-sm); text-transform: uppercase; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
        .week-day-header .day-number { background: var(--primary); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: var(--font-size-xs); }
        .week-day.today .week-day-header { border-bottom-color: #16a34a; }
        .week-day.today .week-day-header .day-number { background: #16a34a; }
        .week-entry { font-size: var(--font-size-xs); padding: 4px 0; border-bottom: 1px dotted var(--border); display: flex; gap: 6px; align-items: flex-start; }
        .week-entry:last-child { border-bottom: none; }
        .week-entry-symbol { flex-shrink: 0; }
        .week-entry-text { flex: 1; word-break: break-word; }
        .week-entry-text.done { text-decoration: line-through; color: var(--muted-foreground); }
        .week-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .week-nav-title { font-weight: 700; font-size: var(--font-size-lg); }
        .weekend-container { display: flex; flex-direction: column; flex: 1; gap: 8px; }
        /* Day View Buttons */
        .day-buttons-grid { display: flex; flex-direction: column; margin-top: 10px; }
        .day-btn { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; margin-bottom: 10px; background: var(--card); border: 2px solid var(--border); border-radius: var(--radius); cursor: pointer; font-size: var(--font-size-lg); font-weight: 600; transition: all 0.1s ease; }
        .day-btn:active { transform: scale(0.98); background: var(--secondary); }
        .day-btn-icon { font-size: 1.5rem; margin-right: 12px; }
        .day-btn-label { flex: 1; text-align: left; }
        .day-btn-arrow { color: var(--muted-foreground); }
        .day-btn-badge { background: var(--primary); color: #fff; padding: 2px 10px; border-radius: 12px; font-size: var(--font-size-sm); margin-right: 8px; }
        /* Full Modal for Day Sections */
        .modal-full { background: #fff; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 101; overflow-y: auto; padding: 1rem; }
        .modal-full-header { display: flex; align-items: center; justify-content: space-between; padding: 7px 0; border-bottom: 2px solid var(--primary); margin-bottom: 16px; position: sticky; top: 0; background: #fff; z-index: 10; }
        .modal-full-title { font-size: var(--font-size-xl); font-weight: 700; }
        .modal-full-close { background: var(--secondary); border: 1px solid var(--border); border-radius: 0.5rem; padding: 10px 20px; font-size: var(--font-size-base); cursor: pointer; font-weight: 600; }
        .modal-full-close:active { background: var(--border); }
    </style>
</head>
<body>
<div class="app-shell">
    <header class="app-header">
        <div class="header-top">
            <div>
                <div class="header-date" id="header-date"></div>
            </div>
            <button class="btn-icon" onclick="window.location.href='dashboard.html'">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            </button>
        </div>
        <div class="nav-tabs" id="nav-tabs">
            <span class="nav-tab active" data-view="dia">Dia</span>
            <span class="nav-tab" data-view="semana">Semana</span>
            <span class="nav-tab" data-view="mes">Mês</span>
            <span class="nav-tab" data-view="plano">Plano</span>
            <span class="nav-tab" data-view="notas">Notas</span>
        </div>
    </header>
    <div class="main" id="main-content"></div>
</div>
<div class="modal-overlay" id="modal-overlay"><div class="modal" id="modal-content"></div></div>
<script>
var TIME_OFFSET_MINUTES = -180; // -3h (UTC-3 Brasil)
function agoraCorrigido() { var d = new Date(); return new Date(d.getTime() + TIME_OFFSET_MINUTES * 60000); }

var BuJo = {
    state: {
        currentView: 'dia',
        selectedDate: agoraCorrigido(),
        entries: [],
        spiritualHabits: {},
        studyGoals: {},
        mortifications: {},
        projects: [],
        futureLog: [],
        notes: [],
        calendarEvents: [],
    },
    symbols: { task: '•', taskDone: '✕', taskMigrated: '→', event: '○', note: '–' },
    dailySpiritualHabits: [
        { id: 'serviam', name: 'Sérviam' },
        { id: 'preces', name: 'Preces' },
        { id: 'oracao-manha', name: 'Oração manhã' },
        { id: 'santa-missa', name: 'Santa Missa' },
        { id: 'leitura-espiritual', name: 'Leit. Espiritual' },
        { id: 'leitura-nt', name: 'Leitura NT' },
        { id: 'angelus', name: 'Angelus' },
        { id: 'visita-santissimo', name: 'Visita Santíssimo' },
        { id: 'lembrai-vos', name: 'Lembrai-vos' },
        { id: 'terco', name: 'Terço' },
        { id: 'oracao-tarde', name: 'Oração tarde' },
        { id: 'contemplacao', name: 'Contemplação' },
        { id: 'exame', name: 'Exame' },
        { id: '2-horas', name: '2 horas' },
        { id: '3-ave-marias', name: '3 Ave Marias' }
    ],
    weeklySpecialHabits: {
        2: [{ id: 'turno', name: 'Dia de Turno' }, { id: 'salmo-2', name: 'Salmo 2' }],
        3: [{ id: 'guarda', name: 'Dia de Guarda' }, { id: 'disciplina', name: 'Disciplina' }],
        4: [{ id: 'adoro-te', name: 'Adoro Te Devote' }],
        6: [{ id: 'oracao-nossa-senhora', name: 'Oração N. Senhora' }, { id: 'mortificacao-extra', name: 'Mortif. Extra' }]
    },
    studyGoalsList: [
        { id: 'latim', name: 'Latim', dailyGoal: 1, description: 'Gradus Primus - 1 lição', weekDays: [1, 2, 3, 4, 5] },
        { id: 'japones', name: 'Japonês', dailyGoal: 1, description: '1 sessão de estudo', weekDays: [0, 2, 3, 4] },
        { id: 'estatistica', name: 'Estatística', dailyGoal: 2, description: '2 blocos de estudo' },
        { id: 'tenis-mesa', name: 'Tênis Mesa', dailyGoal: 1, description: '1 treino', weekDays: [1, 5, 6] }
    ],
    dayNames: ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'],
    dayNamesShort: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb']
};

function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
function formatDateKey(date) {
    var d = new Date(date);
    return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}
function getMonthKey(date) { var d = new Date(date); return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0'); }
function getWeekDays(date) {
    var d = new Date(date);
    var start = new Date(d);
    start.setDate(d.getDate() - d.getDay());
    var days = [];
    for (var i = 0; i < 7; i++) {
        var day = new Date(start);
        day.setDate(start.getDate() + i);
        days.push(day);
    }
    return days;
}
function isToday(date) {
    var today = agoraCorrigido();
    return date.getDate() === today.getDate() && date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear();
}
function isThirdSunday(date) { return date.getDay() === 0 && date.getDate() >= 15 && date.getDate() <= 21; }
function formatDateDisplay(date) { return date.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' }); }
function formatDateShort(date) { return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }); }

// ============= SALVAMENTO E CARREGAMENTO (SERVIDOR) =============
var syncTimeout = null;
var isSyncing = false;

function saveState() {
    clearTimeout(syncTimeout);
    syncTimeout = setTimeout(syncToServer, 2000);
}

async function syncToServer() {
    if (isSyncing) return;
    isSyncing = true;
    try {
        var stateToSync = {
            entries: BuJo.state.entries,
            spiritualHabits: BuJo.state.spiritualHabits,
            studyGoals: BuJo.state.studyGoals,
            mortifications: BuJo.state.mortifications,
            projects: BuJo.state.projects,
            futureLog: BuJo.state.futureLog,
            notes: BuJo.state.notes
        };
        var response = await fetch('/api/sync/jornal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(stateToSync)
        });
        if (response.ok) {
            console.log('Jornal salvo no servidor');
        }
    } catch(e) {
        console.warn('Falha ao salvar no servidor:', e.message);
    } finally {
        isSyncing = false;
    }
}

async function loadFromServer() {
    try {
        var response = await fetch('/api/sync/jornal');
        if (response.ok) {
            var data = await response.json();
            if (data.state) {
                var s = data.state;
                BuJo.state.entries = s.entries || [];
                BuJo.state.spiritualHabits = s.spiritualHabits || {};
                BuJo.state.studyGoals = s.studyGoals || {};
                BuJo.state.mortifications = s.mortifications || {};
                BuJo.state.projects = s.projects || [];
                BuJo.state.futureLog = s.futureLog || [];
                BuJo.state.notes = s.notes || [];
                return true;
            }
        }
    } catch(e) {
        console.warn('Falha ao carregar do servidor:', e.message);
    }
    return false;
}

async function loadCalendarEvents() {
    try {
        var API_URL = window.location.origin;
        var response = await fetch(API_URL + '/api/calendar/events?days=60');
        if (response.ok) BuJo.state.calendarEvents = await response.json();
        else BuJo.state.calendarEvents = [];
    } catch(e) { BuJo.state.calendarEvents = []; }
    render();
}

function getEventsForDate(dateStr) {
    var events = [];
    for (var i = 0; i < BuJo.state.calendarEvents.length; i++) {
        var ev = BuJo.state.calendarEvents[i];
        if (ev.start.date && ev.start.date === dateStr) {
            events.push({ ...ev, allDay: true });
        } else if (ev.start.dateTime) {
            var rd = new Date(ev.start.dateTime);
            rd.setHours(rd.getHours() - 3);
            if (formatDateKey(rd) === dateStr) {
                events.push({ ...ev, allDay: false, startTime: rd.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) });
            }
        }
    }
    events.sort(function(a,b) { return a.allDay && !b.allDay ? -1 : !a.allDay && b.allDay ? 1 : (a.startTime||'').localeCompare(b.startTime||''); });
    return events;
}

async function init() {
    document.getElementById('main-content').innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted-foreground);">Carregando...</div>';
    updateHeaderDate();
    bindNavEvents();
    await loadFromServer();
    render();
    loadCalendarEvents();
}
function updateHeaderDate() {
    var headerDate = document.getElementById('header-date');
    headerDate.textContent = agoraCorrigido().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    headerDate.onclick = function() { goToToday(); };
}
function bindNavEvents() {
    document.getElementById('nav-tabs').onclick = function(e) {
        if (e.target.className.indexOf('nav-tab') !== -1) setView(e.target.getAttribute('data-view'));
    };
    document.getElementById('modal-overlay').onclick = function(e) { if (e.target.id === 'modal-overlay') closeModal(); };
}
function setView(view) {
    BuJo.state.currentView = view;
    document.querySelectorAll('.nav-tab').forEach(function(t) {
        var isActive = t.getAttribute('data-view') === view;
        t.className = 'nav-tab' + (isActive ? ' active' : '');
    });
    render();
}

function render() {
    var main = document.getElementById('main-content');
    var view = BuJo.state.currentView;
    if (view === 'dia') main.innerHTML = renderDayView();
    else if (view === 'semana') main.innerHTML = renderWeekView();
    else if (view === 'mes') main.innerHTML = renderMonthView();
    else if (view === 'plano') main.innerHTML = renderPlanoVida();
    else if (view === 'notas') main.innerHTML = renderNotas();
    bindViewEvents();
}

function bindViewEvents() {
    var prevDate = document.getElementById('prev-date');
    var nextDate = document.getElementById('next-date');
    var prevWeek = document.getElementById('prev-week');
    var nextWeek = document.getElementById('next-week');
    var prevMonth = document.getElementById('prev-month');
    var nextMonth = document.getElementById('next-month');
    var todayBtn = document.getElementById('today-btn');
    if (prevDate) prevDate.onclick = function() { navigateDate(-1); };
    if (nextDate) nextDate.onclick = function() { navigateDate(1); };
    if (prevWeek) prevWeek.onclick = function() { navigateWeek(-1); };
    if (nextWeek) nextWeek.onclick = function() { navigateWeek(1); };
    if (prevMonth) prevMonth.onclick = function() { navigateMonth(-1); };
    if (nextMonth) nextMonth.onclick = function() { navigateMonth(1); };
    if (todayBtn) todayBtn.onclick = function() { goToToday(); };
    
    document.querySelectorAll('.spiritual-check').forEach(function(el) {
        el.onclick = function() { toggleSpiritualHabit(el.getAttribute('data-habit'), el.getAttribute('data-date')); };
    });
    document.querySelectorAll('.study-check').forEach(function(el) {
        el.onclick = function() { toggleStudyGoal(el.getAttribute('data-habit'), el.getAttribute('data-date'), parseInt(el.getAttribute('data-index'))); };
    });
    document.querySelectorAll('.mort-check').forEach(function(el) {
        el.onclick = function() { toggleMortification(el.getAttribute('data-date'), parseInt(el.getAttribute('data-index'))); };
    });
    
    var addEntryBtn = document.getElementById('add-entry-btn');
    var addEntryInput = document.getElementById('add-entry-input');
    if (addEntryBtn) addEntryBtn.onclick = addEntry;
    if (addEntryInput) addEntryInput.onkeypress = function(e) { if (e.key === 'Enter') addEntry(); };
    
    document.querySelectorAll('.entry-symbol[data-id]').forEach(function(el) {
        el.onclick = function() { cycleEntrySymbol(el.getAttribute('data-id')); };
    });
    document.querySelectorAll('.entry-edit').forEach(function(el) {
        el.onclick = function() { showEditEntryModal(el.getAttribute('data-id')); };
    });
    document.querySelectorAll('.event-clickable').forEach(function(el) {
        el.onclick = function() { showEventDetails(el.getAttribute('data-event-date'), parseInt(el.getAttribute('data-event-idx'))); };
    });
    
    var addMortBtn = document.getElementById('add-mort-btn');
    var addNoteBtn = document.getElementById('add-note-btn');
    var saveNotesBtn = document.getElementById('save-notes-btn');
    if (addMortBtn) addMortBtn.onclick = showAddMortModal;
    if (addNoteBtn) addNoteBtn.onclick = showAddNoteModal;
    if (saveNotesBtn) saveNotesBtn.onclick = saveAllNotes;
    
    document.querySelectorAll('.month-cell[data-date]').forEach(function(el) {
        el.onclick = function() { selectMonthDay(el.getAttribute('data-date')); };
        el.ondblclick = function() { BuJo.state.selectedDate = new Date(el.getAttribute('data-date') + 'T12:00:00'); setView('dia'); };
    });
    document.querySelectorAll('.index-item[data-view]').forEach(function(el) {
        el.onclick = function() { setView(el.getAttribute('data-view')); };
    });
}

function renderDayView() {
    var date = BuJo.state.selectedDate;
    var dateStr = formatDateKey(date);
    var dow = date.getDay();
    var specialHabits = BuJo.weeklySpecialHabits[dow] || [];
    var thirdSunday = isThirdSunday(date);
    var dayEntries = BuJo.state.entries.filter(function(e) { return e.date === dateStr; });
    var calendarEvents = getEventsForDate(dateStr);
    var todayBadge = isToday(date) ? ' <span style="background:var(--primary);color:#fff;padding:4px 10px;font-size:0.8rem;border-radius:4px;margin-left:8px;">HOJE</span>' : '';

    // Contadores para badges
    var entriesCount = dayEntries.length;
    var eventsCount = calendarEvents.length;
    var dayHabits = BuJo.state.spiritualHabits[dateStr] || {};
    var habitsChecked = 0;
    var habitsTotal = BuJo.dailySpiritualHabits.length;
    BuJo.dailySpiritualHabits.forEach(function(h) { if (dayHabits[h.id]) habitsChecked++; });
    var morts = BuJo.state.mortifications[dateStr] || [];
    var mortsCount = morts.length;

    // Verifica se o dia possui conteúdo especial
    var hasSpecial = specialHabits.length > 0 || thirdSunday;
    var titleStyle = hasSpecial ? '' : ' style="border-bottom:none;margin-bottom:0;padding-bottom:0;"';

    // Encontrar evento atual ou próximo
    var currentOrNextEvent = getCurrentOrNextEvent(calendarEvents);

    // Encontrar registro estrela
    var starEntry = dayEntries.find(function(e) { return e.starred; });

    var html = '<div class="card">';
    html += '<div class="card-title"' + titleStyle + '><span class="btn" id="prev-date" style="line-height:1;"><img src="/icones/seta.png" style="transform:rotate(180deg);width:20px;height:20px;"></span>';
    html += '<span style="flex:1;text-align:center;text-transform:capitalize;">' + formatDateDisplay(date) + todayBadge + '</span>';
    html += '<span class="btn" id="next-date" style="line-height:1;"><img src="/icones/seta.png" style="width:20px;height:20px;"></span></div>';

    if (hasSpecial) {
        html += '<div class="special-day"><strong>★ Especial:</strong> ';
        var sp = specialHabits.map(function(h) { return h.name; });
        if (thirdSunday) sp.push('Sýmbolum Athanasiánum');
        html += sp.join(' • ') + '</div>';
    }
    html += '</div>';

    // Botões
    html += '<div class="day-buttons-grid">';

    // EVENTOS
    html += '<div class="day-btn" onclick="openDaySection(\'eventos\')">';
    html += '<div style="flex:1;"><div class="day-btn-label">Eventos</div>';
    if (currentOrNextEvent) {
        html += '<div style="font-size:var(--font-size-xs);color:var(--muted-foreground);margin-top:2px;">' + currentOrNextEvent + '</div>';
    }
    html += '</div>';
    if (eventsCount > 0) html += '<span class="day-btn-badge">' + eventsCount + '</span>';
    html += '</div>';

    // REGISTROS
    html += '<div class="day-btn" onclick="openDaySection(\'registros\')">';
    html += '<div style="flex:1;"><div class="day-btn-label">Registros</div>';
    if (starEntry) {
        html += '<div style="font-size:var(--font-size-xs);color:var(--muted-foreground);margin-top:2px;">★ ' + starEntry.text.substring(0, 30) + (starEntry.text.length > 30 ? '...' : '') + '</div>';
    }
    html += '</div>';
    if (entriesCount > 0) html += '<span class="day-btn-badge">' + entriesCount + '</span>';
    html += '</div>';

    // PLANO DE VIDA
    html += '<div class="day-btn" onclick="openDaySection(\'plano\')">';
    html += '<span class="day-btn-label">Plano de Vida</span>';
    html += '<span class="day-btn-badge">' + habitsChecked + '/' + habitsTotal + '</span>';
    html += '</div>';

    // MORTIFICAÇÕES
    html += '<div class="day-btn" onclick="openDaySection(\'mortificacoes\')">';
    html += '<span class="day-btn-label">Mortificações</span>';
    if (mortsCount > 0) html += '<span class="day-btn-badge">' + mortsCount + '</span>';
    html += '</div>';

    html += '</div>';
    return html;
}

function getCurrentOrNextEvent(events) {
    if (!events || events.length === 0) return null;
    var now = agoraCorrigido();
    var currentHour = now.getHours();
    var currentMin = now.getMinutes();
    var currentTime = currentHour * 60 + currentMin;

    for (var i = 0; i < events.length; i++) {
        var ev = events[i];
        if (ev.allDay) return ev.summary;
        if (ev.startTime) {
            var parts = ev.startTime.split(':');
            var evTime = parseInt(parts[0]) * 60 + parseInt(parts[1]);
            if (evTime >= currentTime - 60) { // evento atual ou próximo (dentro de 1h)
                return (evTime <= currentTime ? 'Agora: ' : '') + ev.summary;
            }
        }
    }
    return events[0].summary; // retorna o primeiro se nenhum for atual
}

function renderDaySpiritualHabits(dateStr, dow, thirdSunday) {
    var dayHabits = BuJo.state.spiritualHabits[dateStr] || {};
    var specialHabits = BuJo.weeklySpecialHabits[dow] || [];
    var html = '<div style="display:-webkit-box;display:flex;-webkit-flex-wrap:wrap;flex-wrap:wrap;">';
    BuJo.dailySpiritualHabits.forEach(function(h) {
        var checked = dayHabits[h.id] || false;
        html += '<div class="habit-row" style="width:50%;-webkit-box-sizing:border-box;box-sizing:border-box;padding-right:8px;"><span class="habit-name">' + h.name + '</span>';
        html += '<span class="habit-check spiritual-check' + (checked ? ' checked' : '') + '" data-habit="' + h.id + '" data-date="' + dateStr + '">' + (checked ? '✓' : '') + '</span></div>';
    });
    html += '</div>';
    if (specialHabits.length > 0) {
        html += '<div style="margin-top:14px;padding-top:12px;border-top:2px solid var(--primary);"><strong>★ Especiais do dia</strong></div>';
        specialHabits.forEach(function(h) {
            var checked = dayHabits[h.id] || false;
            html += '<div class="habit-row" style="background:var(--secondary);margin:4px -10px;padding:10px;"><span class="habit-name" style="font-weight:600;">' + h.name + '</span>';
            html += '<span class="habit-check spiritual-check' + (checked ? ' checked' : '') + '" data-habit="' + h.id + '" data-date="' + dateStr + '">' + (checked ? '✓' : '') + '</span></div>';
        });
    }
    if (thirdSunday) {
        var checked = dayHabits['symbolum-athanasianum'] || false;
        html += '<div class="habit-row" style="background:var(--secondary);margin:4px -10px;padding:10px;"><span class="habit-name" style="font-weight:600;">Sýmbolum Athanasiánum</span>';
        html += '<span class="habit-check spiritual-check' + (checked ? ' checked' : '') + '" data-habit="symbolum-athanasianum" data-date="' + dateStr + '">' + (checked ? '✓' : '') + '</span></div>';
    }
    return html;
}

function renderMortifications(dateStr) {
    var morts = BuJo.state.mortifications[dateStr] || [];
    if (morts.length === 0) return '<p style="color:var(--muted-foreground);font-style:italic;">Nenhuma mortificação.</p>';
    return morts.map(function(m, i) {
        return '<div class="habit-row"><span class="habit-name"' + (m.done ? ' style="text-decoration:line-through;color:var(--muted-foreground);"' : '') + '>' + m.text + '</span>' +
            '<span class="habit-check mort-check' + (m.done ? ' checked' : '') + '" data-date="' + dateStr + '" data-index="' + i + '">' + (m.done ? '✓' : '') + '</span></div>';
    }).join('');
}

function renderEntry(entry) {
    var symbol = entry.type === 'note' ? BuJo.symbols.note : entry.type === 'event' ? BuJo.symbols.event : entry.status === 'done' ? BuJo.symbols.taskDone : entry.status === 'migrated' ? BuJo.symbols.taskMigrated : BuJo.symbols.task;
    return '<div class="entry"><span class="entry-symbol" data-id="' + entry.id + '">' + symbol + '</span>' +
        '<span class="entry-text' + (entry.status === 'done' ? ' done' : '') + '">' + entry.text + '</span>' +
        '<span class="btn entry-edit" data-id="' + entry.id + '" style="padding:4px 10px;">✎</span></div>';
}

function renderWeekView() {
    var date = BuJo.state.selectedDate;
    var dayOfWeek = date.getDay();
    // Ajusta para começar na segunda (0=dom, 1=seg, etc)
    var mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
    var monday = new Date(date);
    monday.setDate(date.getDate() + mondayOffset);

    var weekDays = [];
    for (var i = 0; i < 7; i++) {
        var d = new Date(monday);
        d.setDate(monday.getDate() + i);
        weekDays.push(d);
    }

    var weekStart = monday.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' });
    var sunday = weekDays[6];
    var weekEnd = sunday.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' });

    var html = '<div class="week-nav">';
    html += '<span class="btn" id="prev-week" style="line-height:1;"><img src="/icones/seta.png" style="transform:rotate(180deg);width:20px;height:20px;"></span>';
    html += '<span class="week-nav-title">' + weekStart + ' - ' + weekEnd + '</span>';
    html += '<span class="btn" id="next-week" style="line-height:1;"><img src="/icones/seta.png" style="width:20px;height:20px;"></span>';
    html += '</div>';

    html += '<div class="week-grid">';

    // Linha 1: Seg | Ter | Qua
    html += '<div class="week-row">';
    for (var i = 0; i < 3; i++) {
        html += renderWeekDayCard(weekDays[i]);
    }
    html += '</div>';

    // Linha 2: Qui | Sex | (Sab & Dom)
    html += '<div class="week-row">';
    for (var i = 3; i < 5; i++) {
        html += renderWeekDayCard(weekDays[i]);
    }
    // Sab & Dom dividindo espaço de um
    html += '<div class="weekend-container">';
    html += renderWeekDayCard(weekDays[5], true); // Sábado
    html += renderWeekDayCard(weekDays[6], true); // Domingo
    html += '</div>';
    html += '</div>';

    html += '</div>';
    return html;
}

function renderWeekDayCard(date, isWeekend) {
    var dateStr = formatDateKey(date);
    var dayName = date.toLocaleDateString('pt-BR', { weekday: 'short' }).replace('.', '');
    var dayNum = date.getDate();
    var isTodayDate = isToday(date);

    var entries = BuJo.state.entries.filter(function(e) { return e.date === dateStr; });

    var cardClass = 'week-day' + (isWeekend ? ' weekend' : '') + (isTodayDate ? ' today' : '');
    var html = '<div class="' + cardClass + '">';
    html += '<div class="week-day-header"><span>' + dayName + '</span><span class="day-number">' + dayNum + '</span></div>';

    if (entries.length === 0) {
        html += '<div style="color:var(--muted-foreground);font-size:var(--font-size-xs);font-style:italic;">Sem registros</div>';
    } else {
        entries.forEach(function(entry) {
            var symbol = entry.type === 'note' ? BuJo.symbols.note : entry.type === 'event' ? BuJo.symbols.event : entry.status === 'done' ? BuJo.symbols.taskDone : entry.status === 'migrated' ? BuJo.symbols.taskMigrated : BuJo.symbols.task;
            html += '<div class="week-entry">';
            html += '<span class="week-entry-symbol">' + symbol + '</span>';
            html += '<span class="week-entry-text' + (entry.status === 'done' ? ' done' : '') + '">' + entry.text + '</span>';
            html += '</div>';
        });
    }

    html += '</div>';
    return html;
}

function renderMonthView() {
    var date = BuJo.state.selectedDate;
    var year = date.getFullYear(), month = date.getMonth();
    var firstDay = new Date(year, month, 1);
    var lastDay = new Date(year, month + 1, 0);
    var startPadding = firstDay.getDay();
    var monthName = date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

    var html = '<div class="card"><div class="card-title"><span class="btn" id="prev-month" style="line-height:1;"><img src="/icones/seta.png" style="transform:rotate(180deg);width:20px;height:20px;"></span>';
    html += '<span style="flex:1;text-align:center;text-transform:capitalize;">' + monthName + '</span>';
    html += '<span class="btn" id="next-month" style="line-height:1;"><img src="/icones/seta.png" style="width:20px;height:20px;"></span></div>';
    html += '<div class="month-calendar"><div class="month-row">';
    BuJo.dayNamesShort.forEach(function(d) { html += '<div class="month-cell header">' + d + '</div>'; });
    html += '</div>';

    var dayCount = 0, totalCells = startPadding + lastDay.getDate(), rows = Math.ceil(totalCells / 7);
    for (var r = 0; r < rows; r++) {
        html += '<div class="month-row">';
        for (var c = 0; c < 7; c++) {
            var cellIndex = r * 7 + c;
            if (cellIndex < startPadding || dayCount >= lastDay.getDate()) {
                html += '<div class="month-cell empty"></div>';
            } else {
                dayCount++;
                var dayDate = new Date(year, month, dayCount);
                var dateStr = formatDateKey(dayDate);
                var dow = dayDate.getDay();
                var isTodayCell = isToday(dayDate);
                var isSelected = dateStr === formatDateKey(date);
                var special = dow === 2 || dow === 3 || dow === 4 || dow === 6 || isThirdSunday(dayDate);
                var hasEvents = getEventsForDate(dateStr).length > 0;

                var cellClass = 'month-cell';
                if (isTodayCell) cellClass += ' today';
                if (isSelected) cellClass += ' selected';
                if (special && !isTodayCell && !isSelected) cellClass += ' special';
                if (hasEvents) cellClass += ' has-events';
                html += '<div class="' + cellClass + '" data-date="' + dateStr + '"><strong>' + dayCount + '</strong></div>';
            }
        }
        html += '</div>';
    }
    html += '</div></div>';

    html += '<div class="card" id="day-events-panel">' + renderDayEventsPanel(formatDateKey(date)) + '</div>';
    return html;
}

function renderDayEventsPanel(dateStr) {
    var date = new Date(dateStr + 'T12:00:00');
    var dow = date.getDay();
    var calendarEvents = getEventsForDate(dateStr);
    var specialHabits = BuJo.weeklySpecialHabits[dow] || [];
    var thirdSunday = isThirdSunday(date);

    var html = '<div class="card-title" style="text-transform:capitalize;">' + formatDateDisplay(date) + '</div>';
    if (specialHabits.length > 0 || thirdSunday) {
        html += '<div class="special-day"><strong>★ </strong>';
        var sp = specialHabits.map(function(h) { return h.name; });
        if (thirdSunday) sp.push('Sýmbolum Athanasiánum');
        html += sp.join(' • ') + '</div>';
    }
    if (calendarEvents.length === 0) html += '<p style="color:var(--muted-foreground);font-style:italic;">Nenhum evento agendado.</p>';
    else calendarEvents.forEach(function(ev) {
        html += '<div class="schedule-item"><span class="schedule-time">' + (ev.allDay ? 'Dia' : ev.startTime) + '</span>';
        html += '<span class="schedule-event">' + (ev.summary || 'Sem título') + '</span></div>';
    });
    html += '<div style="margin-top:14px;text-align:center;"><span class="btn btn-primary" onclick="goToDay(\'' + dateStr + '\')">Ir para este dia <img src="/icones/seta.png" style="width:16px;height:16px;vertical-align:middle;"></span></div>';
    return html;
}

function renderPlanoVida() {
    var weekDays = getWeekDays(BuJo.state.selectedDate);
    var html = '<div class="card"><div class="card-title"><span class="btn" id="prev-week" style="line-height:1;"><img src="/icones/seta.png" style="transform:rotate(180deg);width:20px;height:20px;"></span>';
    html += '<span style="flex:1;text-align:center;">Plano de Vida</span><span class="btn" id="next-week" style="line-height:1;"><img src="/icones/seta.png" style="width:20px;height:20px;"></span></div>';
    html += '<div style="overflow-x:auto;"><table class="tracker-table"><tr><th class="label">Hábito</th>';
    weekDays.forEach(function(d) {
        var style = isToday(d) ? ' style="background:var(--primary);color:#fff;"' : '';
        html += '<th' + style + '>' + BuJo.dayNamesShort[d.getDay()] + '<br>' + d.getDate() + '</th>';
    });
    html += '</tr>';

    BuJo.dailySpiritualHabits.forEach(function(h) {
        html += '<tr><td class="label">' + h.name + '</td>';
        weekDays.forEach(function(d) {
            var dateStr = formatDateKey(d);
            var dayHabits = BuJo.state.spiritualHabits[dateStr] || {};
            var checked = dayHabits[h.id] || false;
            html += '<td class="tracker-cell spiritual-check' + (checked ? ' checked' : '') + '" data-habit="' + h.id + '" data-date="' + dateStr + '">' + (checked ? '✓' : '') + '</td>';
        });
        html += '</tr>';
    });

    var specialRows = [
        { id: 'turno', name: 'Dia Turno', dow: 2 }, { id: 'salmo-2', name: 'Salmo 2', dow: 2 },
        { id: 'guarda', name: 'Dia Guarda', dow: 3 }, { id: 'disciplina', name: 'Disciplina', dow: 3 },
        { id: 'adoro-te', name: 'Adoro Te Devote', dow: 4 },
        { id: 'oracao-nossa-senhora', name: 'Oração N.Sra', dow: 6 }, { id: 'mortificacao-extra', name: 'Mortif. Extra', dow: 6 }
    ];
    html += '<tr><td colspan="8" style="background:var(--secondary);font-weight:600;padding:10px;">★ Especiais</td></tr>';
    specialRows.forEach(function(row) {
        html += '<tr><td class="label">' + row.name + '</td>';
        weekDays.forEach(function(d) {
            var dateStr = formatDateKey(d);
            if (d.getDay() !== row.dow) html += '<td class="tracker-cell na">–</td>';
            else {
                var dayHabits = BuJo.state.spiritualHabits[dateStr] || {};
                var checked = dayHabits[row.id] || false;
                html += '<td class="tracker-cell spiritual-check' + (checked ? ' checked' : '') + '" data-habit="' + row.id + '" data-date="' + dateStr + '">' + (checked ? '✓' : '') + '</td>';
            }
        });
        html += '</tr>';
    });

    html += '<tr><td class="label">Symb. Athan.</td>';
    weekDays.forEach(function(d) {
        var dateStr = formatDateKey(d);
        if (!isThirdSunday(d)) html += '<td class="tracker-cell na">–</td>';
        else {
            var dayHabits = BuJo.state.spiritualHabits[dateStr] || {};
            var checked = dayHabits['symbolum-athanasianum'] || false;
            html += '<td class="tracker-cell spiritual-check' + (checked ? ' checked' : '') + '" data-habit="symbolum-athanasianum" data-date="' + dateStr + '">' + (checked ? '✓' : '') + '</td>';
        }
    });
    html += '</tr></table></div></div>';

    html += '<div class="card"><div class="card-title">Resumo da Semana</div>' + renderSpiritualSummary(weekDays) + '</div>';
    return html;
}

function renderSpiritualSummary(weekDays) {
    var dayStats = [];
    weekDays.forEach(function(d) {
        var dateStr = formatDateKey(d);
        var dayHabits = BuJo.state.spiritualHabits[dateStr] || {};
        var checked = 0, possible = BuJo.dailySpiritualHabits.length;
        BuJo.dailySpiritualHabits.forEach(function(h) { if (dayHabits[h.id]) checked++; });
        if (d.getDay() === 2) { possible += 2; if (dayHabits['turno']) checked++; if (dayHabits['salmo-2']) checked++; }
        if (d.getDay() === 3) { possible += 2; if (dayHabits['guarda']) checked++; if (dayHabits['disciplina']) checked++; }
        if (d.getDay() === 4) { possible++; if (dayHabits['adoro-te']) checked++; }
        if (d.getDay() === 6) { possible += 2; if (dayHabits['oracao-nossa-senhora']) checked++; if (dayHabits['mortificacao-extra']) checked++; }
        if (isThirdSunday(d)) { possible++; if (dayHabits['symbolum-athanasianum']) checked++; }
        var pct = possible > 0 ? Math.round((checked / possible) * 100) : 0;
        dayStats.push({ day: BuJo.dayNamesShort[d.getDay()], pct: pct, isToday: isToday(d) });
    });
    var html = '<div style="display:-webkit-box;display:flex;-webkit-box-align:flex-end;align-items:flex-end;height:150px;border-bottom:2px solid var(--primary);padding-bottom:8px;">';
    dayStats.forEach(function(s) {
        var barHeight = Math.max(s.pct * 1.2, 4);
        var barStyle = 'width:12%;height:' + barHeight + 'px;background:' + (s.isToday ? 'var(--primary)' : 'var(--border)') + ';margin-right:2%;';
        html += '<div style="' + barStyle + '"></div>';
    });
    html += '</div>';
    html += '<div style="display:-webkit-box;display:flex;margin-top:4px;">';
    dayStats.forEach(function(s) {
        html += '<div style="width:12%;margin-right:2%;text-align:center;font-size:var(--font-size-xs);">' + s.day + '</div>';
    });
    html += '</div>';
    html += '<div style="display:-webkit-box;display:flex;margin-top:2px;">';
    dayStats.forEach(function(s) {
        html += '<div style="width:12%;margin-right:2%;text-align:center;font-size:var(--font-size-xs);font-weight:600;">' + s.pct + '%</div>';
    });
    html += '</div>';
    return html;
}

function renderNotas() {
    var html = '<div class="card"><div class="card-title">Notas Salvas <span class="btn" id="add-note-btn">+ Nova</span></div>';
    html += '<div style="margin-bottom:16px;"><span class="btn" id="save-notes-btn">Importar notas do Registro</span></div>';

    if (BuJo.state.notes.length === 0) html += '<p style="color:var(--muted-foreground);font-style:italic;text-align:center;padding:20px;">Nenhuma nota salva.</p>';
    else {
        var sorted = BuJo.state.notes.slice().sort(function(a,b) { return new Date(b.createdAt) - new Date(a.createdAt); });
        sorted.forEach(function(note) {
            var d = new Date(note.createdAt);
            html += '<div class="note-item"><div class="note-date">';
            if (note.type) html += '<span class="note-type">' + note.type + '</span>';
            html += formatDateShort(d) + ' às ' + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) + '</div>';
            html += '<div class="note-content">' + note.text + '</div>';
            html += '<div style="margin-top:8px;"><span class="btn" onclick="deleteNote(\'' + note.id + '\')" style="padding:4px 10px;">Excluir</span></div></div>';
        });
    }
    html += '</div>';
    return html;
}

function navigateDate(delta) { BuJo.state.selectedDate = new Date(BuJo.state.selectedDate.getTime() + delta * 86400000); render(); }
function navigateWeek(delta) { BuJo.state.selectedDate = new Date(BuJo.state.selectedDate.getTime() + delta * 7 * 86400000); render(); }
function navigateMonth(delta) { var d = BuJo.state.selectedDate; BuJo.state.selectedDate = new Date(d.getFullYear(), d.getMonth() + delta, 1); render(); }
function selectMonthDay(dateStr) { BuJo.state.selectedDate = new Date(dateStr + 'T12:00:00'); render(); }
function goToDay(dateStr) { BuJo.state.selectedDate = new Date(dateStr + 'T12:00:00'); setView('dia'); }
function goToToday() { BuJo.state.selectedDate = agoraCorrigido(); render(); }

function toggleSpiritualHabit(habitId, dateStr) {
    if (!BuJo.state.spiritualHabits[dateStr]) BuJo.state.spiritualHabits[dateStr] = {};
    var newValue = !BuJo.state.spiritualHabits[dateStr][habitId];
    BuJo.state.spiritualHabits[dateStr][habitId] = newValue;
    saveState(); render();
}
function toggleStudyGoal(habitId, dateStr, index) {
    if (!BuJo.state.studyGoals[dateStr]) BuJo.state.studyGoals[dateStr] = {};
    if (!BuJo.state.studyGoals[dateStr][habitId]) BuJo.state.studyGoals[dateStr][habitId] = [];
    var newValue = !BuJo.state.studyGoals[dateStr][habitId][index];
    BuJo.state.studyGoals[dateStr][habitId][index] = newValue;
    saveState(); render();
}
function toggleMortification(dateStr, index) {
    var morts = BuJo.state.mortifications[dateStr];
    if (morts && morts[index]) {
        morts[index].done = !morts[index].done;
        saveState(); render();
    }
}

function addEntry() {
    var input = document.getElementById('add-entry-input');
    var type = document.getElementById('add-entry-type').value;
    var text = input.value.trim();
    if (!text) return;
    var dateStr = formatDateKey(BuJo.state.selectedDate);
    var newEntry = { id: generateId(), date: dateStr, type: type, text: text, status: 'pending', createdAt: new Date().toISOString() };
    BuJo.state.entries.push(newEntry);
    saveState(); input.value = ''; render();
}
function cycleEntrySymbol(id) {
    var entry = BuJo.state.entries.find(function(e) { return e.id === id; });
    if (entry && entry.type === 'task') {
        entry.status = entry.status === 'pending' ? 'done' : entry.status === 'done' ? 'migrated' : 'pending';
        saveState(); render();
    }
}
function deleteEntry(id) {
    BuJo.state.entries = BuJo.state.entries.filter(function(e) { return e.id !== id; });
    saveState();
    closeModal();
    if (daySectionOverlay) {
        refreshDaySection('registros');
    } else {
        render();
    }
}

function showEditEntryModal(id) {
    var entry = BuJo.state.entries.find(function(e) { return e.id === id; });
    if (!entry) return;
    var typeOptions = '<option value="task"' + (entry.type === 'task' ? ' selected' : '') + '>' + BuJo.symbols.task + ' Tarefa</option>' +
        '<option value="event"' + (entry.type === 'event' ? ' selected' : '') + '>' + BuJo.symbols.event + ' Evento</option>' +
        '<option value="note"' + (entry.type === 'note' ? ' selected' : '') + '>' + BuJo.symbols.note + ' Nota</option>';
    var dateDisplay = entry.date ? entry.date.split('-').reverse().join('/') : '';
    showModal('<div class="modal-title">Editar Registro</div>' +
        '<div class="form-group"><label>Tipo</label><select id="edit-entry-type">' + typeOptions + '</select></div>' +
        '<div class="form-group"><label>Texto</label><textarea id="edit-entry-text" rows="3">' + entry.text + '</textarea></div>' +
        '<div class="form-group"><label>Data (DD/MM/AAAA)</label><input type="text" id="edit-entry-date" value="' + dateDisplay + '" placeholder="DD/MM/AAAA"></div>' +
        '<div class="form-group"><label style="display:inline;cursor:pointer;"><input type="checkbox" id="edit-entry-starred"' + (entry.starred ? ' checked' : '') + '> ★ Destacar</label></div>' +
        '<div class="modal-actions" style="justify-content:space-between;">' +
        '<span class="btn" style="background:#dc2626;color:#fff;border-color:#dc2626;" onclick="deleteEntry(\'' + id + '\')">Excluir</span>' +
        '<div style="display:flex;gap:10px;"><span class="btn" onclick="closeModal()">Cancelar</span><span class="btn btn-primary" onclick="editEntry(\'' + id + '\')">Salvar</span></div></div>');
}

function editEntry(id) {
    var entry = BuJo.state.entries.find(function(e) { return e.id === id; });
    if (!entry) return;
    var newText = document.getElementById('edit-entry-text').value.trim();
    var newType = document.getElementById('edit-entry-type').value;
    var newDateRaw = document.getElementById('edit-entry-date').value.trim();
    var starred = document.getElementById('edit-entry-starred').checked;
    if (!newText) return;
    // Converter DD/MM/AAAA para YYYY-MM-DD
    var dateParts = newDateRaw.split('/');
    var newDate = dateParts.length === 3 ? dateParts[2] + '-' + dateParts[1] + '-' + dateParts[0] : entry.date;
    entry.text = newText;
    entry.type = newType;
    entry.date = newDate;
    if (newType !== 'task') entry.status = 'pending';
    // Se marcou estrela, remove de outros do mesmo dia
    if (starred) {
        BuJo.state.entries.forEach(function(e) { if (e.date === newDate && e.id !== id) e.starred = false; });
    }
    entry.starred = starred;
    saveState();
    closeModal();
    if (daySectionOverlay) {
        refreshDaySection('registros');
    } else {
        render();
    }
}

function showEventDetails(dateStr, eventIdx) {
    var events = getEventsForDate(dateStr);
    if (!events || eventIdx >= events.length) return;
    var ev = events[eventIdx];

    var html = '<div class="modal-title">' + (ev.summary || 'Sem título') + '</div>';

    // Horários
    if (ev.allDay) {
        html += '<div style="margin-bottom:12px;"><strong>Dia inteiro</strong></div>';
    } else {
        var startTime = '';
        var endTime = '';
        if (ev.start.dateTime) {
            var startDate = new Date(ev.start.dateTime);
            startDate.setHours(startDate.getHours() - 3);
            startTime = startDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }
        if (ev.end && ev.end.dateTime) {
            var endDate = new Date(ev.end.dateTime);
            endDate.setHours(endDate.getHours() - 3);
            endTime = endDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }
        html += '<div style="margin-bottom:12px;">';
        html += '<div style="font-size:0.9rem;color:var(--muted-foreground);margin-bottom:4px;">Horário</div>';
        html += '<div style="font-size:1.1rem;font-weight:600;">' + startTime;
        if (endTime) html += ' – ' + endTime;
        html += '</div></div>';
    }

    // Localização
    if (ev.location) {
        html += '<div style="margin-bottom:12px;">';
        html += '<div style="font-size:0.9rem;color:var(--muted-foreground);margin-bottom:4px;">Local</div>';
        html += '<div>' + ev.location + '</div></div>';
    }

    // Descrição
    if (ev.description) {
        html += '<div style="margin-bottom:12px;">';
        html += '<div style="font-size:0.9rem;color:var(--muted-foreground);margin-bottom:4px;">Descrição</div>';
        html += '<div style="white-space:pre-wrap;font-size:0.95rem;background:var(--secondary);padding:10px;border-radius:6px;">' + ev.description + '</div></div>';
    }

    html += '<div class="modal-actions"><span class="btn btn-primary" onclick="closeModal()">Fechar</span></div>';
    showModal(html);
}

function deleteNote(id) {
    BuJo.state.notes = BuJo.state.notes.filter(function(n) { return n.id !== id; });
    saveState(); render();
}
function deleteFutureEntry(id) {
    BuJo.state.futureLog = BuJo.state.futureLog.filter(function(f) { return f.id !== id; });
    saveState(); render();
}

function saveAllNotes() {
    var imported = 0;
    BuJo.state.entries.forEach(function(entry) {
        if (entry.type === 'note' && !BuJo.state.notes.some(function(n) { return n.originalId === entry.id; })) {
            BuJo.state.notes.push({ id: generateId(), originalId: entry.id, text: entry.text, type: 'Registro', date: entry.date, createdAt: entry.createdAt });
            imported++;
        }
    });
    saveState();
    alert(imported > 0 ? imported + ' nota(s) importada(s)!' : 'Nenhuma nota nova.');
    render();
}

function showModal(content) { document.getElementById('modal-content').innerHTML = content; document.getElementById('modal-overlay').className = 'modal-overlay active'; }
function closeModal() { document.getElementById('modal-overlay').className = 'modal-overlay'; }

// ============= MODAIS DE SEÇÃO DO DIA =============
var daySectionOverlay = null;

function openDaySection(section) {
    var date = BuJo.state.selectedDate;
    var dateStr = formatDateKey(date);
    var dow = date.getDay();
    var thirdSunday = isThirdSunday(date);

    var html = '<div class="modal-full" id="day-section-modal">';
    html += '<div class="modal-full-header">';

    var title = '';
    if (section === 'eventos') title = 'Eventos';
    else if (section === 'registros') title = 'Registros';
    else if (section === 'plano') title = 'Plano de Vida';
    else if (section === 'mortificacoes') title = 'Mortificações';
    else if (section === 'exame') title = 'Exame de Consciência';

    html += '<span class="modal-full-title">' + title + '</span>';
    html += '<button class="modal-full-close" onclick="closeDaySection()">Voltar</button>';
    html += '</div>';

    if (section === 'eventos') html += renderDaySectionEventos(dateStr);
    else if (section === 'registros') html += renderDaySectionRegistros(dateStr);
    else if (section === 'plano') html += renderDaySectionPlano(dateStr, dow, thirdSunday);
    else if (section === 'mortificacoes') html += renderDaySectionMortificacoes(dateStr);
    else if (section === 'exame') html += renderDaySectionExame();

    html += '</div>';

    daySectionOverlay = document.createElement('div');
    daySectionOverlay.innerHTML = html;
    document.body.appendChild(daySectionOverlay);
    bindDaySectionEvents(section, dateStr);
}

function closeDaySection() {
    if (daySectionOverlay) {
        daySectionOverlay.remove();
        daySectionOverlay = null;
    }
}

function bindDaySectionEvents(section, dateStr) {
    if (section === 'registros') {
        var addBtn = document.getElementById('section-add-entry-btn');
        var addInput = document.getElementById('section-add-entry-input');
        if (addBtn) addBtn.onclick = addEntryFromSection;
        if (addInput) addInput.onkeypress = function(e) { if (e.key === 'Enter') addEntryFromSection(); };

        document.querySelectorAll('.section-entry-symbol[data-id]').forEach(function(el) {
            el.onclick = function() { cycleEntrySymbol(el.getAttribute('data-id')); refreshDaySection('registros'); };
        });

        // Clique no texto para editar
        document.querySelectorAll('.section-entry-text[data-id]').forEach(function(el) {
            el.onclick = function() {
                showEditEntryModal(el.getAttribute('data-id'));
            };
        });

        // Botão para duplicar migrado para próximo dia
        document.querySelectorAll('.section-migrate-next[data-id]').forEach(function(el) {
            el.onclick = function() { duplicateToNextDay(el.getAttribute('data-id')); };
        });

    }

    if (section === 'eventos') {
        document.querySelectorAll('.section-event-clickable').forEach(function(el) {
            el.onclick = function() {
                showEventDetails(el.getAttribute('data-event-date'), parseInt(el.getAttribute('data-event-idx')));
            };
        });
    }

    if (section === 'plano' || section === 'mortificacoes') {
        document.querySelectorAll('.section-spiritual-check').forEach(function(el) {
            el.onclick = function() {
                toggleSpiritualHabit(el.getAttribute('data-habit'), el.getAttribute('data-date'));
                refreshDaySection('plano');
            };
        });
        document.querySelectorAll('.section-mort-check').forEach(function(el) {
            el.onclick = function() {
                toggleMortification(el.getAttribute('data-date'), parseInt(el.getAttribute('data-index')));
                refreshDaySection('mortificacoes');
            };
        });
        var addMortBtn = document.getElementById('section-add-mort-btn');
        if (addMortBtn) addMortBtn.onclick = function() { showAddMortModalFromSection(dateStr); };

        // Link do Exame para abrir seção de Exame de Consciência
        document.querySelectorAll('.exame-link').forEach(function(el) {
            el.onclick = function(e) {
                e.stopPropagation();
                closeDaySection();
                setTimeout(function() { openDaySection('exame'); }, 50);
            };
        });
    }
}

function refreshDaySection(section) {
    closeDaySection();
    openDaySection(section);
}

function addEntryFromSection() {
    var dateStr = formatDateKey(BuJo.state.selectedDate);
    var type = document.getElementById('section-add-entry-type').value;
    var text = document.getElementById('section-add-entry-input').value.trim();
    if (!text) return;
    var newEntry = { id: generateId(), date: dateStr, type: type, text: text, status: type === 'task' ? 'pending' : null, createdAt: new Date().toISOString() };
    BuJo.state.entries.push(newEntry);
    saveState();
    refreshDaySection('registros');
}

function showAddMortModalFromSection(dateStr) {
    showAddMortModal();
}

function duplicateToNextDay(id) {
    var entry = BuJo.state.entries.find(function(e) { return e.id === id; });
    if (!entry) return;
    var currentDate = new Date(entry.date + 'T12:00:00');
    currentDate.setDate(currentDate.getDate() + 1);
    var nextDateStr = formatDateKey(currentDate);
    var newEntry = {
        id: generateId(),
        date: nextDateStr,
        type: entry.type,
        text: entry.text,
        status: 'pending',
        createdAt: new Date().toISOString()
    };
    BuJo.state.entries.push(newEntry);
    saveState();
    refreshDaySection('registros');
}


function renderDaySectionEventos(dateStr) {
    var calendarEvents = getEventsForDate(dateStr);
    var html = '<div class="card">';
    if (calendarEvents.length === 0) {
        html += '<p style="color:var(--muted-foreground);font-style:italic;text-align:center;padding:20px;">Nenhum evento agendado para este dia.</p>';
    } else {
        calendarEvents.forEach(function(ev, idx) {
            html += '<div class="schedule-item section-event-clickable" data-event-idx="' + idx + '" data-event-date="' + dateStr + '" style="padding:12px 0;cursor:pointer;">';
            html += '<span class="schedule-time" style="font-weight:600;">' + (ev.allDay ? 'Dia todo' : ev.startTime) + '</span>';
            html += '<span class="schedule-event" style="font-size:var(--font-size-lg);">' + (ev.summary || 'Sem título') + '</span>';
            html += '</div>';
        });
    }
    html += '</div>';
    return html;
}

function renderDaySectionRegistros(dateStr) {
    var dayEntries = BuJo.state.entries.filter(function(e) { return e.date === dateStr; });
    var html = '<div class="card">';
    html += '<div style="font-size:0.9rem;color:var(--muted-foreground);padding:8px 0;border-bottom:1px dotted var(--border);margin-bottom:10px;">';
    html += BuJo.symbols.task + ' tarefa &nbsp;&nbsp;' + BuJo.symbols.taskDone + ' feito &nbsp;&nbsp;' + BuJo.symbols.taskMigrated + ' migrado &nbsp;&nbsp;' + BuJo.symbols.event + ' evento &nbsp;&nbsp;' + BuJo.symbols.note + ' nota</div>';

    if (dayEntries.length === 0) {
        html += '<p style="color:var(--muted-foreground);font-style:italic;">Nenhuma entrada...</p>';
    } else {
        dayEntries.forEach(function(e) {
            var symbol = e.type === 'note' ? BuJo.symbols.note : e.type === 'event' ? BuJo.symbols.event : e.status === 'done' ? BuJo.symbols.taskDone : e.status === 'migrated' ? BuJo.symbols.taskMigrated : BuJo.symbols.task;
            html += '<div class="entry" style="padding:12px 0;">';
            if (e.starred) html += '<span style="font-size:1rem;margin-right:6px;color:#f59e0b;">★</span>';
            html += '<span class="entry-symbol section-entry-symbol" data-id="' + e.id + '" style="font-size:1.2rem;">' + symbol + '</span>';
            html += '<span class="entry-text section-entry-text' + (e.status === 'done' ? ' done' : '') + '" data-id="' + e.id + '" style="font-size:var(--font-size-lg);cursor:pointer;">' + e.text + '</span>';
            if (e.status === 'migrated') {
                html += '<span class="btn section-migrate-next" data-id="' + e.id + '" style="padding:6px 10px;font-size:0.8rem;margin-left:8px;">→+1</span>';
            }
            html += '</div>';
        });
    }

    html += '<div class="add-entry" style="margin-top:20px;padding-top:20px;">';
    html += '<select id="section-add-entry-type" style="padding:12px;font-size:var(--font-size-base);"><option value="task">' + BuJo.symbols.task + ' Tarefa</option><option value="event">' + BuJo.symbols.event + ' Evento</option><option value="note">' + BuJo.symbols.note + ' Nota</option></select>';
    html += '<input type="text" id="section-add-entry-input" placeholder="Digite..." style="padding:12px;font-size:var(--font-size-base);">';
    html += '<span class="btn btn-primary" id="section-add-entry-btn" style="padding:12px 20px;">+</span></div>';
    html += '</div>';
    return html;
}

function renderDaySectionPlano(dateStr, dow, thirdSunday) {
    var dayHabits = BuJo.state.spiritualHabits[dateStr] || {};
    var specialHabits = BuJo.weeklySpecialHabits[dow] || [];

    var html = '<div class="card">';
    html += '<div style="display:-webkit-box;display:flex;-webkit-flex-wrap:wrap;flex-wrap:wrap;">';
    BuJo.dailySpiritualHabits.forEach(function(h) {
        var checked = dayHabits[h.id] || false;
        var nameHtml = h.name;
        // Tornar "Exame" clicável para abrir a seção de Exame de Consciência
        if (h.id === 'exame') {
            nameHtml = '<span class="exame-link" style="cursor:pointer;text-decoration:underline;color:var(--primary);">' + h.name + '</span>';
        }
        html += '<div class="habit-row" style="width:50%;-webkit-box-sizing:border-box;box-sizing:border-box;padding-right:8px;"><span class="habit-name">' + nameHtml + '</span>';
        html += '<span class="habit-check section-spiritual-check' + (checked ? ' checked' : '') + '" data-habit="' + h.id + '" data-date="' + dateStr + '">' + (checked ? '✓' : '') + '</span></div>';
    });
    html += '</div>';

    if (specialHabits.length > 0) {
        html += '<div style="margin-top:14px;padding-top:12px;border-top:2px solid var(--primary);"><strong>★ Especiais do dia</strong></div>';
        specialHabits.forEach(function(h) {
            var checked = dayHabits[h.id] || false;
            html += '<div class="habit-row" style="background:var(--secondary);margin:4px -10px;padding:10px;"><span class="habit-name" style="font-weight:600;">' + h.name + '</span>';
            html += '<span class="habit-check section-spiritual-check' + (checked ? ' checked' : '') + '" data-habit="' + h.id + '" data-date="' + dateStr + '">' + (checked ? '✓' : '') + '</span></div>';
        });
    }

    if (thirdSunday) {
        var checked = dayHabits['symbolum-athanasianum'] || false;
        html += '<div class="habit-row" style="background:var(--secondary);margin:4px -10px;padding:10px;"><span class="habit-name" style="font-weight:600;">Sýmbolum Athanasiánum</span>';
        html += '<span class="habit-check section-spiritual-check' + (checked ? ' checked' : '') + '" data-habit="symbolum-athanasianum" data-date="' + dateStr + '">' + (checked ? '✓' : '') + '</span></div>';
    }
    html += '</div>';
    return html;
}

function renderDaySectionMortificacoes(dateStr) {
    var morts = BuJo.state.mortifications[dateStr] || [];
    var html = '<div class="card">';

    if (morts.length === 0) {
        html += '<p style="color:var(--muted-foreground);font-style:italic;text-align:center;padding:20px;">Nenhuma mortificação definida.</p>';
    } else {
        morts.forEach(function(m, i) {
            html += '<div class="habit-row" style="padding:14px 0;font-size:var(--font-size-lg);"><span class="habit-name"' + (m.done ? ' style="text-decoration:line-through;color:var(--muted-foreground);"' : '') + '>' + m.text + '</span>';
            html += '<span class="habit-check section-mort-check' + (m.done ? ' checked' : '') + '" data-date="' + dateStr + '" data-index="' + i + '" style="width:44px;height:44px;">' + (m.done ? '✓' : '') + '</span></div>';
        });
    }

    html += '<div style="margin-top:20px;text-align:center;"><span class="btn btn-primary" id="section-add-mort-btn" style="padding:14px 24px;font-size:var(--font-size-base);">+ Adicionar Mortificação</span></div>';
    html += '</div>';
    return html;
}

function renderDaySectionExame() {
    var html = '<div style="padding:0 4px;line-height:1.8;">';

    html += '<div style="font-size:var(--font-size-xl);font-weight:700;margin-bottom:20px;padding-bottom:10px;border-bottom:3px solid var(--primary);">';
    html += 'Jesus, afasta de mim o que me afasta de ti!';
    html += '</div>';

    html += '<div style="margin-bottom:24px;">';
    html += '<p style="font-size:var(--font-size-base);margin-bottom:16px;"><strong>"Muitos vivem como anjos no meio do mundo. - Tu… por que não? (C122)"</strong></p>';
    html += '<p style="font-size:var(--font-size-sm);padding-left:12px;border-left:3px solid var(--border);">Usei o telefone enquanto estava deitado? Tirei ele do modo sono sem necessidade? Fiquei usando ele até tarde?</p>';
    html += '</div>';

    html += '<div style="margin-bottom:24px;">';
    html += '<p style="font-size:var(--font-size-base);margin-bottom:16px;"><strong>"Põe um motivo sobrenatural na tua atividade profissional de cada dia, e terás santificado o trabalho. (C359)"</strong></p>';
    html += '<p style="font-size:var(--font-size-sm);padding-left:12px;border-left:3px solid var(--border);">Lembrei de pedir graças antes de estudar? Deixei me distrair durante o estudo? Agradeci o tempo de estudo?</p>';
    html += '</div>';

    html += '<div style="margin-bottom:24px;">';
    html += '<p style="font-size:var(--font-size-base);margin-bottom:16px;"><strong>"Estar ocioso é coisa que não se compreende num homem com alma de apóstolo. (C358)"</strong></p>';
    html += '<p style="font-size:var(--font-size-sm);padding-left:12px;border-left:3px solid var(--border);">Lembrei das jaculatórias habituais? Vivi bem o tempo da tarde? Levei a sério o meu apostolado planejado?</p>';
    html += '</div>';

    html += '<div style="margin-top:30px;padding-top:20px;border-top:2px solid var(--primary);">';
    html += '<div style="font-size:var(--font-size-xl);font-weight:700;margin-bottom:16px;">Ato de Contrição</div>';
    html += '<p style="font-size:var(--font-size-base);font-style:italic;background:var(--secondary);padding:16px;border-radius:var(--radius);">';
    html += 'Senhor, me arrependo de todo o coração de vos ter ofendido. Dai-me a graça de não mais pecar.';
    html += '</p>';
    html += '</div>';

    html += '<div style="text-align:center;margin-top:30px;">';
    html += '<img src="/Imagens/download.png" alt="Imagem devocional" style="max-width:100%;height:auto;border-radius:var(--radius);">';
    html += '</div>';

    html += '</div>';
    return html;
}

function showAddMortModal() {
    var dateStr = formatDateKey(BuJo.state.selectedDate);
    showModal('<div class="modal-title">Adicionar Mortificação</div>' +
        '<div class="form-group"><label>Descrição</label><input type="text" id="mort-text" placeholder="Ex: Jejum até o almoço"></div>' +
        '<div class="modal-actions"><span class="btn" onclick="closeModal()">Cancelar</span><span class="btn btn-primary" onclick="addMortification(\'' + dateStr + '\')">Adicionar</span></div>');
}
function addMortification(dateStr) {
    var text = document.getElementById('mort-text').value.trim();
    if (!text) return;
    if (!BuJo.state.mortifications[dateStr]) BuJo.state.mortifications[dateStr] = [];
    BuJo.state.mortifications[dateStr].push({ text: text, done: false });
    saveState();
    closeModal();
    if (daySectionOverlay) {
        refreshDaySection('mortificacoes');
    } else {
        render();
    }
}

function showAddNoteModal() {
    showModal('<div class="modal-title">Nova Nota</div>' +
        '<div class="form-group"><label>Tipo (opcional)</label><input type="text" id="note-type" placeholder="Ex: Reflexão, Ideia"></div>' +
        '<div class="form-group"><label>Conteúdo</label><textarea id="note-text" rows="4" placeholder="Escreva sua nota..."></textarea></div>' +
        '<div class="modal-actions"><span class="btn" onclick="closeModal()">Cancelar</span><span class="btn btn-primary" onclick="addNote()">Salvar</span></div>');
}
function addNote() {
    var text = document.getElementById('note-text').value.trim();
    if (!text) return;
    var noteType = document.getElementById('note-type').value.trim() || 'Nota';
    var newNote = { id: generateId(), text: text, type: noteType, createdAt: new Date().toISOString() };
    BuJo.state.notes.push(newNote);
    saveState(); closeModal(); render();
}

if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
else init();
</script>
</body>
</html>