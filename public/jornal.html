<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Bullet Journal - Pedro 2026</title>
    <style>
        :root {
            --background: #ffffff;
            --foreground: #09090b;
            --card: #ffffff;
            --primary: #18181b;
            --secondary: #f4f4f5;
            --muted-foreground: #71717a;
            --border: #e4e4e7;
            --radius: 0.75rem;
            --font-sans: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-size-base: 18px;
            --font-size-sm: 16px;
            --font-size-xs: 14px;
            --font-size-lg: 20px;
            --font-size-xl: 24px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; background-color: var(--background); color: var(--foreground); font-family: var(--font-sans); font-size: var(--font-size-base); line-height: 1.5; }
        .app-shell { display: flex; flex-direction: column; height: 100vh; }
        .app-header { border-bottom: 1px solid var(--border); padding: 12px 1.25rem; background: rgba(255,255,255,0.95); backdrop-filter: blur(8px); z-index: 50; flex-shrink: 0; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .app-title { font-size: var(--font-size-xl); font-weight: 700; }
        .header-date { font-size: var(--font-size-xs); color: var(--muted-foreground); }
        .btn-icon { background: transparent; border: 1px solid var(--border); border-radius: 0.5rem; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .btn-icon:active { background: var(--secondary); transform: scale(0.96); }
        .nav-tabs { display: -webkit-box; display: flex; -webkit-flex-wrap: wrap; flex-wrap: wrap; -webkit-box-pack: center; justify-content: center; }
        .nav-tab { font-size: var(--font-size-sm); text-transform: uppercase; padding: 8px 14px; border: 1px solid var(--border); background: var(--secondary); cursor: pointer; border-radius: 0.5rem; font-weight: 500; margin-right: 6px; margin-bottom: 6px; }
        .nav-tab:active { transform: scale(0.96); }
        .nav-tab.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .main { flex: 1; overflow-y: auto; padding: 1.25rem; padding-bottom: 3rem; max-width: 700px; margin: 0 auto; width: 100%; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.25rem; margin-bottom: 1.25rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .card-title { font-size: var(--font-size-lg); font-weight: 700; border-bottom: 1px solid var(--secondary); padding-bottom: 10px; margin-bottom: 14px; display: flex; justify-content: space-between; align-items: center; }
        .btn { font-size: var(--font-size-sm); padding: 8px 16px; border: 1px solid var(--border); background: var(--secondary); cursor: pointer; border-radius: 0.5rem; font-weight: 500; }
        .btn:active { transform: scale(0.96); background: var(--border); }
        .btn-primary { background: var(--primary); color: #fff; border-color: var(--primary); }
        .special-day { background: var(--secondary); border: 1px solid var(--border); border-radius: 0.5rem; padding: 10px 14px; margin-bottom: 14px; font-size: var(--font-size-sm); }
        .schedule-item { display: flex; padding: 8px 0; border-bottom: 1px dotted var(--border); }
        .schedule-time { width: 70px; font-size: var(--font-size-sm); color: var(--muted-foreground); flex-shrink: 0; }
        .schedule-event { flex: 1; }
        .schedule-event.special { font-weight: 600; }
        .habit-row { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px dotted var(--border); }
        .habit-name { flex: 1; }
        .habit-check { width: 36px; height: 36px; border: 2px solid var(--primary); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .habit-check.checked { background: var(--primary); color: #fff; }
        .tracker-table { width: 100%; border-collapse: collapse; font-size: var(--font-size-sm); table-layout: fixed; }
        .tracker-table th, .tracker-table td { border: 1px solid var(--border); padding: 8px; text-align: center; }
        .tracker-table th { background: var(--secondary); font-size: var(--font-size-xs); text-transform: uppercase; }
        .tracker-table .label { text-align: left; font-weight: 500; width: 25%; }
        .tracker-cell { cursor: pointer; min-width: 36px; height: 36px; }
        .tracker-cell.checked { background: var(--primary); color: #fff; }
        .tracker-cell.na { background: var(--secondary); color: var(--muted-foreground); }
        .month-calendar { display: table; width: 100%; border-collapse: collapse; }
        .month-row { display: table-row; }
        .month-cell { display: table-cell; border: 1px solid var(--border); width: 14.28%; height: 50px; text-align: center; vertical-align: top; padding: 4px; cursor: pointer; }
        .month-cell.header { background: var(--secondary); font-size: var(--font-size-xs); font-weight: 600; height: auto; padding: 8px 4px; }
        .month-cell.today { border: 3px solid var(--primary); font-weight: 700; background: var(--secondary); }
        .month-cell.selected { background: var(--primary); color: #fff; }
        .month-cell.special { background: #f5f5f5; }
        .month-cell.empty { background: #fafafa; }
        .month-cell.has-events { font-weight: 700; text-decoration: underline; }
        .entry { padding: 10px 0; border-bottom: 1px dotted var(--border); display: flex; align-items: flex-start; gap: 10px; }
        .entry-symbol { width: 24px; cursor: pointer; font-size: var(--font-size-lg); flex-shrink: 0; }
        .entry-text { flex: 1; }
        .entry-text.done { text-decoration: line-through; color: var(--muted-foreground); }
        .add-entry { margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--border); display: flex; gap: 8px; flex-wrap: wrap; }
        .add-entry input { flex: 1; min-width: 150px; padding: 10px 14px; border: 1px solid var(--border); border-radius: 0.5rem; font-size: var(--font-size-base); }
        .add-entry select { padding: 10px 14px; border: 1px solid var(--border); border-radius: 0.5rem; font-size: var(--font-size-base); }
        .index-item { padding: 14px 0; border-bottom: 1px dotted var(--border); cursor: pointer; }
        .index-item:active { background: var(--secondary); }
        .summary-box { text-align: center; padding: 16px; }
        .summary-percent { font-size: 2.5rem; font-weight: 700; }
        .summary-bar { height: 10px; background: var(--secondary); margin-top: 10px; border-radius: 5px; overflow: hidden; }
        .summary-fill { height: 100%; background: var(--primary); border-radius: 5px; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 100; }
        .modal-overlay.active { display: flex; align-items: center; justify-content: center; }
        .modal { background: #fff; border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; width: 90%; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        .modal-title { font-weight: 700; font-size: var(--font-size-lg); margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; font-size: var(--font-size-xs); text-transform: uppercase; color: var(--muted-foreground); margin-bottom: 6px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: 0.5rem; font-size: var(--font-size-base); font-family: inherit; }
        .modal-actions { margin-top: 16px; display: flex; gap: 10px; justify-content: flex-end; }
        .study-check { width: 28px; height: 28px; border: 2px solid var(--border); border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .study-check.checked { background: var(--primary); color: #fff; border-color: var(--primary); }
        .future-month { margin-bottom: 16px; }
        .future-month-header { font-weight: 600; padding: 10px 14px; background: var(--primary); color: #fff; border-radius: 0.5rem 0.5rem 0 0; text-transform: capitalize; }
        .future-month-content { padding: 10px 14px; border: 1px solid var(--border); border-top: none; border-radius: 0 0 0.5rem 0.5rem; min-height: 50px; }
        .note-item { padding: 14px; border: 1px solid var(--border); border-radius: 0.5rem; margin-bottom: 12px; }
        .note-date { font-size: var(--font-size-xs); color: var(--muted-foreground); margin-bottom: 6px; }
        .note-type { display: inline-block; font-size: var(--font-size-xs); padding: 2px 8px; background: var(--secondary); border-radius: 4px; margin-right: 8px; }
        /* Leituras */
        .nav-tab.leituras { background: var(--secondary); border-color: var(--border); }
        .nav-tab.leituras.active { background: var(--primary); color: #fff; }
        .reading-card { border-left: 4px solid var(--primary); }
        .reading-card.noturna { background: var(--secondary); }
        .reading-progress { display: -webkit-box; display: flex; -webkit-box-align: center; align-items: center; margin: 10px 0; }
        .reading-progress-bar { -webkit-box-flex: 1; flex: 1; height: 12px; background: var(--secondary); border-radius: 6px; overflow: hidden; margin-right: 10px; }
        .reading-progress-fill { height: 100%; border-radius: 6px; background: var(--primary); }
        .reading-percent { font-weight: 700; min-width: 50px; text-align: right; }
        .reading-meta { font-size: var(--font-size-xs); color: var(--muted-foreground); }
        .reading-input { width: 80px; padding: 6px 10px; border: 1px solid var(--border); border-radius: 0.5rem; text-align: center; }
        .stats-grid { display: -webkit-box; display: flex; -webkit-flex-wrap: wrap; flex-wrap: wrap; }
        .stat-box { text-align: center; padding: 16px; background: var(--secondary); border-radius: var(--radius); width: 48%; margin-right: 2%; margin-bottom: 12px; }
        .stat-value { font-size: 1.8rem; font-weight: 700; }
        .stat-label { font-size: var(--font-size-xs); color: var(--muted-foreground); text-transform: uppercase; }
        .book-type { font-size: var(--font-size-xs); padding: 2px 8px; border-radius: 4px; font-weight: 600; background: #ccc; color: #333; }
    </style>
</head>
<body>
<div class="app-shell">
    <header class="app-header">
        <div class="header-top">
            <div>
                <div class="app-title">BULLET JOURNAL</div>
                <div class="header-date" id="header-date"></div>
            </div>
            <button class="btn-icon" onclick="window.location.href='dashboard.html'">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            </button>
        </div>
        <div class="nav-tabs" id="nav-tabs">
            <span class="nav-tab active" data-view="dia">Dia</span>
            <span class="nav-tab" data-view="mes">Mês</span>
            <span class="nav-tab" data-view="plano">Plano</span>
            <span class="nav-tab" data-view="estudo">Estudo</span>
            <span class="nav-tab leituras" data-view="leituras">Leituras</span>
            <span class="nav-tab" data-view="future">Future</span>
            <span class="nav-tab" data-view="notas">Notas</span>
            <span class="nav-tab" data-view="projetos">Projetos</span>
        </div>
    </header>
    <div class="main" id="main-content"></div>
</div>
<div class="modal-overlay" id="modal-overlay"><div class="modal" id="modal-content"></div></div>
<script>
var BuJo = {
    state: {
        currentView: 'dia',
        selectedDate: new Date(),
        entries: [],
        spiritualHabits: {},
        studyGoals: {},
        mortifications: {},
        projects: [],
        futureLog: [],
        notes: [],
        calendarEvents: [],
        readingProgress: { noturna: { currentPage: 0 }, currentWeek: 1, books: {} }
    },
    symbols: { task: '•', taskDone: '✕', taskMigrated: '→', event: '○', note: '–' },
    dailySpiritualHabits: [
        { id: 'serviam', name: 'Sérviam' },
        { id: 'preces', name: 'Preces' },
        { id: 'oracao-manha', name: 'Oração manhã' },
        { id: 'santa-missa', name: 'Santa Missa' },
        { id: 'leitura-espiritual', name: 'Leit. Espiritual' },
        { id: 'leitura-nt', name: 'Leitura NT' },
        { id: 'angelus', name: 'Angelus' },
        { id: 'visita-santissimo', name: 'Visita Santíssimo' },
        { id: 'lembrai-vos', name: 'Lembrai-vos' },
        { id: 'terco', name: 'Terço' },
        { id: 'oracao-tarde', name: 'Oração tarde' },
        { id: 'contemplacao', name: 'Contemplação' },
        { id: 'exame', name: 'Exame' },
        { id: '2-horas', name: '2 horas' },
        { id: '3-ave-marias', name: '3 Ave Marias' }
    ],
    weeklySpecialHabits: {
        2: [{ id: 'turno', name: 'Dia de Turno' }, { id: 'salmo-2', name: 'Salmo 2' }],
        3: [{ id: 'guarda', name: 'Dia de Guarda' }, { id: 'disciplina', name: 'Disciplina' }],
        4: [{ id: 'adoro-te', name: 'Adoro Te Devote' }],
        6: [{ id: 'oracao-nossa-senhora', name: 'Oração N. Senhora' }, { id: 'mortificacao-extra', name: 'Mortif. Extra' }]
    },
    studyGoalsList: [
        { id: 'latim', name: 'Latim', dailyGoal: 1, description: 'Gradus Primus - 1 lição', weekDays: [1, 2, 3, 4, 5] },
        { id: 'japones', name: 'Japonês', dailyGoal: 1, description: '1 sessão de estudo', weekDays: [0, 2, 3, 4] },
        { id: 'estatistica', name: 'Estatística', dailyGoal: 2, description: '2 blocos de estudo' },
        { id: 'tenis-mesa', name: 'Tênis Mesa', dailyGoal: 1, description: '1 treino', weekDays: [1, 5, 6] }
    ],
    readingPlan: {
        noturna: { titulo: 'Vida de Cristo', autor: 'Fulton Sheen', paginas: 1015 },
        cronograma: [
            { semana: 1, espiritual: { titulo: 'Cristianismo puro e simples', autor: 'C.S. Lewis', pInicio: 1, pFim: 58 }, secular: { titulo: 'Por que ler os clássicos', autor: 'Italo Calvino', pInicio: 1, pFim: 56 }, bloco: 'Fundamentos da Fé' },
            { semana: 2, espiritual: { titulo: 'Cristianismo puro e simples', autor: 'C.S. Lewis', pInicio: 59, pFim: 116 }, secular: { titulo: 'Por que ler os clássicos', autor: 'Italo Calvino', pInicio: 57, pFim: 112 }, bloco: 'Fundamentos da Fé' },
            { semana: 3, espiritual: { titulo: 'Cristianismo puro e simples', autor: 'C.S. Lewis', pInicio: 117, pFim: 174 }, secular: { titulo: 'Por que ler os clássicos', autor: 'Italo Calvino', pInicio: 113, pFim: 168 }, bloco: 'Fundamentos da Fé' },
            { semana: 4, espiritual: { titulo: 'Cristianismo puro e simples', autor: 'C.S. Lewis', pInicio: 175, pFim: 232 }, secular: { titulo: 'Por que ler os clássicos', autor: 'Italo Calvino', pInicio: 169, pFim: 224 }, bloco: 'Fundamentos da Fé' },
            { semana: 5, espiritual: { titulo: 'Cristianismo puro e simples', autor: 'C.S. Lewis', pInicio: 233, pFim: 288 }, secular: { titulo: 'Por que ler os clássicos', autor: 'Italo Calvino', pInicio: 225, pFim: 279 }, bloco: 'Fundamentos da Fé' },
            { semana: 6, espiritual: { titulo: 'Cartas de um diabo a seu aprendiz', autor: 'C.S. Lewis', pInicio: 1, pFim: 42 }, secular: { titulo: 'Memórias póstumas de Brás Cubas', autor: 'Machado de Assis', pInicio: 1, pFim: 66 }, bloco: 'Fundamentos da Fé' },
            { semana: 7, espiritual: { titulo: 'Cartas de um diabo a seu aprendiz', autor: 'C.S. Lewis', pInicio: 43, pFim: 84 }, secular: { titulo: 'Memórias póstumas de Brás Cubas', autor: 'Machado de Assis', pInicio: 67, pFim: 132 }, bloco: 'Fundamentos da Fé' },
            { semana: 8, espiritual: { titulo: 'Cartas de um diabo a seu aprendiz', autor: 'C.S. Lewis', pInicio: 85, pFim: 126 }, secular: { titulo: 'Memórias póstumas de Brás Cubas', autor: 'Machado de Assis', pInicio: 133, pFim: 198 }, bloco: 'Fundamentos da Fé' },
            { semana: 9, espiritual: { titulo: 'Cartas de um diabo a seu aprendiz', autor: 'C.S. Lewis', pInicio: 127, pFim: 168 }, secular: { titulo: 'Memórias póstumas de Brás Cubas', autor: 'Machado de Assis', pInicio: 199, pFim: 264 }, bloco: 'Fundamentos da Fé' },
            { semana: 10, espiritual: { titulo: 'Cartas de um diabo a seu aprendiz', autor: 'C.S. Lewis', pInicio: 169, pFim: 208 }, secular: { titulo: 'Memórias póstumas de Brás Cubas', autor: 'Machado de Assis', pInicio: 265, pFim: 332 }, bloco: 'Fundamentos da Fé' },
            { semana: 11, espiritual: { titulo: 'A abolição do homem', autor: 'C.S. Lewis', pInicio: 1, pFim: 26 }, secular: { titulo: 'Fundamentos de antropologia', autor: 'Ricardo Yepes Stork', pInicio: 1, pFim: 76 }, bloco: 'Pessoa e Antropologia' },
            { semana: 12, espiritual: { titulo: 'A abolição do homem', autor: 'C.S. Lewis', pInicio: 27, pFim: 52 }, secular: { titulo: 'Fundamentos de antropologia', autor: 'Ricardo Yepes Stork', pInicio: 77, pFim: 152 }, bloco: 'Pessoa e Antropologia' },
            { semana: 13, espiritual: { titulo: 'A abolição do homem', autor: 'C.S. Lewis', pInicio: 53, pFim: 78 }, secular: { titulo: 'Fundamentos de antropologia', autor: 'Ricardo Yepes Stork', pInicio: 153, pFim: 228 }, bloco: 'Pessoa e Antropologia' },
            { semana: 14, espiritual: { titulo: 'A abolição do homem', autor: 'C.S. Lewis', pInicio: 79, pFim: 104 }, secular: { titulo: 'Fundamentos de antropologia', autor: 'Ricardo Yepes Stork', pInicio: 229, pFim: 304 }, bloco: 'Pessoa e Antropologia' },
            { semana: 15, espiritual: { titulo: 'A abolição do homem', autor: 'C.S. Lewis', pInicio: 105, pFim: 128 }, secular: { titulo: 'Fundamentos de antropologia', autor: 'Ricardo Yepes Stork', pInicio: 305, pFim: 380 }, bloco: 'Pessoa e Antropologia' },
            { semana: 16, espiritual: { titulo: 'Confissões de um Converso', autor: 'Robert H. Benson', pInicio: 1, pFim: 45 }, secular: { titulo: 'Personalismo', autor: 'Emmanuel Mounier', pInicio: 1, pFim: 46 }, bloco: 'Pessoa e Antropologia' },
            { semana: 17, espiritual: { titulo: 'Confissões de um Converso', autor: 'Robert H. Benson', pInicio: 46, pFim: 90 }, secular: { titulo: 'Personalismo', autor: 'Emmanuel Mounier', pInicio: 47, pFim: 92 }, bloco: 'Pessoa e Antropologia' },
            { semana: 18, espiritual: { titulo: 'Confissões de um Converso', autor: 'Robert H. Benson', pInicio: 91, pFim: 136 }, secular: { titulo: 'Personalismo', autor: 'Emmanuel Mounier', pInicio: 93, pFim: 139 }, bloco: 'Pessoa e Antropologia' },
            { semana: 19, espiritual: { titulo: 'Gabriel Marcel e Edith Stein', autor: 'Urbano Zilles', pInicio: 1, pFim: 32 }, secular: { titulo: 'A antropologia personalista de Mounier', autor: 'A.J. Severino', pInicio: 1, pFim: 53 }, bloco: 'Pessoa e Antropologia' },
            { semana: 20, espiritual: { titulo: 'Gabriel Marcel e Edith Stein', autor: 'Urbano Zilles', pInicio: 33, pFim: 64 }, secular: { titulo: 'A antropologia personalista de Mounier', autor: 'A.J. Severino', pInicio: 54, pFim: 106 }, bloco: 'Pessoa e Antropologia' },
            { semana: 21, espiritual: { titulo: 'Gabriel Marcel e Edith Stein', autor: 'Urbano Zilles', pInicio: 65, pFim: 94 }, secular: { titulo: 'A antropologia personalista de Mounier', autor: 'A.J. Severino', pInicio: 107, pFim: 158 }, bloco: 'Pessoa e Antropologia' },
            { semana: 22, espiritual: { titulo: 'As Moradas do Castelo Interior', autor: 'Sta. Teresa d Ávila', pInicio: 1, pFim: 64 }, secular: { titulo: 'Mapa do mundo pessoal', autor: 'Julián Marías', pInicio: 1, pFim: 37 }, bloco: 'Vida Interior I' },
            { semana: 23, espiritual: { titulo: 'As Moradas do Castelo Interior', autor: 'Sta. Teresa d Ávila', pInicio: 65, pFim: 128 }, secular: { titulo: 'Mapa do mundo pessoal', autor: 'Julián Marías', pInicio: 38, pFim: 74 }, bloco: 'Vida Interior I' },
            { semana: 24, espiritual: { titulo: 'As Moradas do Castelo Interior', autor: 'Sta. Teresa d Ávila', pInicio: 129, pFim: 192 }, secular: { titulo: 'Mapa do mundo pessoal', autor: 'Julián Marías', pInicio: 75, pFim: 111 }, bloco: 'Vida Interior I' },
            { semana: 25, espiritual: { titulo: 'As Moradas do Castelo Interior', autor: 'Sta. Teresa d Ávila', pInicio: 193, pFim: 254 }, secular: { titulo: 'Mapa do mundo pessoal', autor: 'Julián Marías', pInicio: 112, pFim: 148 }, bloco: 'Vida Interior I' },
            { semana: 26, espiritual: { titulo: 'São Bernardo de Claraval', autor: 'Daniel-Rops', pInicio: 1, pFim: 32 }, secular: { titulo: 'A educação sentimental', autor: 'Julián Marías', pInicio: 1, pFim: 60 }, bloco: 'Vida Interior I' },
            { semana: 27, espiritual: { titulo: 'São Bernardo de Claraval', autor: 'Daniel-Rops', pInicio: 33, pFim: 64 }, secular: { titulo: 'A educação sentimental', autor: 'Julián Marías', pInicio: 61, pFim: 120 }, bloco: 'Vida Interior I' },
            { semana: 28, espiritual: { titulo: 'São Bernardo de Claraval', autor: 'Daniel-Rops', pInicio: 65, pFim: 96 }, secular: { titulo: 'A educação sentimental', autor: 'Julián Marías', pInicio: 121, pFim: 180 }, bloco: 'Vida Interior I' },
            { semana: 29, espiritual: { titulo: 'São Bernardo de Claraval', autor: 'Daniel-Rops', pInicio: 97, pFim: 128 }, secular: { titulo: 'A educação sentimental', autor: 'Julián Marías', pInicio: 181, pFim: 240 }, bloco: 'Vida Interior I' },
            { semana: 30, espiritual: { titulo: 'Introdução ao Cristianismo', autor: 'Joseph Ratzinger', pInicio: 1, pFim: 54 }, secular: { titulo: 'O mito do Papa de Hitler', autor: 'David G. Dalin', pInicio: 1, pFim: 45 }, bloco: 'Cristo e a História' },
            { semana: 31, espiritual: { titulo: 'Introdução ao Cristianismo', autor: 'Joseph Ratzinger', pInicio: 55, pFim: 108 }, secular: { titulo: 'O mito do Papa de Hitler', autor: 'David G. Dalin', pInicio: 46, pFim: 90 }, bloco: 'Cristo e a História' },
            { semana: 32, espiritual: { titulo: 'Introdução ao Cristianismo', autor: 'Joseph Ratzinger', pInicio: 109, pFim: 162 }, secular: { titulo: 'O mito do Papa de Hitler', autor: 'David G. Dalin', pInicio: 91, pFim: 135 }, bloco: 'Cristo e a História' },
            { semana: 33, espiritual: { titulo: 'Introdução ao Cristianismo', autor: 'Joseph Ratzinger', pInicio: 163, pFim: 216 }, secular: { titulo: 'O mito do Papa de Hitler', autor: 'David G. Dalin', pInicio: 136, pFim: 180 }, bloco: 'Cristo e a História' },
            { semana: 34, espiritual: { titulo: 'Introdução ao Cristianismo', autor: 'Joseph Ratzinger', pInicio: 217, pFim: 272 }, secular: { titulo: 'O mito do Papa de Hitler', autor: 'David G. Dalin', pInicio: 181, pFim: 224 }, bloco: 'Cristo e a História' },
            { semana: 35, espiritual: { titulo: 'Relatório sobre a fé', autor: 'Messori/Ratzinger', pInicio: 1, pFim: 54 }, secular: { titulo: 'Comunismo', autor: 'Jordán B. Genta', pInicio: 1, pFim: 40 }, bloco: 'Cristo e a História' },
            { semana: 36, espiritual: { titulo: 'Relatório sobre a fé', autor: 'Messori/Ratzinger', pInicio: 55, pFim: 108 }, secular: { titulo: 'Comunismo', autor: 'Jordán B. Genta', pInicio: 41, pFim: 80 }, bloco: 'Cristo e a História' },
            { semana: 37, espiritual: { titulo: 'Relatório sobre a fé', autor: 'Messori/Ratzinger', pInicio: 109, pFim: 162 }, secular: { titulo: 'Comunismo', autor: 'Jordán B. Genta', pInicio: 81, pFim: 120 }, bloco: 'Cristo e a História' },
            { semana: 38, espiritual: { titulo: 'Relatório sobre a fé', autor: 'Messori/Ratzinger', pInicio: 163, pFim: 216 }, secular: { titulo: 'Comunismo', autor: 'Jordán B. Genta', pInicio: 121, pFim: 160 }, bloco: 'Cristo e a História' },
            { semana: 39, espiritual: { titulo: 'Relatório sobre a fé', autor: 'Messori/Ratzinger', pInicio: 217, pFim: 272 }, secular: { titulo: 'Comunismo', autor: 'Jordán B. Genta', pInicio: 161, pFim: 200 }, bloco: 'Cristo e a História' },
            { semana: 40, espiritual: { titulo: 'A vida vale a pena ser vivida', autor: 'Fulton Sheen', pInicio: 1, pFim: 46 }, secular: { titulo: 'Dostoievski: Sementes da revolta', autor: 'Joseph Frank', pInicio: 1, pFim: 55 }, bloco: 'Literatura Russa I' },
            { semana: 41, espiritual: { titulo: 'A vida vale a pena ser vivida', autor: 'Fulton Sheen', pInicio: 47, pFim: 92 }, secular: { titulo: 'Dostoievski: Sementes da revolta', autor: 'Joseph Frank', pInicio: 56, pFim: 110 }, bloco: 'Literatura Russa I' },
            { semana: 42, espiritual: { titulo: 'A vida vale a pena ser vivida', autor: 'Fulton Sheen', pInicio: 93, pFim: 138 }, secular: { titulo: 'Dostoievski: Sementes da revolta', autor: 'Joseph Frank', pInicio: 111, pFim: 165 }, bloco: 'Literatura Russa I' },
            { semana: 43, espiritual: { titulo: 'A vida vale a pena ser vivida', autor: 'Fulton Sheen', pInicio: 139, pFim: 184 }, secular: { titulo: 'Dostoievski: Sementes da revolta', autor: 'Joseph Frank', pInicio: 166, pFim: 220 }, bloco: 'Literatura Russa I' },
            { semana: 44, espiritual: { titulo: 'A vida vale a pena ser vivida', autor: 'Fulton Sheen', pInicio: 185, pFim: 230 }, secular: { titulo: 'Dostoievski: Sementes da revolta', autor: 'Joseph Frank', pInicio: 221, pFim: 275 }, bloco: 'Literatura Russa I' },
            { semana: 45, espiritual: { titulo: 'A vida vale a pena ser vivida', autor: 'Fulton Sheen', pInicio: 231, pFim: 276 }, secular: { titulo: 'Dostoievski: Sementes da revolta', autor: 'Joseph Frank', pInicio: 276, pFim: 330 }, bloco: 'Literatura Russa I' },
            { semana: 46, espiritual: { titulo: 'A vida vale a pena ser vivida', autor: 'Fulton Sheen', pInicio: 277, pFim: 322 }, secular: { titulo: 'Dostoievski: Sementes da revolta', autor: 'Joseph Frank', pInicio: 331, pFim: 385 }, bloco: 'Literatura Russa I' },
            { semana: 47, espiritual: { titulo: 'A vida vale a pena ser vivida', autor: 'Fulton Sheen', pInicio: 323, pFim: 368 }, secular: { titulo: 'Dostoievski: Sementes da revolta', autor: 'Joseph Frank', pInicio: 386, pFim: 440 }, bloco: 'Literatura Russa I' },
            { semana: 48, espiritual: { titulo: 'A vida vale a pena ser vivida', autor: 'Fulton Sheen', pInicio: 369, pFim: 416 }, secular: { titulo: 'Dostoievski: Sementes da revolta', autor: 'Joseph Frank', pInicio: 441, pFim: 496 }, bloco: 'Literatura Russa I' },
            { semana: 49, espiritual: { titulo: 'Cartas de Amor de uma Santa', autor: 'Gianna B. Molla', pInicio: 1, pFim: 36 }, secular: { titulo: 'A última ao cadafalso', autor: 'Gertrud von le Fort', pInicio: 1, pFim: 48 }, bloco: 'Amor e Vocação' },
            { semana: 50, espiritual: { titulo: 'Cartas de Amor de uma Santa', autor: 'Gianna B. Molla', pInicio: 37, pFim: 72 }, secular: { titulo: 'A última ao cadafalso', autor: 'Gertrud von le Fort', pInicio: 49, pFim: 96 }, bloco: 'Amor e Vocação' },
            { semana: 51, espiritual: { titulo: 'Cartas de Amor de uma Santa', autor: 'Gianna B. Molla', pInicio: 73, pFim: 108 }, secular: { titulo: 'A última ao cadafalso', autor: 'Gertrud von le Fort', pInicio: 97, pFim: 144 }, bloco: 'Amor e Vocação' },
            { semana: 52, espiritual: { titulo: 'Cartas de Amor de uma Santa', autor: 'Gianna B. Molla', pInicio: 109, pFim: 144 }, secular: { titulo: 'A última ao cadafalso', autor: 'Gertrud von le Fort', pInicio: 145, pFim: 192 }, bloco: 'Amor e Vocação' },
            { semana: 53, espiritual: { titulo: 'Amor e responsabilidade', autor: 'Karol Wojtyla', pInicio: 1, pFim: 50 }, secular: { titulo: 'Otelo', autor: 'William Shakespeare', pInicio: 1, pFim: 47 }, bloco: 'Amor e Vocação' },
            { semana: 54, espiritual: { titulo: 'Amor e responsabilidade', autor: 'Karol Wojtyla', pInicio: 51, pFim: 100 }, secular: { titulo: 'Otelo', autor: 'William Shakespeare', pInicio: 48, pFim: 94 }, bloco: 'Amor e Vocação' },
            { semana: 55, espiritual: { titulo: 'Amor e responsabilidade', autor: 'Karol Wojtyla', pInicio: 101, pFim: 150 }, secular: { titulo: 'Otelo', autor: 'William Shakespeare', pInicio: 95, pFim: 141 }, bloco: 'Amor e Vocação' },
            { semana: 56, espiritual: { titulo: 'Amor e responsabilidade', autor: 'Karol Wojtyla', pInicio: 151, pFim: 200 }, secular: { titulo: 'Otelo', autor: 'William Shakespeare', pInicio: 142, pFim: 188 }, bloco: 'Amor e Vocação' },
            { semana: 57, espiritual: { titulo: 'Amor e responsabilidade', autor: 'Karol Wojtyla', pInicio: 201, pFim: 250 }, secular: { titulo: 'Otelo', autor: 'William Shakespeare', pInicio: 189, pFim: 235 }, bloco: 'Amor e Vocação' },
            { semana: 58, espiritual: { titulo: 'Amor e responsabilidade', autor: 'Karol Wojtyla', pInicio: 251, pFim: 300 }, secular: { titulo: 'Otelo', autor: 'William Shakespeare', pInicio: 236, pFim: 282 }, bloco: 'Amor e Vocação' },
            { semana: 59, espiritual: { titulo: 'Amor e responsabilidade', autor: 'Karol Wojtyla', pInicio: 301, pFim: 354 }, secular: { titulo: 'Otelo', autor: 'William Shakespeare', pInicio: 283, pFim: 328 }, bloco: 'Amor e Vocação' },
            { semana: 60, espiritual: { titulo: 'Caminhar com Jesus', autor: 'Álvaro del Portillo', pInicio: 1, pFim: 42 }, secular: { titulo: 'Dostoievski: Anos de provação', autor: 'Joseph Frank', pInicio: 1, pFim: 53 }, bloco: 'Literatura Russa II' },
            { semana: 61, espiritual: { titulo: 'Caminhar com Jesus', autor: 'Álvaro del Portillo', pInicio: 43, pFim: 84 }, secular: { titulo: 'Dostoievski: Anos de provação', autor: 'Joseph Frank', pInicio: 54, pFim: 106 }, bloco: 'Literatura Russa II' },
            { semana: 62, espiritual: { titulo: 'Caminhar com Jesus', autor: 'Álvaro del Portillo', pInicio: 85, pFim: 126 }, secular: { titulo: 'Dostoievski: Anos de provação', autor: 'Joseph Frank', pInicio: 107, pFim: 159 }, bloco: 'Literatura Russa II' },
            { semana: 63, espiritual: { titulo: 'Caminhar com Jesus', autor: 'Álvaro del Portillo', pInicio: 127, pFim: 168 }, secular: { titulo: 'Dostoievski: Anos de provação', autor: 'Joseph Frank', pInicio: 160, pFim: 212 }, bloco: 'Literatura Russa II' },
            { semana: 64, espiritual: { titulo: 'Caminhar com Jesus', autor: 'Álvaro del Portillo', pInicio: 169, pFim: 210 }, secular: { titulo: 'Dostoievski: Anos de provação', autor: 'Joseph Frank', pInicio: 213, pFim: 265 }, bloco: 'Literatura Russa II' },
            { semana: 65, espiritual: { titulo: 'Caminhar com Jesus', autor: 'Álvaro del Portillo', pInicio: 211, pFim: 252 }, secular: { titulo: 'Dostoievski: Anos de provação', autor: 'Joseph Frank', pInicio: 266, pFim: 318 }, bloco: 'Literatura Russa II' },
            { semana: 66, espiritual: { titulo: 'Caminhar com Jesus', autor: 'Álvaro del Portillo', pInicio: 253, pFim: 294 }, secular: { titulo: 'Dostoievski: Anos de provação', autor: 'Joseph Frank', pInicio: 319, pFim: 371 }, bloco: 'Literatura Russa II' },
            { semana: 67, espiritual: { titulo: 'Caminhar com Jesus', autor: 'Álvaro del Portillo', pInicio: 295, pFim: 336 }, secular: { titulo: 'Dostoievski: Anos de provação', autor: 'Joseph Frank', pInicio: 372, pFim: 424 }, bloco: 'Literatura Russa II' },
            { semana: 68, espiritual: { titulo: 'As cerejeiras em flor', autor: 'José Miguel Cejas', pInicio: 1, pFim: 41 }, secular: { titulo: 'Dostoievski: Efeitos da libertação', autor: 'Joseph Frank', pInicio: 1, pFim: 59 }, bloco: 'Literatura Russa II' },
            { semana: 69, espiritual: { titulo: 'As cerejeiras em flor', autor: 'José Miguel Cejas', pInicio: 42, pFim: 82 }, secular: { titulo: 'Dostoievski: Efeitos da libertação', autor: 'Joseph Frank', pInicio: 60, pFim: 118 }, bloco: 'Literatura Russa II' },
            { semana: 70, espiritual: { titulo: 'As cerejeiras em flor', autor: 'José Miguel Cejas', pInicio: 83, pFim: 123 }, secular: { titulo: 'Dostoievski: Efeitos da libertação', autor: 'Joseph Frank', pInicio: 119, pFim: 177 }, bloco: 'Literatura Russa II' },
            { semana: 71, espiritual: { titulo: 'As cerejeiras em flor', autor: 'José Miguel Cejas', pInicio: 124, pFim: 164 }, secular: { titulo: 'Dostoievski: Efeitos da libertação', autor: 'Joseph Frank', pInicio: 178, pFim: 236 }, bloco: 'Literatura Russa II' },
            { semana: 72, espiritual: { titulo: 'As cerejeiras em flor', autor: 'José Miguel Cejas', pInicio: 165, pFim: 205 }, secular: { titulo: 'Dostoievski: Efeitos da libertação', autor: 'Joseph Frank', pInicio: 237, pFim: 295 }, bloco: 'Literatura Russa II' },
            { semana: 73, espiritual: { titulo: 'As cerejeiras em flor', autor: 'José Miguel Cejas', pInicio: 206, pFim: 246 }, secular: { titulo: 'Dostoievski: Efeitos da libertação', autor: 'Joseph Frank', pInicio: 296, pFim: 354 }, bloco: 'Literatura Russa II' },
            { semana: 74, espiritual: { titulo: 'As cerejeiras em flor', autor: 'José Miguel Cejas', pInicio: 247, pFim: 287 }, secular: { titulo: 'Dostoievski: Efeitos da libertação', autor: 'Joseph Frank', pInicio: 355, pFim: 413 }, bloco: 'Literatura Russa II' },
            { semana: 75, espiritual: { titulo: 'As cerejeiras em flor', autor: 'José Miguel Cejas', pInicio: 288, pFim: 328 }, secular: { titulo: 'Dostoievski: Efeitos da libertação', autor: 'Joseph Frank', pInicio: 414, pFim: 472 }, bloco: 'Literatura Russa II' },
            { semana: 76, espiritual: { titulo: 'As cerejeiras em flor', autor: 'José Miguel Cejas', pInicio: 329, pFim: 368 }, secular: { titulo: 'Dostoievski: Efeitos da libertação', autor: 'Joseph Frank', pInicio: 473, pFim: 528 }, bloco: 'Literatura Russa II' },
            { semana: 77, espiritual: { titulo: 'A economia das parábolas', autor: 'Robert A. Sirico', pInicio: 1, pFim: 31 }, secular: { titulo: 'A Grande Depressão Americana', autor: 'Murray N. Rothbard', pInicio: 1, pFim: 63 }, bloco: 'Economia e Sociedade' },
            { semana: 78, espiritual: { titulo: 'A economia das parábolas', autor: 'Robert A. Sirico', pInicio: 32, pFim: 62 }, secular: { titulo: 'A Grande Depressão Americana', autor: 'Murray N. Rothbard', pInicio: 64, pFim: 126 }, bloco: 'Economia e Sociedade' },
            { semana: 79, espiritual: { titulo: 'A economia das parábolas', autor: 'Robert A. Sirico', pInicio: 63, pFim: 93 }, secular: { titulo: 'A Grande Depressão Americana', autor: 'Murray N. Rothbard', pInicio: 127, pFim: 189 }, bloco: 'Economia e Sociedade' },
            { semana: 80, espiritual: { titulo: 'A economia das parábolas', autor: 'Robert A. Sirico', pInicio: 94, pFim: 124 }, secular: { titulo: 'A Grande Depressão Americana', autor: 'Murray N. Rothbard', pInicio: 190, pFim: 252 }, bloco: 'Economia e Sociedade' },
            { semana: 81, espiritual: { titulo: 'A economia das parábolas', autor: 'Robert A. Sirico', pInicio: 125, pFim: 155 }, secular: { titulo: 'A Grande Depressão Americana', autor: 'Murray N. Rothbard', pInicio: 253, pFim: 315 }, bloco: 'Economia e Sociedade' },
            { semana: 82, espiritual: { titulo: 'A economia das parábolas', autor: 'Robert A. Sirico', pInicio: 156, pFim: 184 }, secular: { titulo: 'A Grande Depressão Americana', autor: 'Murray N. Rothbard', pInicio: 316, pFim: 378 }, bloco: 'Economia e Sociedade' },
            { semana: 83, espiritual: { titulo: 'Cristianismo e economia', autor: 'Élio E. Gasda', pInicio: 1, pFim: 45 }, secular: { titulo: 'Manual do Perfeito Idiota', autor: 'Mendoza et al.', pInicio: 1, pFim: 52 }, bloco: 'Economia e Sociedade' },
            { semana: 84, espiritual: { titulo: 'Cristianismo e economia', autor: 'Élio E. Gasda', pInicio: 46, pFim: 90 }, secular: { titulo: 'Manual do Perfeito Idiota', autor: 'Mendoza et al.', pInicio: 53, pFim: 104 }, bloco: 'Economia e Sociedade' },
            { semana: 85, espiritual: { titulo: 'Cristianismo e economia', autor: 'Élio E. Gasda', pInicio: 91, pFim: 135 }, secular: { titulo: 'Manual do Perfeito Idiota', autor: 'Mendoza et al.', pInicio: 105, pFim: 156 }, bloco: 'Economia e Sociedade' },
            { semana: 86, espiritual: { titulo: 'Cristianismo e economia', autor: 'Élio E. Gasda', pInicio: 136, pFim: 180 }, secular: { titulo: 'Manual do Perfeito Idiota', autor: 'Mendoza et al.', pInicio: 157, pFim: 208 }, bloco: 'Economia e Sociedade' },
            { semana: 87, espiritual: { titulo: 'Cristianismo e economia', autor: 'Élio E. Gasda', pInicio: 181, pFim: 225 }, secular: { titulo: 'Manual do Perfeito Idiota', autor: 'Mendoza et al.', pInicio: 209, pFim: 260 }, bloco: 'Economia e Sociedade' },
            { semana: 88, espiritual: { titulo: 'Cristianismo e economia', autor: 'Élio E. Gasda', pInicio: 226, pFim: 270 }, secular: { titulo: 'Manual do Perfeito Idiota', autor: 'Mendoza et al.', pInicio: 261, pFim: 312 }, bloco: 'Economia e Sociedade' },
            { semana: 89, espiritual: { titulo: 'Cristianismo e economia', autor: 'Élio E. Gasda', pInicio: 271, pFim: 312 }, secular: { titulo: 'Manual do Perfeito Idiota', autor: 'Mendoza et al.', pInicio: 313, pFim: 364 }, bloco: 'Economia e Sociedade' },
            { semana: 90, espiritual: { titulo: 'O que há de errado com o mundo', autor: 'G.K. Chesterton', pInicio: 1, pFim: 55 }, secular: { titulo: 'As ideias têm consequências', autor: 'Richard M. Weaver', pInicio: 1, pFim: 52 }, bloco: 'Pensamento e Cultura' },
            { semana: 91, espiritual: { titulo: 'O que há de errado com o mundo', autor: 'G.K. Chesterton', pInicio: 56, pFim: 110 }, secular: { titulo: 'As ideias têm consequências', autor: 'Richard M. Weaver', pInicio: 53, pFim: 104 }, bloco: 'Pensamento e Cultura' },
            { semana: 92, espiritual: { titulo: 'O que há de errado com o mundo', autor: 'G.K. Chesterton', pInicio: 111, pFim: 165 }, secular: { titulo: 'As ideias têm consequências', autor: 'Richard M. Weaver', pInicio: 105, pFim: 156 }, bloco: 'Pensamento e Cultura' },
            { semana: 93, espiritual: { titulo: 'O que há de errado com o mundo', autor: 'G.K. Chesterton', pInicio: 166, pFim: 218 }, secular: { titulo: 'As ideias têm consequências', autor: 'Richard M. Weaver', pInicio: 157, pFim: 208 }, bloco: 'Pensamento e Cultura' },
            { semana: 94, espiritual: { titulo: 'O Catecismo', autor: 'Fulton J. Sheen', pInicio: 1, pFim: 58 }, secular: { titulo: 'Dostoievski: Anos milagrosos', autor: 'Joseph Frank', pInicio: 1, pFim: 60 }, bloco: 'Literatura Russa III' },
            { semana: 95, espiritual: { titulo: 'O Catecismo', autor: 'Fulton J. Sheen', pInicio: 59, pFim: 116 }, secular: { titulo: 'Dostoievski: Anos milagrosos', autor: 'Joseph Frank', pInicio: 61, pFim: 120 }, bloco: 'Literatura Russa III' },
            { semana: 96, espiritual: { titulo: 'O Catecismo', autor: 'Fulton J. Sheen', pInicio: 117, pFim: 174 }, secular: { titulo: 'Dostoievski: Anos milagrosos', autor: 'Joseph Frank', pInicio: 121, pFim: 180 }, bloco: 'Literatura Russa III' },
            { semana: 97, espiritual: { titulo: 'O Catecismo', autor: 'Fulton J. Sheen', pInicio: 175, pFim: 232 }, secular: { titulo: 'Dostoievski: Anos milagrosos', autor: 'Joseph Frank', pInicio: 181, pFim: 240 }, bloco: 'Literatura Russa III' },
            { semana: 98, espiritual: { titulo: 'O Catecismo', autor: 'Fulton J. Sheen', pInicio: 233, pFim: 290 }, secular: { titulo: 'Dostoievski: Anos milagrosos', autor: 'Joseph Frank', pInicio: 241, pFim: 300 }, bloco: 'Literatura Russa III' },
            { semana: 99, espiritual: { titulo: 'O Catecismo', autor: 'Fulton J. Sheen', pInicio: 291, pFim: 348 }, secular: { titulo: 'Dostoievski: Anos milagrosos', autor: 'Joseph Frank', pInicio: 301, pFim: 360 }, bloco: 'Literatura Russa III' },
            { semana: 100, espiritual: { titulo: 'O Catecismo', autor: 'Fulton J. Sheen', pInicio: 349, pFim: 406 }, secular: { titulo: 'Dostoievski: Anos milagrosos', autor: 'Joseph Frank', pInicio: 361, pFim: 420 }, bloco: 'Literatura Russa III' },
            { semana: 101, espiritual: { titulo: 'O Catecismo', autor: 'Fulton J. Sheen', pInicio: 407, pFim: 464 }, secular: { titulo: 'Dostoievski: Anos milagrosos', autor: 'Joseph Frank', pInicio: 421, pFim: 480 }, bloco: 'Literatura Russa III' },
            { semana: 102, espiritual: { titulo: 'O Catecismo', autor: 'Fulton J. Sheen', pInicio: 465, pFim: 522 }, secular: { titulo: 'Dostoievski: Anos milagrosos', autor: 'Joseph Frank', pInicio: 481, pFim: 540 }, bloco: 'Literatura Russa III' },
            { semana: 103, espiritual: { titulo: 'O Catecismo', autor: 'Fulton J. Sheen', pInicio: 523, pFim: 580 }, secular: { titulo: 'Dostoievski: Anos milagrosos', autor: 'Joseph Frank', pInicio: 541, pFim: 600 }, bloco: 'Literatura Russa III' },
            { semana: 104, espiritual: { titulo: 'O Catecismo', autor: 'Fulton J. Sheen', pInicio: 581, pFim: 639 }, secular: { titulo: 'Dostoievski: Anos milagrosos', autor: 'Joseph Frank', pInicio: 601, pFim: 662 }, bloco: 'Literatura Russa III' }
        ]
    },
    dayNames: ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'],
    dayNamesShort: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb']
};

function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
function formatDateKey(date) {
    var d = new Date(date);
    return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}
function getMonthKey(date) { var d = new Date(date); return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0'); }
function getWeekDays(date) {
    var d = new Date(date);
    var start = new Date(d);
    start.setDate(d.getDate() - d.getDay());
    var days = [];
    for (var i = 0; i < 7; i++) {
        var day = new Date(start);
        day.setDate(start.getDate() + i);
        days.push(day);
    }
    return days;
}
function isToday(date) {
    var today = new Date();
    return date.getDate() === today.getDate() && date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear();
}
function isThirdSunday(date) { return date.getDay() === 0 && date.getDate() >= 15 && date.getDate() <= 21; }
function formatDateDisplay(date) { return date.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' }); }
function formatDateShort(date) { return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }); }

// Debounce para evitar múltiplas chamadas de sync
var syncTimeout = null;
var lastSyncTime = 0;

function saveState() {
    try {
        localStorage.setItem('bujo-kindle-v2', JSON.stringify(BuJo.state));
    } catch(e){}

    // Sincronizar com Google Sheets (debounced - espera 3 segundos após última alteração)
    clearTimeout(syncTimeout);
    syncTimeout = setTimeout(syncToCloud, 3000);
}

async function syncToCloud() {
    try {
        var stateToSync = {
            entries: BuJo.state.entries,
            spiritualHabits: BuJo.state.spiritualHabits,
            studyGoals: BuJo.state.studyGoals,
            mortifications: BuJo.state.mortifications,
            projects: BuJo.state.projects,
            futureLog: BuJo.state.futureLog,
            notes: BuJo.state.notes,
            readingProgress: BuJo.state.readingProgress
        };

        var response = await fetch('/api/sync/jornal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(stateToSync)
        });

        if (response.ok) {
            lastSyncTime = Date.now();
            console.log('Jornal sincronizado com sucesso');
        }
    } catch(e) {
        console.warn('Falha ao sincronizar com nuvem:', e.message);
    }
}

async function loadFromCloud() {
    try {
        var response = await fetch('/api/sync/jornal');
        if (response.ok) {
            var data = await response.json();
            if (data.state) {
                return data;
            }
        }
    } catch(e) {
        console.warn('Falha ao carregar da nuvem:', e.message);
    }
    return null;
}

function loadState() {
    try {
        var saved = localStorage.getItem('bujo-kindle-v2');
        if (saved) {
            var p = JSON.parse(saved);
            BuJo.state.entries = p.entries || [];
            BuJo.state.spiritualHabits = p.spiritualHabits || {};
            BuJo.state.studyGoals = p.studyGoals || {};
            BuJo.state.mortifications = p.mortifications || {};
            BuJo.state.projects = p.projects || [];
            BuJo.state.futureLog = p.futureLog || [];
            BuJo.state.notes = p.notes || [];
            BuJo.state.readingProgress = p.readingProgress || { noturna: { currentPage: 0 }, currentWeek: 1, books: {} };
            if (p.selectedDate) BuJo.state.selectedDate = new Date(p.selectedDate);
        }
    } catch(e){}
}

async function syncFromCloud() {
    var cloudData = await loadFromCloud();
    if (cloudData && cloudData.state) {
        var localTime = localStorage.getItem('bujo-kindle-v2-time') || '0';
        var cloudTime = new Date(cloudData.timestamp).getTime();

        // Se dados da nuvem são mais recentes, usar eles
        if (cloudTime > parseInt(localTime)) {
            var p = cloudData.state;
            BuJo.state.entries = p.entries || [];
            BuJo.state.spiritualHabits = p.spiritualHabits || {};
            BuJo.state.studyGoals = p.studyGoals || {};
            BuJo.state.mortifications = p.mortifications || {};
            BuJo.state.projects = p.projects || [];
            BuJo.state.futureLog = p.futureLog || [];
            BuJo.state.notes = p.notes || [];
            BuJo.state.readingProgress = p.readingProgress || BuJo.state.readingProgress;
            localStorage.setItem('bujo-kindle-v2', JSON.stringify(BuJo.state));
            localStorage.setItem('bujo-kindle-v2-time', cloudTime.toString());
            console.log('Dados carregados da nuvem');
            render();
        }
    }
}

async function loadCalendarEvents() {
    try {
        var API_URL = window.location.origin;
        var response = await fetch(API_URL + '/api/calendar/events?days=60');
        if (response.ok) BuJo.state.calendarEvents = await response.json();
        else BuJo.state.calendarEvents = [];
    } catch(e) { BuJo.state.calendarEvents = []; }
    render();
}

function getEventsForDate(dateStr) {
    var events = [];
    for (var i = 0; i < BuJo.state.calendarEvents.length; i++) {
        var ev = BuJo.state.calendarEvents[i];
        if (ev.start.date && ev.start.date === dateStr) {
            events.push({ ...ev, allDay: true });
        } else if (ev.start.dateTime) {
            var rd = new Date(ev.start.dateTime);
            rd.setHours(rd.getHours() - 3);
            if (formatDateKey(rd) === dateStr) {
                events.push({ ...ev, allDay: false, startTime: rd.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) });
            }
        }
    }
    events.sort(function(a,b) { return a.allDay && !b.allDay ? -1 : !a.allDay && b.allDay ? 1 : (a.startTime||'').localeCompare(b.startTime||''); });
    return events;
}

function init() { loadState(); updateHeaderDate(); bindNavEvents(); loadCalendarEvents(); syncFromCloud(); }
function updateHeaderDate() { document.getElementById('header-date').textContent = new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }); }
function bindNavEvents() {
    document.getElementById('nav-tabs').onclick = function(e) {
        if (e.target.className.indexOf('nav-tab') !== -1) setView(e.target.getAttribute('data-view'));
    };
    document.getElementById('modal-overlay').onclick = function(e) { if (e.target.id === 'modal-overlay') closeModal(); };
}
function setView(view) {
    BuJo.state.currentView = view;
    document.querySelectorAll('.nav-tab').forEach(function(t) {
        var isLeituras = t.getAttribute('data-view') === 'leituras';
        var isActive = t.getAttribute('data-view') === view;
        t.className = 'nav-tab' + (isLeituras ? ' leituras' : '') + (isActive ? ' active' : '');
    });
    render();
}

function render() {
    var main = document.getElementById('main-content');
    var view = BuJo.state.currentView;
    if (view === 'dia') main.innerHTML = renderDayView();
    else if (view === 'mes') main.innerHTML = renderMonthView();
    else if (view === 'plano') main.innerHTML = renderPlanoVida();
    else if (view === 'estudo') main.innerHTML = renderEstudo();
    else if (view === 'leituras') main.innerHTML = renderLeituras();
    else if (view === 'future') main.innerHTML = renderFutureLog();
    else if (view === 'notas') main.innerHTML = renderNotas();
    else if (view === 'projetos') main.innerHTML = renderProjects();
    bindViewEvents();
}

function bindViewEvents() {
    var prevDate = document.getElementById('prev-date');
    var nextDate = document.getElementById('next-date');
    var prevWeek = document.getElementById('prev-week');
    var nextWeek = document.getElementById('next-week');
    var prevMonth = document.getElementById('prev-month');
    var nextMonth = document.getElementById('next-month');
    var todayBtn = document.getElementById('today-btn');
    if (prevDate) prevDate.onclick = function() { navigateDate(-1); };
    if (nextDate) nextDate.onclick = function() { navigateDate(1); };
    if (prevWeek) prevWeek.onclick = function() { navigateWeek(-1); };
    if (nextWeek) nextWeek.onclick = function() { navigateWeek(1); };
    if (prevMonth) prevMonth.onclick = function() { navigateMonth(-1); };
    if (nextMonth) nextMonth.onclick = function() { navigateMonth(1); };
    if (todayBtn) todayBtn.onclick = function() { goToToday(); };
    
    document.querySelectorAll('.spiritual-check').forEach(function(el) {
        el.onclick = function() { toggleSpiritualHabit(el.getAttribute('data-habit'), el.getAttribute('data-date')); };
    });
    document.querySelectorAll('.study-check').forEach(function(el) {
        el.onclick = function() { toggleStudyGoal(el.getAttribute('data-habit'), el.getAttribute('data-date'), parseInt(el.getAttribute('data-index'))); };
    });
    document.querySelectorAll('.mort-check').forEach(function(el) {
        el.onclick = function() { toggleMortification(el.getAttribute('data-date'), parseInt(el.getAttribute('data-index'))); };
    });
    
    var addEntryBtn = document.getElementById('add-entry-btn');
    var addEntryInput = document.getElementById('add-entry-input');
    if (addEntryBtn) addEntryBtn.onclick = addEntry;
    if (addEntryInput) addEntryInput.onkeypress = function(e) { if (e.key === 'Enter') addEntry(); };
    
    document.querySelectorAll('.entry-symbol[data-id]').forEach(function(el) {
        el.onclick = function() { cycleEntrySymbol(el.getAttribute('data-id')); };
    });
    document.querySelectorAll('.entry-delete').forEach(function(el) {
        el.onclick = function() { deleteEntry(el.getAttribute('data-id')); };
    });
    
    var addMortBtn = document.getElementById('add-mort-btn');
    var addProjectBtn = document.getElementById('add-project-btn');
    var addFutureBtn = document.getElementById('add-future-btn');
    var addNoteBtn = document.getElementById('add-note-btn');
    var saveNotesBtn = document.getElementById('save-notes-btn');
    if (addMortBtn) addMortBtn.onclick = showAddMortModal;
    if (addProjectBtn) addProjectBtn.onclick = showAddProjectModal;
    if (addFutureBtn) addFutureBtn.onclick = showAddFutureModal;
    if (addNoteBtn) addNoteBtn.onclick = showAddNoteModal;
    if (saveNotesBtn) saveNotesBtn.onclick = saveAllNotes;
    
    document.querySelectorAll('.month-cell[data-date]').forEach(function(el) {
        el.onclick = function() { selectMonthDay(el.getAttribute('data-date')); };
        el.ondblclick = function() { BuJo.state.selectedDate = new Date(el.getAttribute('data-date') + 'T12:00:00'); setView('dia'); };
    });
    document.querySelectorAll('.index-item[data-view]').forEach(function(el) {
        el.onclick = function() { setView(el.getAttribute('data-view')); };
    });
}

function renderDayView() {
    var date = BuJo.state.selectedDate;
    var dateStr = formatDateKey(date);
    var dow = date.getDay();
    var specialHabits = BuJo.weeklySpecialHabits[dow] || [];
    var thirdSunday = isThirdSunday(date);
    var dayEntries = BuJo.state.entries.filter(function(e) { return e.date === dateStr; });
    var calendarEvents = getEventsForDate(dateStr);
    var todayBadge = isToday(date) ? ' <span style="background:var(--primary);color:#fff;padding:4px 10px;font-size:0.8rem;border-radius:4px;margin-left:8px;">HOJE</span>' : '';

    var html = '<div class="card">';
    html += '<div class="card-title"><span class="btn" id="prev-date">←</span>';
    html += '<span style="flex:1;text-align:center;text-transform:capitalize;">' + formatDateDisplay(date) + todayBadge + '</span>';
    html += '<span class="btn" id="next-date">→</span></div>';

    if (specialHabits.length > 0 || thirdSunday) {
        html += '<div class="special-day"><strong>★ Especial:</strong> ';
        var sp = specialHabits.map(function(h) { return h.name; });
        if (thirdSunday) sp.push('Sýmbolum Athanasiánum');
        html += sp.join(' • ') + '</div>';
    }

    if (calendarEvents.length > 0) {
        html += '<div style="margin-bottom:14px;"><div style="font-size:0.85rem;text-transform:uppercase;color:var(--muted-foreground);margin-bottom:8px;">Agenda do Dia</div>';
        calendarEvents.forEach(function(ev) {
            html += '<div class="schedule-item"><span class="schedule-time">' + (ev.allDay ? 'Dia' : ev.startTime) + '</span>';
            html += '<span class="schedule-event">' + (ev.summary || 'Sem título') + '</span></div>';
        });
        html += '</div>';
    }
    html += '</div>';

    html += '<div class="card"><div class="card-title">Registro</div>';
    html += '<div style="font-size:0.9rem;color:var(--muted-foreground);padding:8px 0;border-bottom:1px dotted var(--border);margin-bottom:10px;">';
    html += BuJo.symbols.task + ' tarefa &nbsp;&nbsp;' + BuJo.symbols.taskDone + ' feito &nbsp;&nbsp;' + BuJo.symbols.taskMigrated + ' migrado &nbsp;&nbsp;' + BuJo.symbols.event + ' evento &nbsp;&nbsp;' + BuJo.symbols.note + ' nota</div>';
    if (dayEntries.length === 0) html += '<p style="color:var(--muted-foreground);font-style:italic;">Nenhuma entrada...</p>';
    else dayEntries.forEach(function(e) { html += renderEntry(e); });
    html += '<div class="add-entry"><select id="add-entry-type"><option value="task">' + BuJo.symbols.task + ' Tarefa</option><option value="event">' + BuJo.symbols.event + ' Evento</option><option value="note">' + BuJo.symbols.note + ' Nota</option></select>';
    html += '<input type="text" id="add-entry-input" placeholder="Digite..."><span class="btn btn-primary" id="add-entry-btn">+</span></div></div>';

    html += '<div class="card"><div class="card-title">Plano de Vida</div>';
    html += renderDaySpiritualHabits(dateStr, dow, thirdSunday) + '</div>';

    html += '<div class="card"><div class="card-title">Mortificações <span class="btn" id="add-mort-btn">+ Add</span></div>';
    html += renderMortifications(dateStr) + '</div>';

    html += '<div class="card"><div class="card-title">Leituras do Dia</div>';
    html += renderDayReading() + '</div>';
    return html;
}

function renderDaySpiritualHabits(dateStr, dow, thirdSunday) {
    var dayHabits = BuJo.state.spiritualHabits[dateStr] || {};
    var specialHabits = BuJo.weeklySpecialHabits[dow] || [];
    var html = '<div style="display:-webkit-box;display:flex;-webkit-flex-wrap:wrap;flex-wrap:wrap;">';
    BuJo.dailySpiritualHabits.forEach(function(h) {
        var checked = dayHabits[h.id] || false;
        html += '<div class="habit-row" style="width:50%;-webkit-box-sizing:border-box;box-sizing:border-box;padding-right:8px;"><span class="habit-name">' + h.name + '</span>';
        html += '<span class="habit-check spiritual-check' + (checked ? ' checked' : '') + '" data-habit="' + h.id + '" data-date="' + dateStr + '">' + (checked ? '✓' : '') + '</span></div>';
    });
    html += '</div>';
    if (specialHabits.length > 0) {
        html += '<div style="margin-top:14px;padding-top:12px;border-top:2px solid var(--primary);"><strong>★ Especiais do dia</strong></div>';
        specialHabits.forEach(function(h) {
            var checked = dayHabits[h.id] || false;
            html += '<div class="habit-row" style="background:var(--secondary);margin:4px -10px;padding:10px;"><span class="habit-name" style="font-weight:600;">' + h.name + '</span>';
            html += '<span class="habit-check spiritual-check' + (checked ? ' checked' : '') + '" data-habit="' + h.id + '" data-date="' + dateStr + '">' + (checked ? '✓' : '') + '</span></div>';
        });
    }
    if (thirdSunday) {
        var checked = dayHabits['symbolum-athanasianum'] || false;
        html += '<div class="habit-row" style="background:var(--secondary);margin:4px -10px;padding:10px;"><span class="habit-name" style="font-weight:600;">Sýmbolum Athanasiánum</span>';
        html += '<span class="habit-check spiritual-check' + (checked ? ' checked' : '') + '" data-habit="symbolum-athanasianum" data-date="' + dateStr + '">' + (checked ? '✓' : '') + '</span></div>';
    }
    return html;
}

function renderMortifications(dateStr) {
    var morts = BuJo.state.mortifications[dateStr] || [];
    if (morts.length === 0) return '<p style="color:var(--muted-foreground);font-style:italic;">Nenhuma mortificação.</p>';
    return morts.map(function(m, i) {
        return '<div class="habit-row"><span class="habit-name"' + (m.done ? ' style="text-decoration:line-through;color:var(--muted-foreground);"' : '') + '>' + m.text + '</span>' +
            '<span class="habit-check mort-check' + (m.done ? ' checked' : '') + '" data-date="' + dateStr + '" data-index="' + i + '">' + (m.done ? '✓' : '') + '</span></div>';
    }).join('');
}

function renderEntry(entry) {
    var symbol = entry.type === 'note' ? BuJo.symbols.note : entry.type === 'event' ? BuJo.symbols.event : entry.status === 'done' ? BuJo.symbols.taskDone : entry.status === 'migrated' ? BuJo.symbols.taskMigrated : BuJo.symbols.task;
    return '<div class="entry"><span class="entry-symbol" data-id="' + entry.id + '">' + symbol + '</span>' +
        '<span class="entry-text' + (entry.status === 'done' ? ' done' : '') + '">' + entry.text + '</span>' +
        '<span class="btn entry-delete" data-id="' + entry.id + '" style="padding:4px 10px;">×</span></div>';
}

function renderMonthView() {
    var date = BuJo.state.selectedDate;
    var year = date.getFullYear(), month = date.getMonth();
    var firstDay = new Date(year, month, 1);
    var lastDay = new Date(year, month + 1, 0);
    var startPadding = firstDay.getDay();
    var monthName = date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

    var html = '<div class="card"><div class="card-title"><span class="btn" id="prev-month">←</span>';
    html += '<span style="flex:1;text-align:center;text-transform:capitalize;">' + monthName + '</span>';
    html += '<span class="btn" id="next-month">→</span></div>';
    html += '<div style="text-align:center;margin-bottom:12px;"><span class="btn" id="today-btn">Hoje</span></div>';
    html += '<div class="month-calendar"><div class="month-row">';
    BuJo.dayNamesShort.forEach(function(d) { html += '<div class="month-cell header">' + d + '</div>'; });
    html += '</div>';

    var dayCount = 0, totalCells = startPadding + lastDay.getDate(), rows = Math.ceil(totalCells / 7);
    for (var r = 0; r < rows; r++) {
        html += '<div class="month-row">';
        for (var c = 0; c < 7; c++) {
            var cellIndex = r * 7 + c;
            if (cellIndex < startPadding || dayCount >= lastDay.getDate()) {
                html += '<div class="month-cell empty"></div>';
            } else {
                dayCount++;
                var dayDate = new Date(year, month, dayCount);
                var dateStr = formatDateKey(dayDate);
                var dow = dayDate.getDay();
                var isTodayCell = isToday(dayDate);
                var isSelected = dateStr === formatDateKey(date);
                var special = dow === 2 || dow === 3 || dow === 4 || dow === 6 || isThirdSunday(dayDate);
                var hasEvents = getEventsForDate(dateStr).length > 0;

                var cellClass = 'month-cell';
                if (isTodayCell) cellClass += ' today';
                if (isSelected) cellClass += ' selected';
                if (special && !isTodayCell && !isSelected) cellClass += ' special';
                if (hasEvents) cellClass += ' has-events';
                html += '<div class="' + cellClass + '" data-date="' + dateStr + '"><strong>' + dayCount + '</strong></div>';
            }
        }
        html += '</div>';
    }
    html += '</div></div>';

    html += '<div class="card" id="day-events-panel">' + renderDayEventsPanel(formatDateKey(date)) + '</div>';
    return html;
}

function renderDayEventsPanel(dateStr) {
    var date = new Date(dateStr + 'T12:00:00');
    var dow = date.getDay();
    var calendarEvents = getEventsForDate(dateStr);
    var specialHabits = BuJo.weeklySpecialHabits[dow] || [];
    var thirdSunday = isThirdSunday(date);

    var html = '<div class="card-title" style="text-transform:capitalize;">' + formatDateDisplay(date) + '</div>';
    if (specialHabits.length > 0 || thirdSunday) {
        html += '<div class="special-day"><strong>★ </strong>';
        var sp = specialHabits.map(function(h) { return h.name; });
        if (thirdSunday) sp.push('Sýmbolum Athanasiánum');
        html += sp.join(' • ') + '</div>';
    }
    if (calendarEvents.length === 0) html += '<p style="color:var(--muted-foreground);font-style:italic;">Nenhum evento agendado.</p>';
    else calendarEvents.forEach(function(ev) {
        html += '<div class="schedule-item"><span class="schedule-time">' + (ev.allDay ? 'Dia' : ev.startTime) + '</span>';
        html += '<span class="schedule-event">' + (ev.summary || 'Sem título') + '</span></div>';
    });
    html += '<div style="margin-top:14px;text-align:center;"><span class="btn btn-primary" onclick="goToDay(\'' + dateStr + '\')">Ir para este dia →</span></div>';
    return html;
}

function renderPlanoVida() {
    var weekDays = getWeekDays(BuJo.state.selectedDate);
    var html = '<div class="card"><div class="card-title"><span class="btn" id="prev-week">←</span>';
    html += '<span style="flex:1;text-align:center;">Plano de Vida</span><span class="btn" id="next-week">→</span></div>';
    html += '<div style="overflow-x:auto;"><table class="tracker-table"><tr><th class="label">Hábito</th>';
    weekDays.forEach(function(d) {
        var style = isToday(d) ? ' style="background:var(--primary);color:#fff;"' : '';
        html += '<th' + style + '>' + BuJo.dayNamesShort[d.getDay()] + '<br>' + d.getDate() + '</th>';
    });
    html += '</tr>';

    BuJo.dailySpiritualHabits.forEach(function(h) {
        html += '<tr><td class="label">' + h.name + '</td>';
        weekDays.forEach(function(d) {
            var dateStr = formatDateKey(d);
            var dayHabits = BuJo.state.spiritualHabits[dateStr] || {};
            var checked = dayHabits[h.id] || false;
            html += '<td class="tracker-cell spiritual-check' + (checked ? ' checked' : '') + '" data-habit="' + h.id + '" data-date="' + dateStr + '">' + (checked ? '✓' : '') + '</td>';
        });
        html += '</tr>';
    });

    var specialRows = [
        { id: 'turno', name: 'Dia Turno', dow: 2 }, { id: 'salmo-2', name: 'Salmo 2', dow: 2 },
        { id: 'guarda', name: 'Dia Guarda', dow: 3 }, { id: 'disciplina', name: 'Disciplina', dow: 3 },
        { id: 'adoro-te', name: 'Adoro Te Devote', dow: 4 },
        { id: 'oracao-nossa-senhora', name: 'Oração N.Sra', dow: 6 }, { id: 'mortificacao-extra', name: 'Mortif. Extra', dow: 6 }
    ];
    html += '<tr><td colspan="8" style="background:var(--secondary);font-weight:600;padding:10px;">★ Especiais</td></tr>';
    specialRows.forEach(function(row) {
        html += '<tr><td class="label">' + row.name + '</td>';
        weekDays.forEach(function(d) {
            var dateStr = formatDateKey(d);
            if (d.getDay() !== row.dow) html += '<td class="tracker-cell na">–</td>';
            else {
                var dayHabits = BuJo.state.spiritualHabits[dateStr] || {};
                var checked = dayHabits[row.id] || false;
                html += '<td class="tracker-cell spiritual-check' + (checked ? ' checked' : '') + '" data-habit="' + row.id + '" data-date="' + dateStr + '">' + (checked ? '✓' : '') + '</td>';
            }
        });
        html += '</tr>';
    });

    html += '<tr><td class="label">Symb. Athan.</td>';
    weekDays.forEach(function(d) {
        var dateStr = formatDateKey(d);
        if (!isThirdSunday(d)) html += '<td class="tracker-cell na">–</td>';
        else {
            var dayHabits = BuJo.state.spiritualHabits[dateStr] || {};
            var checked = dayHabits['symbolum-athanasianum'] || false;
            html += '<td class="tracker-cell spiritual-check' + (checked ? ' checked' : '') + '" data-habit="symbolum-athanasianum" data-date="' + dateStr + '">' + (checked ? '✓' : '') + '</td>';
        }
    });
    html += '</tr></table></div></div>';

    html += '<div class="card"><div class="card-title">Resumo da Semana</div>' + renderSpiritualSummary(weekDays) + '</div>';
    return html;
}

function renderSpiritualSummary(weekDays) {
    var dayStats = [];
    weekDays.forEach(function(d) {
        var dateStr = formatDateKey(d);
        var dayHabits = BuJo.state.spiritualHabits[dateStr] || {};
        var checked = 0, possible = BuJo.dailySpiritualHabits.length;
        BuJo.dailySpiritualHabits.forEach(function(h) { if (dayHabits[h.id]) checked++; });
        if (d.getDay() === 2) { possible += 2; if (dayHabits['turno']) checked++; if (dayHabits['salmo-2']) checked++; }
        if (d.getDay() === 3) { possible += 2; if (dayHabits['guarda']) checked++; if (dayHabits['disciplina']) checked++; }
        if (d.getDay() === 4) { possible++; if (dayHabits['adoro-te']) checked++; }
        if (d.getDay() === 6) { possible += 2; if (dayHabits['oracao-nossa-senhora']) checked++; if (dayHabits['mortificacao-extra']) checked++; }
        if (isThirdSunday(d)) { possible++; if (dayHabits['symbolum-athanasianum']) checked++; }
        var pct = possible > 0 ? Math.round((checked / possible) * 100) : 0;
        dayStats.push({ day: BuJo.dayNamesShort[d.getDay()], pct: pct, isToday: isToday(d) });
    });
    var html = '<div style="display:-webkit-box;display:flex;-webkit-box-align:flex-end;align-items:flex-end;height:150px;border-bottom:2px solid var(--primary);padding-bottom:8px;">';
    dayStats.forEach(function(s) {
        var barHeight = Math.max(s.pct * 1.2, 4);
        var barStyle = 'width:12%;height:' + barHeight + 'px;background:' + (s.isToday ? 'var(--primary)' : 'var(--border)') + ';margin-right:2%;';
        html += '<div style="' + barStyle + '"></div>';
    });
    html += '</div>';
    html += '<div style="display:-webkit-box;display:flex;margin-top:4px;">';
    dayStats.forEach(function(s) {
        html += '<div style="width:12%;margin-right:2%;text-align:center;font-size:var(--font-size-xs);">' + s.day + '</div>';
    });
    html += '</div>';
    html += '<div style="display:-webkit-box;display:flex;margin-top:2px;">';
    dayStats.forEach(function(s) {
        html += '<div style="width:12%;margin-right:2%;text-align:center;font-size:var(--font-size-xs);font-weight:600;">' + s.pct + '%</div>';
    });
    html += '</div>';
    return html;
}

function renderEstudo() {
    var weekDays = getWeekDays(BuJo.state.selectedDate);
    var html = '<div class="card"><div class="card-title"><span class="btn" id="prev-week">←</span>';
    html += '<span style="flex:1;text-align:center;">Metas de Estudo</span><span class="btn" id="next-week">→</span></div>';
    html += '<p style="font-size:0.95rem;color:var(--muted-foreground);margin-bottom:14px;">Marque cada meta alcançada. Cada quadrado = 1 sessão/meta.</p>';

    BuJo.studyGoalsList.forEach(function(goal) {
        html += '<div style="margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--border);">';
        html += '<div style="font-weight:600;font-size:1.1rem;margin-bottom:4px;">' + goal.name + '</div>';
        html += '<div style="font-size:0.9rem;color:var(--muted-foreground);margin-bottom:10px;">' + goal.description + '</div>';
        html += '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;"><tr>';
        weekDays.forEach(function(d) {
            var style = isToday(d) ? ' style="background:var(--primary);color:#fff;padding:6px;font-weight:600;"' : ' style="padding:6px;background:var(--secondary);"';
            html += '<th' + style + '>' + BuJo.dayNamesShort[d.getDay()] + ' ' + d.getDate() + '</th>';
        });
        html += '</tr><tr>';
        weekDays.forEach(function(d) {
            var dateStr = formatDateKey(d);
            var isApplicable = !goal.weekDays || goal.weekDays.indexOf(d.getDay()) !== -1;
            html += '<td style="padding:8px;text-align:center;">';
            if (!isApplicable) html += '<span style="color:var(--muted-foreground);">–</span>';
            else {
                html += '<div style="display:flex;gap:4px;justify-content:center;">';
                for (var g = 0; g < goal.dailyGoal; g++) {
                    var dayGoals = BuJo.state.studyGoals[dateStr] || {};
                    var goalChecks = dayGoals[goal.id] || [];
                    var checked = goalChecks[g] || false;
                    html += '<span class="study-check' + (checked ? ' checked' : '') + '" data-habit="' + goal.id + '" data-date="' + dateStr + '" data-index="' + g + '">' + (checked ? '✓' : '') + '</span>';
                }
                html += '</div>';
            }
            html += '</td>';
        });
        html += '</tr></table></div></div>';
    });
    html += '</div>';

    html += '<div class="card"><div class="card-title">Resumo Semanal</div>';
    BuJo.studyGoalsList.forEach(function(goal) {
        var completed = 0, total = 0;
        weekDays.forEach(function(d) {
            var isApplicable = !goal.weekDays || goal.weekDays.indexOf(d.getDay()) !== -1;
            if (!isApplicable) return;
            var dateStr = formatDateKey(d);
            var dayGoals = BuJo.state.studyGoals[dateStr] || {};
            var goalChecks = dayGoals[goal.id] || [];
            for (var g = 0; g < goal.dailyGoal; g++) { total++; if (goalChecks[g]) completed++; }
        });
        var percent = total > 0 ? Math.round((completed / total) * 100) : 0;
        html += '<div style="display:flex;align-items:center;padding:10px 0;border-bottom:1px dotted var(--border);">';
        html += '<span style="flex:1;">' + goal.name + '</span><span style="width:60px;text-align:right;font-weight:600;">' + percent + '%</span>';
        html += '<div style="width:80px;height:8px;background:var(--secondary);border-radius:4px;margin-left:10px;overflow:hidden;">';
        html += '<div style="width:' + percent + '%;height:100%;background:var(--primary);"></div></div></div>';
    });
    html += '</div>';
    return html;
}

function renderFutureLog() {
    var now = new Date();
    var months = [];
    for (var i = 0; i < 12; i++) {
        var d = new Date(now.getFullYear(), now.getMonth() + i, 1);
        months.push({ key: getMonthKey(d), name: d.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }) });
    }

    var html = '<div class="card"><div class="card-title">Future Log <span class="btn" id="add-future-btn">+ Add</span></div>';
    html += '<div style="font-size:0.95rem;color:var(--muted-foreground);margin-bottom:16px;padding:12px;background:var(--secondary);border-radius:0.5rem;">';
    html += '<strong>O que é o Future Log?</strong><br>Espaço para eventos, compromissos e objetivos futuros. Use para: aniversários, viagens, prazos importantes, metas trimestrais.</div>';

    months.forEach(function(month) {
        var entries = BuJo.state.futureLog.filter(function(e) { return e.month === month.key; });
        html += '<div class="future-month"><div class="future-month-header">' + month.name + '</div>';
        html += '<div class="future-month-content">';
        if (entries.length === 0) html += '<p style="color:var(--muted-foreground);font-style:italic;margin:0;">Nenhum evento</p>';
        else entries.forEach(function(e) {
            html += '<div class="entry" style="border-bottom:none;padding:6px 0;">';
            html += '<span style="font-weight:600;min-width:30px;">' + (e.day || '–') + '</span>';
            html += '<span class="entry-text">' + e.text + '</span>';
            html += '<span class="btn" onclick="deleteFutureEntry(\'' + e.id + '\')" style="padding:2px 8px;">×</span></div>';
        });
        html += '</div></div>';
    });
    html += '</div>';
    return html;
}

function renderNotas() {
    var html = '<div class="card"><div class="card-title">Notas Salvas <span class="btn" id="add-note-btn">+ Nova</span></div>';
    html += '<p style="font-size:0.95rem;color:var(--muted-foreground);margin-bottom:16px;">Notas e reflexões consolidadas.</p>';
    html += '<div style="margin-bottom:16px;"><span class="btn" id="save-notes-btn">Importar notas do Registro</span></div>';

    if (BuJo.state.notes.length === 0) html += '<p style="color:var(--muted-foreground);font-style:italic;text-align:center;padding:20px;">Nenhuma nota salva.</p>';
    else {
        var sorted = BuJo.state.notes.slice().sort(function(a,b) { return new Date(b.createdAt) - new Date(a.createdAt); });
        sorted.forEach(function(note) {
            var d = new Date(note.createdAt);
            html += '<div class="note-item"><div class="note-date">';
            if (note.type) html += '<span class="note-type">' + note.type + '</span>';
            html += formatDateShort(d) + ' às ' + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) + '</div>';
            html += '<div class="note-content">' + note.text + '</div>';
            html += '<div style="margin-top:8px;"><span class="btn" onclick="deleteNote(\'' + note.id + '\')" style="padding:4px 10px;">Excluir</span></div></div>';
        });
    }
    html += '</div>';
    return html;
}

function renderProjects() {
    var html = '<div class="card"><div class="card-title">Projetos <span class="btn" id="add-project-btn">+ Novo</span></div>';
    if (BuJo.state.projects.length === 0) html += '<p style="color:var(--muted-foreground);font-style:italic;">Nenhum projeto ativo.</p>';
    else BuJo.state.projects.forEach(function(p) {
        html += '<div style="border-left:4px solid var(--primary);padding-left:14px;margin-bottom:16px;">';
        html += '<div style="font-weight:600;font-size:1.1rem;">' + p.name + '</div>';
        html += '<div style="font-size:0.9rem;color:var(--muted-foreground);">' + (p.status || 'Em andamento') + '</div>';
        if (p.nextAction) html += '<p style="margin-top:6px;">→ ' + p.nextAction + '</p>';
        html += '</div>';
    });
    html += '</div>';
    html += '<div class="card"><div class="card-title">Plano 2026</div>';
    html += '<p style="margin-bottom:10px;"><strong>Línguas:</strong> Gradus Primus + Japonês N5→N4</p>';
    html += '<p style="margin-bottom:10px;"><strong>Acadêmico:</strong> Mestrado IME-USP</p>';
    html += '<p style="margin-bottom:10px;"><strong>Literatura:</strong> Machado de Assis</p>';
    html += '<p><strong>Físico:</strong> Tênis de Mesa Seg/Sex + Sáb</p></div>';
    return html;
}

function navigateDate(delta) { BuJo.state.selectedDate = new Date(BuJo.state.selectedDate.getTime() + delta * 86400000); render(); }
function navigateWeek(delta) { BuJo.state.selectedDate = new Date(BuJo.state.selectedDate.getTime() + delta * 7 * 86400000); render(); }
function navigateMonth(delta) { var d = BuJo.state.selectedDate; BuJo.state.selectedDate = new Date(d.getFullYear(), d.getMonth() + delta, 1); render(); }
function selectMonthDay(dateStr) { BuJo.state.selectedDate = new Date(dateStr + 'T12:00:00'); render(); }
function goToDay(dateStr) { BuJo.state.selectedDate = new Date(dateStr + 'T12:00:00'); setView('dia'); }
function goToToday() { BuJo.state.selectedDate = new Date(); render(); }

function toggleSpiritualHabit(habitId, dateStr) {
    if (!BuJo.state.spiritualHabits[dateStr]) BuJo.state.spiritualHabits[dateStr] = {};
    BuJo.state.spiritualHabits[dateStr][habitId] = !BuJo.state.spiritualHabits[dateStr][habitId];
    saveState(); render();
}
function toggleStudyGoal(habitId, dateStr, index) {
    if (!BuJo.state.studyGoals[dateStr]) BuJo.state.studyGoals[dateStr] = {};
    if (!BuJo.state.studyGoals[dateStr][habitId]) BuJo.state.studyGoals[dateStr][habitId] = [];
    BuJo.state.studyGoals[dateStr][habitId][index] = !BuJo.state.studyGoals[dateStr][habitId][index];
    saveState(); render();
}
function toggleMortification(dateStr, index) {
    var morts = BuJo.state.mortifications[dateStr];
    if (morts && morts[index]) { morts[index].done = !morts[index].done; saveState(); render(); }
}

function addEntry() {
    var input = document.getElementById('add-entry-input');
    var type = document.getElementById('add-entry-type').value;
    var text = input.value.trim();
    if (!text) return;
    BuJo.state.entries.push({ id: generateId(), date: formatDateKey(BuJo.state.selectedDate), type: type, text: text, status: 'pending', createdAt: new Date().toISOString() });
    saveState(); input.value = ''; render();
}
function cycleEntrySymbol(id) {
    var entry = BuJo.state.entries.find(function(e) { return e.id === id; });
    if (entry && entry.type === 'task') {
        entry.status = entry.status === 'pending' ? 'done' : entry.status === 'done' ? 'migrated' : 'pending';
        saveState(); render();
    }
}
function deleteEntry(id) { BuJo.state.entries = BuJo.state.entries.filter(function(e) { return e.id !== id; }); saveState(); render(); }
function deleteNote(id) { BuJo.state.notes = BuJo.state.notes.filter(function(n) { return n.id !== id; }); saveState(); render(); }
function deleteFutureEntry(id) { BuJo.state.futureLog = BuJo.state.futureLog.filter(function(f) { return f.id !== id; }); saveState(); render(); }

function saveAllNotes() {
    var imported = 0;
    BuJo.state.entries.forEach(function(entry) {
        if (entry.type === 'note' && !BuJo.state.notes.some(function(n) { return n.originalId === entry.id; })) {
            BuJo.state.notes.push({ id: generateId(), originalId: entry.id, text: entry.text, type: 'Registro', date: entry.date, createdAt: entry.createdAt });
            imported++;
        }
    });
    saveState();
    alert(imported > 0 ? imported + ' nota(s) importada(s)!' : 'Nenhuma nota nova.');
    render();
}

function showModal(content) { document.getElementById('modal-content').innerHTML = content; document.getElementById('modal-overlay').className = 'modal-overlay active'; }
function closeModal() { document.getElementById('modal-overlay').className = 'modal-overlay'; }

function showAddMortModal() {
    var dateStr = formatDateKey(BuJo.state.selectedDate);
    showModal('<div class="modal-title">Adicionar Mortificação</div>' +
        '<div class="form-group"><label>Descrição</label><input type="text" id="mort-text" placeholder="Ex: Jejum até o almoço"></div>' +
        '<div class="modal-actions"><span class="btn" onclick="closeModal()">Cancelar</span><span class="btn btn-primary" onclick="addMortification(\'' + dateStr + '\')">Adicionar</span></div>');
}
function addMortification(dateStr) {
    var text = document.getElementById('mort-text').value.trim();
    if (!text) return;
    if (!BuJo.state.mortifications[dateStr]) BuJo.state.mortifications[dateStr] = [];
    BuJo.state.mortifications[dateStr].push({ text: text, done: false });
    saveState(); closeModal(); render();
}

function showAddProjectModal() {
    showModal('<div class="modal-title">Novo Projeto</div>' +
        '<div class="form-group"><label>Nome</label><input type="text" id="project-name"></div>' +
        '<div class="form-group"><label>Próxima Ação</label><input type="text" id="project-next"></div>' +
        '<div class="modal-actions"><span class="btn" onclick="closeModal()">Cancelar</span><span class="btn btn-primary" onclick="addProject()">Criar</span></div>');
}
function addProject() {
    var name = document.getElementById('project-name').value.trim();
    if (!name) return;
    BuJo.state.projects.push({ id: generateId(), name: name, nextAction: document.getElementById('project-next').value, status: 'Em andamento', createdAt: new Date().toISOString() });
    saveState(); closeModal(); render();
}

function showAddFutureModal() {
    var now = new Date(), options = '';
    for (var i = 0; i < 12; i++) {
        var d = new Date(now.getFullYear(), now.getMonth() + i, 1);
        options += '<option value="' + getMonthKey(d) + '">' + d.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }) + '</option>';
    }
    showModal('<div class="modal-title">Adicionar ao Future Log</div>' +
        '<div class="form-group"><label>Mês</label><select id="future-month">' + options + '</select></div>' +
        '<div class="form-group"><label>Dia (opcional)</label><input type="number" id="future-day" min="1" max="31" placeholder="Ex: 15"></div>' +
        '<div class="form-group"><label>Descrição</label><input type="text" id="future-text" placeholder="Ex: Aniversário"></div>' +
        '<div class="modal-actions"><span class="btn" onclick="closeModal()">Cancelar</span><span class="btn btn-primary" onclick="addFutureEntry()">Adicionar</span></div>');
}
function addFutureEntry() {
    var text = document.getElementById('future-text').value.trim();
    if (!text) return;
    BuJo.state.futureLog.push({ id: generateId(), month: document.getElementById('future-month').value, day: document.getElementById('future-day').value || null, text: text, createdAt: new Date().toISOString() });
    saveState(); closeModal(); render();
}

function showAddNoteModal() {
    showModal('<div class="modal-title">Nova Nota</div>' +
        '<div class="form-group"><label>Tipo (opcional)</label><input type="text" id="note-type" placeholder="Ex: Reflexão, Ideia"></div>' +
        '<div class="form-group"><label>Conteúdo</label><textarea id="note-text" rows="4" placeholder="Escreva sua nota..."></textarea></div>' +
        '<div class="modal-actions"><span class="btn" onclick="closeModal()">Cancelar</span><span class="btn btn-primary" onclick="addNote()">Salvar</span></div>');
}
function addNote() {
    var text = document.getElementById('note-text').value.trim();
    if (!text) return;
    BuJo.state.notes.push({ id: generateId(), text: text, type: document.getElementById('note-type').value.trim() || 'Nota', createdAt: new Date().toISOString() });
    saveState(); closeModal(); render();
}

function renderDayReading() {
    var cw = BuJo.state.readingProgress.currentWeek || 1;
    var wd = BuJo.readingPlan.cronograma.find(function(w) { return w.semana === cw; });
    var noturna = BuJo.readingPlan.noturna;
    var np = BuJo.state.readingProgress.noturna.currentPage || 0;
    var nPct = Math.round((np / noturna.paginas) * 100);

    var html = '<div style="margin-bottom:12px;">';
    html += '<div style="font-weight:600;">Noturna: ' + noturna.titulo + '</div>';
    html += '<div class="reading-progress"><div class="reading-progress-bar"><div class="reading-progress-fill" style="width:' + nPct + '%;"></div></div><span class="reading-percent">' + nPct + '%</span></div></div>';

    if (wd) {
        var ek = 'sem' + cw + '_esp', sk = 'sem' + cw + '_sec';
        var ep = BuJo.state.readingProgress.books[ek] || 0, sp = BuJo.state.readingProgress.books[sk] || 0;
        var et = wd.espiritual.pFim - wd.espiritual.pInicio + 1, st = wd.secular.pFim - wd.secular.pInicio + 1;
        var ePct = Math.round((ep / et) * 100), sPct = Math.round((sp / st) * 100);

        html += '<div style="margin-bottom:8px;"><span class="book-type">Espiritual</span> ' + wd.espiritual.titulo + ' <strong>' + ePct + '%</strong></div>';
        html += '<div style="margin-bottom:12px;"><span class="book-type">Secular</span> ' + wd.secular.titulo + ' <strong>' + sPct + '%</strong></div>';
    }
    html += '<div style="text-align:center;"><span class="btn" onclick="setView(\'leituras\')">Ir para Leituras</span></div>';
    return html;
}

function renderLeituras() {
    var cw = BuJo.state.readingProgress.currentWeek || 1;
    var wd = BuJo.readingPlan.cronograma.find(function(w) { return w.semana === cw; });
    var noturna = BuJo.readingPlan.noturna;
    var np = BuJo.state.readingProgress.noturna.currentPage || 0;
    var nPct = Math.round((np / noturna.paginas) * 100);

    var html = '<div class="card reading-card noturna">';
    html += '<div class="card-title">Leitura Noturna</div>';
    html += '<div style="font-weight:600;">' + noturna.titulo + '</div>';
    html += '<div class="reading-meta">' + noturna.autor + ' · ' + noturna.paginas + ' págs</div>';
    html += '<div class="reading-progress"><div class="reading-progress-bar"><div class="reading-progress-fill" style="width:' + nPct + '%;"></div></div><span class="reading-percent">' + nPct + '%</span></div>';
    html += '<div style="display:-webkit-box;display:flex;-webkit-box-align:center;align-items:center;margin-top:10px;">Página: <input type="number" class="reading-input" value="' + np + '" min="0" max="' + noturna.paginas + '" onchange="updateNoturna(this.value)" style="margin-left:10px;margin-right:10px;"> / ' + noturna.paginas + '</div></div>';

    html += '<div class="card"><div class="card-title"><span class="btn" onclick="navWeek(-1)">←</span><span style="-webkit-box-flex:1;flex:1;text-align:center;">Semana ' + cw + '</span><span class="btn" onclick="navWeek(1)">→</span></div>';

    if (wd) {
        html += '<div style="background:var(--secondary);padding:8px 12px;border-radius:6px;margin-bottom:14px;font-weight:600;">' + wd.bloco + '</div>';
        var ek = 'sem' + cw + '_esp', sk = 'sem' + cw + '_sec';
        var ep = BuJo.state.readingProgress.books[ek] || 0, sp = BuJo.state.readingProgress.books[sk] || 0;
        var et = wd.espiritual.pFim - wd.espiritual.pInicio + 1, st = wd.secular.pFim - wd.secular.pInicio + 1;
        var ePct = Math.round((ep / et) * 100), sPct = Math.round((sp / st) * 100);

        html += '<div style="padding:12px;border:1px solid var(--border);border-radius:8px;margin-bottom:12px;">';
        html += '<span class="book-type">Espiritual</span> <span style="float:right;font-size:0.85rem;">p.' + wd.espiritual.pInicio + '–' + wd.espiritual.pFim + '</span>';
        html += '<div style="font-weight:600;margin:8px 0;">' + wd.espiritual.titulo + '</div>';
        html += '<div class="reading-meta">' + wd.espiritual.autor + '</div>';
        html += '<div class="reading-progress"><div class="reading-progress-bar"><div class="reading-progress-fill" style="width:' + ePct + '%;"></div></div><span class="reading-percent">' + ePct + '%</span></div>';
        html += '<input type="range" style="width:100%;" min="0" max="' + et + '" value="' + ep + '" onchange="updateBook(\'' + ek + '\',this.value)"></div>';

        html += '<div style="padding:12px;border:1px solid var(--border);border-radius:8px;">';
        html += '<span class="book-type">Secular</span> <span style="float:right;font-size:0.85rem;">p.' + wd.secular.pInicio + '–' + wd.secular.pFim + '</span>';
        html += '<div style="font-weight:600;margin:8px 0;">' + wd.secular.titulo + '</div>';
        html += '<div class="reading-meta">' + wd.secular.autor + '</div>';
        html += '<div class="reading-progress"><div class="reading-progress-bar"><div class="reading-progress-fill" style="width:' + sPct + '%;"></div></div><span class="reading-percent">' + sPct + '%</span></div>';
        html += '<input type="range" style="width:100%;" min="0" max="' + st + '" value="' + sp + '" onchange="updateBook(\'' + sk + '\',this.value)"></div>';
    }
    html += '</div>';
    return html;
}

function updateNoturna(v) { BuJo.state.readingProgress.noturna.currentPage = parseInt(v) || 0; saveState(); render(); }
function updateBook(k, v) { BuJo.state.readingProgress.books[k] = parseInt(v) || 0; saveState(); render(); }
function navWeek(d) { var nw = BuJo.state.readingProgress.currentWeek + d; if (nw >= 1 && nw <= 104) { BuJo.state.readingProgress.currentWeek = nw; saveState(); render(); } }

if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
else init();
</script>
</body>
</html>