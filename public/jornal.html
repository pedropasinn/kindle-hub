<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bullet Journal - Pedro 2026</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: Georgia, serif;
            font-size: 14px;
            line-height: 1.5;
            background: #fff;
            color: #000;
        }
        .header {
            border-bottom: 2px solid #000;
            padding: 8px 12px;
            background: #fff;
        }
        .header h1 { font-size: 1.1rem; margin-bottom: 4px; }
        .header-date { font-size: 0.7rem; color: #666; }
        .nav-tabs { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; }
        .nav-tab {
            font-size: 0.65rem;
            text-transform: uppercase;
            padding: 4px 8px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
        }
        .nav-tab.active { background: #000; color: #fff; border-color: #000; }
        .main { padding: 12px; max-width: 600px; margin: 0 auto; }
        .card { border: 1px solid #000; padding: 12px; margin-bottom: 12px; }
        .card-title {
            font-size: 1rem;
            font-weight: bold;
            border-bottom: 1px solid #000;
            padding-bottom: 6px;
            margin-bottom: 10px;
        }
        .btn {
            font-size: 0.7rem;
            padding: 4px 10px;
            border: 1px solid #000;
            background: #fff;
            cursor: pointer;
        }
        .special-day {
            background: #f5f5f5;
            border: 1px solid #999;
            padding: 6px;
            margin-bottom: 10px;
            font-size: 0.85rem;
        }
        .schedule-item {
            display: table;
            width: 100%;
            padding: 3px 0;
            border-bottom: 1px dotted #ccc;
            font-size: 0.85rem;
        }
        .schedule-time {
            display: table-cell;
            width: 50px;
            font-size: 0.75rem;
            color: #666;
        }
        .schedule-event { display: table-cell; }
        .schedule-event.special { font-weight: bold; }
        .habit-row {
            display: table;
            width: 100%;
            padding: 4px 0;
            border-bottom: 1px dotted #ccc;
        }
        .habit-name { display: table-cell; vertical-align: middle; }
        .habit-check {
            display: table-cell;
            width: 28px;
            height: 28px;
            border: 2px solid #000;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .habit-check.checked { background: #000; color: #fff; }
        .tracker-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        .tracker-table th, .tracker-table td {
            border: 1px solid #ccc;
            padding: 4px;
            text-align: center;
        }
        .tracker-table th { background: #f5f5f5; font-size: 0.65rem; text-transform: uppercase; }
        .tracker-table .label { text-align: left; font-weight: normal; }
        .tracker-cell { cursor: pointer; min-width: 24px; }
        .tracker-cell.checked { background: #000; color: #fff; }
        .tracker-cell.na { background: #eee; color: #999; }
        .week-grid { display: table; width: 100%; border-collapse: collapse; }
        .week-day { display: table-cell; border: 1px solid #ccc; vertical-align: top; width: 14.28%; }
        .week-day-header {
            font-size: 0.65rem;
            text-transform: uppercase;
            padding: 4px;
            border-bottom: 1px solid #ccc;
            background: #f5f5f5;
        }
        .week-day-header.today { background: #000; color: #fff; }
        .week-day-header.special { background: #666; color: #fff; }
        .week-day-content { padding: 4px; font-size: 0.7rem; min-height: 80px; }
        .month-calendar { display: table; width: 100%; border-collapse: collapse; }
        .month-row { display: table-row; }
        .month-cell {
            display: table-cell;
            border: 1px solid #ccc;
            width: 14.28%;
            height: 40px;
            text-align: center;
            vertical-align: top;
            padding: 2px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .month-cell.header { background: #f5f5f5; font-size: 0.65rem; font-weight: bold; height: auto; }
        .month-cell.today { border: 2px solid #000; font-weight: bold; }
        .month-cell.special { background: #eee; }
        .month-cell.empty { background: #fafafa; }
        .entry { padding: 4px 0; border-bottom: 1px dotted #ccc; }
        .entry-symbol { display: inline-block; width: 20px; cursor: pointer; }
        .entry-text { display: inline; }
        .entry-text.done { text-decoration: line-through; color: #999; }
        .add-entry { margin-top: 10px; padding-top: 10px; border-top: 1px solid #ccc; }
        .add-entry input { width: 60%; padding: 6px; border: 1px solid #ccc; font-size: 0.9rem; }
        .add-entry select { padding: 6px; border: 1px solid #ccc; }
        .index-item { padding: 8px 0; border-bottom: 1px dotted #ccc; cursor: pointer; }
        .summary-box { text-align: center; padding: 12px; }
        .summary-percent { font-size: 2rem; font-weight: bold; }
        .summary-bar { height: 8px; background: #eee; margin-top: 8px; }
        .summary-fill { height: 100%; background: #000; }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100;
        }
        .modal-overlay.active { display: block; }
        .modal {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 2px solid #000;
            padding: 16px;
            width: 90%;
            max-width: 320px;
            z-index: 101;
        }
        .modal-title { font-weight: bold; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #000; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; font-size: 0.75rem; text-transform: uppercase; color: #666; margin-bottom: 4px; }
        .form-group input, .form-group select { width: 100%; padding: 6px; border: 1px solid #ccc; }
        .modal-actions { margin-top: 12px; text-align: right; }
        .modal-actions .btn { margin-left: 8px; }
        .study-input { width: 100%; text-align: center; padding: 4px; border: 1px solid #ccc; font-size: 0.75rem; }
        .study-input.reached { background: #ddd; }
    </style>
</head>
<body>
    <div class="header">
        <h1>BULLET JOURNAL</h1>
        <div class="header-date" id="header-date"></div>
        <div class="nav-tabs" id="nav-tabs">
            <span class="nav-tab active" data-view="dia">Dia</span>
            <span class="nav-tab" data-view="semana">Semana</span>
            <span class="nav-tab" data-view="mes">Mês</span>
            <span class="nav-tab" data-view="plano">Plano</span>
            <span class="nav-tab" data-view="estudo">Estudo</span>
            <span class="nav-tab" data-view="future">Future</span>
            <span class="nav-tab" data-view="projetos">Projetos</span>
            <span class="nav-tab" data-view="indice">Índice</span>
        </div>
    </div>
    <div class="main" id="main-content"></div>
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal" id="modal-content"></div>
    </div>

<script>
// ========== ESTADO GLOBAL ==========
var BuJo = {
    state: {
        currentView: 'dia',
        selectedDate: new Date(),
        entries: [],
        spiritualHabits: {},
        studyHabits: {},
        mortifications: {},
        projects: [],
        futureLog: []
    },

    symbols: {
        task: '•',
        taskDone: '✕',
        taskMigrated: '→',
        event: '○',
        note: '–'
    },

    dailySpiritualHabits: [
        { id: 'serviam', name: 'Sérviam' },
        { id: 'preces', name: 'Preces' },
        { id: 'oracao-manha', name: 'Oração manhã' },
        { id: 'santa-missa', name: 'Santa Missa' },
        { id: 'leitura-espiritual', name: 'Leit. Espiritual' },
        { id: 'leitura-nt', name: 'Leitura NT' },
        { id: 'angelus', name: 'Angelus' },
        { id: 'visita-santissimo', name: 'Visita Santíssimo' },
        { id: 'lembrai-vos', name: 'Lembrai-vos' },
        { id: 'terco', name: 'Terço' },
        { id: 'oracao-tarde', name: 'Oração tarde' },
        { id: 'contemplacao', name: 'Contemplação' },
        { id: 'exame', name: 'Exame' },
        { id: '2-horas', name: '2 horas' },
        { id: '3-ave-marias', name: '3 Ave Marias' }
    ],

    weeklySpecialHabits: {
        2: [{ id: 'turno', name: 'Dia de Turno' }],
        3: [{ id: 'guarda', name: 'Dia de Guarda' }, { id: 'disciplina', name: 'Disciplina' }],
        6: [{ id: 'oracao-nossa-senhora', name: 'Oração N. Senhora' }, { id: 'mortificacao-extra', name: 'Mortif. Extra' }]
    },

    studyHabitsList: [
        { id: 'latim', name: 'Latim', target: 45 },
        { id: 'japones', name: 'Japonês', target: 120 },
        { id: 'estatistica', name: 'Estatística', target: 180 },
        { id: 'literatura', name: 'Leitura', target: 60 },
        { id: 'tenis-mesa', name: 'Tênis Mesa', target: 90 }
    ],

    weeklySchedule: {
        0: [
            { time: '10:00', event: 'Latim (2h)' },
            { time: '14:00', event: 'Estatística (3h)' },
            { time: '17:30', event: 'Japonês' }
        ],
        1: [
            { time: '05:45', event: 'Acordar' },
            { time: '08:15', event: 'Ida IME (Terço)' },
            { time: '09:00', event: 'Latim' },
            { time: '10:00', event: 'Aula IME' },
            { time: '13:30', event: 'Estatística' },
            { time: '15:30', event: 'Tênis de Mesa', special: true },
            { time: '18:30', event: 'Oração' }
        ],
        2: [
            { time: '05:45', event: 'Acordar' },
            { time: '09:00', event: 'Latim' },
            { time: '10:00', event: 'Aula IME' },
            { time: '18:00', event: 'Japonês (2h)' },
            { time: '★', event: 'DIA DE TURNO', special: true }
        ],
        3: [
            { time: '05:45', event: 'Acordar' },
            { time: '09:00', event: 'Latim' },
            { time: '10:00', event: 'Aula IME' },
            { time: '13:45', event: 'Estatística' },
            { time: '17:30', event: 'Disciplina', special: true },
            { time: '18:00', event: 'Leitura' },
            { time: '★', event: 'DIA DE GUARDA', special: true }
        ],
        4: [
            { time: '05:45', event: 'Acordar' },
            { time: '09:00', event: 'Latim' },
            { time: '10:00', event: 'Aula IME' },
            { time: '13:45', event: 'Estatística' },
            { time: '18:00', event: 'Japonês (2h)' }
        ],
        5: [
            { time: '05:45', event: 'Acordar' },
            { time: '09:00', event: 'Latim' },
            { time: '10:00', event: 'Aula IME' },
            { time: '13:30', event: 'Estatística' },
            { time: '15:30', event: 'Tênis de Mesa', special: true },
            { time: '18:00', event: 'Leitura' }
        ],
        6: [
            { time: '10:00', event: 'Tênis de Mesa', special: true },
            { time: '14:00', event: 'Estatística (3h)' },
            { time: '18:00', event: 'Leitura' },
            { time: '★', event: 'Oração N. Senhora', special: true },
            { time: '★', event: 'Mortif. Extra', special: true }
        ]
    },

    dayNames: ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'],
    dayNamesShort: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb']
};

// ========== UTILITÁRIOS ==========
function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

function formatDateKey(date) {
    var d = new Date(date);
    var year = d.getFullYear();
    var month = d.getMonth() + 1;
    var day = d.getDate();
    return year + '-' + (month < 10 ? '0' : '') + month + '-' + (day < 10 ? '0' : '') + day;
}

function getMonthKey(date) {
    var d = new Date(date);
    var year = d.getFullYear();
    var month = d.getMonth() + 1;
    return year + '-' + (month < 10 ? '0' : '') + month;
}

function getWeekDays(date) {
    var d = new Date(date);
    var day = d.getDay();
    var diff = d.getDate() - day;
    var days = [];
    for (var i = 0; i < 7; i++) {
        days.push(new Date(d.getFullYear(), d.getMonth(), diff + i));
    }
    return days;
}

function isToday(date) {
    var today = new Date();
    return date.getDate() === today.getDate() &&
           date.getMonth() === today.getMonth() &&
           date.getFullYear() === today.getFullYear();
}

function isThirdSunday(date) {
    if (date.getDay() !== 0) return false;
    var day = date.getDate();
    return day >= 15 && day <= 21;
}

function saveState() {
    try {
        localStorage.setItem('bujo-kindle-v1', JSON.stringify(BuJo.state));
    } catch (e) {}
}

function loadState() {
    try {
        var saved = localStorage.getItem('bujo-kindle-v1');
        if (saved) {
            var parsed = JSON.parse(saved);
            BuJo.state.entries = parsed.entries || [];
            BuJo.state.spiritualHabits = parsed.spiritualHabits || {};
            BuJo.state.studyHabits = parsed.studyHabits || {};
            BuJo.state.mortifications = parsed.mortifications || {};
            BuJo.state.projects = parsed.projects || [];
            BuJo.state.futureLog = parsed.futureLog || [];
            if (parsed.selectedDate) {
                BuJo.state.selectedDate = new Date(parsed.selectedDate);
            }
        }
    } catch (e) {}
}

// ========== INICIALIZAÇÃO ==========
function init() {
    loadState();
    updateHeaderDate();
    bindNavEvents();
    render();
}

function updateHeaderDate() {
    var el = document.getElementById('header-date');
    var now = new Date();
    var options = { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' };
    el.textContent = now.toLocaleDateString('pt-BR', options).toUpperCase();
}

function bindNavEvents() {
    var tabs = document.getElementById('nav-tabs');
    tabs.onclick = function(e) {
        var target = e.target;
        if (target.className.indexOf('nav-tab') !== -1) {
            var view = target.getAttribute('data-view');
            setView(view);
        }
    };

    var overlay = document.getElementById('modal-overlay');
    overlay.onclick = function(e) {
        if (e.target.id === 'modal-overlay') {
            closeModal();
        }
    };
}

function setView(view) {
    BuJo.state.currentView = view;
    var tabs = document.querySelectorAll('.nav-tab');
    for (var i = 0; i < tabs.length; i++) {
        var tab = tabs[i];
        if (tab.getAttribute('data-view') === view) {
            tab.className = 'nav-tab active';
        } else {
            tab.className = 'nav-tab';
        }
    }
    render();
}

// ========== RENDERIZAÇÃO ==========
function render() {
    var main = document.getElementById('main-content');
    var view = BuJo.state.currentView;

    if (view === 'dia') {
        main.innerHTML = renderDayView();
    } else if (view === 'semana') {
        main.innerHTML = renderWeekView();
    } else if (view === 'mes') {
        main.innerHTML = renderMonthView();
    } else if (view === 'plano') {
        main.innerHTML = renderPlanoVida();
    } else if (view === 'estudo') {
        main.innerHTML = renderEstudo();
    } else if (view === 'future') {
        main.innerHTML = renderFutureLog();
    } else if (view === 'projetos') {
        main.innerHTML = renderProjects();
    } else if (view === 'indice') {
        main.innerHTML = renderIndex();
    }

    bindViewEvents();
}

function bindViewEvents() {
    // Navegação
    var prevDate = document.getElementById('prev-date');
    var nextDate = document.getElementById('next-date');
    var prevWeek = document.getElementById('prev-week');
    var nextWeek = document.getElementById('next-week');
    var prevMonth = document.getElementById('prev-month');
    var nextMonth = document.getElementById('next-month');

    if (prevDate) prevDate.onclick = function() { navigateDate(-1); };
    if (nextDate) nextDate.onclick = function() { navigateDate(1); };
    if (prevWeek) prevWeek.onclick = function() { navigateWeek(-1); };
    if (nextWeek) nextWeek.onclick = function() { navigateWeek(1); };
    if (prevMonth) prevMonth.onclick = function() { navigateMonth(-1); };
    if (nextMonth) nextMonth.onclick = function() { navigateMonth(1); };

    // Hábitos espirituais
    var spiritualChecks = document.querySelectorAll('.spiritual-check');
    for (var i = 0; i < spiritualChecks.length; i++) {
        (function(el) {
            el.onclick = function() {
                toggleSpiritualHabit(el.getAttribute('data-habit'), el.getAttribute('data-date'));
            };
        })(spiritualChecks[i]);
    }

    // Hábitos de estudo
    var studyInputs = document.querySelectorAll('.study-input');
    for (var i = 0; i < studyInputs.length; i++) {
        (function(el) {
            el.onchange = function() {
                updateStudyHabit(el.getAttribute('data-habit'), el.getAttribute('data-date'), parseInt(el.value) || 0);
            };
        })(studyInputs[i]);
    }

    // Mortificações
    var mortChecks = document.querySelectorAll('.mort-check');
    for (var i = 0; i < mortChecks.length; i++) {
        (function(el) {
            el.onclick = function() {
                toggleMortification(el.getAttribute('data-date'), parseInt(el.getAttribute('data-index')));
            };
        })(mortChecks[i]);
    }

    // Entradas
    var addEntryBtn = document.getElementById('add-entry-btn');
    var addEntryInput = document.getElementById('add-entry-input');
    if (addEntryBtn) addEntryBtn.onclick = addEntry;
    if (addEntryInput) {
        addEntryInput.onkeypress = function(e) {
            if (e.key === 'Enter' || e.keyCode === 13) addEntry();
        };
    }

    var entrySymbols = document.querySelectorAll('.entry-symbol[data-id]');
    for (var i = 0; i < entrySymbols.length; i++) {
        (function(el) {
            el.onclick = function() { cycleEntrySymbol(el.getAttribute('data-id')); };
        })(entrySymbols[i]);
    }

    var entryDeletes = document.querySelectorAll('.entry-delete');
    for (var i = 0; i < entryDeletes.length; i++) {
        (function(el) {
            el.onclick = function() { deleteEntry(el.getAttribute('data-id')); };
        })(entryDeletes[i]);
    }

    // Botões
    var addMortBtn = document.getElementById('add-mort-btn');
    var addProjectBtn = document.getElementById('add-project-btn');
    var addFutureBtn = document.getElementById('add-future-btn');

    if (addMortBtn) addMortBtn.onclick = showAddMortModal;
    if (addProjectBtn) addProjectBtn.onclick = showAddProjectModal;
    if (addFutureBtn) addFutureBtn.onclick = showAddFutureModal;

    // Calendário mensal - clique único mostra eventos, duplo clique vai para o dia
    var monthCells = document.querySelectorAll('.month-cell[data-date]');
    for (var i = 0; i < monthCells.length; i++) {
        (function(el) {
            var clickTimer = null;
            var clickCount = 0;
            
            el.onclick = function() {
                clickCount++;
                var dateStr = el.getAttribute('data-date');
                
                if (clickCount === 1) {
                    clickTimer = setTimeout(function() {
                        // Clique único - mostrar eventos
                        showDayEvents(dateStr);
                        clickCount = 0;
                    }, 300);
                } else if (clickCount === 2) {
                    // Duplo clique - ir para o dia
                    clearTimeout(clickTimer);
                    clickCount = 0;
                    BuJo.state.selectedDate = new Date(dateStr + 'T12:00:00');
                    setView('dia');
                }
            };
        })(monthCells[i]);
    }

    // Índice
    var indexItems = document.querySelectorAll('.index-item[data-view]');
    for (var i = 0; i < indexItems.length; i++) {
        (function(el) {
            el.onclick = function() { setView(el.getAttribute('data-view')); };
        })(indexItems[i]);
    }
}

// ========== VIEW: DIA ==========
function renderDayView() {
    var date = BuJo.state.selectedDate;
    var dateStr = formatDateKey(date);
    var dayOfWeek = date.getDay();
    var schedule = BuJo.weeklySchedule[dayOfWeek] || [];
    var specialHabits = BuJo.weeklySpecialHabits[dayOfWeek] || [];
    var thirdSunday = isThirdSunday(date);
    var dayEntries = [];

    for (var i = 0; i < BuJo.state.entries.length; i++) {
        if (BuJo.state.entries[i].date === dateStr) {
            dayEntries.push(BuJo.state.entries[i]);
        }
    }

    var dateLabel = date.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
    var todayBadge = isToday(date) ? ' <span style="background:#000;color:#fff;padding:2px 6px;font-size:0.7rem;">HOJE</span>' : '';

    var html = '<div class="card">';
    html += '<div class="card-title">';
    html += '<span class="btn" id="prev-date">←</span> ';
    html += dateLabel + todayBadge;
    html += ' <span class="btn" id="next-date">→</span>';
    html += '</div>';

    // Dias especiais
    if (specialHabits.length > 0 || thirdSunday) {
        html += '<div class="special-day"><strong>★ Especial:</strong> ';
        var specials = [];
        for (var i = 0; i < specialHabits.length; i++) {
            specials.push(specialHabits[i].name);
        }
        if (thirdSunday) specials.push('Sýmbolum Athanasiánum');
        html += specials.join(' • ');
        html += '</div>';
    }

    // Rotina
    html += '<div style="margin-bottom:12px;">';
    html += '<div style="font-size:0.7rem;text-transform:uppercase;color:#666;margin-bottom:6px;">Rotina de ' + BuJo.dayNames[dayOfWeek] + '</div>';
    for (var i = 0; i < schedule.length; i++) {
        var item = schedule[i];
        html += '<div class="schedule-item">';
        html += '<span class="schedule-time">' + item.time + '</span>';
        html += '<span class="schedule-event' + (item.special ? ' special' : '') + '">' + item.event + '</span>';
        html += '</div>';
    }
    html += '</div>';
    html += '</div>';

    // Registro Rápido (MOVIDO PARA CIMA)
    html += '<div class="card">';
    html += '<div class="card-title">Registro</div>';
    // Legenda logo abaixo do título
    html += '<div style="font-size:0.75rem;color:#666;padding:4px 0 8px;border-bottom:1px dotted #ccc;margin-bottom:8px;">';
    html += BuJo.symbols.task + ' tarefa &nbsp; ';
    html += BuJo.symbols.taskDone + ' feito &nbsp; ';
    html += BuJo.symbols.taskMigrated + ' migrado &nbsp; ';
    html += BuJo.symbols.event + ' evento &nbsp; ';
    html += BuJo.symbols.note + ' nota';
    html += '</div>';
    if (dayEntries.length === 0) {
        html += '<p style="color:#999;font-style:italic;">Nenhuma entrada...</p>';
    } else {
        for (var i = 0; i < dayEntries.length; i++) {
            html += renderEntry(dayEntries[i]);
        }
    }
    html += '<div class="add-entry">';
    html += '<select id="add-entry-type">';
    html += '<option value="task">' + BuJo.symbols.task + '</option>';
    html += '<option value="event">' + BuJo.symbols.event + '</option>';
    html += '<option value="note">' + BuJo.symbols.note + '</option>';
    html += '</select> ';
    html += '<input type="text" id="add-entry-input" placeholder="Digite..."> ';
    html += '<span class="btn" id="add-entry-btn">+</span>';
    html += '</div>';
    html += '</div>';

    // Plano de Vida do Dia (MOVIDO PARA BAIXO)
    html += '<div class="card">';
    html += '<div class="card-title">Plano de Vida</div>';
    html += renderDaySpiritualHabits(dateStr, dayOfWeek, thirdSunday);
    html += '</div>';

    // Mortificações
    html += '<div class="card">';
    html += '<div class="card-title">Mortificações <span class="btn" id="add-mort-btn" style="float:right;">+ Add</span></div>';
    html += renderMortifications(dateStr);
    html += '</div>';

    return html;
}

function renderDaySpiritualHabits(dateStr, dayOfWeek, thirdSunday) {
    var dayHabits = BuJo.state.spiritualHabits[dateStr] || {};
    var specialHabits = BuJo.weeklySpecialHabits[dayOfWeek] || [];
    var html = '';

    // Hábitos diários em 2 colunas
    html += '<table style="width:100%;border-collapse:collapse;">';
    var habitsCount = BuJo.dailySpiritualHabits.length;
    var halfCount = Math.ceil(habitsCount / 2);
    
    for (var i = 0; i < halfCount; i++) {
        html += '<tr>';
        
        // Coluna 1
        var habit1 = BuJo.dailySpiritualHabits[i];
        var checked1 = dayHabits[habit1.id] || false;
        html += '<td style="padding:3px 4px;border-bottom:1px dotted #ccc;width:45%;">' + habit1.name + '</td>';
        html += '<td style="padding:3px;border-bottom:1px dotted #ccc;width:5%;text-align:center;">';
        html += '<span class="habit-check spiritual-check' + (checked1 ? ' checked' : '') + '" data-habit="' + habit1.id + '" data-date="' + dateStr + '" style="display:inline-block;width:24px;height:24px;line-height:24px;">';
        html += checked1 ? '✓' : '';
        html += '</span></td>';
        
        // Coluna 2
        var idx2 = i + halfCount;
        if (idx2 < habitsCount) {
            var habit2 = BuJo.dailySpiritualHabits[idx2];
            var checked2 = dayHabits[habit2.id] || false;
            html += '<td style="padding:3px 4px;border-bottom:1px dotted #ccc;border-left:1px solid #ccc;width:45%;">' + habit2.name + '</td>';
            html += '<td style="padding:3px;border-bottom:1px dotted #ccc;width:5%;text-align:center;">';
            html += '<span class="habit-check spiritual-check' + (checked2 ? ' checked' : '') + '" data-habit="' + habit2.id + '" data-date="' + dateStr + '" style="display:inline-block;width:24px;height:24px;line-height:24px;">';
            html += checked2 ? '✓' : '';
            html += '</span></td>';
        } else {
            html += '<td style="border-bottom:1px dotted #ccc;"></td><td style="border-bottom:1px dotted #ccc;"></td>';
        }
        
        html += '</tr>';
    }
    html += '</table>';

    // Hábitos especiais
    if (specialHabits.length > 0) {
        html += '<div style="margin-top:10px;padding-top:8px;border-top:2px solid #000;"><strong>★ Especial</strong></div>';
        for (var i = 0; i < specialHabits.length; i++) {
            var habit = specialHabits[i];
            var checked = dayHabits[habit.id] || false;
            html += '<div class="habit-row" style="background:#f5f5f5;">';
            html += '<span class="habit-name" style="font-weight:bold;">' + habit.name + '</span>';
            html += '<span class="habit-check spiritual-check' + (checked ? ' checked' : '') + '" data-habit="' + habit.id + '" data-date="' + dateStr + '">';
            html += checked ? '✓' : '';
            html += '</span>';
            html += '</div>';
        }
    }

    // 3º Domingo
    if (thirdSunday) {
        var checked = dayHabits['symbolum-athanasianum'] || false;
        html += '<div class="habit-row" style="background:#f5f5f5;margin-top:8px;">';
        html += '<span class="habit-name" style="font-weight:bold;">Sýmbolum Athanasiánum</span>';
        html += '<span class="habit-check spiritual-check' + (checked ? ' checked' : '') + '" data-habit="symbolum-athanasianum" data-date="' + dateStr + '">';
        html += checked ? '✓' : '';
        html += '</span>';
        html += '</div>';
    }

    return html;
}

function renderMortifications(dateStr) {
    var morts = BuJo.state.mortifications[dateStr] || [];
    if (morts.length === 0) {
        return '<p style="color:#999;font-style:italic;font-size:0.85rem;">Nenhuma mortificação.</p>';
    }
    var html = '';
    for (var i = 0; i < morts.length; i++) {
        var m = morts[i];
        html += '<div class="habit-row">';
        html += '<span class="habit-name"' + (m.done ? ' style="text-decoration:line-through;color:#999;"' : '') + '>' + m.text + '</span>';
        html += '<span class="habit-check mort-check' + (m.done ? ' checked' : '') + '" data-date="' + dateStr + '" data-index="' + i + '">';
        html += m.done ? '✓' : '';
        html += '</span>';
        html += '</div>';
    }
    return html;
}

function renderEntry(entry) {
    var symbol;
    if (entry.type === 'note') symbol = BuJo.symbols.note;
    else if (entry.type === 'event') symbol = BuJo.symbols.event;
    else if (entry.status === 'done') symbol = BuJo.symbols.taskDone;
    else if (entry.status === 'migrated') symbol = BuJo.symbols.taskMigrated;
    else symbol = BuJo.symbols.task;

    var textClass = entry.status === 'done' ? ' done' : '';

    var html = '<div class="entry">';
    html += '<span class="entry-symbol" data-id="' + entry.id + '">' + symbol + '</span>';
    html += '<span class="entry-text' + textClass + '">' + entry.text + '</span>';
    html += ' <span class="btn entry-delete" data-id="' + entry.id + '" style="font-size:0.7rem;padding:1px 5px;">×</span>';
    html += '</div>';
    return html;
}

// ========== VIEW: PLANO DE VIDA ==========
function renderPlanoVida() {
    var weekDays = getWeekDays(BuJo.state.selectedDate);
    var html = '<div class="card">';
    html += '<div class="card-title">';
    html += '<span class="btn" id="prev-week">←</span> Plano de Vida <span class="btn" id="next-week">→</span>';
    html += '</div>';

    // Tabela
    html += '<table class="tracker-table">';
    html += '<tr><th class="label">Hábito</th>';
    for (var i = 0; i < weekDays.length; i++) {
        var d = weekDays[i];
        var label = BuJo.dayNamesShort[d.getDay()] + '<br>' + d.getDate();
        var style = isToday(d) ? ' style="font-weight:bold;text-decoration:underline;"' : '';
        html += '<th' + style + '>' + label + '</th>';
    }
    html += '</tr>';

    // Hábitos diários
    for (var h = 0; h < BuJo.dailySpiritualHabits.length; h++) {
        var habit = BuJo.dailySpiritualHabits[h];
        html += '<tr><td class="label">' + habit.name + '</td>';
        for (var i = 0; i < weekDays.length; i++) {
            var dateStr = formatDateKey(weekDays[i]);
            var dayHabits = BuJo.state.spiritualHabits[dateStr] || {};
            var checked = dayHabits[habit.id] || false;
            html += '<td class="tracker-cell spiritual-check' + (checked ? ' checked' : '') + '" data-habit="' + habit.id + '" data-date="' + dateStr + '">';
            html += checked ? '✓' : '';
            html += '</td>';
        }
        html += '</tr>';
    }

    // Especiais
    var specialRows = [
        { id: 'turno', name: 'Dia Turno', dow: 2 },
        { id: 'guarda', name: 'Dia Guarda', dow: 3 },
        { id: 'disciplina', name: 'Disciplina', dow: 3 },
        { id: 'oracao-nossa-senhora', name: 'Oração N.Sra', dow: 6 },
        { id: 'mortificacao-extra', name: 'Mortif. Extra', dow: 6 }
    ];

    for (var r = 0; r < specialRows.length; r++) {
        var row = specialRows[r];
        html += '<tr><td class="label">' + row.name + '</td>';
        for (var i = 0; i < weekDays.length; i++) {
            var d = weekDays[i];
            var dateStr = formatDateKey(d);
            if (d.getDay() !== row.dow) {
                html += '<td class="tracker-cell na">–</td>';
            } else {
                var dayHabits = BuJo.state.spiritualHabits[dateStr] || {};
                var checked = dayHabits[row.id] || false;
                html += '<td class="tracker-cell spiritual-check' + (checked ? ' checked' : '') + '" data-habit="' + row.id + '" data-date="' + dateStr + '">';
                html += checked ? '✓' : '';
                html += '</td>';
            }
        }
        html += '</tr>';
    }

    // Símbolo Atanasiano (3º domingo)
    html += '<tr><td class="label">Symb. Athan.</td>';
    for (var i = 0; i < weekDays.length; i++) {
        var d = weekDays[i];
        var dateStr = formatDateKey(d);
        if (!isThirdSunday(d)) {
            html += '<td class="tracker-cell na">–</td>';
        } else {
            var dayHabits = BuJo.state.spiritualHabits[dateStr] || {};
            var checked = dayHabits['symbolum-athanasianum'] || false;
            html += '<td class="tracker-cell spiritual-check' + (checked ? ' checked' : '') + '" data-habit="symbolum-athanasianum" data-date="' + dateStr + '">';
            html += checked ? '✓' : '';
            html += '</td>';
        }
    }
    html += '</tr>';

    html += '</table>';
    html += '</div>';

    // Resumo
    html += '<div class="card">';
    html += '<div class="card-title">Resumo</div>';
    html += renderSpiritualSummary(weekDays);
    html += '</div>';

    return html;
}

function renderSpiritualSummary(weekDays) {
    var totalChecked = 0;
    var totalPossible = 0;

    for (var i = 0; i < weekDays.length; i++) {
        var d = weekDays[i];
        var dateStr = formatDateKey(d);
        var dayHabits = BuJo.state.spiritualHabits[dateStr] || {};

        for (var h = 0; h < BuJo.dailySpiritualHabits.length; h++) {
            totalPossible++;
            if (dayHabits[BuJo.dailySpiritualHabits[h].id]) totalChecked++;
        }

        // Especiais
        if (d.getDay() === 2) { totalPossible++; if (dayHabits['turno']) totalChecked++; }
        if (d.getDay() === 3) { totalPossible += 2; if (dayHabits['guarda']) totalChecked++; if (dayHabits['disciplina']) totalChecked++; }
        if (d.getDay() === 6) { totalPossible += 2; if (dayHabits['oracao-nossa-senhora']) totalChecked++; if (dayHabits['mortificacao-extra']) totalChecked++; }
        if (isThirdSunday(d)) { totalPossible++; if (dayHabits['symbolum-athanasianum']) totalChecked++; }
    }

    var percent = totalPossible > 0 ? Math.round((totalChecked / totalPossible) * 100) : 0;

    var html = '<div class="summary-box">';
    html += '<div class="summary-percent">' + percent + '%</div>';
    html += '<div style="font-size:0.85rem;color:#666;">' + totalChecked + ' de ' + totalPossible + ' práticas</div>';
    html += '<div class="summary-bar"><div class="summary-fill" style="width:' + percent + '%;"></div></div>';
    html += '</div>';
    return html;
}

// ========== VIEW: ESTUDO ==========
function renderEstudo() {
    var weekDays = getWeekDays(BuJo.state.selectedDate);
    var html = '<div class="card">';
    html += '<div class="card-title">';
    html += '<span class="btn" id="prev-week">←</span> Tracker de Estudo <span class="btn" id="next-week">→</span>';
    html += '</div>';
    html += '<p style="font-size:0.8rem;color:#666;margin-bottom:10px;">Registre minutos.</p>';

    html += '<table class="tracker-table">';
    html += '<tr><th class="label">Atividade</th>';
    for (var i = 0; i < weekDays.length; i++) {
        var d = weekDays[i];
        var style = isToday(d) ? ' style="font-weight:bold;"' : '';
        html += '<th' + style + '>' + BuJo.dayNamesShort[d.getDay()] + '</th>';
    }
    html += '</tr>';

    for (var h = 0; h < BuJo.studyHabitsList.length; h++) {
        var habit = BuJo.studyHabitsList[h];
        html += '<tr><td class="label">' + habit.name + '</td>';
        for (var i = 0; i < weekDays.length; i++) {
            var dateStr = formatDateKey(weekDays[i]);
            var dayStudy = BuJo.state.studyHabits[dateStr] || {};
            var minutes = dayStudy[habit.id] || 0;
            var reached = minutes >= habit.target;
            html += '<td>';
            html += '<input type="number" class="study-input' + (reached ? ' reached' : '') + '" data-habit="' + habit.id + '" data-date="' + dateStr + '" value="' + minutes + '" min="0">';
            html += '</td>';
        }
        html += '</tr>';
    }
    html += '</table>';
    html += '</div>';

    // Resumo
    html += '<div class="card">';
    html += '<div class="card-title">Resumo Semanal</div>';
    for (var h = 0; h < BuJo.studyHabitsList.length; h++) {
        var habit = BuJo.studyHabitsList[h];
        var total = 0;
        for (var i = 0; i < weekDays.length; i++) {
            var dateStr = formatDateKey(weekDays[i]);
            var dayStudy = BuJo.state.studyHabits[dateStr] || {};
            total += dayStudy[habit.id] || 0;
        }
        var hours = Math.floor(total / 60);
        var mins = total % 60;
        html += '<div style="display:table;width:100%;padding:4px 0;border-bottom:1px dotted #ccc;">';
        html += '<span style="display:table-cell;">' + habit.name + '</span>';
        html += '<span style="display:table-cell;text-align:right;">' + hours + 'h ' + mins + 'min</span>';
        html += '</div>';
    }
    html += '</div>';

    return html;
}

// ========== VIEW: SEMANA ==========
function renderWeekView() {
    var weekDays = getWeekDays(BuJo.state.selectedDate);
    var html = '<div class="card">';
    html += '<div class="card-title">';
    html += '<span class="btn" id="prev-week">←</span> Semana <span class="btn" id="next-week">→</span>';
    html += '</div>';

    html += '<div class="week-grid">';
    for (var i = 0; i < weekDays.length; i++) {
        var d = weekDays[i];
        var dow = d.getDay();
        var schedule = BuJo.weeklySchedule[dow] || [];
        var today = isToday(d);
        var special = (BuJo.weeklySpecialHabits[dow] || []).length > 0;

        var headerClass = 'week-day-header';
        if (today) headerClass += ' today';
        else if (special) headerClass += ' special';

        html += '<div class="week-day">';
        html += '<div class="' + headerClass + '" style="display:table;width:100%;">';
        html += '<span style="display:table-cell;text-align:left;">' + BuJo.dayNamesShort[dow] + '</span>';
        html += '<span style="display:table-cell;text-align:right;font-weight:bold;">' + d.getDate() + '</span>';
        html += '</div>';
        html += '<div class="week-day-content">';
        for (var j = 0; j < Math.min(schedule.length, 6); j++) {
            var item = schedule[j];
            var timeStr = item.time !== '★' ? item.time + ' ' : '★ ';
            html += '<div style="border-bottom:1px dotted #ccc;padding:2px 0;font-size:0.65rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">';
            html += '<span style="color:#666;">' + timeStr + '</span>' + item.event;
            html += '</div>';
        }
        if (schedule.length > 6) {
            html += '<div style="color:#999;font-size:0.6rem;">+' + (schedule.length - 6) + ' mais</div>';
        }
        html += '</div>';
        html += '</div>';
    }
    html += '</div>';
    html += '</div>';

    return html;
}

// ========== VIEW: MÊS ==========
function renderMonthView() {
    var date = BuJo.state.selectedDate;
    var year = date.getFullYear();
    var month = date.getMonth();
    var firstDay = new Date(year, month, 1);
    var lastDay = new Date(year, month + 1, 0);
    var startPadding = firstDay.getDay();

    var monthName = date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

    var html = '<div class="card">';
    html += '<div class="card-title">';
    html += '<span class="btn" id="prev-month">←</span> ';
    html += '<span style="text-transform:capitalize;">' + monthName + '</span>';
    html += ' <span class="btn" id="next-month">→</span>';
    html += '</div>';

    html += '<p style="font-size:0.7rem;color:#666;margin-bottom:6px;">★ Ter:Turno | Qua:Guarda | Sáb:N.Sra | 3ºDom:Athan.</p>';
    html += '<p style="font-size:0.65rem;color:#999;margin-bottom:8px;">Clique: ver eventos | Duplo clique: ir para o dia</p>';

    html += '<div class="month-calendar">';

    // Header
    html += '<div class="month-row">';
    for (var i = 0; i < 7; i++) {
        html += '<div class="month-cell header">' + BuJo.dayNamesShort[i] + '</div>';
    }
    html += '</div>';

    // Dias
    var dayCount = 0;
    var totalCells = startPadding + lastDay.getDate();
    var rows = Math.ceil(totalCells / 7);

    for (var r = 0; r < rows; r++) {
        html += '<div class="month-row">';
        for (var c = 0; c < 7; c++) {
            var cellIndex = r * 7 + c;
            if (cellIndex < startPadding || dayCount >= lastDay.getDate()) {
                html += '<div class="month-cell empty"></div>';
            } else {
                dayCount++;
                var dayDate = new Date(year, month, dayCount);
                var dateStr = formatDateKey(dayDate);
                var dow = dayDate.getDay();
                var today = isToday(dayDate);
                var special = dow === 2 || dow === 3 || dow === 6 || isThirdSunday(dayDate);
                var hasHabits = BuJo.state.spiritualHabits[dateStr] && Object.keys(BuJo.state.spiritualHabits[dateStr]).length > 0;

                var cellClass = 'month-cell';
                if (today) cellClass += ' today';
                if (special) cellClass += ' special';

                html += '<div class="' + cellClass + '" data-date="' + dateStr + '" data-day="' + dayCount + '">';
                html += '<strong>' + dayCount + '</strong>';
                if (hasHabits) html += '<div style="width:4px;height:4px;background:#000;border-radius:50%;margin:2px auto 0;"></div>';
                html += '</div>';
            }
        }
        html += '</div>';
    }
    html += '</div>';
    html += '</div>';

    // Painel de eventos do dia selecionado
    html += '<div class="card" id="day-events-panel">';
    html += '<div class="card-title">Eventos do Dia</div>';
    html += '<p style="color:#999;font-style:italic;font-size:0.85rem;">Clique em um dia para ver os eventos.</p>';
    html += '</div>';

    return html;
}

function showDayEvents(dateStr) {
    var panel = document.getElementById('day-events-panel');
    if (!panel) return;

    var date = new Date(dateStr + 'T12:00:00');
    var dow = date.getDay();
    var schedule = BuJo.weeklySchedule[dow] || [];
    var specialHabits = BuJo.weeklySpecialHabits[dow] || [];
    var thirdSunday = isThirdSunday(date);

    var dateLabel = date.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });

    var html = '<div class="card-title">' + dateLabel + '</div>';

    // Indicador de dia especial
    if (specialHabits.length > 0 || thirdSunday) {
        html += '<div style="background:#f5f5f5;padding:4px 8px;margin-bottom:8px;font-size:0.8rem;">';
        html += '<strong>★ </strong>';
        var specials = [];
        for (var i = 0; i < specialHabits.length; i++) {
            specials.push(specialHabits[i].name);
        }
        if (thirdSunday) specials.push('Sýmbolum Athanasiánum');
        html += specials.join(' • ');
        html += '</div>';
    }

    // Eventos do dia
    if (schedule.length === 0) {
        html += '<p style="color:#999;font-style:italic;font-size:0.85rem;">Nenhum evento agendado.</p>';
    } else {
        for (var i = 0; i < schedule.length; i++) {
            var item = schedule[i];
            html += '<div class="schedule-item">';
            html += '<span class="schedule-time">' + item.time + '</span>';
            html += '<span class="schedule-event' + (item.special ? ' special' : '') + '">' + item.event + '</span>';
            html += '</div>';
        }
    }

    html += '<div style="margin-top:12px;text-align:center;">';
    html += '<span class="btn" onclick="goToDay(\'' + dateStr + '\')">Ir para este dia →</span>';
    html += '</div>';

    panel.innerHTML = html;
}

function goToDay(dateStr) {
    BuJo.state.selectedDate = new Date(dateStr + 'T12:00:00');
    setView('dia');
}

// ========== VIEW: FUTURE LOG ==========
function renderFutureLog() {
    var now = new Date();
    var months = [];
    for (var i = 0; i < 12; i++) {
        var d = new Date(now.getFullYear(), now.getMonth() + i, 1);
        months.push({
            key: getMonthKey(d),
            name: d.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })
        });
    }

    var html = '<div class="card">';
    html += '<div class="card-title">Future Log <span class="btn" id="add-future-btn" style="float:right;">+ Add</span></div>';

    for (var m = 0; m < months.length; m++) {
        var month = months[m];
        var entries = [];
        for (var i = 0; i < BuJo.state.futureLog.length; i++) {
            if (BuJo.state.futureLog[i].month === month.key) {
                entries.push(BuJo.state.futureLog[i]);
            }
        }

        html += '<div style="margin-bottom:12px;">';
        html += '<div style="font-weight:bold;padding:6px;background:#000;color:#fff;text-transform:capitalize;">' + month.name + '</div>';
        html += '<div style="padding-left:8px;">';
        if (entries.length === 0) {
            html += '<p style="color:#999;font-style:italic;font-size:0.85rem;">–</p>';
        } else {
            for (var e = 0; e < entries.length; e++) {
                var entry = entries[e];
                html += '<div class="entry">';
                html += '<span class="entry-symbol">' + (entry.day || '–') + '</span> ';
                html += '<span class="entry-text">' + entry.text + '</span>';
                html += '</div>';
            }
        }
        html += '</div>';
        html += '</div>';
    }
    html += '</div>';

    return html;
}

// ========== VIEW: PROJETOS ==========
function renderProjects() {
    var html = '<div class="card">';
    html += '<div class="card-title">Projetos <span class="btn" id="add-project-btn" style="float:right;">+ Novo</span></div>';

    if (BuJo.state.projects.length === 0) {
        html += '<p style="color:#999;font-style:italic;">Nenhum projeto.</p>';
    } else {
        for (var i = 0; i < BuJo.state.projects.length; i++) {
            var p = BuJo.state.projects[i];
            html += '<div style="border-left:3px solid #000;padding-left:10px;margin-bottom:12px;">';
            html += '<div style="font-weight:bold;">' + p.name + '</div>';
            html += '<div style="font-size:0.75rem;color:#666;">' + (p.status || 'Em andamento') + '</div>';
            if (p.nextAction) html += '<p style="font-size:0.9rem;">→ ' + p.nextAction + '</p>';
            html += '</div>';
        }
    }
    html += '</div>';

    html += '<div class="card">';
    html += '<div class="card-title">Projetos 2026</div>';
    html += '<p style="margin-bottom:6px;"><strong>Línguas:</strong> Gradus Primus + Japonês N5→N4</p>';
    html += '<p style="margin-bottom:6px;"><strong>Acadêmico:</strong> Mestrado IME-USP</p>';
    html += '<p style="margin-bottom:6px;"><strong>Literatura:</strong> Machado de Assis</p>';
    html += '<p><strong>Físico:</strong> TM Seg/Sex + Sáb</p>';
    html += '</div>';

    return html;
}

// ========== VIEW: ÍNDICE ==========
function renderIndex() {
    var html = '<div class="card">';
    html += '<div class="card-title">Índice</div>';

    html += '<div style="margin-bottom:12px;padding:10px;background:#f5f5f5;">';
    html += '<div style="font-size:0.7rem;text-transform:uppercase;margin-bottom:6px;">Legenda</div>';
    html += BuJo.symbols.task + ' tarefa &nbsp; ';
    html += BuJo.symbols.taskDone + ' feito &nbsp; ';
    html += BuJo.symbols.taskMigrated + ' migrado &nbsp; ';
    html += BuJo.symbols.event + ' evento &nbsp; ';
    html += BuJo.symbols.note + ' nota';
    html += '</div>';

    var items = [
        { name: 'Registro Diário', view: 'dia', desc: 'Rotina + Plano + Registro' },
        { name: 'Visão Semanal', view: 'semana', desc: 'Rotina da semana' },
        { name: 'Pacote Mensal', view: 'mes', desc: 'Calendário mensal' },
        { name: 'Plano de Vida', view: 'plano', desc: '15 hábitos + especiais' },
        { name: 'Tracker Estudo', view: 'estudo', desc: 'Latim, Japonês, Estatística...' },
        { name: 'Future Log', view: 'future', desc: 'Próximos 12 meses' },
        { name: 'Projetos', view: 'projetos', desc: 'Projetos ativos' }
    ];

    for (var i = 0; i < items.length; i++) {
        var item = items[i];
        html += '<div class="index-item" data-view="' + item.view + '">';
        html += '<strong>' + item.name + '</strong><br>';
        html += '<small style="color:#666;">' + item.desc + '</small>';
        html += '</div>';
    }
    html += '</div>';

    html += '<div class="card">';
    html += '<div class="card-title">Dias Especiais</div>';
    html += '<p style="margin-bottom:4px;"><strong>Terça:</strong> Dia de Turno</p>';
    html += '<p style="margin-bottom:4px;"><strong>Quarta:</strong> Dia de Guarda + Disciplina</p>';
    html += '<p style="margin-bottom:4px;"><strong>Sábado:</strong> Oração N.Senhora + Mortif. Extra</p>';
    html += '<p><strong>3º Domingo:</strong> Sýmbolum Athanasiánum</p>';
    html += '</div>';

    html += '<div class="card">';
    html += '<div class="card-title">Estatísticas</div>';
    html += '<p>Entradas: ' + BuJo.state.entries.length + '</p>';
    html += '<p>Projetos: ' + BuJo.state.projects.length + '</p>';
    html += '<p>Dias com plano: ' + Object.keys(BuJo.state.spiritualHabits).length + '</p>';
    html += '<p>Future Log: ' + BuJo.state.futureLog.length + '</p>';
    html += '</div>';

    return html;
}

// ========== AÇÕES ==========
function navigateDate(delta) {
    var d = BuJo.state.selectedDate;
    BuJo.state.selectedDate = new Date(d.getTime() + delta * 86400000);
    render();
}

function navigateWeek(delta) {
    var d = BuJo.state.selectedDate;
    BuJo.state.selectedDate = new Date(d.getTime() + delta * 7 * 86400000);
    render();
}

function navigateMonth(delta) {
    var d = BuJo.state.selectedDate;
    BuJo.state.selectedDate = new Date(d.getFullYear(), d.getMonth() + delta, 1);
    render();
}

function toggleSpiritualHabit(habitId, dateStr) {
    if (!BuJo.state.spiritualHabits[dateStr]) {
        BuJo.state.spiritualHabits[dateStr] = {};
    }
    BuJo.state.spiritualHabits[dateStr][habitId] = !BuJo.state.spiritualHabits[dateStr][habitId];
    saveState();
    render();
}

function updateStudyHabit(habitId, dateStr, minutes) {
    if (!BuJo.state.studyHabits[dateStr]) {
        BuJo.state.studyHabits[dateStr] = {};
    }
    BuJo.state.studyHabits[dateStr][habitId] = minutes;
    saveState();
}

function toggleMortification(dateStr, index) {
    var morts = BuJo.state.mortifications[dateStr];
    if (morts && morts[index]) {
        morts[index].done = !morts[index].done;
        saveState();
        render();
    }
}

function addEntry() {
    var input = document.getElementById('add-entry-input');
    var typeSelect = document.getElementById('add-entry-type');
    var text = input.value.replace(/^\s+|\s+$/g, '');
    if (!text) return;

    BuJo.state.entries.push({
        id: generateId(),
        date: formatDateKey(BuJo.state.selectedDate),
        type: typeSelect.value,
        text: text,
        status: 'pending',
        createdAt: new Date().toISOString()
    });
    saveState();
    input.value = '';
    render();
}

function cycleEntrySymbol(id) {
    for (var i = 0; i < BuJo.state.entries.length; i++) {
        if (BuJo.state.entries[i].id === id) {
            var entry = BuJo.state.entries[i];
            if (entry.type === 'task') {
                if (entry.status === 'pending') entry.status = 'done';
                else if (entry.status === 'done') entry.status = 'migrated';
                else entry.status = 'pending';
            }
            break;
        }
    }
    saveState();
    render();
}

function deleteEntry(id) {
    var newEntries = [];
    for (var i = 0; i < BuJo.state.entries.length; i++) {
        if (BuJo.state.entries[i].id !== id) {
            newEntries.push(BuJo.state.entries[i]);
        }
    }
    BuJo.state.entries = newEntries;
    saveState();
    render();
}

// ========== MODAIS ==========
function showModal(content) {
    document.getElementById('modal-content').innerHTML = content;
    document.getElementById('modal-overlay').className = 'modal-overlay active';
}

function closeModal() {
    document.getElementById('modal-overlay').className = 'modal-overlay';
}

function showAddMortModal() {
    var dateStr = formatDateKey(BuJo.state.selectedDate);
    var html = '<div class="modal-title">Adicionar Mortificação</div>';
    html += '<div class="form-group">';
    html += '<label>Descrição</label>';
    html += '<input type="text" id="mort-text" placeholder="Ex: Jejum até o almoço">';
    html += '</div>';
    html += '<div class="modal-actions">';
    html += '<span class="btn" onclick="closeModal()">Cancelar</span>';
    html += '<span class="btn" onclick="addMortification(\'' + dateStr + '\')">Adicionar</span>';
    html += '</div>';
    showModal(html);
}

function addMortification(dateStr) {
    var text = document.getElementById('mort-text').value.replace(/^\s+|\s+$/g, '');
    if (!text) return;
    if (!BuJo.state.mortifications[dateStr]) {
        BuJo.state.mortifications[dateStr] = [];
    }
    BuJo.state.mortifications[dateStr].push({ text: text, done: false });
    saveState();
    closeModal();
    render();
}

function showAddProjectModal() {
    var html = '<div class="modal-title">Novo Projeto</div>';
    html += '<div class="form-group">';
    html += '<label>Nome</label>';
    html += '<input type="text" id="project-name">';
    html += '</div>';
    html += '<div class="form-group">';
    html += '<label>Próxima Ação</label>';
    html += '<input type="text" id="project-next">';
    html += '</div>';
    html += '<div class="modal-actions">';
    html += '<span class="btn" onclick="closeModal()">Cancelar</span>';
    html += '<span class="btn" onclick="addProject()">Criar</span>';
    html += '</div>';
    showModal(html);
}

function addProject() {
    var name = document.getElementById('project-name').value.replace(/^\s+|\s+$/g, '');
    if (!name) return;
    BuJo.state.projects.push({
        id: generateId(),
        name: name,
        nextAction: document.getElementById('project-next').value,
        status: 'Em andamento',
        createdAt: new Date().toISOString()
    });
    saveState();
    closeModal();
    render();
}

function showAddFutureModal() {
    var now = new Date();
    var options = '';
    for (var i = 0; i < 12; i++) {
        var d = new Date(now.getFullYear(), now.getMonth() + i, 1);
        var key = getMonthKey(d);
        var name = d.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
        options += '<option value="' + key + '">' + name + '</option>';
    }

    var html = '<div class="modal-title">Adicionar ao Future</div>';
    html += '<div class="form-group">';
    html += '<label>Mês</label>';
    html += '<select id="future-month">' + options + '</select>';
    html += '</div>';
    html += '<div class="form-group">';
    html += '<label>Dia (opcional)</label>';
    html += '<input type="number" id="future-day" min="1" max="31">';
    html += '</div>';
    html += '<div class="form-group">';
    html += '<label>Descrição</label>';
    html += '<input type="text" id="future-text">';
    html += '</div>';
    html += '<div class="modal-actions">';
    html += '<span class="btn" onclick="closeModal()">Cancelar</span>';
    html += '<span class="btn" onclick="addFutureEntry()">Adicionar</span>';
    html += '</div>';
    showModal(html);
}

function addFutureEntry() {
    var text = document.getElementById('future-text').value.replace(/^\s+|\s+$/g, '');
    if (!text) return;
    BuJo.state.futureLog.push({
        id: generateId(),
        month: document.getElementById('future-month').value,
        day: document.getElementById('future-day').value || null,
        text: text,
        createdAt: new Date().toISOString()
    });
    saveState();
    closeModal();
    render();
}

// ========== INICIALIZAÇÃO ==========
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}
</script>
</body>
</html>