<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda - Hub Kindle</title>
    <style>
        /* --- RESET & VARIÁVEIS --- */
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border-color: #000000;
            --font-main: Helvetica, Arial, sans-serif;
            --radius: 12px;
            --spacing: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            overflow: auto;
        }

        /* --- CABEÇALHO --- */
        header {
            padding: var(--spacing);
            border-bottom: 1px solid #ccc;
        }
        
        .header-content {
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 12px;
        }

        /* --- CALENDÁRIO --- */
        .calendar-container {
            margin: 8px var(--spacing);
            padding: 20px;
            border: 2px solid #000;
            background: #fff;
            border-radius: var(--radius);
            box-shadow: 4px 4px 0px #000;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-header h2 {
            font-size: 24px;
            margin: 0;
        }

        .calendar-nav button {
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid #000;
            background: #fff;
            border-radius: 50px;
            margin-left: 8px;
            font-family: inherit;
        }

        .calendar-nav button:hover {
            background: #000;
            color: #fff;
        }

        /* --- GRID DO CALENDÁRIO (CORREÇÃO CSS) --- */
        .calendar-grid {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        
        /* CORREÇÃO MATEMÁTICA:
           100% de largura - 12px (que é a soma das 6 margens de 2px)
           Dividido por 7 colunas.
        */
        .calendar-grid > * {
            width: calc((100% - 12px) / 7);
            margin-right: 2px;
            margin-bottom: 2px;
        }
        
        /* O 7º item da linha (e múltiplos) não tem margem à direita */
        .calendar-grid > *:nth-child(7n) {
            margin-right: 0;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: bold;
            padding: 6px;
            background: #f0f0f0;
            border: 1px solid #000;
            font-size: 12px;
        }

        .calendar-day {
            text-align: center;
            padding: 6px;
            border: 1px solid #ccc;
            cursor: pointer;
            min-height: 30px;
            background: #fff;
            font-size: 13px;
        }

        .calendar-day.today {
            background: #000;
            color: #fff;
            font-weight: bold;
        }

        .calendar-day.selected {
            background: #666;
            color: #fff;
            font-weight: bold;
        }

        .calendar-day.other-month {
            color: #ccc;
        }

        .calendar-day.has-events {
            font-weight: bold;
            text-decoration: underline;
        }

        /* --- NAVEGAÇÃO DA SEMANA --- */
        .week-nav {
            display: flex;
            margin-top: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .week-day-btn {
            margin-right: 8px;
            margin-bottom: 8px;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid #000;
            background: #fff;
            border-radius: 20px;
            font-family: inherit;
        }

        .week-day-btn:last-child { margin-right: 0; }
        .week-day-btn.active { background: #000; color: #fff; }

        /* --- LISTA DE EVENTOS --- */
        .events-list {
            margin: 8px var(--spacing);
            padding: 20px;
            border: 2px solid #000;
            background: #fff;
            border-radius: var(--radius);
            box-shadow: 4px 4px 0px #000;
            margin-bottom: 40px;
        }

        .events-list h2 {
            font-size: 22px;
            margin-bottom: 15px;
            border-bottom: 2px solid #000;
            padding-bottom: 8px;
        }

        .event-item {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            padding: 12px;
            border-left: 4px solid #000;
            margin-bottom: 10px;
            background: #f9f9f9;
            border-radius: 4px;
        }

        .event-item.all-day {
            background-color: #e0e0e0;
            border-left-color: #555;
            align-items: center;
        }

        .event-info {
            display: flex;
            flex-direction: column;
            margin-right: 10px;
        }

        .event-time {
            font-weight: bold;
            font-size: 18px;
            color: #000;
            white-space: nowrap;
            text-align: right;
        }

        .event-title {
            font-size: 18px;
            font-weight: bold;
        }

        .event-duration {
            font-weight: normal;
            font-size: 0.9em;
            color: #666;
            margin-left: 6px;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 20px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div style="display:flex;align-items:center;">
                <a href="dashboard.html" style="display:flex;align-items:center;">
                    <img src="/icones/casa.png" alt="Home" style="width:40px;height:40px;">
                </a>
            </div>
            <h1 style="font-size: 30px; font-weight: bold;">Agenda</h1>
            <div style="width: 70px"></div>
        </div>
    </header>

    <div class="calendar-container">
        <div class="calendar-header">
            <h2 id="monthYear"></h2>
            <div class="calendar-nav">
                <button onclick="changeMonth(-1)">←</button>
                <button onclick="goToToday()">Hoje</button>
                <button onclick="changeMonth(1)">→</button>
            </div>
        </div>

        <div class="calendar-grid" id="calendarGrid"></div>

        <div class="week-nav" id="weekNav">
            </div>
    </div>

    <div class="events-list">
        <h2 id="selectedDateTitle">Eventos</h2>
        <div id="eventsContainer">Carregando eventos...</div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let currentMonth = new Date();
        let selectedDate = new Date();
        let allEvents = [];

        // --- FUNÇÕES UTILITÁRIAS ---

        // 1. Ajusta fuso horário (apenas para horários específicos)
        function adjustTime(date) {
            const adjusted = new Date(date);
            adjusted.setHours(adjusted.getHours() - 3);
            return adjusted;
        }

        // 2. Formata data para String "YYYY-MM-DD" (para comparar eventos de dia inteiro)
        function formatDateToISO(dateObj) {
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Ajusta a data inicial para o timezone correto ao carregar a página
        selectedDate = adjustTime(selectedDate);

        const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                           'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        const dayNames = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];

        // --- LÓGICA DE DADOS ---

        async function loadEvents() {
            try {
                // Sugestão: Aumentar o range de dias se necessário
                const response = await fetch(`${API_URL}/api/calendar/events?days=40`);
                if (response.ok) {
                    allEvents = await response.json();
                } else {
                    allEvents = [];
                }
                renderCalendar();
                displayEventsForDate(selectedDate);
            } catch (error) {
                console.error('Erro ao carregar eventos:', error);
                allEvents = [];
                renderCalendar();
                displayEventsForDate(selectedDate);
            }
        }

        // --- RENDERIZAÇÃO ---

        function renderCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();

            document.getElementById('monthYear').textContent = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);

            const firstDayWeek = firstDay.getDay();
            const lastDate = lastDay.getDate();
            const prevLastDate = prevLastDay.getDate();

            let html = '';

            // Cabeçalhos
            const dayHeaders = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];
            dayHeaders.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });

            // Dias mês anterior
            for (let i = firstDayWeek - 1; i >= 0; i--) {
                html += `<div class="calendar-day other-month">${prevLastDate - i}</div>`;
            }

            // Dias mês atual
            const today = adjustTime(new Date());

            for (let day = 1; day <= lastDate; day++) {
                const dateLoop = new Date(year, month, day);
                const dateLoopISO = formatDateToISO(dateLoop);
                
                const isToday = dateLoop.toDateString() === today.toDateString();
                const isSelected = dateLoop.toDateString() === selectedDate.toDateString();

                // CORREÇÃO: Verificação híbrida (String vs Date)
                const hasEvents = allEvents.some(e => {
                    if (e.start.date) {
                        // Evento de dia inteiro: Comparação de String exata "2025-12-11"
                        return e.start.date === dateLoopISO;
                    } else if (e.start.dateTime) {
                        // Evento com hora: Ajusta fuso e compara
                        const rawDate = new Date(e.start.dateTime);
                        const adjustedEventDate = adjustTime(rawDate);
                        return adjustedEventDate.toDateString() === dateLoop.toDateString();
                    }
                    return false;
                });

                let className = 'calendar-day';
                if (isToday) className += ' today';
                if (isSelected) className += ' selected';
                if (hasEvents) className += ' has-events';

                html += `<div class="${className}" onclick="selectDate(${year}, ${month}, ${day})">${day}</div>`;
            }

            // Dias próximo mês para completar grid
            const totalCells = firstDayWeek + lastDate;
            const remainingDays = 7 - (totalCells % 7);
            
            if (remainingDays < 7) {
                for (let day = 1; day <= remainingDays; day++) {
                    html += `<div class="calendar-day other-month">${day}</div>`;
                }
            }

            document.getElementById('calendarGrid').innerHTML = html;
        }

        // Calcular duração entre dois horários
        function calculateDuration(start, end) {
            if (!start || !end) return '';

            const diffMs = end - start;
            const diffMins = Math.round(diffMs / 60000);

            if (diffMins <= 0) return '';

            if (diffMins < 60) {
                return `${diffMins} min`;
            } else {
                const h = Math.floor(diffMins / 60);
                const m = diffMins % 60;
                if (m === 0) return `${h}h`;
                return `${h}h ${m}min`;
            }
        }

        function displayEventsForDate(date) {
            const dayName = dayNames[date.getDay()];
            const optionsDate = { day: 'numeric', month: 'long', year: 'numeric' };
            const dateFull = date.toLocaleDateString('pt-BR', optionsDate);

            document.getElementById('selectedDateTitle').textContent = `${dateFull} - ${dayName}`;

            const targetISO = formatDateToISO(date);

            // 1. Filtragem Híbrida
            let dayEvents = allEvents.filter(event => {
                if (event.start.date) {
                    return event.start.date === targetISO;
                } else if (event.start.dateTime) {
                    const rawDate = new Date(event.start.dateTime);
                    const adjustedEventDate = adjustTime(rawDate);
                    return adjustedEventDate.toDateString() === date.toDateString();
                }
                return false;
            });

            // 2. Ordenação (Dia inteiro primeiro, depois por horário)
            dayEvents.sort((a, b) => {
                if (a.start.date && b.start.dateTime) return -1;
                if (a.start.dateTime && b.start.date) return 1;
                if (a.start.dateTime && b.start.dateTime) {
                    return new Date(a.start.dateTime) - new Date(b.start.dateTime);
                }
                return 0;
            });

            const container = document.getElementById('eventsContainer');

            if (dayEvents.length === 0) {
                container.innerHTML = '<p class="empty-state">Nenhum evento para este dia</p>';
                return;
            }

            container.innerHTML = dayEvents.map(event => {
                let timeStr = '';
                let durationStr = '';
                let isAllDay = false;
                let cssClass = 'event-item';

                if (event.start.dateTime) {
                    const start = adjustTime(new Date(event.start.dateTime));
                    const end = event.end.dateTime ? adjustTime(new Date(event.end.dateTime)) : new Date(start);

                    const durationText = calculateDuration(start, end);
                    if (durationText) {
                        durationStr = `<span class="event-duration">(${durationText})</span>`;
                    }

                    timeStr = start.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    if (event.end.dateTime) {
                        timeStr += ' - ' + end.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    }
                } else {
                    isAllDay = true;
                    cssClass += ' all-day';
                    timeStr = 'Dia Todo';
                }

                return `
                    <div class="${cssClass}">
                        <div class="event-info">
                            <div class="event-title">
                                ${event.summary || 'Sem título'}
                                ${durationStr}
                            </div>
                            ${event.description ? `<div style="margin-top: 4px; font-size: 13px; color: #555;">${event.description}</div>` : ''}
                        </div>
                        <div class="event-time">${timeStr}</div>
                    </div>
                `;
            }).join('');
        }

        // --- INTERATIVIDADE ---

        function selectDate(year, month, day) {
            selectedDate = new Date(year, month, day);
            renderCalendar();
            displayEventsForDate(selectedDate);
            updateWeekButtons();
        }

        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderCalendar();
        }

        function goToToday() {
            const today = adjustTime(new Date());
            currentMonth = new Date(today);
            selectedDate = new Date(today);
            renderCalendar();
            displayEventsForDate(selectedDate);
            updateWeekButtons();
        }

        function selectWeekDay(dayOfWeek) {
            const today = adjustTime(new Date());
            const currentDay = today.getDay();
            let daysToAdd = dayOfWeek - currentDay;
            if (daysToAdd < 0) daysToAdd += 7;

            const targetDate = new Date(today);
            targetDate.setDate(today.getDate() + daysToAdd);

            currentMonth = new Date(targetDate);
            selectedDate = new Date(targetDate);
            renderCalendar();
            displayEventsForDate(selectedDate);
            updateWeekButtons();
        }

        function updateWeekButtons() {
            const today = adjustTime(new Date());
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay());
            
            const dayLabels = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];
            let html = '';

            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                
                const isActive = date.toDateString() === selectedDate.toDateString() ? 'active' : '';
                
                html += `
                    <button class="week-day-btn ${isActive}" onclick="selectWeekDay(${i})">
                        ${dayLabels[i]} ${date.getDate()}
                    </button>
                `;
            }
            document.getElementById('weekNav').innerHTML = html;
        }

        // --- INICIALIZAÇÃO ---
        loadEvents();
        updateWeekButtons();

    </script>
</body>
</html>