<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarefas - Hub Kindle</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="page-container">
        <div class="header">
            <h1>Tarefas (Google Tasks)</h1>
            <a href="dashboard.html" class="back-link">Voltar ao Dashboard</a>
        </div>

        <div class="list-section">
            <h2>Minhas Tarefas do Google Tasks</h2>
            <div id="tasksList" class="loading">Carregando tarefas...</div>
            <div id="errorMessage" style="display: none; padding: 20px; background: #fff3cd; border: 2px solid #ffc107; margin-top: 15px;">
                <strong>‚ö†Ô∏è Google Tasks n√£o configurado</strong>
                <p style="margin: 10px 0;">As mesmas credenciais do Google Calendar j√° habilitam o Google Tasks automaticamente.</p>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;

        // Carregar tarefas do Google Tasks
        async function loadTasks() {
            try {
                const response = await fetch(`${API_URL}/api/google-tasks`);

                if (response.ok) {
                    const tasks = await response.json();
                    displayTasks(tasks);
                    document.getElementById('errorMessage').style.display = 'none';
                } else {
                    const error = await response.json();
                    showError(error.error || 'Erro ao carregar tarefas');
                }
            } catch (error) {
                console.error('Erro ao carregar tarefas:', error);
                showError('Erro ao conectar com o servidor');
            }
        }

        // Exibir tarefas
        function displayTasks(tasks) {
            const container = document.getElementById('tasksList');

            if (tasks.length === 0) {
                container.innerHTML = '<p class="empty-state">Nenhuma tarefa no Google Tasks</p>';
                return;
            }

            // Agrupar tarefas por status
            const pendingTasks = tasks.filter(t => t.status !== 'completed');
            const completedTasks = tasks.filter(t => t.status === 'completed');

            let html = '';

            // Tarefas pendentes
            if (pendingTasks.length > 0) {
                html += '<h3 style="margin-top: 0; color: #333;">Pendentes</h3>';
                html += pendingTasks.map(task => renderTask(task)).join('');
            }

            // Tarefas conclu√≠das (recolhidas)
            if (completedTasks.length > 0) {
                html += '<details style="margin-top: 20px;"><summary style="cursor: pointer; font-weight: bold; padding: 10px; background: #f5f5f5; border: 2px solid #000;">Conclu√≠das (' + completedTasks.length + ')</summary>';
                html += '<div style="margin-top: 10px;">';
                html += completedTasks.map(task => renderTask(task)).join('');
                html += '</div></details>';
            }

            container.innerHTML = html;

            // Adicionar event listeners aos checkboxes
            container.querySelectorAll('.task-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const taskId = this.getAttribute('data-task-id');
                    const completed = this.checked;
                    toggleTask(taskId, completed);
                });
            });
        }

        // Renderizar uma tarefa individual
        function renderTask(task) {
            const isCompleted = task.status === 'completed';
            const dueDate = task.due ? formatDate(task.due) : null;
            const checkboxId = 'task-' + Math.random().toString(36).substring(7);

            return `
                <div class="item ${isCompleted ? 'completed' : ''}" style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; margin-bottom: 8px; border: 2px solid #ddd; background: ${isCompleted ? '#f5f5f5' : '#fff'};">
                    <input type="checkbox"
                           id="${checkboxId}"
                           data-task-id="${escapeHtml(task.id)}"
                           ${isCompleted ? 'checked' : ''}
                           class="task-checkbox"
                           style="width: 20px; height: 20px; cursor: pointer; margin-top: 2px;">
                    <div style="flex: 1;">
                        <div class="item-title" style="font-size: 16px; font-weight: bold; ${isCompleted ? 'text-decoration: line-through; color: #999;' : ''}">
                            ${escapeHtml(task.title)}
                        </div>
                        ${task.notes ? `<div class="item-content" style="margin-top: 4px; color: #666;">${escapeHtml(task.notes)}</div>` : ''}
                        ${dueDate ? `<div class="item-meta" style="margin-top: 4px; font-size: 14px; color: #666;">üìÖ Vencimento: ${dueDate}</div>` : ''}
                    </div>
                </div>
            `;
        }

        // Toggle tarefa (marcar/desmarcar)
        async function toggleTask(taskId, completed) {
            try {
                const status = completed ? 'completed' : 'needsAction';
                const response = await fetch(`${API_URL}/api/google-tasks/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });

                if (response.ok) {
                    loadTasks(); // Recarregar lista
                } else {
                    const error = await response.json();
                    alert('Erro ao atualizar tarefa: ' + (error.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao atualizar tarefa:', error);
                alert('Erro ao atualizar tarefa');
            }
        }

        // Mostrar mensagem de erro
        function showError(message) {
            const container = document.getElementById('tasksList');
            const errorDiv = document.getElementById('errorMessage');

            container.innerHTML = `<p class="empty-state" style="color: #dc3545;">Google Tasks n√£o est√° acess√≠vel no momento.</p>`;
            errorDiv.style.display = 'block';
        }

        // Formatar data
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        // Escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Carregar ao iniciar
        loadTasks();

        // Recarregar a cada 2 minutos
        setInterval(loadTasks, 120000);
    </script>
</body>
</html>
