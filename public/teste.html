<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Contemplação - Hub Kindle</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        /* --- RESET & VARIÁVEIS --- */
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border-color: #000000;
            --font-main: Helvetica, Arial, sans-serif;
            --radius: 12px;
            --spacing: 16px;
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            -webkit-tap-highlight-color: transparent; 
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* Impede rolagem no Kindle */
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* --- CABEÇALHO --- */
        header {
            padding: 10px var(--spacing);
            text-align: center;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
        }
        header h1 { font-size: 22px; font-weight: bold; }

        /* --- CONTAINER PRINCIPAL (ÁREA DE TOQUE) --- */
        .viewport-main {
            flex-grow: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 3px;
        }

        /* --- INFORMAÇÕES DO TÍTULO --- */
        .imagem-info {
            margin: 10px;
            text-align: center;
            margin-bottom: 3px;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            height: 22px;
        }

        /* --- ÁREA DE CONTEÚDO (IMAGEM OU TEXTO) --- */
        .conteudo-wrapper {
            width: 100%;
            height: calc(100% - 28px);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background: #fff;
            padding: 3px;
        }

        .imagem-display {
            max-width: 95%;
            max-height: 95%;
            border-radius: var(--radius);
            box-shadow: 2px 2px 0px #000;
            display: block;
            object-fit: contain;
            border: 2px solid #000;
        }

        .texto-display {
            display: none;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding: 20px;
            font-size: 19px;
            line-height: 1.6;
            text-align: justify;
            background: #fafafa;
            border: 2px solid #000;
            border-radius: var(--radius);
        }

        .texto-display.ativo { display: block; }
        .imagem-display.oculto { display: none; }

        /* --- ZONAS DE TOQUE INVISÍVEIS --- */
        .touch-zones {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: grid;
            grid-template-columns: 25% 50% 25%;
            grid-template-rows: 80% 20%;
            z-index: 10;
        }

        .zone { cursor: pointer; }
        /* .zone:active { background: rgba(0,0,0,0.05); } Descomente para testar áreas */

        /* --- MENU INFERIOR (POPUP) --- */
        .menu-popup {
            position: fixed;
            bottom: -100%;
            left: 0;
            width: 100%;
            background: #fff;
            border-top: 3px solid #000;
            padding: 20px;
            transition: bottom 0.3s ease;
            z-index: 100;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .menu-popup.open { bottom: 0; }

        .misterios-selector {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .misterio-btn {
            padding: 10px 20px;
            background: #fff;
            border: 2px solid #000;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            font-family: inherit;
        }

        .misterio-btn.ativo { background: #000; color: #fff; }

        /* --- LADAINHA VIEW --- */
        .ladainha-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #fff;
            z-index: 200;
            display: none;
            flex-direction: column;
            overflow-y: auto;
            padding: 20px;
        }
        .ladainha-overlay.ativo { display: flex; }

        .ladainha-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }

        .ladainha-texto { font-size: 18px; line-height: 1.6; }
        .ladainha-texto .rub { color: #c00; font-weight: bold; }

        /* --- LOADING SPINNER --- */
        .loading {
            position: absolute;
            display: none;
            flex-direction: column;
            align-items: center;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #000;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <main class="viewport-main">
        <div id="imagemInfo" class="imagem-info">Carregando...</div>
        
        <div class="conteudo-wrapper">
            <div id="loading" class="loading">
                <div class="spinner"></div>
            </div>
            <img id="imgMain" class="imagem-display" src="" alt="Mistério">
            <div id="txtMain" class="texto-display"></div>
        </div>

        <!-- Zonas de Toque -->
        <div class="touch-zones">
            <div class="zone" onclick="anterior()" title="Voltar"></div>
            <div class="zone" onclick="toggleTexto()" title="Ver Texto"></div>
            <div class="zone" onclick="proximo()" title="Avançar"></div>
            <!-- Linha de baixo (Menu) -->
            <div class="zone" onclick="toggleMenu()" style="grid-column: span 3;" title="Abrir Menu"></div>
        </div>
    </main>

    <!-- Menu de Navegação Inferior -->
    <div id="menuPopup" class="menu-popup">
        <div style="width: 40px; height: 5px; background: #ddd; border-radius: 5px; margin-bottom: 15px;"></div>
        <div class="misterios-selector">
            <button class="misterio-btn" onclick="selecionarMisterio('gozosos', this)">Gozosos</button>
            <button class="misterio-btn" onclick="selecionarMisterio('dolorosos', this)">Dolorosos</button>
            <button class="misterio-btn" onclick="selecionarMisterio('gloriosos', this)">Gloriosos</button>
            <button class="misterio-btn" onclick="selecionarMisterio('luminosos', this)">Luminosos</button>
            <a href="javascript:void(0)" onclick="abrirLadainha()" style="display:flex;align-items:center;margin-left:5px;">
                <img src="/icones/virgem-maria.png" alt="Ladainha" style="width:36px;height:36px;">
            </a>
        </div>
        <button onclick="toggleMenu()" style="margin-top: 10px; background: #f0f0f0; border: 2px solid #000; border-radius: 50%; width: 36px; height: 36px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
            <i class="ph ph-caret-down"></i>
        </button>
    </div>

    <!-- Overlay da Ladainha -->
    <div id="ladainhaOverlay" class="ladainha-overlay">
        <div class="ladainha-header">
            <h2>Ladainha</h2>
            <div>
                <button onclick="mudarIdiomaLadainha('pt')" id="btnPt" style="font-weight:bold; padding: 5px 10px;">PT</button>
                <button onclick="mudarIdiomaLadainha('la')" id="btnLa" style="padding: 5px 10px;">LA</button>
                <button onclick="fecharLadainha()" style="margin-left:15px; font-weight:bold; background:#000; color:#fff; border-radius:50%; width:30px; height:30px; border:none;">X</button>
            </div>
        </div>
        <div id="ladainhaContent" class="ladainha-texto"></div>
    </div>

    <script>
        let misterioAtual = 'gozosos';
        let indiceAtual = 0;
        let imagens = [];
        let modoTexto = false;
        let textosCache = {};

        const misteriosInfo = {
            gozosos: { nome: 'Mistérios Gozosos', ids: [141, 142, 143, 144, 145], titulos: ['A Anunciação', 'Visitação', 'Nascimento', 'Apresentação', 'O Menino Perdido'] },
            dolorosos: { nome: 'Mistérios Dolorosos', ids: [146, 147, 148, 149, 150], titulos: ['Agonia no Horto', 'Flagelação', 'Coroação de Espinhos', 'Cruz às Costas', 'Crucificação'] },
            gloriosos: { nome: 'Mistérios Gloriosos', ids: [151, 152, 153, 154, 155], titulos: ['Ressurreição', 'Ascensão', 'Pentecostes', 'Assunção', 'Coroação'] },
            luminosos: { nome: 'Mistérios Luminosos', ids: [619, 620, 621, 622, 623], titulos: ['Batismo', 'Bodas de Caná', 'Anúncio do Reino', 'Transfiguração', 'Eucaristia'] }
        };

        // --- INICIALIZAÇÃO ---
        window.onload = () => {
            const salvo = localStorage.getItem('contemplacao_prefs');
            if (salvo) {
                const prefs = JSON.parse(salvo);
                misterioAtual = prefs.misterio || 'gozosos';
                indiceAtual = prefs.indice || 0;
            }
            atualizarBotoesAtivos();
            carregarImagens();
            carregarLadainha('pt');
        };

        function salvarProgresso() {
            localStorage.setItem('contemplacao_prefs', JSON.stringify({
                misterio: misterioAtual,
                indice: indiceAtual
            }));
        }

        // --- NAVEGAÇÃO ---
        async function carregarImagens() {
            // Fallback manual caso a API de listagem não exista no ambiente atual
            imagens = [];
            for (let i = 1; i <= 5; i++) {
                imagens.push(`/cont/${misterioAtual}/${i}.jpg`);
            }
            exibirConteudo();
        }

        function exibirConteudo() {
            const imgElement = document.getElementById('imgMain');
            const infoElement = document.getElementById('imagemInfo');
            const loading = document.getElementById('loading');
            
            const info = misteriosInfo[misterioAtual];
            const titulo = info.titulos[indiceAtual];
            
            infoElement.textContent = `${info.nome}: ${titulo} (${indiceAtual + 1}/5)`;
            
            loading.style.display = 'flex';
            imgElement.src = imagens[indiceAtual];
            
            imgElement.onload = () => loading.style.display = 'none';
            imgElement.onerror = () => {
                loading.style.display = 'none';
                imgElement.src = 'https://via.placeholder.com/400x300?text=Imagem+Indisponível';
            };

            // Resetar visualização para imagem ao trocar
            modoTexto = false;
            document.getElementById('txtMain').classList.remove('ativo');
            imgElement.classList.remove('oculto');
            
            salvarProgresso();
        }

        function proximo() {
            indiceAtual++;
            if (indiceAtual >= 5) {
                const ord = ['gozosos', 'dolorosos', 'gloriosos', 'luminosos'];
                let nextIdx = (ord.indexOf(misterioAtual) + 1) % ord.length;
                misterioAtual = ord[nextIdx];
                indiceAtual = 0;
                atualizarBotoesAtivos();
                carregarImagens();
                return;
            }
            exibirConteudo();
        }

        function anterior() {
            indiceAtual--;
            if (indiceAtual < 0) {
                const ord = ['gozosos', 'dolorosos', 'gloriosos', 'luminosos'];
                let prevIdx = (ord.indexOf(misterioAtual) - 1 + ord.length) % ord.length;
                misterioAtual = ord[prevIdx];
                indiceAtual = 4;
                atualizarBotoesAtivos();
                carregarImagens();
                return;
            }
            exibirConteudo();
        }

        // --- TEXTO (CENTRO) ---
        async function toggleTexto() {
            const txtElement = document.getElementById('txtMain');
            const imgElement = document.getElementById('imgMain');
            
            modoTexto = !modoTexto;

            if (modoTexto) {
                imgElement.classList.add('oculto');
                txtElement.classList.add('ativo');
                txtElement.innerHTML = 'Carregando meditação...';
                
                const idApi = misteriosInfo[misterioAtual].ids[indiceAtual];
                if (textosCache[idApi]) {
                    txtElement.innerHTML = textosCache[idApi];
                } else {
                    try {
                        const res = await fetch(`https://escriva.org/api/v1/mysteries/${idApi}/`);
                        const data = await res.json();
                        textosCache[idApi] = data.text || 'Texto não disponível.';
                        txtElement.innerHTML = textosCache[idApi];
                    } catch (e) {
                        txtElement.innerHTML = 'Erro ao carregar texto. Verifique sua conexão.';
                    }
                }
            } else {
                imgElement.classList.remove('oculto');
                txtElement.classList.remove('ativo');
            }
        }

        // --- MENU (INFERIOR) ---
        function toggleMenu() {
            document.getElementById('menuPopup').classList.toggle('open');
        }

        function selecionarMisterio(tipo, btn) {
            misterioAtual = tipo;
            indiceAtual = 0;
            atualizarBotoesAtivos();
            carregarImagens();
            toggleMenu();
        }

        function atualizarBotoesAtivos() {
            document.querySelectorAll('.misterio-btn').forEach(b => {
                b.classList.remove('ativo');
                if (b.textContent.toLowerCase() === misterioAtual) b.classList.add('ativo');
            });
        }

        // --- LADAINHA ---
        function abrirLadainha() {
            document.getElementById('ladainhaOverlay').classList.add('ativo');
            toggleMenu();
        }

        function fecharLadainha() {
            document.getElementById('ladainhaOverlay').classList.remove('ativo');
        }

        function mudarIdiomaLadainha(lang) {
            document.getElementById('btnPt').style.fontWeight = lang === 'pt' ? 'bold' : 'normal';
            document.getElementById('btnLa').style.fontWeight = lang === 'la' ? 'bold' : 'normal';
            carregarLadainha(lang);
        }

        function carregarLadainha(lang) {
            const content = document.getElementById('ladainhaContent');
            const textos = {
                pt: `<h3>Ladainha de Nossa Senhora</h3><br><p><span class="rub">V.</span> Senhor, tende piedade de nós.<br><span class="rub">R.</span> Senhor, tende piedade de nós.</p><p><span class="rub">V.</span> Jesus Cristo, tende piedade de nós.<br><span class="rub">R.</span> Jesus Cristo, tende piedade de nós.</p>... (Conteúdo da Ladainha em PT) ...`,
                la: `<h3>Litaniæ Lauretanæ</h3><br><p><span class="rub">V.</span> Kyrie, eleison.<br><span class="rub">R.</span> Kyrie, eleison.</p><p><span class="rub">V.</span> Christe, eleison.<br><span class="rub">R.</span> Christe, eleison.</p>... (Conteúdo da Ladainha em LA) ...`
            };
            // Note: Adicionei apenas o início por brevidade, mas o script mantém a lógica de troca.
            content.innerHTML = lang === 'pt' ? getLadainhaPT() : getLadainhaLA();
        }

        // Funções auxiliares para retornar o texto longo da ladainha
        function getLadainhaPT() {
            return `<p><span class="rub">V.</span> Senhor, tende piedade de nós. <span class="rub">R.</span> Senhor, tende piedade de nós.</p><p><span class="rub">V.</span> Jesus Cristo, tende piedade de nós. <span class="rub">R.</span> Jesus Cristo, tende piedade de nós.</p><p><span class="rub">V.</span> Senhor, tende piedade de nós. <span class="rub">R.</span> Senhor, tende piedade de nós.</p><br><p>Santa Maria, <span class="rub">rogai por nós.</span></p><p>Santa Mãe de Deus, <span class="rub">rogai por nós.</span></p><p>Mãe de Jesus Cristo, <span class="rub">rogai por nós.</span></p><p>Mãe da divina graça, <span class="rub">rogai por nós.</span></p><p>Espelho de justiça, <span class="rub">rogai por nós.</span></p><p>Sede de sabedoria, <span class="rub">rogai por nós.</span></p><p>Causa da nossa alegria, <span class="rub">rogai por nós.</span></p><p>Rosa mística, <span class="rub">rogai por nós.</span></p><p>Torre de Davi, <span class="rub">rogai por nós.</span></p><p>Porta do céu, <span class="rub">rogai por nós.</span></p><p>Estrela da manhã, <span class="rub">rogai por nós.</span></p><p>Saúde dos enfermos, <span class="rub">rogai por nós.</span></p><p>Refúgio dos pecadores, <span class="rub">rogai por nós.</span></p><p>Auxílio dos cristãos, <span class="rub">rogai por nós.</span></p><p>Rainha dos Anjos, <span class="rub">rogai por nós.</span></p><p>Rainha da paz, <span class="rub">rogai por nós.</span></p>`;
        }

        function getLadainhaLA() {
            return `<p><span class="rub">V.</span> Kyrie, eleison. <span class="rub">R.</span> Kyrie, eleison.</p><p><span class="rub">V.</span> Christe, eleison. <span class="rub">R.</span> Christe, eleison.</p><p><span class="rub">V.</span> Kyrie, eleison. <span class="rub">R.</span> Kyrie, eleison.</p><br><p>Sancta Maria, <span class="rub">ora pro nobis.</span></p><p>Sancta Dei Genetrix, <span class="rub">ora pro nobis.</span></p><p>Mater Christi, <span class="rub">ora pro nobis.</span></p><p>Mater divinae gratiae, <span class="rub">ora pro nobis.</span></p><p>Speculum iustitiae, <span class="rub">ora pro nobis.</span></p><p>Sedes sapientiae, <span class="rub">ora pro nobis.</span></p><p>Rosa mystica, <span class="rub">ora pro nobis.</span></p><p>Turris Davidica, <span class="rub">ora pro nobis.</span></p><p>Ianua caeli, <span class="rub">ora pro nobis.</span></p><p>Stella matutina, <span class="rub">ora pro nobis.</span></p><p>Salus infirmorum, <span class="rub">ora pro nobis.</span></p><p>Refugium peccatorum, <span class="rub">ora pro nobis.</span></p><p>Auxilium christianorum, <span class="rub">ora pro nobis.</span></p><p>Regina Angelorum, <span class="rub">ora pro nobis.</span></p><p>Regina pacis, <span class="rub">ora pro nobis.</span></p>`;
        }

        // Atalhos de teclado
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight') proximo();
            if (e.key === 'ArrowLeft') anterior();
            if (e.key === ' ') toggleTexto();
        });
    </script>
</body>
</html>