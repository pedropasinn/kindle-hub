<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contemplação - Hub Kindle</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="timer.js" defer></script>
    <script src="points-popup.js"></script>
    <style>
        /* --- RESET & VARIÁVEIS --- */
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border-color: #000000;
            --font-main: Helvetica, Arial, sans-serif;
            --radius: 12px;
            --spacing: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            overflow: auto;
            display: flex;
            flex-direction: column;
        }

        /* --- CABEÇALHO GERAL --- */
        header {
            padding: var(--spacing);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid transparent;
        }
        header h1 { font-size: 26px; font-weight: bold; margin: 0; }

        /* --- ESTILOS ESPECÍFICOS DA CONTEMPLAÇÃO --- */
        .contemplacao-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 20px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        /* --- BOTÕES DE MISTÉRIOS (MENORES) --- */
        .misterios-selector {
            display: flex;
            gap: 8px; /* Espaço menor entre botões */
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }

        .misterio-btn {
            padding: 8px 16px; /* Reduzido para caber lado a lado */
            background: #fff;
            border: 2px solid #000;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            font-size: 17px; /* Fonte menor */
            font-family: inherit;
            transition: all 0.2s;
            flex-shrink: 0; /* Evita que amassem demais */
        }

        .misterio-btn:hover { background: #f0f0f0; }
        .misterio-btn.ativo { background: #000; color: #fff; }

        .galeria-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- ÁREA DA IMAGEM (CLICÁVEL) --- */
        .imagem-atual {
            width: 100%;
            max-width: 600px; /* Limite para não ficar gigante no desktop */
            /* Altura dinâmica baseada na proporção, mas com limite */
            min-height: 300px; 
            border: 2px solid #000;
            border-radius: var(--radius);
            box-shadow: 4px 4px 0px #000;
            margin-bottom: 20px;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer; 
            position: relative;
            overflow: hidden;
            user-select: none; 
            -webkit-user-select: none;
            /* Tira o highlight azul do toque no Android/Kindle */
            -webkit-tap-highlight-color: transparent;
        }

        .imagem-atual:active {
            transform: scale(0.99);
            transition: transform 0.1s;
        }

        .imagem-atual img {
            width: 100%;
            height: auto;
            display: block;
            pointer-events: none;
        }

        .sem-imagem {
            padding: 40px;
            color: #666;
            font-size: 16px;
            text-align: center;
        }

        .imagem-info {
            text-align: center;
            margin-bottom: 10px;
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        /* Spinner */
        .loading-spinner {
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #000;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text { color: #666; font-size: 14px; }

        /* Texto da Meditação */
        #textoMisterio {
            width: 100%;
            max-width: 700px;
            margin-top: 10px;
            font-size: 18px; /* Bom para leitura no Kindle */
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <header>
            <div style="display:flex;align-items:center;gap:16px">
                <a href="plano-inclinado.html" style="display:flex;align-items:center;">
                    <img src="/icones/de-volta.png" alt="Voltar" style="width:36px;height:36px;">
                </a>
            </div>
            <h1>Contemplação</h1>
            <div style="width: 52px"></div>
        </header>

        <div class="contemplacao-container">
            <div class="misterios-selector">
                <button class="misterio-btn ativo" onclick="selecionarMisterio('gozosos')">Gozosos</button>
                <button class="misterio-btn" onclick="selecionarMisterio('dolorosos')">Dolorosos</button>
                <button class="misterio-btn" onclick="selecionarMisterio('gloriosos')">Gloriosos</button>
                <button class="misterio-btn" onclick="selecionarMisterio('luminosos')">Luminosos</button>
            </div>

            <div class="galeria-container">
                <div id="imagemInfo" class="imagem-info">—</div>

                <div id="imagemAtual" class="imagem-atual" onclick="navegarPorToque(event)">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div class="loading-text">Carregando...</div>
                    </div>
                </div>

                <div id="textoMisterio"></div>
            </div>
        </div>
    </div>

    <script>
        let misterioAtual = 'gozosos';
        let indiceAtual = 0;
        let imagens = [];
        let imagensPreCarregadas = {};
        let textosCarregados = {}; 
        let preCarregamentoTimeout = null;

        const mapeamentoMisteriosAPI = {
            gozosos: [141, 142, 143, 144, 145],
            dolorosos: [146, 147, 148, 149, 150],
            gloriosos: [151, 152, 153, 154, 155],
            luminosos: [619, 620, 621, 622, 623]
        };

        const misterios = {
            gozosos: { nome: 'Mistérios Gozosos', titulos: ['A Anunciação', 'Visitação', 'Nascimento', 'Apresentação', 'O Menino Perdido'] },
            dolorosos: { nome: 'Mistérios Dolorosos', titulos: ['Agonia no Horto', 'Flagelação', 'Coroação de Espinhos', 'Cruz às Costas', 'Crucificação'] },
            gloriosos: { nome: 'Mistérios Gloriosos', titulos: ['Ressurreição', 'Ascensão', 'Pentecostes', 'Assunção', 'Coroação'] },
            luminosos: { nome: 'Mistérios Luminosos', titulos: ['Batismo', 'Bodas de Caná', 'Anúncio do Reino', 'Transfiguração', 'Eucaristia'] }
        };

        function carregarPreferencias() {
            const m = localStorage.getItem('misterioAtual');
            const i = localStorage.getItem('indiceAtual');
            if (m && misterios[m]) misterioAtual = m;
            if (i !== null) indiceAtual = parseInt(i) || 0;
        }

        function salvarPreferencias() {
            localStorage.setItem('misterioAtual', misterioAtual);
            localStorage.setItem('indiceAtual', indiceAtual);
        }

        function navegarPorToque(event) {
            if (imagens.length === 0) return;
            const larguraTotal = event.currentTarget.offsetWidth;
            const posicaoX = event.offsetX;
            
            // Toque na direita avança, esquerda volta
            if (posicaoX > larguraTotal / 2) {
                proximo();
            } else {
                anterior();
            }
        }

        async function carregarImagens() {
            try {
                const response = await fetch(`/api/imagens/${misterioAtual}`);
                if (response.ok) {
                    imagens = await response.json();
                } else {
                    imagens = [];
                    for (let i = 1; i <= 5; i++) imagens.push(`/cont/${misterioAtual}/${i}.jpg`);
                }
            } catch (error) {
                console.error('Erro:', error);
                imagens = [];
                for (let i = 1; i <= 5; i++) imagens.push(`/cont/${misterioAtual}/${i}.jpg`);
            }
            if (indiceAtual >= imagens.length) indiceAtual = 0;
            exibirImagem();
        }

        function exibirImagem() {
            const container = document.getElementById('imagemAtual');
            const info = document.getElementById('imagemInfo');

            if (imagens.length === 0) {
                container.innerHTML = '<div class="sem-imagem">Nenhuma imagem encontrada.</div>';
                info.textContent = '—';
                return;
            }

            const imagemPath = imagens[indiceAtual];
            const misterio = misterios[misterioAtual];
            const titulo = misterio.titulos[indiceAtual] || `Imagem ${indiceAtual + 1}`;

            info.textContent = `${misterio.nome} - ${titulo} (${indiceAtual + 1}/${imagens.length})`;

            if (imagensPreCarregadas[imagemPath] && imagensPreCarregadas[imagemPath].complete) {
                container.innerHTML = '';
                container.appendChild(imagensPreCarregadas[imagemPath].cloneNode());
            } else {
                container.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><div class="loading-text">Carregando...</div></div>';
                const img = new Image();
                img.onload = function() {
                    container.innerHTML = '';
                    container.appendChild(img);
                    imagensPreCarregadas[imagemPath] = img;
                };
                img.onerror = function() {
                    container.innerHTML = `<div class="sem-imagem">Erro ao carregar</div>`;
                };
                img.src = imagemPath;
            }

            salvarPreferencias();
            exibirTextoMisterio();
            
            clearTimeout(preCarregamentoTimeout);
            preCarregamentoTimeout = setTimeout(preCarregarInteligente, 500);
        }

        function preCarregarInteligente() {
            if (imagens.length === 0) return;
            const proxima = (indiceAtual + 1) % imagens.length;
            carregarNoCache(imagens[proxima]);
            const anterior = (indiceAtual - 1 + imagens.length) % imagens.length;
            carregarNoCache(imagens[anterior]);
        }

        function carregarNoCache(src) {
            if (!imagensPreCarregadas[src]) {
                const img = new Image();
                img.src = src;
                imagensPreCarregadas[src] = img;
            }
        }

        async function carregarTextoMisterio(tipo, indice) {
            const chave = `${tipo}-${indice}`;
            if (textosCarregados[chave]) return textosCarregados[chave];

            try {
                const misterioId = mapeamentoMisteriosAPI[tipo][indice];
                const response = await fetch(`https://escriva.org/api/v1/mysteries/${misterioId}/`);
                if (!response.ok) throw new Error('Erro na API');
                const data = await response.json();
                textosCarregados[chave] = data.text || 'Texto não disponível';
                return textosCarregados[chave];
            } catch (error) {
                return `(Texto offline ou erro de conexão)`;
            }
        }

        async function exibirTextoMisterio() {
            const containerTexto = document.getElementById('textoMisterio');
            if (!containerTexto) return;
            containerTexto.innerHTML = '<div style="color:#999;text-align:center;font-size:14px;">Carregando meditação...</div>';
            const texto = await carregarTextoMisterio(misterioAtual, indiceAtual);
            containerTexto.innerHTML = `<div style="padding:15px;background:#f9f9f9;border:2px solid #ddd;border-radius:8px;text-align:justify;">${texto}</div>`;
        }

        function selecionarMisterio(tipo) {
            misterioAtual = tipo;
            indiceAtual = 0;
            document.querySelectorAll('.misterio-btn').forEach(btn => btn.classList.remove('ativo'));
            event.target.classList.add('ativo');
            carregarImagens();
        }

        function anterior() {
            if (imagens.length === 0) return;
            indiceAtual--;
            if (indiceAtual < 0) indiceAtual = imagens.length - 1;
            exibirImagem();
        }

        function proximo() {
            if (imagens.length === 0) return;
            indiceAtual++;
            if (indiceAtual >= imagens.length) indiceAtual = 0;
            exibirImagem();
        }

        // Atalhos de teclado (Setas)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft') anterior();
            else if (e.key === 'ArrowRight') proximo();
        });

        // Inicialização
        carregarPreferencias();
        document.querySelectorAll('.misterio-btn').forEach(btn => {
            btn.classList.remove('ativo');
            if(btn.getAttribute('onclick').includes(misterioAtual)) {
                btn.classList.add('ativo');
            }
        });
        carregarImagens();
    </script>
</body>
</html>