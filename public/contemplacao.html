<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contemplação - Hub Kindle</title>
    <link rel="stylesheet" href="style.css">
    <!-- Phosphor Icons: Biblioteca de ícones leve e nítida -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="timer.js" defer></script>
    <script src="points-popup.js"></script>
    <style>
        /* --- RESET & VARIÁVEIS --- */
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border-color: #000000;
            --font-main: Helvetica, Arial, sans-serif;
            --radius: 12px;
            --spacing: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            overflow: auto;
            display: flex;
            flex-direction: column;
        }

        /* --- CABEÇALHO GERAL --- */
        header {
            padding: var(--spacing);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid transparent;
        }
        header h1 { font-size: 30px; font-weight: bold; }

        /* --- ESTILOS ESPECÍFICOS DA CONTEMPLAÇÃO --- */
        .contemplacao-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        .misterios-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .misterio-btn {
            padding: 12px 24px;
            background: #fff;
            border: 2px solid #000;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .misterio-btn:hover {
            background: #f0f0f0;
        }

        .misterio-btn.ativo {
            background: #000;
            color: #fff;
        }

        .galeria-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .imagem-atual {
            max-width: 100%;
            max-height: 500px;
            border: 2px solid #000;
            border-radius: var(--radius);
            box-shadow: 4px 4px 0px #000;
            margin-bottom: 20px;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .imagem-atual img {
            max-width: 100%;
            max-height: 500px;
            display: block;
        }

        .sem-imagem {
            padding: 60px;
            color: #666;
            font-size: 18px;
            text-align: center;
        }

        .imagem-info {
            text-align: center;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: bold;
        }

        .navegacao {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .nav-btn {
            padding: 15px 40px;
            background: #fff;
            border: 2px solid #000;
            border-radius: 50px;
            font-weight: bold;
            font-size: 24px;
            cursor: pointer;
            min-width: 80px;
            font-family: inherit;
        }

        .nav-btn:hover {
            background: #f0f0f0;
        }

        .nav-btn:active {
            background: #e0e0e0;
        }

        /* Spinner de carregamento */
        .loading-spinner {
            padding: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #000;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #666;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <header>
            <div style="display:flex;align-items:center;gap:16px">
                <a href="plano-inclinado.html" style="display:flex;align-items:center;">
                    <img src="/icones/de-volta.png" alt="Anotações" style="width:40px;height:40px;">
                </a>
            </div>
            <h1>Contemplação</h1>
            <div style="width: 70px"></div> <!-- Espaçador visual -->
        </header>

        <div class="contemplacao-container">
            <div class="misterios-selector">
                <button class="misterio-btn ativo" onclick="selecionarMisterio('gozosos')">Gozosos</button>
                <button class="misterio-btn" onclick="selecionarMisterio('dolorosos')">Dolorosos</button>
                <button class="misterio-btn" onclick="selecionarMisterio('gloriosos')">Gloriosos</button>
                <button class="misterio-btn" onclick="selecionarMisterio('luminosos')">Luminosos</button>
            </div>

            <div class="galeria-container">
                <div id="imagemInfo" class="imagem-info">—</div>

                <div id="imagemAtual" class="imagem-atual">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div class="loading-text">Carregando imagens...</div>
                    </div>
                </div>

                <div class="navegacao">
                    <button class="nav-btn" onclick="anterior()">◄</button>
                    <button class="nav-btn" onclick="proximo()">►</button>
                </div>

                <!-- Container para o texto da meditação -->
                <div id="textoMisterio" style="width: 100%; max-width: 700px; margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <script>
        let misterioAtual = 'gozosos';
        let indiceAtual = 0;
        let imagens = [];
        let imagensPreCarregadas = {}; // Cache de imagens pré-carregadas
        let imagensCarregando = new Set(); // Controle de imagens em carregamento
        let textosCarregados = {}; // Cache para textos das meditações

        // Mapeamento dos mistérios para IDs da API do Escriba.org
        const mapeamentoMisteriosAPI = {
            gozosos: [141, 142, 143, 144, 145],      // IDs 141-145
            dolorosos: [146, 147, 148, 149, 150],    // IDs 146-150
            gloriosos: [151, 152, 153, 154, 155],    // IDs 151-155
            luminosos: [619, 620, 621, 622, 623]     // IDs 619-623
        };

        const misterios = {
            gozosos: {
                nome: 'Mistérios Gozosos',
                titulos: [
                    'A Anunciação',
                    'Visitação de Nossa Senhora',
                    'Nascimento de Jesus',
                    'Purificação de Nossa Senhora',
                    'O Menino Perdido'
                ]
            },
            dolorosos: {
                nome: 'Mistérios Dolorosos',
                titulos: [
                    'Oração no Horto',
                    'Flagelação de Senhor',
                    'Coroação de Espinhos',
                    'A Cruz às Costas',
                    'Morte de Jesus'
                ]
            },
            gloriosos: {
                nome: 'Mistérios Gloriosos',
                titulos: [
                    'Ressurreição de Senhor',
                    'Ascensão do Senhor',
                    'Pentecostes',
                    'Assunção de Nossa Senhora',
                    'Coroação de Nossa Senhora'
                ]
            },
            luminosos: {
                nome: 'Mistérios Luminosos',
                titulos: [
                    'Batismo do Senhor',
                    'As Bodas de Caná',
                    'O Anúncio do Reino',
                    'A Transfiguração',
                    'A Instituição da Eucaristia'
                ]
            }
        };

        function carregarPreferencias() {
            const misterioSalvo = localStorage.getItem('misterioAtual');
            const indiceSalvo = localStorage.getItem('indiceAtual');

            if (misterioSalvo && misterios[misterioSalvo]) {
                misterioAtual = misterioSalvo;
            }

            if (indiceSalvo !== null) {
                indiceAtual = parseInt(indiceSalvo) || 0;
            }
        }

        function salvarPreferencias() {
            localStorage.setItem('misterioAtual', misterioAtual);
            localStorage.setItem('indiceAtual', indiceAtual);
        }

        async function carregarImagens() {
            try {
                // Tentar carregar imagens da pasta /cont/{misterioAtual}/
                const response = await fetch(`/api/imagens/${misterioAtual}`);
                if (response.ok) {
                    imagens = await response.json();
                } else {
                    // Se não houver endpoint, usar lista padrão de 5 imagens
                    imagens = [];
                    for (let i = 1; i <= 5; i++) {
                        imagens.push(`/cont/${misterioAtual}/${i}.jpg`);
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar imagens:', error);
                // Fallback: assumir 5 imagens numeradas
                imagens = [];
                for (let i = 1; i <= 5; i++) {
                    imagens.push(`/cont/${misterioAtual}/${i}.jpg`);
                }
            }

            // Garantir que o índice está dentro dos limites
            if (indiceAtual >= imagens.length) {
                indiceAtual = 0;
            }

            exibirImagem();
            preCarregarTodasImagens(); // Pré-carregar todas as imagens do mistério atual
        }

        // Função para pré-carregar todas as imagens do mistério atual
        function preCarregarTodasImagens() {
            imagens.forEach((imagemPath, index) => {
                preCarregarImagem(imagemPath);
            });
        }

        // Função para pré-carregar uma imagem específica
        function preCarregarImagem(imagemPath) {
            // Se já está carregada ou em carregamento, ignorar
            if (imagensPreCarregadas[imagemPath] || imagensCarregando.has(imagemPath)) {
                return;
            }

            imagensCarregando.add(imagemPath);

            const img = new Image();
            img.onload = function() {
                imagensPreCarregadas[imagemPath] = img;
                imagensCarregando.delete(imagemPath);
                console.log('Imagem pré-carregada:', imagemPath);
            };
            img.onerror = function() {
                imagensCarregando.delete(imagemPath);
                console.error('Erro ao pré-carregar:', imagemPath);
            };
            img.src = imagemPath;
        }

        // Função para pré-carregar imagens adjacentes (anterior e próxima)
        function preCarregarAdjacentes() {
            if (imagens.length === 0) return;

            // Pré-carregar próxima imagem
            const proximoIndice = (indiceAtual + 1) % imagens.length;
            preCarregarImagem(imagens[proximoIndice]);

            // Pré-carregar imagem anterior
            const anteriorIndice = (indiceAtual - 1 + imagens.length) % imagens.length;
            preCarregarImagem(imagens[anteriorIndice]);
        }

        // Função para carregar texto da meditação da API do Escriba.org
        async function carregarTextoMisterio(tipo, indice) {
            const chave = `${tipo}-${indice}`;

            // Se já está em cache, retornar
            if (textosCarregados[chave]) {
                return textosCarregados[chave];
            }

            try {
                // Obter o ID do mistério diretamente do mapeamento
                const misterioId = mapeamentoMisteriosAPI[tipo][indice];

                // Buscar o mistério específico pelo ID
                const response = await fetch(`https://escriva.org/api/v1/mysteries/${misterioId}/`);

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const data = await response.json();

                // Armazenar em cache
                textosCarregados[chave] = data.text || 'Texto não disponível';
                return textosCarregados[chave];

            } catch (error) {
                console.error('Erro ao carregar texto do mistério:', error);
                return `Erro ao carregar texto: ${error.message}`;
            }
        }

        // Função para exibir o texto da meditação
        async function exibirTextoMisterio() {
            const containerTexto = document.getElementById('textoMisterio');
            if (!containerTexto) return;

            containerTexto.innerHTML = '<div style="color: #666; font-style: italic; padding: 15px;">Carregando meditação...</div>';

            const texto = await carregarTextoMisterio(misterioAtual, indiceAtual);
            containerTexto.innerHTML = `<div style="padding: 15px; background: #f9f9f9; border: 2px solid #ddd; border-radius: 8px; line-height: 1.6; text-align: justify;">${texto}</div>`;
        }

        function exibirImagem() {
            const container = document.getElementById('imagemAtual');
            const info = document.getElementById('imagemInfo');

            if (imagens.length === 0) {
                container.innerHTML = '<div class="sem-imagem">Nenhuma imagem encontrada para este mistério.<br>Adicione imagens na pasta /cont/' + misterioAtual + '/</div>';
                info.textContent = '—';
                return;
            }

            const imagemPath = imagens[indiceAtual];
            const numero = indiceAtual + 1;
            const total = imagens.length;
            const misterio = misterios[misterioAtual];
            const titulo = misterio.titulos[indiceAtual] || `Imagem ${numero}`;

            info.textContent = `${misterio.nome} - ${titulo} (${numero}/${total})`;

            // Verificar se a imagem já foi pré-carregada
            if (imagensPreCarregadas[imagemPath]) {
                // Usar imagem do cache - exibição instantânea!
                container.innerHTML = '';
                const imgClone = imagensPreCarregadas[imagemPath].cloneNode();
                container.appendChild(imgClone);
                preCarregarAdjacentes(); // Pré-carregar adjacentes para navegação suave
            } else {
                // Mostrar loading e carregar imagem
                container.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><div class="loading-text">Carregando...</div></div>';

                const img = new Image();
                img.onload = function() {
                    container.innerHTML = '';
                    container.appendChild(img);
                    imagensPreCarregadas[imagemPath] = img; // Adicionar ao cache
                    preCarregarAdjacentes(); // Pré-carregar adjacentes
                };
                img.onerror = function() {
                    container.innerHTML = `<div class="sem-imagem">Imagem não encontrada:<br>${imagemPath}</div>`;
                };
                img.src = imagemPath;
            }

            salvarPreferencias();

            // Carregar e exibir o texto da meditação
            exibirTextoMisterio();
        }

        function selecionarMisterio(tipo) {
            misterioAtual = tipo;
            indiceAtual = 0;

            // Atualizar botões ativos
            document.querySelectorAll('.misterio-btn').forEach(btn => {
                btn.classList.remove('ativo');
            });
            event.target.classList.add('ativo');

            carregarImagens();
        }

        function anterior() {
            if (imagens.length === 0) return;

            indiceAtual--;
            if (indiceAtual < 0) {
                indiceAtual = imagens.length - 1;
            }
            exibirImagem();
        }

        function proximo() {
            if (imagens.length === 0) return;

            indiceAtual++;
            if (indiceAtual >= imagens.length) {
                indiceAtual = 0;
            }
            exibirImagem();
        }

        // Suporte para teclas de seta
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft') {
                anterior();
            } else if (e.key === 'ArrowRight') {
                proximo();
            }
        });

        // Inicializar
        carregarPreferencias();
        carregarImagens();

        // Atualizar botão ativo baseado na preferência salva
        document.querySelectorAll('.misterio-btn').forEach(btn => {
            btn.classList.remove('ativo');
        });
        document.querySelector(`[onclick="selecionarMisterio('${misterioAtual}')"]`).classList.add('ativo');
    </script>
</body>
</html>
