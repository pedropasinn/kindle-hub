<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>São Josemaría Escrivá - Hub Kindle</title>
    <link rel="stylesheet" href="style.css">
    <script src="timer.js"></script>
    <style>
        /* --- RESET & VARIÁVEIS --- */
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border-color: #000000;
            --font-main: Helvetica, Arial, sans-serif;
            --radius: 12px;
            --spacing: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            overflow: auto;
        }

        /* Container principal */
        .content-container {
            margin: 8px var(--spacing);
            padding: 20px;
            border: 2px solid #000;
            background: #fff;
            border-radius: var(--radius);
            box-shadow: 4px 4px 0px #000;
        }

        .content-container h2 {
            font-size: 22px;
            margin-bottom: 15px;
            border-bottom: 2px solid #000;
            padding-bottom: 8px;
        }

        /* Seleção de livro */
        .book-selector {
            display: flex;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .book-btn {
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .book-btn:last-child {
            margin-right: 0;
        }

        .book-btn {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid #000;
            background: #fff;
            border-radius: 50px;
            transition: all 0.2s;
            font-family: inherit;
        }

        .book-btn:hover {
            background: #f0f0f0;
        }

        .book-btn.active {
            background: #000;
            color: #fff;
        }

        /* Barra de busca */
        .search-container {
            margin-bottom: 20px;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #000;
            border-radius: 8px;
            font-family: inherit;
        }

        /* Navegação de capítulos e pontos */
        .navigation {
            display: flex;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .select-group {
            margin-right: 15px;
            margin-bottom: 15px;
        }
        .select-group:last-child {
            margin-right: 0;
        }

        .select-group {
            flex: 1;
            min-width: 200px;
        }

        .select-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .select-group select {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 2px solid #000;
            border-radius: 8px;
            font-family: inherit;
            background: #fff;
            cursor: pointer;
        }

        /* Navegação anterior/próximo */
        .nav-controls {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .nav-btn + .nav-btn {
            margin-left: 10px;
        }

        .nav-btn {
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid #000;
            background: #fff;
            border-radius: 50px;
            transition: all 0.2s;
            font-family: inherit;
        }

        .nav-btn:hover:not(:disabled) {
            background: #000;
            color: #fff;
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Conteúdo do ponto */
        .point-content {
            padding: 20px;
            border: 2px solid #000;
            border-radius: var(--radius);
            background: #f9f9f9;
            margin-bottom: 20px;
        }

        .point-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #000;
        }

        .point-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .point-chapter {
            font-size: 16px;
            color: #666;
        }

        .point-text {
            font-size: 18px;
            line-height: 1.8;
            margin-bottom: 15px;
        }

        .point-text p {
            margin-bottom: 12px;
        }

        .point-link {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 16px;
            font-size: 14px;
            text-decoration: none;
            color: #000;
            border: 2px solid #000;
            border-radius: 20px;
            transition: all 0.2s;
        }

        .point-link:hover {
            background: #000;
            color: #fff;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
        }

        /* Resultados de busca */
        .search-results {
            max-height: 400px;
            overflow-y: auto;
        }

        .search-result-item {
            padding: 15px;
            border: 2px solid #000;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            background: #fff;
        }

        .search-result-item:hover {
            background: #f0f0f0;
            transform: translateX(5px);
        }

        .result-book {
            font-weight: bold;
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .result-text {
            font-size: 16px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <header style="padding: var(--spacing); border-bottom: 1px solid #ccc;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div style="display:flex;align-items:center;">
                <a href="dashboard.html" style="display:flex;align-items:center;margin-right:16px;">
                    <img src="/icones/casa.png" alt="Home" style="width:40px;height:40px;">
                </a>
                <a href="plano-inclinado.html" style="display:flex;align-items:center;">
                    <img src="/icones/de-volta.png" alt="Voltar" style="width:40px;height:40px;">
                </a>
            </div>
            <h1 style="font-size: 30px; font-weight: bold;">São Josemaría</h1>
            <div style="width: 70px"></div>
        </div>
    </header>

    <div class="content-container">
        <!-- Seleção de livro -->
        <div class="book-selector">
            <button class="book-btn active" data-book="camino" onclick="selectBook('camino')">Caminho</button>
            <button class="book-btn" data-book="surco" onclick="selectBook('surco')">Sulco</button>
            <button class="book-btn" data-book="forja" onclick="selectBook('forja')">Forja</button>
        </div>

        <!-- Barra de busca -->
        <div class="search-container">
            <input type="text"
                   class="search-box"
                   id="searchBox"
                   placeholder="Buscar por palavra-chave no conteúdo..."
                   onkeyup="handleSearch(event)">
        </div>

        <!-- Resultados de busca -->
        <div id="searchResults" style="display: none;">
            <h3 style="margin-bottom: 15px;">Resultados da busca:</h3>
            <div class="search-results" id="searchResultsList"></div>
        </div>

        <!-- Navegação por capítulos e pontos -->
        <div id="normalNavigation">
            <div class="navigation">
                <div class="select-group">
                    <label for="chapterSelect">Capítulo:</label>
                    <select id="chapterSelect" onchange="loadPointsForChapter()">
                        <option value="">Carregando...</option>
                    </select>
                </div>
                <div class="select-group">
                    <label for="pointSelect">Ponto:</label>
                    <select id="pointSelect" onchange="loadPointContent()">
                        <option value="">Selecione um capítulo primeiro</option>
                    </select>
                </div>
            </div>

            <!-- Controles de navegação -->
            <div class="nav-controls">
                <button class="nav-btn" id="prevBtn" onclick="navigatePoint(-1)" disabled>← Anterior</button>
                <button class="nav-btn" id="nextBtn" onclick="navigatePoint(1)" disabled>Próximo →</button>
            </div>
        </div>

        <!-- Conteúdo do ponto -->
        <div id="pointContainer">
            <div class="empty-state">Selecione um livro, capítulo e ponto para começar</div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://escriva.org/api/v1';
        const SITE_ID = 6; // Portuguese (Brazil)

        let currentBook = 'Caminho';
        let allChapters = [];
        let currentChapterPoints = [];
        let currentPointIndex = -1;
        let searchTimeout = null;

        // Carregar JSON de capítulos
        async function loadChaptersData() {
            try {
                const response = await fetch('/escriva/chapters.json');
                allChapters = await response.json();
            } catch (error) {
                console.error('Erro ao carregar chapters.json:', error);
            }
        }

        // Carregar capítulos do livro selecionado
        function loadChapters() {
            const select = document.getElementById('chapterSelect');
            select.innerHTML = '<option value="">Selecione um capítulo</option>';

            const bookChapters = allChapters.filter(c => c.book === currentBook);

            bookChapters.forEach(chapter => {
                const option = document.createElement('option');
                option.value = chapter.id;
                option.textContent = chapter.name;
                select.appendChild(option);
            });

            // Limpar pontos
            document.getElementById('pointSelect').innerHTML = '<option value="">Selecione um capítulo primeiro</option>';
        }

        function getCurrentBookName() {
            const bookNames = {
                'Caminho': 'caminho',
                'Sulco': 'sulco',
                'Forja': 'forja'
            };
            return bookNames[currentBook];
        }

        async function loadPointsForChapter() {
            const chapterId = document.getElementById('chapterSelect').value;
            const pointSelect = document.getElementById('pointSelect');

            if (!chapterId) {
                pointSelect.innerHTML = '<option value="">Selecione um capítulo primeiro</option>';
                return;
            }

            pointSelect.innerHTML = '<option value="">Carregando pontos...</option>';

            try {
                // Buscar pontos do capítulo pela API usando chapter_id
                const response = await fetch(`${API_BASE}/points/?chapter_id=${chapterId}&subject_subtree=6`);
                const data = await response.json();

                currentChapterPoints = data.results || [];
                currentChapterPoints.sort((a, b) => a.number - b.number);

                pointSelect.innerHTML = '<option value="">Selecione um ponto</option>';
                currentChapterPoints.forEach((point, index) => {
                    const option = document.createElement('option');
                    option.value = index; // Usar índice local
                    option.textContent = point.label;
                    pointSelect.appendChild(option);
                });

            } catch (error) {
                console.error('Erro ao carregar pontos do capítulo:', error);
                pointSelect.innerHTML = '<option value="">Erro ao carregar pontos</option>';
            }
        }

        function loadPointContent() {
            const pointIndex = parseInt(document.getElementById('pointSelect').value);

            if (isNaN(pointIndex) || !currentChapterPoints[pointIndex]) return;

            const point = currentChapterPoints[pointIndex];
            displayPoint(point);

            // Atualizar índice para navegação dentro do capítulo
            currentPointIndex = pointIndex;
            updateNavigationButtons();
        }

        function displayPoint(point) {
            const container = document.getElementById('pointContainer');

            container.innerHTML = `
                <div class="point-content">
                    <div class="point-header">
                        <div class="point-title">${point.book.name} - Ponto ${point.number}</div>
                        <div class="point-chapter">${point.chapter.name}</div>
                    </div>
                    <div class="point-text">
                        ${point.text}
                    </div>
                    <a href="${point.public_url}" target="_blank" class="point-link">Ver no site oficial →</a>
                </div>
            `;
        }

        function navigatePoint(direction) {
            currentPointIndex += direction;

            if (currentPointIndex < 0 || currentPointIndex >= currentChapterPoints.length) {
                currentPointIndex -= direction;
                return;
            }

            const point = currentChapterPoints[currentPointIndex];
            displayPoint(point);

            // Atualizar select de pontos
            document.getElementById('pointSelect').value = currentPointIndex;

            updateNavigationButtons();
        }

        function updateNavigationButtons() {
            document.getElementById('prevBtn').disabled = currentPointIndex <= 0;
            document.getElementById('nextBtn').disabled = currentPointIndex >= currentChapterPoints.length - 1;
        }

        function selectBook(book) {
            currentBook = book;

            // Atualizar botões
            document.querySelectorAll('.book-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const bookMap = {
                'camino': 'Caminho',
                'surco': 'Sulco',
                'forja': 'Forja'
            };
            document.querySelector(`[data-book="${book}"]`).classList.add('active');
            currentBook = bookMap[book];

            // Limpar seleções
            document.getElementById('chapterSelect').innerHTML = '<option value="">Carregando...</option>';
            document.getElementById('pointSelect').innerHTML = '<option value="">Selecione um capítulo primeiro</option>';
            document.getElementById('searchBox').value = '';
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('normalNavigation').style.display = 'block';
            document.getElementById('pointContainer').innerHTML = '<div class="empty-state">Selecione um capítulo e ponto para começar</div>';

            // Carregar capítulos
            loadChapters();
            currentChapterPoints = [];
        }

        function handleSearch(event) {
            const query = event.target.value.trim().toLowerCase();

            clearTimeout(searchTimeout);

            if (query.length < 3) {
                document.getElementById('searchResults').style.display = 'none';
                document.getElementById('normalNavigation').style.display = 'block';
                return;
            }

            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 500);
        }

        async function performSearch(query) {
            try {
                // Buscar todos os pontos do livro selecionado
                const bookChapters = allChapters.filter(c => c.book === currentBook);
                let allBookPoints = [];

                // Carregar pontos de todos os capítulos (limitado a primeiros 5 capítulos por performance)
                for (const chapter of bookChapters.slice(0, 10)) {
                    const response = await fetch(`${API_BASE}/points/?chapter_id=${chapter.id}&subject_subtree=6`);
                    const data = await response.json();
                    allBookPoints = allBookPoints.concat(data.results || []);
                }

                // Filtrar resultados
                const results = allBookPoints.filter(point => {
                    const text = point.text.toLowerCase();
                    const chapterName = point.chapter.name.toLowerCase();
                    return text.includes(query) || chapterName.includes(query);
                });

                displaySearchResults(results);
            } catch (error) {
                console.error('Erro na busca:', error);
            }
        }

        function displaySearchResults(results) {
            const container = document.getElementById('searchResultsList');
            const searchResultsDiv = document.getElementById('searchResults');
            const normalNav = document.getElementById('normalNavigation');

            if (results.length === 0) {
                container.innerHTML = '<div class="empty-state">Nenhum resultado encontrado</div>';
                searchResultsDiv.style.display = 'block';
                normalNav.style.display = 'none';
                return;
            }

            container.innerHTML = results.slice(0, 20).map(point => {
                const textPreview = point.text.replace(/<[^>]*>/g, '').substring(0, 200) + '...';
                return `
                    <div class="search-result-item" onclick="selectSearchResult(${point.id})">
                        <div class="result-book">${point.book.name} - Ponto ${point.number} (${point.chapter.name})</div>
                        <div class="result-text">${textPreview}</div>
                    </div>
                `;
            }).join('');

            searchResultsDiv.style.display = 'block';
            normalNav.style.display = 'none';
        }

        async function selectSearchResult(pointId) {
            // Limpar busca
            document.getElementById('searchBox').value = '';
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('normalNavigation').style.display = 'block';

            // Buscar o ponto específico pela API
            try {
                const response = await fetch(`${API_BASE}/points/${pointId}/`);
                const point = await response.json();

                // Exibir ponto
                displayPoint(point);

                // Carregar capítulo correspondente
                const chapter = allChapters.find(c => c.id === point.chapter.id);
                if (chapter) {
                    document.getElementById('chapterSelect').value = chapter.id;
                    await loadPointsForChapter();

                    // Encontrar índice do ponto no capítulo
                    const pointIndex = currentChapterPoints.findIndex(p => p.id === pointId);
                    if (pointIndex >= 0) {
                        document.getElementById('pointSelect').value = pointIndex;
                        currentPointIndex = pointIndex;
                        updateNavigationButtons();
                    }
                }

                // Scroll para o topo
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error('Erro ao carregar ponto:', error);
            }
        }

        // Inicializar
        async function init() {
            await loadChaptersData();
            loadChapters();
        }

        init();
    </script>
</body>
</html>
