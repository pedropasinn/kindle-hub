<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>São Josemaría Escrivá - Hub Kindle</title>
    <style>
        /* --- RESET & VARIÁVEIS --- */
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border-color: #000000;
            --font-main: Helvetica, Arial, sans-serif;
            --radius: 12px;
            --spacing: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            overflow: auto;
        }

        /* Container principal */
        .content-container {
            margin: 8px var(--spacing);
            padding: 20px;
            border: 2px solid #000;
            background: #f9f9f9;
            border-radius: var(--radius);
            box-shadow: 4px 4px 0px #000;
        }

        /* Seleção de livro */
        .book-selector {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .book-btn {
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .book-btn:last-child {
            margin-right: 0;
        }

        .book-btn {
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid #000;
            background: #fff;
            border-radius: 50px;
            transition: all 0.2s;
            font-family: inherit;
        }

        .book-btn:hover {
            background: #f0f0f0;
        }

        .book-btn.active {
            background: #000;
            color: #fff;
        }

        /* Navegação de capítulos e pontos (Dropdowns) */
        .navigation {
            display: flex;
            flex-wrap: wrap;
            /* gap: 15px; -> Removido */
        }

        /* Seleciona todos os filhos diretos de .navigation */
        .navigation > * {
            margin-right: 15px;
            
            /* Opcional: Se os itens quebrarem de linha (wrap), 
            você provavelmente vai querer espaço vertical também: */
            margin-bottom: 15px; 
        }

        /* Remove a margem direita do último item */
        .navigation > *:last-child {
            margin-right: 0;
        }
        
        .select-group {
            flex: 1;
            min-width: 150px;
        }

        .select-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
            color: #555;
        }

        .select-group select {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 2px solid #000;
            border-radius: 8px;
            font-family: inherit;
            background: #fff;
            cursor: pointer;
        }

        /* Navegação anterior/próximo */
        .nav-controls {
            display: flex;
            justify-content: space-between;
        }
        
        .nav-btn {
            padding: 10px 20px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid #000;
            background: #fff;
            border-radius: 50px;
            transition: all 0.2s;
            font-family: inherit;
            min-width: 100px;
        }

        .nav-btn:hover:not(:disabled) {
            background: #000;
            color: #fff;
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            border-color: #ccc;
            color: #999;
        }

        /* Conteúdo do ponto */
        .point-content {
            padding: 12px;
            min-height: 200px; /* Evita pulo de layout */
        }

        .point-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ccc;
        }

        .point-title {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .point-chapter {
            font-size: 14px;
            color: #666;
            letter-spacing: 1px;
        }

        .point-text {
            font-size: 20px; /* Leitura confortável */
            line-height: 1.6;
            margin-bottom: 20px;
            text-align: justify;
        }

        .point-text p {
            margin-bottom: 12px;
        }

        .point-link {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 16px;
            font-size: 13px;
            text-decoration: none;
            color: #666;
            border: 1px solid #ccc;
            border-radius: 20px;
            transition: all 0.2s;
        }

        .point-link:hover {
            border-color: #000;
            color: #000;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <header style="padding: var(--spacing); border-bottom: 1px solid #ccc;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div style="display:flex;align-items:center;">
                <a href="dashboard.html" style="display:flex;align-items:center;margin-right:16px;">
                    <img src="/icones/casa.png" alt="Home" style="width:40px;height:40px;">
                </a>
                <a href="plano-inclinado.html" style="display:flex;align-items:center;">
                    <img src="/icones/de-volta.png" alt="Voltar" style="width:40px;height:40px;">
                </a>
            </div>
            <h1 style="font-size: 30px; font-weight: bold;">São Josemaría</h1>
            <div style="width: 70px;"></div>
        </div>
        <div class="book-selector">
            <button class="book-btn active" data-book="camino" onclick="selectBook('camino')">Caminho</button>
            <button class="book-btn" data-book="surco" onclick="selectBook('surco')">Sulco</button>
            <button class="book-btn" data-book="forja" onclick="selectBook('forja')">Forja</button>
        </div>
        <div class="navigation">
        <div class="select-group">
             <label for="chapterSelect">Capítulo:</label>
                <select id="chapterSelect" onchange="loadPointsForChapter()">
                    <option value="">Carregando...</option>
                </select>
        </div>
            <div class="select-group">
                <label for="pointSelect">Ponto:</label>
                <select id="pointSelect" onchange="loadPointContent()">
                    <option value="">Selecione um capítulo</option>
                </select>
                </div>
            </div>
        </div>
    </header>

    <div class="content-container">

        <div id="mainContent">
            
            <div class="nav-controls">
                <button class="nav-btn" id="prevBtn" onclick="navigatePoint(-1)" disabled>← Anterior</button>
                <button class="nav-btn" id="nextBtn" onclick="navigatePoint(1)" disabled>Próximo →</button>
            </div>

            <div id="pointContainer">
                <div class="empty-state">Selecione um capítulo e ponto acima para começar a leitura.</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://escriva.org/api/v1';
        
        let currentBook = 'Caminho';
        let allChapters = [];
        let currentChapterPoints = [];
        let currentPointIndex = -1;

        // Carregar JSON de capítulos (local ou remoto)
        async function loadChaptersData() {
            try {
                // Tenta carregar localmente primeiro, ajuste o caminho conforme sua estrutura
                const response = await fetch('/escriva/chapters.json');
                allChapters = await response.json();
            } catch (error) {
                console.error('Erro ao carregar chapters.json:', error);
                // Fallback ou alerta de erro aqui se necessário
            }
        }

        // Carregar capítulos do livro selecionado no Select
        function loadChapters() {
            const select = document.getElementById('chapterSelect');
            select.innerHTML = '<option value="">Selecione um capítulo</option>';

            const bookChapters = allChapters.filter(c => c.book === currentBook);

            bookChapters.forEach(chapter => {
                const option = document.createElement('option');
                option.value = chapter.id;
                option.textContent = chapter.name;
                select.appendChild(option);
            });

            // Resetar select de pontos
            document.getElementById('pointSelect').innerHTML = '<option value="">← Selecione cap.</option>';
        }

        async function loadPointsForChapter() {
            const chapterId = document.getElementById('chapterSelect').value;
            const pointSelect = document.getElementById('pointSelect');

            if (!chapterId) {
                pointSelect.innerHTML = '<option value="">← Selecione cap.</option>';
                return;
            }

            pointSelect.innerHTML = '<option value="">Carregando...</option>';

            try {
                const response = await fetch(`${API_BASE}/points/?chapter_id=${chapterId}&subject_subtree=6`);
                const data = await response.json();

                currentChapterPoints = data.results || [];
                currentChapterPoints.sort((a, b) => a.number - b.number);

                pointSelect.innerHTML = '<option value="">Selecione um ponto</option>';
                currentChapterPoints.forEach((point, index) => {
                    const option = document.createElement('option');
                    option.value = index; // Usamos o índice do array para facilitar navegação
                    option.textContent = point.label;
                    pointSelect.appendChild(option);
                });

            } catch (error) {
                console.error('Erro ao carregar pontos:', error);
                pointSelect.innerHTML = '<option value="">Erro na conexão</option>';
            }
        }

        function loadPointContent() {
            const pointIndex = parseInt(document.getElementById('pointSelect').value);

            if (isNaN(pointIndex) || !currentChapterPoints[pointIndex]) return;

            const point = currentChapterPoints[pointIndex];
            displayPoint(point);

            currentPointIndex = pointIndex;
            updateNavigationButtons();
        }

        function displayPoint(point) {
            const container = document.getElementById('pointContainer');

            container.innerHTML = `
                <div class="point-content">
                    <div class="point-header">
                        <div class="point-title">${point.book.name} - Ponto ${point.number}</div>
                        <div class="point-chapter">${point.chapter.name}</div>
                    </div>
                    <div class="point-text">
                        ${point.text}
                    </div>
                    <a href="${point.public_url}" target="_blank" class="point-link">Ver no escriva.org →</a>
                </div>
            `;
        }

        function navigatePoint(direction) {
            currentPointIndex += direction;

            // Verificação de limites
            if (currentPointIndex < 0 || currentPointIndex >= currentChapterPoints.length) {
                currentPointIndex -= direction; // Desfaz mudança
                return;
            }

            const point = currentChapterPoints[currentPointIndex];
            displayPoint(point);

            // Sincronizar o dropdown com a navegação pelos botões
            document.getElementById('pointSelect').value = currentPointIndex;

            updateNavigationButtons();
        }

        function updateNavigationButtons() {
            document.getElementById('prevBtn').disabled = currentPointIndex <= 0;
            document.getElementById('nextBtn').disabled = currentPointIndex >= currentChapterPoints.length - 1;
        }

        function selectBook(book) {
            // Mapeamento código -> Nome no JSON
            const bookMap = {
                'camino': 'Caminho',
                'surco': 'Sulco',
                'forja': 'Forja'
            };
            
            currentBook = bookMap[book];

            // Atualizar visual dos botões
            document.querySelectorAll('.book-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-book="${book}"]`).classList.add('active');

            // Resetar interface
            document.getElementById('chapterSelect').innerHTML = '<option value="">Carregando...</option>';
            document.getElementById('pointSelect').innerHTML = '<option value="">← Selecione cap.</option>';
            document.getElementById('pointContainer').innerHTML = '<div class="empty-state">Selecione um capítulo e ponto acima para começar.</div>';
            document.getElementById('prevBtn').disabled = true;
            document.getElementById('nextBtn').disabled = true;

            // Recarregar lógica
            loadChapters();
            currentChapterPoints = [];
        }

        // Inicialização
        async function init() {
            await loadChaptersData();
            loadChapters();
        }

        init();
    </script>
</body>
</html>