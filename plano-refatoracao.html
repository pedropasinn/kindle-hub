<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Plano de Refatoração: Missale Web App</title>
    <style>
        @page {
            size: A4;
            margin: 2cm;
            @bottom-center {
                content: counter(page);
            }
        }
        body {
            font-family: 'Georgia', serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #333;
            max-width: 100%;
        }
        h1 {
            text-align: center;
            font-size: 24pt;
            margin-bottom: 0.3em;
            page-break-before: always;
        }
        h1:first-of-type {
            page-break-before: avoid;
        }
        h2 {
            font-size: 14pt;
            color: #8B4513;
            border-bottom: 1px solid #8B4513;
            padding-bottom: 0.3em;
            margin-top: 1.5em;
        }
        h3 {
            font-size: 12pt;
            color: #555;
            margin-top: 1.2em;
        }
        h4 {
            font-size: 11pt;
            margin-top: 1em;
        }
        .titulo-principal {
            text-align: center;
            padding: 2em 0;
            border-bottom: 2px solid #8B4513;
            margin-bottom: 2em;
        }
        .titulo-principal h1 {
            page-break-before: avoid;
        }
        .subtitulo {
            font-size: 14pt;
            font-style: italic;
            color: #666;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
            font-size: 10pt;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f5f5dc;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #fafafa;
        }
        pre, code {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 9pt;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        pre {
            padding: 1em;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        code {
            padding: 0.2em 0.4em;
        }
        pre code {
            padding: 0;
            border: none;
            background: none;
        }
        ul, ol {
            margin: 0.5em 0;
            padding-left: 2em;
        }
        li {
            margin: 0.3em 0;
        }
        .fase-box {
            background: #f9f9f9;
            border-left: 4px solid #8B4513;
            padding: 1em;
            margin: 1em 0;
        }
        .checklist {
            list-style: none;
            padding-left: 1em;
        }
        .checklist li::before {
            content: "☐ ";
        }
        .arquivo {
            font-family: monospace;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
        }
        .destaque {
            background: #fffacd;
            padding: 0.5em 1em;
            border-radius: 5px;
            margin: 1em 0;
        }
        .sumario {
            background: #f5f5dc;
            padding: 1em 2em;
            border-radius: 5px;
            margin-bottom: 2em;
        }
        .sumario h2 {
            border: none;
            margin-top: 0;
        }
        .sumario ol {
            columns: 2;
        }
        @media print {
            .page-break {
                page-break-before: always;
            }
        }
    </style>
</head>
<body>

<div class="titulo-principal">
    <h1 style="page-break-before: avoid;">Plano de Refatoração</h1>
    <p style="font-size: 18pt;">Missale Romano — Aplicação Web</p>
    <p class="subtitulo">Otimizado para Navegadores e Kindle</p>
    <hr style="width: 60%; margin: 1em auto;">
    <p>Dezembro 2024</p>
</div>

<div class="sumario">
    <h2>Sumário</h2>
    <ol>
        <li>Visão Geral do Projeto</li>
        <li>Fase 1: Extração e Conversão de Conteúdo</li>
        <li>Fase 2: Motor do Calendário Litúrgico</li>
        <li>Fase 3: Estrutura Base do App</li>
        <li>Fase 4: Sistema de Navegação</li>
        <li>Fase 5: Sistema de Preferências</li>
        <li>Fase 6: Otimização para Kindle</li>
        <li>Fase 7: Funcionalidade Offline</li>
        <li>Fase 8: Testes e Deploy</li>
        <li>Checklist por Fase</li>
        <li>Anexo: Mapeamento de Arquivos</li>
    </ol>
</div>

<h1>1. Visão Geral do Projeto</h1>

<h2>Objetivo</h2>
<p>Refatorar o aplicativo Missale Romano (atualmente em Cordova) para uma aplicação web moderna, estática e otimizada para:</p>
<ul>
    <li>Navegadores modernos (Chrome, Firefox, Safari)</li>
    <li><strong>Navegador do Kindle</strong> (foco principal — e-ink, recursos limitados)</li>
    <li>Funcionalidade offline via Service Worker</li>
</ul>

<h2>Arquitetura Proposta</h2>
<table>
    <tr>
        <th>App Original (Cordova)</th>
        <th>App Novo (Web Estático)</th>
    </tr>
    <tr><td>jQuery + iScroll</td><td>Vanilla JavaScript ES6+</td></tr>
    <tr><td>Cordova plugins</td><td>Web APIs nativas</td></tr>
    <tr><td>LocalStorage direto</td><td>LocalStorage com fallback</td></tr>
    <tr><td>HTML em ~8 pastas de idioma</td><td>JSON estruturado + templates</td></tr>
    <tr><td>63MB de arquivos HTML</td><td>~5-10MB otimizado</td></tr>
    <tr><td>feria_actual.html monolítico</td><td>Componentes modulares</td></tr>
</table>

<h2>Fases do Projeto</h2>
<table>
    <tr><th>Fase</th><th>Descrição</th><th>Prioridade</th></tr>
    <tr><td>1</td><td>Extração e Conversão de Conteúdo</td><td>Alta</td></tr>
    <tr><td>2</td><td>Motor do Calendário Litúrgico</td><td>Alta</td></tr>
    <tr><td>3</td><td>Estrutura Base do App</td><td>Alta</td></tr>
    <tr><td>4</td><td>Sistema de Navegação</td><td>Média</td></tr>
    <tr><td>5</td><td>Sistema de Preferências</td><td>Média</td></tr>
    <tr><td>6</td><td>Otimização para Kindle</td><td>Alta</td></tr>
    <tr><td>7</td><td>Funcionalidade Offline</td><td>Média</td></tr>
    <tr><td>8</td><td>Testes e Deploy</td><td>Alta</td></tr>
</table>

<h1 class="page-break">2. Fase 1: Extração e Conversão de Conteúdo</h1>

<h2>Objetivo</h2>
<p>Converter os arquivos HTML existentes (~63MB) em um formato JSON estruturado e otimizado.</p>

<h2>Estrutura Atual a Ser Processada</h2>
<pre>
misal_v2/
├── m_cast/        # Castelhano (usar como referência)
├── m_latin/       # Latim
├── m_port/        # Português
├── m_engl/        # Inglês
├── m_fran/        # Francês
├── m_ital/        # Italiano
├── m_germ/        # Alemão
└── m_estructura/  # Templates base
</pre>

<p>Cada pasta contém:</p>
<ul>
    <li><code>ordinario/</code> — Ordinário da Missa</li>
    <li><code>tiempos/</code> — Tempos litúrgicos (advento, quaresma, páscoa, etc.)</li>
    <li><code>lecturas/</code> — Leituras (~90 arquivos)</li>
    <li><code>santos/</code> — Santos por mês</li>
    <li><code>plegarias_euc/</code> — Orações Eucarísticas</li>
    <li><code>prefacios/</code> — Prefácios</li>
    <li><code>comunes_votivas/</code> — Missas comuns e votivas</li>
</ul>

<h3>Passo 1.1: Criar Script de Extração</h3>
<p><strong>Arquivo a criar:</strong> <code>scripts/extract-content.js</code></p>
<p><strong>O que faz:</strong></p>
<ul>
    <li>Lê cada arquivo HTML das pastas de idioma</li>
    <li>Extrai o conteúdo das classes <code>.hijo</code> (conteúdo) ignorando <code>.padre</code> (template)</li>
    <li>Identifica seções por IDs e classes</li>
    <li>Gera JSON estruturado</li>
</ul>

<p><strong>Arquivos originais a analisar:</strong></p>
<ul>
    <li><code>m_estructura/ordinario/m_estructura_ordinario.html</code> — estrutura base</li>
    <li><code>m_cast/ordinario/m_cast_ordinario.html</code> — exemplo de conteúdo</li>
</ul>

<p><strong>Estrutura JSON de saída proposta:</strong></p>
<pre><code>{
  "ordinario": {
    "ritos_iniciais": {
      "id": "ritos_iniciais",
      "titulo": "Ritos Iniciais",
      "conteudo": {
        "cast": "&lt;p&gt;En el nombre del Padre...&lt;/p&gt;",
        "latin": "&lt;p&gt;In nomine Patris...&lt;/p&gt;",
        "port": "&lt;p&gt;Em nome do Pai...&lt;/p&gt;"
      }
    },
    "kyrie": { },
    "gloria": { }
  }
}</code></pre>

<h3>Passo 1.2: Processar Ordinário da Missa</h3>
<p><strong>Arquivos fonte:</strong> <code>m_*/ordinario/m_*_ordinario.html</code> (todos os idiomas)</p>
<p><strong>Seções a extrair (IDs do original):</strong></p>
<ul>
    <li><code>ritos_iniciales</code> — Ritos Iniciais</li>
    <li><code>liturgia_palabra</code> — Liturgia da Palavra</li>
    <li><code>liturgia_eucaristica_1</code>, <code>_2</code>, <code>_3</code> — Liturgia Eucarística</li>
    <li><code>rito_comunion</code> — Rito da Comunhão</li>
    <li><code>despedida</code> — Despedida</li>
</ul>
<p><strong>Saída:</strong> <code>data/ordinario.json</code></p>

<h3>Passo 1.3: Processar Tempos Litúrgicos</h3>
<table>
    <tr><th>Tempo</th><th>Arquivos</th></tr>
    <tr><td>Advento</td><td><code>tiempos/adviento_*.html</code></td></tr>
    <tr><td>Natal</td><td><code>tiempos/navidad_*.html</code></td></tr>
    <tr><td>Quaresma</td><td><code>tiempos/cuaresma_*.html</code></td></tr>
    <tr><td>Semana Santa</td><td><code>tiempos/semana_santa_*.html</code></td></tr>
    <tr><td>Páscoa</td><td><code>tiempos/pascua_*.html</code></td></tr>
    <tr><td>Tempo Ordinário</td><td><code>tiempos/ordinario_*.html</code></td></tr>
</table>

<p><strong>Estrutura de saída:</strong></p>
<pre>
data/
└── tempos/
    ├── advento.json
    ├── natal.json
    ├── quaresma.json
    ├── pascoa.json
    └── ordinario.json
</pre>

<h3>Passo 1.4: Processar Leituras</h3>
<p><strong>Arquivos fonte:</strong> <code>m_*/lecturas/*.html</code> (~90 arquivos por idioma)</p>
<pre>
data/
└── leituras/
    ├── domingos-a.json    # Ciclo A
    ├── domingos-b.json    # Ciclo B
    ├── domingos-c.json    # Ciclo C
    ├── ferias-ano1.json   # Ano I
    ├── ferias-ano2.json   # Ano II
    └── santos.json        # Leituras de santos
</pre>

<h3>Passo 1.5: Processar Santos e Celebrações</h3>
<p><strong>Arquivos fonte:</strong> <code>m_*/santos/santos_*.html</code> (12 arquivos por mês)</p>
<p><strong>Saída:</strong> <code>data/santos/</code> com arquivo por mês</p>

<h3>Passo 1.6: Processar Orações Eucarísticas e Prefácios</h3>
<p><strong>Arquivos fonte:</strong></p>
<ul>
    <li><code>m_*/plegarias_euc/*.html</code></li>
    <li><code>m_*/prefacios/*.html</code></li>
</ul>
<p><strong>Saída:</strong> <code>data/plegarias-eucaristicas.json</code>, <code>data/prefacios.json</code></p>

<h3>Entregáveis da Fase 1</h3>
<table>
    <tr><th>Item</th><th>Localização</th></tr>
    <tr><td>Script de extração</td><td><code>scripts/extract-content.js</code></td></tr>
    <tr><td>Ordinário processado</td><td><code>data/ordinario.json</code></td></tr>
    <tr><td>Tempos litúrgicos</td><td><code>data/tempos/*.json</code></td></tr>
    <tr><td>Leituras</td><td><code>data/leituras/*.json</code></td></tr>
    <tr><td>Santos</td><td><code>data/santos/*.json</code></td></tr>
    <tr><td>Orações e Prefácios</td><td><code>data/plegarias-eucaristicas.json</code>, <code>data/prefacios.json</code></td></tr>
</table>

<h1 class="page-break">3. Fase 2: Motor do Calendário Litúrgico</h1>

<h2>Objetivo</h2>
<p>Criar um módulo JavaScript puro que calcule todas as datas litúrgicas, reutilizando a lógica do arquivo original <code>mis_funciones_misal.js</code>.</p>

<h2>Código a Reutilizar do Original</h2>
<p><strong>Arquivo fonte:</strong> <code>misal_v2/mis_funciones_misal.js</code> (linhas ~1-500)</p>

<h3>Funções essenciais a extrair</h3>

<h4>Cálculo da Páscoa (Algoritmo de Gauss):</h4>
<pre><code>// Original: função para calcular domingo de Páscoa
function calculaPascua(year) {
  var a = year % 19;
  var b = Math.floor(year / 100);
  var c = year % 100;
  var d = Math.floor(b / 4);
  var e = b % 4;
  var f = Math.floor((b + 8) / 25);
  var g = Math.floor((b - f + 1) / 3);
  var h = (19 * a + b - d - g + 15) % 30;
  var i = Math.floor(c / 4);
  var k = c % 4;
  var l = (32 + 2 * e + 2 * i - h - k) % 7;
  var m = Math.floor((a + 11 * h + 22 * l) / 451);
  var mes = Math.floor((h + l - 7 * m + 114) / 31);
  var dia = ((h + l - 7 * m + 114) % 31) + 1;
  return new Date(year, mes - 1, dia);
}</code></pre>

<h4>Cálculo de festas móveis:</h4>
<pre><code>// A partir da Páscoa, calcular:
// - Quarta-feira de Cinzas: Páscoa - 46 dias
// - Domingo de Ramos: Páscoa - 7 dias
// - Ascensão: Páscoa + 40 dias (ou domingo seguinte)
// - Pentecostes: Páscoa + 49 dias
// - Corpus Christi: Páscoa + 63 dias
// - Primeiro domingo do Advento</code></pre>

<h4>Ciclo litúrgico:</h4>
<pre><code>// Original usa: ciclos[(aniociclo - 1969) % 3]
// Onde ciclos = ["C", "A", "B"]</code></pre>

<h3>Passo 2.1: Criar Módulo do Calendário</h3>
<p><strong>Arquivo a criar:</strong> <code>src/calendario.js</code></p>
<pre><code>// src/calendario.js
export class CalendarioLiturgico {
  constructor(ano) {
    this.ano = ano;
    this.pascoa = this.calculaPascoa(ano);
    this.ciclo = this.calculaCiclo(ano);
    this.tipoAno = ano % 2 === 0 ? 'II' : 'I';
  }
  
  calculaPascoa(ano) { /* ... */ }
  calculaCiclo(ano) { /* ... */ }
  
  // Festas móveis
  getQuartaCinzas() { /* Páscoa - 46 */ }
  getDomingoRamos() { /* Páscoa - 7 */ }
  getAscensao() { /* Páscoa + 40 */ }
  getPentecostes() { /* Páscoa + 49 */ }
  getCorpusChristi() { /* Páscoa + 63 */ }
  getPrimeiroAdvento() { /* ... */ }
  getBatismoSenhor() { /* ... */ }
  
  // Identificar tempo litúrgico de uma data
  getTempoLiturgico(data) {
    // Retorna: 'advento', 'natal', 'ordinario1', 
    //          'quaresma', 'pascoa', 'ordinario2'
  }
  
  // Identificar celebração do dia
  getCelebracao(data) {
    // Verifica santos fixos + festas móveis
    // Retorna objeto com tipo, nome, cor, etc.
  }
}</code></pre>

<h3>Passo 2.2: Criar Base de Dados de Santos</h3>
<p><strong>Arquivo a criar:</strong> <code>src/santos-fixos.js</code></p>
<pre><code>// src/santos-fixos.js
export const santosFixos = {
  "01-01": { nome: "Santa Maria, Mãe de Deus", tipo: "solenidade", cor: "branco" },
  "01-06": { nome: "Epifania do Senhor", tipo: "solenidade", cor: "branco" },
  "02-02": { nome: "Apresentação do Senhor", tipo: "festa", cor: "branco" },
  // ... continuar para todo o ano
};</code></pre>

<h3>Passo 2.3: Sistema de Cores Litúrgicas</h3>
<p><strong>Arquivo a criar:</strong> <code>src/cores-liturgicas.js</code></p>
<pre><code>export const coresLiturgicas = {
  branco: { nome: "Branco", hex: "#FFFFFF", kindle: "#FFF" },
  verde: { nome: "Verde", hex: "#228B22", kindle: "#888" },
  roxo: { nome: "Roxo", hex: "#800080", kindle: "#666" },
  vermelho: { nome: "Vermelho", hex: "#DC143C", kindle: "#444" },
  rosa: { nome: "Rosa", hex: "#FFB6C1", kindle: "#AAA" },
};</code></pre>

<h3>Entregáveis da Fase 2</h3>
<ul>
    <li><code>src/calendario.js</code> — Classe principal do calendário</li>
    <li><code>src/santos-fixos.js</code> — Base de dados de santos</li>
    <li><code>src/festas-moveis.js</code> — Cálculos de festas móveis</li>
    <li><code>src/cores-liturgicas.js</code> — Mapeamento de cores</li>
    <li><code>tests/calendario.test.js</code> — Testes unitários</li>
</ul>

<h1 class="page-break">4. Fase 3: Estrutura Base do App</h1>

<h2>Objetivo</h2>
<p>Criar a estrutura HTML/CSS/JS base da aplicação, otimizada para performance.</p>

<h3>Passo 3.1: Estrutura de Diretórios</h3>
<pre>
missale-web/
├── index.html           # Página única (SPA)
├── manifest.json        # PWA manifest
├── sw.js                # Service Worker
├── css/
│   ├── base.css         # Reset e estilos base
│   ├── liturgico.css    # Estilos do conteúdo litúrgico
│   ├── kindle.css       # Otimizações para Kindle
│   └── temas/
│       ├── claro.css
│       ├── escuro.css
│       └── sepia.css
├── src/
│   ├── app.js           # Inicialização
│   ├── calendario.js    # Módulo do calendário
│   ├── navegacao.js     # Navegação/routing
│   ├── renderizador.js  # Renderização de conteúdo
│   ├── preferencias.js  # Gerenciamento de prefs
│   └── utils.js         # Funções utilitárias
├── data/
│   └── [JSONs da Fase 1]
└── assets/
    └── icons/
</pre>

<h3>Passo 3.2: HTML Base</h3>
<p><strong>Arquivo:</strong> <code>index.html</code></p>
<p><strong>Reutilizar estrutura de:</strong> <code>misal_v2/feria_actual.html</code></p>

<pre><code>&lt;!DOCTYPE html&gt;
&lt;html lang="pt"&gt;
&lt;head&gt;
  &lt;meta charset="UTF-8"&gt;
  &lt;meta name="viewport" content="width=device-width, 
        initial-scale=1.0, user-scalable=yes"&gt;
  &lt;meta name="theme-color" content="#8B4513"&gt;
  &lt;title&gt;Missale Romano&lt;/title&gt;
  &lt;link rel="stylesheet" href="css/base.css"&gt;
  &lt;link rel="stylesheet" href="css/liturgico.css"&gt;
  &lt;link rel="manifest" href="manifest.json"&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;!-- Cabeçalho fixo --&gt;
  &lt;header id="cabecera"&gt;
    &lt;div class="data-liturgica"&gt;&lt;/div&gt;
    &lt;div class="controles"&gt;
      &lt;button id="btn-menu"&gt;Menu&lt;/button&gt;
      &lt;button id="btn-config"&gt;Config&lt;/button&gt;
    &lt;/div&gt;
  &lt;/header&gt;

  &lt;!-- Container principal --&gt;
  &lt;main id="contenedor"&gt;
    &lt;div id="scroller"&gt;
      &lt;!-- Conteúdo dinâmico aqui --&gt;
    &lt;/div&gt;
  &lt;/main&gt;

  &lt;!-- Navegação inferior --&gt;
  &lt;nav id="piedepantalla"&gt;
    &lt;button data-tab="ordinario"&gt;Ordinário&lt;/button&gt;
    &lt;button data-tab="proprio"&gt;Próprio&lt;/button&gt;
    &lt;button data-tab="leituras"&gt;Leituras&lt;/button&gt;
  &lt;/nav&gt;

  &lt;script type="module" src="src/app.js"&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>

<h3>Passo 3.3: CSS Base (Adaptado do Original)</h3>
<p><strong>Arquivo fonte:</strong> <code>misal_v2/misal.css</code> (1311 linhas)</p>

<pre><code>/* css/base.css */
*, *::before, *::after {
  box-sizing: border-box;
}

:root {
  --cor-fundo: #F5F5DC;
  --cor-texto: #333;
  --cor-rubrica: #8B0000;
  --cor-titulo: #8B4513;
  --fonte-principal: Georgia, serif;
  --tamanho-base: 16px;
}

body {
  font-family: var(--fonte-principal);
  font-size: var(--tamanho-base);
  background: var(--cor-fundo);
  color: var(--cor-texto);
  margin: 0;
  padding: 0;
  -webkit-text-size-adjust: 100%;
}</code></pre>

<pre><code>/* css/liturgico.css - Classes do original a manter */
.red, .re { color: var(--cor-rubrica); }
.rebo { color: var(--cor-rubrica); font-weight: bold; }
.rece { color: var(--cor-rubrica); text-align: center; }
.pueblo { font-weight: bold; }
.cap { font-variant: small-caps; }
.cruzroja::before { content: "+"; color: var(--cor-rubrica); }

/* Versículos e respostas */
.versiculo { margin-left: 1em; }
.resposta { margin-left: 2em; font-weight: bold; }

/* Seções colapsáveis */
.secao-titulo {
  cursor: pointer;
  padding: 0.5em;
  background: rgba(0,0,0,0.05);
}
.secao-conteudo { padding: 0 1em; }
.secao-conteudo.collapsed { display: none; }</code></pre>

<h3>Passo 3.4: JavaScript de Inicialização</h3>
<p><strong>Arquivo:</strong> <code>src/app.js</code></p>

<pre><code>// src/app.js
import { CalendarioLiturgico } from './calendario.js';
import { Navegacao } from './navegacao.js';
import { Renderizador } from './renderizador.js';
import { Preferencias } from './preferencias.js';

class MissaleApp {
  constructor() {
    this.prefs = new Preferencias();
    this.calendario = new CalendarioLiturgico(new Date().getFullYear());
    this.navegacao = new Navegacao(this);
    this.renderizador = new Renderizador(this);
    
    this.dataAtual = new Date();
    this.tabAtiva = 'ordinario';
    this.idiomas = ['port', 'latin']; // Padrão
  }

  async init() {
    // Aplicar preferências salvas
    this.prefs.aplicar();
    
    // Carregar dados do dia
    await this.carregarDia(this.dataAtual);
    
    // Registrar eventos
    this.registrarEventos();
    
    // Registrar Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }
  }

  async carregarDia(data) {
    const info = this.calendario.getCelebracao(data);
    await this.renderizador.renderizar(info, this.tabAtiva);
  }

  registrarEventos() {
    // Tabs
    document.querySelectorAll('[data-tab]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        this.tabAtiva = e.target.dataset.tab;
        this.carregarDia(this.dataAtual);
      });
    });
    
    // Menu e configurações
    document.getElementById('btn-config').addEventListener('click', 
      () => this.abrirConfig());
  }
}

// Iniciar
document.addEventListener('DOMContentLoaded', () => {
  window.app = new MissaleApp();
  window.app.init();
});</code></pre>

<h3>Entregáveis da Fase 3</h3>
<ul>
    <li><code>index.html</code> — Página principal</li>
    <li><code>css/base.css</code> — Estilos base</li>
    <li><code>css/liturgico.css</code> — Estilos do conteúdo</li>
    <li><code>src/app.js</code> — Classe principal</li>
    <li><code>src/renderizador.js</code> — Renderização de conteúdo</li>
</ul>

<h1 class="page-break">5. Fase 4: Sistema de Navegação</h1>

<h2>Objetivo</h2>
<p>Implementar navegação entre seções, tabs e datas sem recarregar a página.</p>

<h3>Passo 4.1: Módulo de Navegação</h3>
<p><strong>Arquivo:</strong> <code>src/navegacao.js</code></p>
<p><strong>Funcionalidades:</strong></p>
<ul>
    <li>Troca de tabs (Ordinário, Próprio, Leituras)</li>
    <li>Navegação por data (calendário)</li>
    <li>Histórico de navegação (voltar/avançar)</li>
    <li>Scroll suave entre seções</li>
</ul>
<p><strong>Reutilizar lógica de:</strong> <code>mis_funciones_misal.js</code></p>
<ul>
    <li>Função <code>toggle_pestanas()</code> — troca de tabs</li>
    <li>Lógica de scroll com <code>myScroll</code> (adaptar sem iScroll)</li>
</ul>

<pre><code>// src/navegacao.js
export class Navegacao {
  constructor(app) {
    this.app = app;
    this.historico = [];
  }

  irParaTab(tab) {
    // Atualizar UI
    document.querySelectorAll('[data-tab]').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.tab === tab);
    });
    
    // Salvar no histórico
    this.historico.push({ tab, data: this.app.dataAtual });
    
    // Renderizar
    this.app.tabAtiva = tab;
    this.app.carregarDia(this.app.dataAtual);
  }

  irParaData(data) {
    this.app.dataAtual = data;
    this.app.carregarDia(data);
  }

  irParaSecao(secaoId) {
    const elemento = document.getElementById(secaoId);
    if (elemento) {
      elemento.scrollIntoView({ behavior: 'smooth' });
    }
  }

  voltar() {
    if (this.historico.length > 1) {
      this.historico.pop();
      const anterior = this.historico[this.historico.length - 1];
      this.app.tabAtiva = anterior.tab;
      this.app.dataAtual = anterior.data;
      this.app.carregarDia(anterior.data);
    }
  }
}</code></pre>

<h3>Passo 4.2: Seletor de Data</h3>
<p>Criar componente simples de calendário (não usar JSCalendar do original)</p>

<pre><code>// src/componentes/seletor-data.js
export class SeletorData {
  constructor(container, onSelect) {
    this.container = container;
    this.onSelect = onSelect;
    this.dataAtual = new Date();
  }

  render() {
    const mes = this.dataAtual.getMonth();
    const ano = this.dataAtual.getFullYear();
    
    // Gerar HTML do calendário
    let html = '&lt;div class="calendario-nav"&gt;' +
      '&lt;button class="prev"&gt;Anterior&lt;/button&gt;' +
      '&lt;span&gt;' + this.getNomeMes(mes) + ' ' + ano + '&lt;/span&gt;' +
      '&lt;button class="next"&gt;Próximo&lt;/button&gt;' +
      '&lt;/div&gt;' +
      '&lt;div class="calendario-grid"&gt;' +
      this.gerarDias(mes, ano) +
      '&lt;/div&gt;';
    
    this.container.innerHTML = html;
    this.registrarEventos();
  }

  gerarDias(mes, ano) {
    // Gerar grid de dias do mês
    // Destacar domingos e festas
  }
}</code></pre>

<h3>Passo 4.3: Navegação por Gestos (Opcional)</h3>
<p>Para swipe no Kindle/touch:</p>

<pre><code>// src/gestos.js
export function configurarGestos(container, callbacks) {
  let startX, startY;
  
  container.addEventListener('touchstart', (e) => {
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
  });
  
  container.addEventListener('touchend', (e) => {
    const diffX = e.changedTouches[0].clientX - startX;
    const diffY = e.changedTouches[0].clientY - startY;
    
    if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
      if (diffX > 0) callbacks.swipeRight?.();
      else callbacks.swipeLeft?.();
    }
  });
}</code></pre>

<h3>Entregáveis da Fase 4</h3>
<ul>
    <li><code>src/navegacao.js</code> — Módulo de navegação</li>
    <li><code>src/componentes/seletor-data.js</code> — Calendário</li>
    <li><code>src/gestos.js</code> — Suporte a gestos</li>
</ul>

<h1 class="page-break">6. Fase 5: Sistema de Preferências</h1>

<h2>Objetivo</h2>
<p>Gerenciar preferências do usuário com persistência em LocalStorage.</p>

<h3>Passo 5.1: Módulo de Preferências</h3>
<p><strong>Arquivo fonte para referência:</strong> <code>mis_funciones_misal.js</code> (funções <code>dime_pref</code>, <code>pon_pref</code>)</p>
<p><strong>Arquivo a criar:</strong> <code>src/preferencias.js</code></p>

<pre><code>// src/preferencias.js
export class Preferencias {
  constructor() {
    this.defaults = {
      idioma1: 'port',
      idioma2: 'latin',
      tamanhoFonte: 100, // porcentagem
      tema: 'claro',
      modoNoturno: false,
      margemSuperior: 10,
      margemInferior: 10,
      passarPaginaSwipe: true,
      intencoes: '',
    };
    
    this.valores = this.carregar();
  }

  carregar() {
    try {
      const salvo = localStorage.getItem('missale_prefs');
      return salvo ? { ...this.defaults, ...JSON.parse(salvo) } : { ...this.defaults };
    } catch (e) {
      console.warn('Erro ao carregar preferências:', e);
      return { ...this.defaults };
    }
  }

  salvar() {
    try {
      localStorage.setItem('missale_prefs', JSON.stringify(this.valores));
    } catch (e) {
      // Tratamento de quota excedida (como no original)
      this.limparAntigos();
      try {
        localStorage.setItem('missale_prefs', JSON.stringify(this.valores));
      } catch (e2) {
        console.error('Não foi possível salvar preferências');
      }
    }
  }

  get(chave) {
    return this.valores[chave] ?? this.defaults[chave];
  }

  set(chave, valor) {
    this.valores[chave] = valor;
    this.salvar();
    this.aplicar();
  }

  aplicar() {
    const root = document.documentElement;
    
    // Tamanho da fonte
    root.style.setProperty('--tamanho-base', 
      (16 * this.valores.tamanhoFonte / 100) + 'px');
    
    // Tema
    document.body.classList.remove('tema-claro', 'tema-escuro', 'tema-sepia');
    document.body.classList.add('tema-' + this.valores.tema);
    
    // Modo noturno
    if (this.valores.modoNoturno) {
      document.body.classList.add('modo-noturno');
    } else {
      document.body.classList.remove('modo-noturno');
    }
    
    // Margens
    root.style.setProperty('--margem-superior', 
      this.valores.margemSuperior + 'px');
    root.style.setProperty('--margem-inferior', 
      this.valores.margemInferior + 'px');
  }

  limparAntigos() {
    // Remove posições de scroll antigas
    for (let i = localStorage.length - 1; i >= 0; i--) {
      const key = localStorage.key(i);
      if (key?.startsWith('scroll_')) {
        localStorage.removeItem(key);
      }
    }
  }
}</code></pre>

<h3>Entregáveis da Fase 5</h3>
<ul>
    <li><code>src/preferencias.js</code> — Gerenciamento de preferências</li>
    <li><code>src/componentes/modal-config.js</code> — UI de configurações</li>
    <li><code>css/temas/claro.css</code>, <code>escuro.css</code>, <code>sepia.css</code> — Temas</li>
</ul>

<h1 class="page-break">7. Fase 6: Otimização para Kindle</h1>

<h2>Objetivo</h2>
<p>Garantir que o app funcione perfeitamente no navegador experimental do Kindle.</p>

<h2>Considerações Específicas do Kindle</h2>
<table>
    <tr><th>Característica</th><th>Implicação</th></tr>
    <tr><td>Tela e-ink</td><td>Evitar animações, transições suaves</td></tr>
    <tr><td>Refresh lento</td><td>Minimizar repinturas do DOM</td></tr>
    <tr><td>JavaScript limitado</td><td>Código simples, sem frameworks pesados</td></tr>
    <tr><td>Sem cores</td><td>UI deve funcionar em escala de cinza</td></tr>
    <tr><td>Memória limitada</td><td>Carregar conteúdo sob demanda</td></tr>
    <tr><td>Touch impreciso</td><td>Botões grandes, áreas de toque amplas</td></tr>
    <tr><td>Sem LocalStorage às vezes</td><td>Fallback para cookies ou sem persistência</td></tr>
</table>

<h3>Passo 6.1: CSS Específico para Kindle</h3>
<p><strong>Arquivo:</strong> <code>css/kindle.css</code></p>

<pre><code>/* css/kindle.css */

/* Detecção via media query ou classe no body */
@media (max-color: 1), (monochrome) {
  :root {
    --cor-fundo: #FFF;
    --cor-texto: #000;
    --cor-rubrica: #555;
    --cor-titulo: #333;
  }
  
  /* Remover sombras e gradientes */
  * {
    box-shadow: none !important;
    text-shadow: none !important;
    background-image: none !important;
  }
  
  /* Bordas sólidas em vez de sutis */
  .secao-titulo {
    border: 1px solid #999;
    background: #EEE;
  }
  
  /* Botões mais visíveis */
  button {
    border: 2px solid #000;
    background: #FFF;
    min-height: 44px;
    min-width: 44px;
  }
  
  /* Contraste alto para texto */
  .red, .re, .rebo {
    font-weight: bold;
    /* Usar negrito em vez de cor */
  }
}

/* Áreas de toque maiores */
.kindle-mode button,
.kindle-mode [onclick],
.kindle-mode a {
  min-height: 48px;
  padding: 12px 16px;
}

/* Scroll por página */
.kindle-mode #contenedor {
  overflow-y: auto;
  scroll-snap-type: y mandatory;
}

.kindle-mode .pagina {
  scroll-snap-align: start;
  min-height: 100vh;
}</code></pre>

<h3>Passo 6.2: Detecção de Kindle</h3>
<pre><code>// src/utils.js
export function detectarKindle() {
  const ua = navigator.userAgent.toLowerCase();
  return ua.includes('kindle') || 
         ua.includes('silk') ||
         ua.includes('kftt') ||  // Kindle Fire
         ua.includes('kfjw') ||
         window.matchMedia('(monochrome)').matches;
}

export function aplicarModoKindle() {
  if (detectarKindle()) {
    document.body.classList.add('kindle-mode');
    
    // Desabilitar animações
    document.body.style.setProperty('--duracao-transicao', '0s');
    
    // Aumentar tamanho de fonte padrão
    const prefs = new Preferencias();
    if (prefs.get('tamanhoFonte') < 110) {
      prefs.set('tamanhoFonte', 110);
    }
  }
}</code></pre>

<h3>Entregáveis da Fase 6</h3>
<ul>
    <li><code>css/kindle.css</code> — Estilos específicos</li>
    <li><code>src/utils.js</code> com <code>detectarKindle()</code> — Detecção</li>
    <li><code>src/carregador-lazy.js</code> — Carregamento otimizado</li>
    <li>Testes em emulador/dispositivo Kindle</li>
</ul>

<h1 class="page-break">8. Fase 7: Funcionalidade Offline</h1>

<h2>Objetivo</h2>
<p>Permitir uso completo do app sem conexão via Service Worker e Cache API.</p>

<h3>Passo 7.1: Service Worker</h3>
<p><strong>Arquivo:</strong> <code>sw.js</code></p>

<pre><code>// sw.js
const CACHE_NAME = 'missale-v1';

const ARQUIVOS_ESSENCIAIS = [
  '/',
  '/index.html',
  '/css/base.css',
  '/css/liturgico.css',
  '/css/kindle.css',
  '/src/app.js',
  '/src/calendario.js',
  '/src/navegacao.js',
  '/src/renderizador.js',
  '/src/preferencias.js',
  '/data/ordinario.json',
];

// Instalar - cachear arquivos essenciais
self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then(cache => cache.addAll(ARQUIVOS_ESSENCIAIS))
      .then(() => self.skipWaiting())
  );
});

// Ativar - limpar caches antigos
self.addEventListener('activate', (event) => {
  event.waitUntil(
    caches.keys().then(keys => 
      Promise.all(
        keys.filter(key => key !== CACHE_NAME)
            .map(key => caches.delete(key))
      )
    ).then(() => self.clients.claim())
  );
});

// Fetch - estratégia Cache First
self.addEventListener('fetch', (event) => {
  event.respondWith(
    caches.match(event.request)
      .then(cached => {
        if (cached) return cached;
        
        return fetch(event.request).then(response => {
          // Cachear novos arquivos de dados
          if (event.request.url.includes('/data/')) {
            const clone = response.clone();
            caches.open(CACHE_NAME)
              .then(cache => cache.put(event.request, clone));
          }
          return response;
        });
      })
      .catch(() => {
        // Fallback para página offline
        if (event.request.mode === 'navigate') {
          return caches.match('/index.html');
        }
      })
  );
});</code></pre>

<h3>Passo 7.2: Manifest PWA</h3>
<p><strong>Arquivo:</strong> <code>manifest.json</code></p>

<pre><code>{
  "name": "Missale Romano",
  "short_name": "Missale",
  "description": "Missal Romano em múltiplos idiomas",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#F5F5DC",
  "theme_color": "#8B4513",
  "icons": [
    {
      "src": "/assets/icons/icon-192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/assets/icons/icon-512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}</code></pre>

<h3>Entregáveis da Fase 7</h3>
<ul>
    <li><code>sw.js</code> — Service Worker</li>
    <li><code>manifest.json</code> — Manifest PWA</li>
    <li>Ícones em <code>assets/icons/</code></li>
    <li><code>src/componentes/status-offline.js</code></li>
</ul>

<h1 class="page-break">9. Fase 8: Testes e Deploy</h1>

<h3>Passo 8.1: Testes Unitários</h3>
<p><strong>Framework sugerido:</strong> Jest ou testes simples sem framework</p>

<pre><code>// tests/calendario.test.js
import { CalendarioLiturgico } from '../src/calendario.js';

// Teste: Páscoa 2024 deve ser 31 de março
const cal2024 = new CalendarioLiturgico(2024);
console.assert(
  cal2024.pascoa.getDate() === 31 && 
  cal2024.pascoa.getMonth() === 2, // março = 2
  'Páscoa 2024 incorreta'
);

// Teste: Ciclo 2024 deve ser B
console.assert(cal2024.ciclo === 'B', 'Ciclo 2024 incorreto');

// Teste: Quarta de Cinzas 2024
const cinzas = cal2024.getQuartaCinzas();
console.assert(
  cinzas.getDate() === 14 && 
  cinzas.getMonth() === 1, // fevereiro = 1
  'Quarta de Cinzas 2024 incorreta'
);</code></pre>

<h3>Passo 8.2: Testes de Interface</h3>
<p><strong>Checklist manual:</strong></p>
<table>
    <tr><th>#</th><th>Teste</th><th>OK</th></tr>
    <tr><td>1</td><td>Página carrega sem erros no console</td><td>☐</td></tr>
    <tr><td>2</td><td>Troca de tabs funciona</td><td>☐</td></tr>
    <tr><td>3</td><td>Seletor de data funciona</td><td>☐</td></tr>
    <tr><td>4</td><td>Troca de idioma funciona</td><td>☐</td></tr>
    <tr><td>5</td><td>Preferências são salvas</td><td>☐</td></tr>
    <tr><td>6</td><td>Funciona offline (após primeiro carregamento)</td><td>☐</td></tr>
    <tr><td>7</td><td>Funciona no Kindle/e-ink</td><td>☐</td></tr>
    <tr><td>8</td><td>Texto é legível em todos os tamanhos</td><td>☐</td></tr>
    <tr><td>9</td><td>Botões são tocáveis em mobile</td><td>☐</td></tr>
    <tr><td>10</td><td>Scroll funciona suavemente</td><td>☐</td></tr>
</table>

<h3>Passo 8.3: Otimização Final</h3>
<p><strong>Minificação:</strong></p>
<pre><code># Usando terser para JS
npx terser src/app.js -o dist/app.min.js

# Usando cssnano para CSS
npx cssnano css/base.css dist/base.min.css</code></pre>

<p><strong>Compressão de JSONs:</strong></p>
<pre><code># Remover espaços e quebras de linha
for f in data/*.json; do
  jq -c '.' "$f" > "dist/data/$(basename $f)"
done</code></pre>

<h3>Passo 8.4: Deploy</h3>
<p><strong>Opções de hospedagem:</strong></p>
<table>
    <tr><th>Plataforma</th><th>Vantagens</th><th>Comando</th></tr>
    <tr><td>GitHub Pages</td><td>Grátis, fácil</td><td><code>gh-pages -d dist</code></td></tr>
    <tr><td>Vercel</td><td>Preview automático</td><td><code>vercel --prod</code></td></tr>
    <tr><td>Netlify</td><td>CDN global</td><td><code>netlify deploy</code></td></tr>
    <tr><td>Firebase Hosting</td><td>Google CDN</td><td><code>firebase deploy</code></td></tr>
</table>

<p><strong>Estrutura final para deploy:</strong></p>
<pre>
dist/
├── index.html
├── manifest.json
├── sw.js
├── css/
│   ├── base.min.css
│   ├── liturgico.min.css
│   └── kindle.min.css
├── src/
│   └── app.min.js
├── data/
│   └── [JSONs minificados]
└── assets/
    └── icons/
</pre>

<h3>Entregáveis da Fase 8</h3>
<ul>
    <li>Suíte de testes</li>
    <li>Scripts de build (<code>scripts/build.sh</code>)</li>
    <li>Configuração de deploy</li>
    <li>Documentação de uso</li>
</ul>

<h1 class="page-break">10. Checklist por Fase</h1>

<h3>Fase 1: Extração de Conteúdo</h3>
<ul class="checklist">
    <li>Criar script <code>extract-content.js</code></li>
    <li>Processar ordinário (todos os idiomas)</li>
    <li>Processar tempos litúrgicos</li>
    <li>Processar leituras</li>
    <li>Processar santos</li>
    <li>Processar orações eucarísticas e prefácios</li>
    <li>Validar JSONs gerados</li>
</ul>

<h3>Fase 2: Calendário Litúrgico</h3>
<ul class="checklist">
    <li>Implementar <code>calendario.js</code></li>
    <li>Cálculo da Páscoa (verificar anos futuros)</li>
    <li>Cálculo de festas móveis</li>
    <li>Base de dados de santos fixos</li>
    <li>Testes unitários do calendário</li>
</ul>

<h3>Fase 3: Estrutura Base</h3>
<ul class="checklist">
    <li>Criar <code>index.html</code></li>
    <li>Criar CSS base e litúrgico</li>
    <li>Criar <code>app.js</code> e módulos</li>
    <li>Testar carregamento básico</li>
</ul>

<h3>Fase 4: Navegação</h3>
<ul class="checklist">
    <li>Implementar troca de tabs</li>
    <li>Criar seletor de data</li>
    <li>Implementar navegação por seção</li>
    <li>Suporte a gestos (opcional)</li>
</ul>

<h3>Fase 5: Preferências</h3>
<ul class="checklist">
    <li>Implementar <code>preferencias.js</code></li>
    <li>Criar modal de configurações</li>
    <li>Criar temas (claro, escuro, sépia)</li>
    <li>Testar persistência</li>
</ul>

<h3>Fase 6: Otimização Kindle</h3>
<ul class="checklist">
    <li>Criar <code>kindle.css</code></li>
    <li>Implementar detecção de Kindle</li>
    <li>Testar em dispositivo/emulador</li>
    <li>Otimizar carregamento</li>
</ul>

<h3>Fase 7: Offline</h3>
<ul class="checklist">
    <li>Implementar Service Worker</li>
    <li>Criar manifest.json</li>
    <li>Criar ícones PWA</li>
    <li>Testar modo offline</li>
</ul>

<h3>Fase 8: Deploy</h3>
<ul class="checklist">
    <li>Executar testes</li>
    <li>Minificar assets</li>
    <li>Configurar hospedagem</li>
    <li>Deploy final</li>
</ul>

<h1 class="page-break">11. Anexo: Mapeamento de Arquivos Originais</h1>

<h2>Arquivos JavaScript a Reutilizar</h2>
<table>
    <tr><th>Original</th><th>Função</th><th>Destino</th></tr>
    <tr><td><code>mis_funciones_misal.js</code> L1-200</td><td>Calendário</td><td><code>calendario.js</code></td></tr>
    <tr><td><code>mis_funciones_misal.js</code> L200-400</td><td>Carregamento</td><td><code>renderizador.js</code></td></tr>
    <tr><td><code>mis_funciones_misal.js</code> L400-600</td><td>Scroll/navegação</td><td><code>navegacao.js</code></td></tr>
    <tr><td><code>mis_funciones_misal.js</code> L600-800</td><td>Preferências</td><td><code>preferencias.js</code></td></tr>
    <tr><td><code>mis_funciones_devoc.js</code> L1-200</td><td>Troca idioma</td><td><code>renderizador.js</code></td></tr>
    <tr><td><code>mis_funciones_devoc.js</code> L200-400</td><td>Layout</td><td><code>utils.js</code></td></tr>
</table>

<h2>Arquivos CSS a Adaptar</h2>
<table>
    <tr><th>Original</th><th>Uso</th></tr>
    <tr><td><code>misal.css</code> L1-150</td><td>Classes de cor (.re, .rebo, etc.)</td></tr>
    <tr><td><code>misal.css</code> L150-300</td><td>Classes de indentação</td></tr>
    <tr><td><code>misal.css</code> L300-500</td><td>Layout de header/footer</td></tr>
    <tr><td><code>misal.css</code> L500-800</td><td>Estilos de botões</td></tr>
    <tr><td><code>misal.css</code> L800-1000</td><td>Estilos de modais</td></tr>
    <tr><td><code>misal.css</code> L1000-1311</td><td>Responsividade</td></tr>
</table>

<h2>Conteúdo HTML por Pasta</h2>
<table>
    <tr><th>Pasta</th><th>Arquivos</th><th>JSON Destino</th></tr>
    <tr><td><code>m_*/ordinario/</code></td><td>1</td><td><code>ordinario.json</code></td></tr>
    <tr><td><code>m_*/tiempos/</code></td><td>~20</td><td><code>tempos/*.json</code></td></tr>
    <tr><td><code>m_*/lecturas/</code></td><td>~90</td><td><code>leituras/*.json</code></td></tr>
    <tr><td><code>m_*/santos/</code></td><td>12</td><td><code>santos/*.json</code></td></tr>
    <tr><td><code>m_*/plegarias_euc/</code></td><td>~5</td><td><code>plegarias.json</code></td></tr>
    <tr><td><code>m_*/prefacios/</code></td><td>~10</td><td><code>prefacios.json</code></td></tr>
    <tr><td><code>m_*/comunes_votivas/</code></td><td>~15</td><td><code>comunes.json</code></td></tr>
</table>

<hr>
<p style="text-align: center; font-style: italic;">Fim do Documento</p>

</body>
</html>
